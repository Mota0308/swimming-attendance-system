# API 服務器部署指南

## 概述
本指南說明如何部署 API 服務器，讓手機應用程序可以通過 API 訪問雲端數據庫。

## 系統要求
- Node.js 16.0.0 或更高版本
- npm 或 yarn 包管理器
- 網絡連接（訪問 MongoDB Atlas）

## 快速開始

### 1. 安裝依賴
```bash
cd api-server
npm install
```

### 2. 啟動服務器
```bash
# 開發模式（自動重啟）
npm run dev

# 生產模式
npm start
```

### 3. 測試服務器
服務器啟動後，訪問以下地址測試：
- 健康檢查：http://localhost:3000/health
- 獲取學生資料：http://localhost:3000/students

## 配置說明

### 1. 環境變量
創建 `.env` 文件（可選）：
```env
PORT=3000
MONGO_URI=mongodb+srv://chenyaolin0308:9GUhZvnuEpAA1r6c@cluster0.0dhi0qc.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
DB_NAME=test
```

### 2. API 密鑰
服務器已配置以下 API 密鑰：
- **公開密鑰**: `ttdrcccy`
- **私有密鑰**: `2b207365-cbf0-4e42-a3bf-f932c84557c4`

## API 端點

### 1. 健康檢查
```
GET /health
```
**用途**: 測試 API 服務器狀態
**響應**: 服務器運行狀態信息

### 2. 學生資料管理
```
GET /students          # 獲取所有學生資料
POST /students/batch   # 批量上傳學生資料
GET /students/:id      # 獲取單個學生資料
PUT /students/:id      # 更新學生資料
DELETE /students/:id   # 刪除學生資料
```

### 3. 用戶認證
```
POST /auth/login       # 用戶登入
```

## 手機 APP 配置

### 1. 開發環境
在 `APIConfig.kt` 中設置：
```kotlin
private const val DEFAULT_BASE_URL = "http://10.0.2.2:3000" // Android 模擬器
```

### 2. 生產環境
設置為實際的服務器地址：
```kotlin
private const val DEFAULT_BASE_URL = "https://your-api-server.com"
```

## 部署選項

### 1. 本地開發
```bash
npm run dev
```
適用於開發和測試。

### 2. 雲端部署
推薦使用以下平台：
- **Heroku**: 免費層級，簡單部署
- **Vercel**: 快速部署，自動擴展
- **Railway**: 簡單易用，支持數據庫
- **DigitalOcean**: 完全控制，成本較低

### 3. 自建服務器
```bash
# 安裝 PM2 進程管理器
npm install -g pm2

# 啟動服務器
pm2 start server.js --name "swimming-api"

# 設置開機自啟
pm2 startup
pm2 save
```

## 安全配置

### 1. HTTPS
生產環境必須使用 HTTPS：
```javascript
const https = require('https');
const fs = require('fs');

const options = {
  key: fs.readFileSync('path/to/key.pem'),
  cert: fs.readFileSync('path/to/cert.pem')
};

https.createServer(options, app).listen(443);
```

### 2. 環境變量
將敏感信息移到環境變量：
```javascript
const MONGO_URI = process.env.MONGO_URI;
const API_PUBLIC_KEY = process.env.API_PUBLIC_KEY;
const API_PRIVATE_KEY = process.env.API_PRIVATE_KEY;
```

### 3. 速率限制
添加請求速率限制：
```bash
npm install express-rate-limit
```

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分鐘
  max: 100 // 限制每個IP 15分鐘內最多100個請求
});

app.use(limiter);
```

## 監控和日誌

### 1. 日誌記錄
```javascript
const morgan = require('morgan');
app.use(morgan('combined'));
```

### 2. 錯誤監控
```bash
npm install winston
```

```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

## 測試

### 1. 使用 curl 測試
```bash
# 測試健康檢查
curl -H "X-API-Public-Key: ttdrcccy" \
     -H "X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" \
     http://localhost:3000/health

# 測試獲取學生資料
curl -H "X-API-Public-Key: ttdrcccy" \
     -H "X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" \
     http://localhost:3000/students
```

### 2. 使用 Postman 測試
1. 創建新的請求
2. 設置請求頭：
   - `X-API-Public-Key: ttdrcccy`
   - `X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4`
3. 發送請求到相應端點

## 故障排除

### 1. 常見問題

**問題**: 服務器無法啟動
**解決**: 檢查端口是否被佔用
```bash
lsof -i :3000
kill -9 <PID>
```

**問題**: MongoDB 連接失敗
**解決**: 檢查網絡連接和數據庫憑證

**問題**: CORS 錯誤
**解決**: 確保 CORS 中間件已正確配置

### 2. 日誌查看
```bash
# 查看實時日誌
tail -f combined.log

# 查看錯誤日誌
tail -f error.log
```

## 性能優化

### 1. 數據庫連接池
```javascript
const { MongoClient } = require('mongodb');

const client = new MongoClient(MONGO_URI, {
  maxPoolSize: 10,
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
});
```

### 2. 緩存
```bash
npm install redis
```

### 3. 壓縮
```bash
npm install compression
```

```javascript
const compression = require('compression');
app.use(compression());
```

## 備份和恢復

### 1. 數據庫備份
```bash
# MongoDB 備份
mongodump --uri="mongodb+srv://chenyaolin0308:9GUhZvnuEpAA1r6c@cluster0.0dhi0qc.mongodb.net/test"

# 恢復備份
mongorestore --uri="mongodb+srv://chenyaolin0308:9GUhZvnuEpAA1r6c@cluster0.0dhi0qc.mongodb.net/test" dump/
```

### 2. 代碼備份
使用 Git 進行版本控制：
```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin <repository-url>
git push -u origin main
```

## 聯繫支持

如有任何問題，請聯繫開發團隊或查看相關文檔。 
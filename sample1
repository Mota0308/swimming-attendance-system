<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç‚¹åç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] min-h-screen transition-colors">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">å­¦ç”Ÿç‚¹åç³»ç»Ÿ</h1>
            <p class="text-gray-600 dark:text-gray-400">ç®¡ç†å­¦ç”Ÿå‡ºå¸­ã€è¯·å‡ä¸è¡¥è¯¾è®°å½•</p>
        </div>

        <!-- Undo/Redo Buttons -->
        <div class="flex justify-end gap-2 mb-4">
            <button
                id="undoBtn"
                onclick="undo()"
                disabled
                class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
                â†¶ å¤åŸ
            </button>
            <button
                id="redoBtn"
                onclick="redo()"
                disabled
                class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
                â†· é‡åš
            </button>
        </div>

        <!-- Add Student Form -->
        <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">æ·»åŠ å­¦ç”Ÿ</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input
                    type="text"
                    id="studentName"
                    placeholder="å­¦ç”Ÿå§“å"
                    class="flex-1 px-4 py-2.5 text-base bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white"
                >
                <input
                    type="number"
                    id="purchasedClasses"
                    placeholder="å·²è´­å ‚æ•°"
                    min="0"
                    class="w-full sm:w-32 px-4 py-2.5 text-base bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white"
                >
                <button
                    onclick="addStudent()"
                    class="px-6 py-2.5 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all font-medium"
                >
                    æ·»åŠ 
                </button>
            </div>
        </div>

        <!-- Students List -->
        <div id="studentsList" class="space-y-4">
            <!-- Students will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <div class="text-gray-400 dark:text-gray-600 text-lg">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <p>æš‚æ— å­¦ç”Ÿæ•°æ®</p>
                <p class="text-sm mt-2">è¯·æ·»åŠ å­¦ç”Ÿå¼€å§‹ä½¿ç”¨</p>
            </div>
        </div>

        <!-- Formula Notes -->
        <div class="mt-8 bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">ğŸ“ è®¡ç®—å…¬å¼è¯´æ˜</h2>
            <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                    <span class="font-semibold text-gray-900 dark:text-white min-w-[200px]">æœªå®šæ—¥å­è¯¾å ‚ï¼š</span>
                    <span>å·²è´­å ‚æ•° - å·²å®šæ—¥å­è¯¾å ‚</span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                    <span class="font-semibold text-gray-900 dark:text-white min-w-[200px]">å·²å®šæ—¥å­è¯¾å ‚ï¼ˆæœªå‡ºå¸­ï¼‰ï¼š</span>
                    <span>å·²å®šæ—¥å­è¯¾å ‚ - å·²å‡ºå¸­</span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                    <span class="font-semibold text-gray-900 dark:text-white min-w-[200px]">æœªçº¦è¡¥å ‚ï¼š</span>
                    <span>è¯·å‡æ¬¡æ•° - å·²çº¦è¡¥å ‚</span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                    <span class="font-semibold text-gray-900 dark:text-white min-w-[200px]">æ€»å‡ºå¸­ï¼š</span>
                    <span>å·²å‡ºå¸­ + è¡¥å ‚å·²å‡ºå¸­</span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                    <span class="font-semibold text-gray-900 dark:text-white min-w-[200px]">å‡ºå¸­ç‡ï¼š</span>
                    <span>å·²å‡ºå¸­ Ã· å·²å®šæ—¥å­è¯¾å ‚ Ã— 100%</span>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">ğŸ”„ æ“ä½œè¯´æ˜</h3>
                <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-blue-600 dark:text-blue-400 min-w-[200px]">ğŸ“… å®šæ—¥å­è¯¾å ‚ï¼š</span>
                        <span>å·²å®šæ—¥å­è¯¾å ‚ +1ï¼ˆä»æœªå®šæ—¥å­è¯¾å ‚ä¸­æ‰£é™¤ï¼‰</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-green-600 dark:text-green-400 min-w-[200px]">âœ… æ ‡è®°å‡ºå¸­ï¼š</span>
                        <span>å·²å‡ºå¸­ +1ï¼ˆä»å·²å®šæ—¥å­è¯¾å ‚ï¼ˆæœªå‡ºå¸­ï¼‰ä¸­æ‰£å‡ï¼‰</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-red-600 dark:text-red-400 min-w-[200px]">âŒ æ ‡è®°ç¼ºå¸­ï¼š</span>
                        <span>å·²å®šæ—¥å­è¯¾å ‚ -1ï¼Œç¼ºå¸­ +1ï¼ˆä»å·²å®šæ—¥å­è¯¾å ‚ï¼ˆæœªå‡ºå¸­ï¼‰ä¸­æ‰£å‡ï¼‰</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-orange-600 dark:text-orange-400 min-w-[200px]">ğŸ–ï¸ è¯·å‡ï¼š</span>
                        <span>è¯·å‡æ¬¡æ•° +1ï¼Œå·²å®šæ—¥å­è¯¾å ‚ -1</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-purple-600 dark:text-purple-400 min-w-[200px]">â° é¢„çº¦åŠ æ—¶ï¼š</span>
                        <span>å·²çº¦è¡¥å ‚ +1ï¼ˆä»æœªçº¦è¡¥å ‚ä¸­æ‰£å‡ï¼‰</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-indigo-600 dark:text-indigo-400 min-w-[200px]">ğŸ”„ é¢„çº¦è°ƒå ‚ï¼š</span>
                        <span>å·²çº¦è¡¥å ‚ +1ï¼ˆä»æœªçº¦è¡¥å ‚ä¸­æ‰£å‡ï¼‰</span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2">
                        <span class="font-semibold text-teal-600 dark:text-teal-400 min-w-[200px]">âœ¨ æ ‡è®°è¡¥å ‚å‡ºå¸­ï¼š</span>
                        <span>è¡¥å ‚å·²å‡ºå¸­ +1ï¼ˆå¿…é¡»æœ‰å·²çº¦è¡¥å ‚ï¼‰</span>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">âš ï¸ é™åˆ¶æ¡ä»¶</h3>
                <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                    <div class="flex items-start gap-2">
                        <span class="text-red-500 dark:text-red-400">â€¢</span>
                        <span>æ€»å‡ºå¸­æ•°ï¼ˆå·²å‡ºå¸­ + è¡¥å ‚å·²å‡ºå¸­ï¼‰ä¸èƒ½è¶…è¿‡å·²è´­å ‚æ•°</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-red-500 dark:text-red-400">â€¢</span>
                        <span>å·²å‡ºå¸­ä¸èƒ½è¶…è¿‡å·²å®šæ—¥å­è¯¾å ‚</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-red-500 dark:text-red-400">â€¢</span>
                        <span>è¡¥å ‚å·²å‡ºå¸­ä¸èƒ½è¶…è¿‡å·²çº¦è¡¥å ‚</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-red-500 dark:text-red-400">â€¢</span>
                        <span>å·²å®šæ—¥å­è¯¾å ‚ä¸èƒ½å°‘äºå·²å‡ºå¸­</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-red-500 dark:text-red-400">â€¢</span>
                        <span>å·²å®šæ—¥å­è¯¾å ‚å’Œæ€»å‡ºå¸­æ€»å’Œä¸èƒ½å¤§äºå·²è´­å ‚æ•°</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="customModal" class="hidden fixed inset-0 z-50 modal-backdrop bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
            <div class="p-6">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900 dark:text-white mb-4"></h3>
                <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button
                        id="modalCancelBtn"
                        onclick="hideModal()"
                        class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                    >
                        å–æ¶ˆ
                    </button>
                    <button
                        id="modalConfirmBtn"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all"
                    >
                        ç¡®è®¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="hidden fixed inset-0 z-50 modal-backdrop bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">é€‰æ‹©æ“ä½œ</h3>
                <div id="actionButtons" class="space-y-2">
                    <!-- Action buttons will be rendered here -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button
                        onclick="hideActionModal()"
                        class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                    >
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data structure
        let students = [];
        let history = [];
        let historyIndex = -1;

        // Load data (in-memory storage)
        function loadData() {
            renderStudents();
            updateUndoRedoButtons();
        }

        // Save data (in-memory storage)
        function saveData() {
            // Data persists in memory during session
        }

        // Save state to history
        function saveState() {
            // Remove any future states if we're not at the end
            history = history.slice(0, historyIndex + 1);

            // Deep clone the current state
            const state = JSON.parse(JSON.stringify(students));
            history.push(state);
            historyIndex++;

            // Limit history to 50 states
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }

            updateUndoRedoButtons();
        }

        // Undo
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                students = JSON.parse(JSON.stringify(history[historyIndex]));
                renderStudents();
                updateUndoRedoButtons();
            }
        }

        // Redo
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                students = JSON.parse(JSON.stringify(history[historyIndex]));
                renderStudents();
                updateUndoRedoButtons();
            }
        }

        // Update undo/redo button states
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            if (undoBtn) {
                undoBtn.disabled = historyIndex <= 0;
            }
            if (redoBtn) {
                redoBtn.disabled = historyIndex >= history.length - 1;
            }
        }

        // Add student
        function addStudent() {
            const nameInput = document.getElementById('studentName');
            const classesInput = document.getElementById('purchasedClasses');

            const name = nameInput.value.trim();
            const purchased = parseInt(classesInput.value) || 0;

            if (!name) {
                showAlert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');
                return;
            }

            students.push({
                id: Date.now(),
                name: name,
                purchasedClasses: purchased,
                scheduledClasses: 0,
                attendedBooked: 0,
                absences: 0,
                leaveRequests: 0,
                bookedMakeup: 0,
                attendedMakeup: 0
            });

            nameInput.value = '';
            classesInput.value = '';

            saveState();
            saveData();
            renderStudents();
        }

        // Render students
        function renderStudents() {
            const container = document.getElementById('studentsList');
            const emptyState = document.getElementById('emptyState');

            if (students.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            container.innerHTML = students.map(student => {
                const unscheduled = student.purchasedClasses - student.scheduledClasses;
                const scheduledNotAttended = student.scheduledClasses - student.attendedBooked;
                const unbookedMakeup = student.leaveRequests - student.bookedMakeup;
                const attendanceRate = student.scheduledClasses > 0
                    ? Math.round((student.attendedBooked / student.scheduledClasses) * 100)
                    : 0;

                return `
                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">${student.name}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    å‡ºå¸­ç‡: <span class="font-semibold ${attendanceRate >= 80 ? 'text-green-600 dark:text-green-400' : attendanceRate >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'}">${attendanceRate}%</span>
                                </p>
                            </div>
                            <div class="flex gap-2 mt-3 sm:mt-0">
                                <button
                                    onclick="showActions(${student.id})"
                                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all text-sm font-medium"
                                >
                                    ç‚¹åæ“ä½œ
                                </button>
                                <button
                                    onclick="deleteStudent(${student.id})"
                                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-sm font-medium"
                                >
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">å·²è´­å ‚æ•°</p>
                                <p class="text-2xl font-bold text-primary">${student.purchasedClasses}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">å·²å®šæ—¥å­è¯¾å ‚</p>
                                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${student.scheduledClasses}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">å·²å®šæ—¥å­è¯¾å ‚ï¼ˆæœªå‡ºå¸­ï¼‰</p>
                                <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${scheduledNotAttended}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">å·²å‡ºå¸­</p>
                                <p class="text-2xl font-bold text-green-600 dark:text-green-400">${student.attendedBooked}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ç¼ºå¸­</p>
                                <p class="text-2xl font-bold text-red-600 dark:text-red-400">${student.absences}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">æœªå®šæ—¥å­è¯¾å ‚</p>
                                <p class="text-2xl font-bold text-gray-600 dark:text-gray-400">${unscheduled}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">è¯·å‡æ¬¡æ•°</p>
                                <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${student.leaveRequests}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">å·²çº¦è¡¥å ‚</p>
                                <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">${student.bookedMakeup}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">æœªçº¦è¡¥å ‚</p>
                                <p class="text-2xl font-bold text-pink-600 dark:text-pink-400">${unbookedMakeup}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">è¡¥å ‚å·²å‡ºå¸­</p>
                                <p class="text-2xl font-bold text-teal-600 dark:text-teal-400">${student.attendedMakeup}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">æ€»å‡ºå¸­</p>
                                <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">${student.attendedBooked + student.attendedMakeup}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show action modal
        function showActions(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const actionButtons = document.getElementById('actionButtons');
            actionButtons.innerHTML = `
                <button onclick="scheduleClass(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-left">
                    ğŸ“… å®šæ—¥å­è¯¾å ‚
                </button>
                <button onclick="markAttended(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all text-left">
                    âœ… æ ‡è®°å‡ºå¸­ï¼ˆå·²å®šæ—¥å­ï¼‰
                </button>
                <button onclick="markAbsent(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-left">
                    âŒ æ ‡è®°ç¼ºå¸­
                </button>
                <button onclick="requestLeave(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all text-left">
                    ğŸ–ï¸ è¯·å‡
                </button>
                <button onclick="bookOvertimeClass(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all text-left">
                    â° é¢„çº¦åŠ æ—¶
                </button>
                <button onclick="bookRescheduleClass(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-all text-left">
                    ğŸ”„ é¢„çº¦è°ƒå ‚
                </button>
                <button onclick="markMakeupAttended(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-all text-left">
                    âœ¨ æ ‡è®°è¡¥å ‚å‡ºå¸­
                </button>
                <button onclick="editPurchased(${studentId}); hideActionModal();" class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all text-left">
                    âœï¸ ä¿®æ”¹å·²è´­å ‚æ•°
                </button>
            `;

            document.getElementById('actionModal').classList.remove('hidden');
        }

        function hideActionModal() {
            document.getElementById('actionModal').classList.add('hidden');
        }

        // Schedule class
        function scheduleClass(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const unscheduled = student.purchasedClasses - student.scheduledClasses;
            if (unscheduled <= 0) {
                showAlert('æ²¡æœ‰å‰©ä½™è¯¾ç¨‹å¯å®šæ—¥å­');
                return;
            }

            // Check if scheduled + total attendance would exceed purchased
            const totalAttendance = student.attendedBooked + student.attendedMakeup;
            if (student.scheduledClasses + 1 + totalAttendance > student.purchasedClasses) {
                showAlert('å·²å®šæ—¥å­è¯¾å ‚å’Œæ€»å‡ºå¸­æ€»å’Œä¸èƒ½å¤§äºå·²è´­å ‚æ•°');
                return;
            }

            student.scheduledClasses++;
            saveState();
            saveData();
            renderStudents();
        }

        // Mark attended
        function markAttended(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const scheduledNotAttended = student.scheduledClasses - student.attendedBooked;
            if (scheduledNotAttended <= 0) {
                showAlert('æ²¡æœ‰å·²å®šæ—¥å­è¯¾å ‚ï¼ˆæœªå‡ºå¸­ï¼‰å¯ä»¥æ ‡è®°');
                return;
            }

            // Check if total attendance would exceed purchased classes
            const totalAttendance = student.attendedBooked + 1 + student.attendedMakeup;
            if (totalAttendance > student.purchasedClasses) {
                showAlert('æ€»å‡ºå¸­æ•°ä¸èƒ½è¶…è¿‡å·²è´­å ‚æ•°');
                return;
            }

            student.attendedBooked++;
            saveState();
            saveData();
            renderStudents();
        }

        // Mark absent
        function markAbsent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const scheduledNotAttended = student.scheduledClasses - student.attendedBooked;
            if (scheduledNotAttended <= 0) {
                showAlert('æ²¡æœ‰å·²å®šæ—¥å­è¯¾å ‚ï¼ˆæœªå‡ºå¸­ï¼‰å¯ä»¥æ ‡è®°');
                return;
            }

            // Check if scheduled classes would go below attended
            if (student.scheduledClasses - 1 < student.attendedBooked) {
                showAlert('å·²å®šæ—¥å­è¯¾å ‚ä¸èƒ½å°‘äºå·²å‡ºå¸­');
                return;
            }

            // Deduct from scheduled classes and increment absences
            student.scheduledClasses--;
            student.absences++;
            saveState();
            saveData();
            renderStudents();
        }

        // Request leave
        function requestLeave(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Check if scheduled classes would go below attended
            if (student.scheduledClasses - 1 < student.attendedBooked) {
                showAlert('å·²å®šæ—¥å­è¯¾å ‚ä¸èƒ½å°‘äºå·²å‡ºå¸­');
                return;
            }

            // Increment leave requests and decrement scheduled classes
            student.leaveRequests++;
            student.scheduledClasses--;
            saveState();
            saveData();
            renderStudents();
        }

        // Book overtime class
        function bookOvertimeClass(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const unbookedMakeup = student.leaveRequests - student.bookedMakeup;
            if (unbookedMakeup <= 0) {
                showAlert('æ²¡æœ‰æœªçº¦è¡¥å ‚å¯ä»¥é¢„çº¦');
                return;
            }

            student.bookedMakeup++;
            saveState();
            saveData();
            renderStudents();
        }

        // Book reschedule class
        function bookRescheduleClass(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const unbookedMakeup = student.leaveRequests - student.bookedMakeup;
            if (unbookedMakeup <= 0) {
                showAlert('æ²¡æœ‰æœªçº¦è¡¥å ‚å¯ä»¥é¢„çº¦');
                return;
            }

            student.bookedMakeup++;
            saveState();
            saveData();
            renderStudents();
        }

        // Mark makeup attended
        function markMakeupAttended(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            if (student.attendedMakeup >= student.bookedMakeup) {
                showAlert('è¡¥å ‚å·²å‡ºå¸­æ•°é‡ä¸èƒ½è¶…è¿‡å·²çº¦è¡¥å ‚æ•°é‡');
                return;
            }

            // Check if total attendance would exceed purchased classes
            const totalAttendance = student.attendedBooked + student.attendedMakeup + 1;
            if (totalAttendance > student.purchasedClasses) {
                showAlert('æ€»å‡ºå¸­æ•°ä¸èƒ½è¶…è¿‡å·²è´­å ‚æ•°');
                return;
            }

            student.attendedMakeup++;
            saveState();
            saveData();
            renderStudents();
        }

        // Edit purchased classes
        function editPurchased(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            showPrompt('ä¿®æ”¹å·²è´­å ‚æ•°', `å½“å‰å·²è´­å ‚æ•°: ${student.purchasedClasses}`, (value) => {
                const newValue = parseInt(value);
                if (isNaN(newValue) || newValue < 0) {
                    showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
                    return;
                }
                student.purchasedClasses = newValue;
                saveState();
                saveData();
                renderStudents();
            });
        }

        // Delete student
        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            showConfirm('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿ "${student.name}" å—ï¼Ÿ`, () => {
                students = students.filter(s => s.id !== studentId);
                saveState();
                saveData();
                renderStudents();
            });
        }

        // Custom modal functions
        function showModal(title, message, onConfirm, showCancel = true) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalCancelBtn').style.display = showCancel ? 'block' : 'none';

            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.onclick = () => {
                hideModal();
                if (onConfirm) onConfirm();
            };

            document.getElementById('customModal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('customModal').classList.add('hidden');
        }

        function showAlert(message) {
            showModal('æç¤º', message, null, false);
        }

        function showConfirm(title, message, onConfirm) {
            showModal(title, message, onConfirm, true);
        }

        function showPrompt(title, message, onConfirm) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;

            const messageEl = document.getElementById('modalMessage');
            messageEl.innerHTML = `
                <p class="text-gray-700 dark:text-gray-300 mb-3">${message}</p>
                <input type="number" id="promptInput" class="w-full px-4 py-2.5 text-base bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-900 dark:text-white" placeholder="è¯·è¾“å…¥æ•°å­—">
            `;

            document.getElementById('modalCancelBtn').style.display = 'block';

            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.onclick = () => {
                const value = document.getElementById('promptInput').value;
                hideModal();
                if (onConfirm) onConfirm(value);
            };

            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('promptInput').focus();
            }, 100);
        }

        // Initialize
        loadData();
        // Save initial empty state
        saveState();

        // Enter key support
        document.getElementById('studentName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addStudent();
        });
        document.getElementById('purchasedClasses').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addStudent();
        });

        // Keyboard shortcuts for undo/redo
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z or Cmd+Z for undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Ctrl+Shift+Z or Cmd+Shift+Z or Ctrl+Y for redo
            if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') ||
                (e.ctrlKey && e.key === 'y')) {
                e.preventDefault();
                redo();
            }
        });
    </script>
</body>
</html>
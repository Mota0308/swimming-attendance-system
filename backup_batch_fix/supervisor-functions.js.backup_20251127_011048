// ä¸»ç®¡åŠŸèƒ½æ¨¡çµ„ - å¾ main-app.js åˆ†é›¢å‡ºä¾†çš„ä¸»ç®¡ç›¸é—œåŠŸèƒ½

/**
 * é¡¯ç¤ºä¸»ç®¡ç•Œé¢
 */
function showSupervisorSection() {
    // ä½¿ç”¨ä¾è³´æ³¨å…¥ï¼Œé¿å…ç›´æ¥ä¾è³´å…¨å±€å‡½æ•¸
    if (window.App && window.App.hideAllSections) {
        window.App.hideAllSections();
    } else {
        console.error('âŒ App.hideAllSections æœªå®šç¾©');
        return;
    }
    
    document.getElementById('supervisorSection').classList.add('active');
    updateSupervisorUserInfo();
    console.log('âœ… é¡¯ç¤ºä¸»ç®¡ç•Œé¢');
}

/**
 * æ›´æ–°ä¸»ç®¡ç”¨æˆ¶ä¿¡æ¯
 */
function updateSupervisorUserInfo() {
    const userPhoneElement = document.getElementById('userPhone');
    const userTypeElement = document.getElementById('userType');
    
    // ä½¿ç”¨ä¾è³´æ³¨å…¥ç²å–å…¨å±€è®Šé‡
    const currentUser = window.App ? window.App.getCurrentUser() : null;
    const currentUserType = window.App ? window.App.getCurrentUserType() : null;
    
    console.log('ğŸ” æ›´æ–°ä¸»ç®¡ç”¨æˆ¶ä¿¡æ¯:', { currentUser, currentUserType });
    
    if (userPhoneElement) {
        // currentUser ç¾åœ¨æ˜¯ä¸€å€‹å°è±¡ï¼Œéœ€è¦è¨ªå• phone å±¬æ€§
        if (currentUser && typeof currentUser === 'object') {
            userPhoneElement.textContent = currentUser.phone || '';
        } else {
        userPhoneElement.textContent = currentUser || '';
        }
        console.log('âœ… ä¸»ç®¡é›»è©±:', userPhoneElement.textContent);
    }
    if (userTypeElement && window.App && window.App.getRoleDisplayName) {
        userTypeElement.textContent = window.App.getRoleDisplayName(currentUserType) || '';
        console.log('âœ… ä¸»ç®¡é¡å‹:', userTypeElement.textContent);
    }
}


/**
 * åˆå§‹åŒ–ä¸»ç®¡å·¥æ™‚ç•Œé¢
 */
async function initializeSupervisorWorkHoursInterface() {
    console.log('ğŸ”„ åˆå§‹åŒ–ä¸»ç®¡å·¥æ™‚ç•Œé¢');
    
    // ä½¿ç”¨æ–°çš„å·¥æ™‚ç®¡ç†åŠŸèƒ½
    if (window.WorkHoursFunctions && window.WorkHoursFunctions.initializeWorkHoursInterface) {
        await window.WorkHoursFunctions.initializeWorkHoursInterface('supervisorWorkHours');
    } else {
        console.error('âŒ WorkHoursFunctions æœªå®šç¾©');
    }
}

/**
 * å¡«å……åœ°é»é¸æ“‡å™¨
 */
async function populateLocationSelect() {
    try {
        const locationSelect = document.getElementById('supervisorWorkLocation');
        if (!locationSelect) return;
        
        const locations = window.App ? await window.App.fetchLocations() : [];
        
        // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™"å…¨éƒ¨åœ°é»"ï¼‰
        locationSelect.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>';
        
        // æ·»åŠ åœ°é»é¸é …
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.location || location;
            option.textContent = location.location || location;
            locationSelect.appendChild(option);
        });
        
        console.log('âœ… åœ°é»é¸æ“‡å™¨å¡«å……å®Œæˆï¼Œå…±', locations.length, 'å€‹åœ°é»');
    } catch (error) {
        console.error('âŒ å¡«å……åœ°é»é¸æ“‡å™¨å¤±æ•—:', error);
    }
}

/**
 * å¡«å……ä¿±æ¨‚éƒ¨é¸æ“‡å™¨
 */
async function populateClubSelect() {
    try {
        const clubSelect = document.getElementById('supervisorWorkClub');
        if (!clubSelect) return;
        
        const clubs = window.App ? window.App.getClubs() : [];
        
        // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™"å…¨éƒ¨ä¿±æ¨‚éƒ¨"ï¼‰
        clubSelect.innerHTML = '<option value="">å…¨éƒ¨ä¿±æ¨‚éƒ¨</option>';
        
        // æ·»åŠ ä¿±æ¨‚éƒ¨é¸é …
        clubs.forEach(club => {
            const option = document.createElement('option');
            option.value = club.club || club;
            option.textContent = club.club || club;
            clubSelect.appendChild(option);
        });
        
        console.log('âœ… ä¿±æ¨‚éƒ¨é¸æ“‡å™¨å¡«å……å®Œæˆï¼Œå…±', clubs.length, 'å€‹ä¿±æ¨‚éƒ¨');
    } catch (error) {
        console.error('âŒ å¡«å……ä¿±æ¨‚éƒ¨é¸æ“‡å™¨å¤±æ•—:', error);
    }
}

/**
 * å¡«å……æ•™ç·´å’Œç®¡ç†å“¡é¸æ“‡å™¨çš„å…¬å…±é‚è¼¯
 */
async function populateCoachSelectCommon(targetElementId, options = {}) {
    const {
        includeAllOption = false,
        allOptionText = 'å…¨éƒ¨å“¡å·¥',
        checkConnection = false,
        logPrefix = 'å“¡å·¥é¸æ“‡å™¨'
    } = options;
    
    try {
        const selectElement = document.getElementById(targetElementId);
        if (!selectElement) {
            console.warn(`âš ï¸ æ‰¾ä¸åˆ° ${targetElementId} å…ƒç´ `);
            return;
        }
        
        // æª¢æŸ¥æ•¸æ“šåº«é€£æ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (checkConnection) {
            const connectionStatus = window.App ? window.App.checkDatabaseConnection() : { connected: false };
            if (!connectionStatus.connected) {
                // âœ… å˜—è©¦é‡æ–°æª¢æŸ¥é€£æ¥ï¼Œä½†ä¸é˜»æ­¢ç¹¼çºŒåŸ·è¡Œï¼ˆå› ç‚ºå¯èƒ½æ˜¯åˆå§‹åŒ–æ™‚é€£æ¥ç‹€æ…‹æœªæ›´æ–°ï¼‰
                console.log('ğŸ”„ DatabaseConnector é€£æ¥ç‹€æ…‹æœªç¢ºèªï¼Œå˜—è©¦é‡æ–°æª¢æŸ¥é€£æ¥...');
                const reconnected = await window.App.reconnectDatabase();
                
                if (!reconnected) {
                    // âœ… å³ä½¿é€£æ¥æª¢æŸ¥å¤±æ•—ï¼Œä¹Ÿç¹¼çºŒåŸ·è¡Œï¼ˆå› ç‚ºå¯¦éš›APIèª¿ç”¨å¯èƒ½æœƒæˆåŠŸï¼‰
                    console.warn('âš ï¸ DatabaseConnector é€£æ¥æª¢æŸ¥å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œï¼ˆå¯¦éš›APIèª¿ç”¨å¯èƒ½æœƒæˆåŠŸï¼‰');
                    // ä¸è¿”å›ï¼Œè®“å‡½æ•¸ç¹¼çºŒåŸ·è¡Œ
                } else {
                    console.log('âœ… DatabaseConnector é€£æ¥å·²ç¢ºèª');
                }
            }
        }
        
        console.log(`ğŸ”„ é–‹å§‹è¼‰å…¥${logPrefix}...`);
        
        // ç²å–ç•¶å‰ç”¨æˆ¶ä¿¡æ¯
        const currentUser = window.App ? window.App.getCurrentUser() : null;
        const currentUserType = window.App ? window.App.getCurrentUserType() : '';
        
        // ç²å–æ•™ç·´å’Œç®¡ç†å“¡åˆ—è¡¨
        const coaches = window.App ? await window.App.fetchCoaches() : [];
        const allAdmins = window.App ? await window.App.fetchAdmins() : [];
        
        // âœ… éæ¿¾å‡ºç®¡ç†å“¡ï¼ˆtype='admin'ï¼‰ï¼Œæ’é™¤ä¸»ç®¡ï¼ˆtype='supervisor'ï¼‰å’Œå…¶ä»–é¡å‹
        const admins = allAdmins.filter(emp => {
            const empType = emp.type || emp.userType || '';
            return empType === 'admin';
        });
        
        // æ¸…ç©ºç¾æœ‰é¸é …
        selectElement.innerHTML = '';
        
        // æ·»åŠ "å…¨éƒ¨å“¡å·¥"é¸é …ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (includeAllOption) {
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = allOptionText;
            selectElement.appendChild(allOption);
        }
        
        // âœ… ä¸»ç®¡/ç®¡ç†å“¡é é¢ï¼ˆæ›´è¡¨ï¼‰ï¼šè‡ªå·± + æ‰€æœ‰ç®¡ç†å“¡ + æ‰€æœ‰æ•™ç·´ï¼ˆä¸åŒ…æ‹¬å…¶ä»–ä¸»ç®¡å’Œç®¡ç†å“¡ï¼‰
        const isSupervisorOrManager = currentUserType === 'supervisor' || currentUserType === 'manager';
        if (isSupervisorOrManager && currentUser) {
            // å…ˆæ·»åŠ è‡ªå·±ï¼ˆä¸»ç®¡æˆ–ç®¡ç†å“¡ï¼‰
            const selfOption = document.createElement('option');
            selfOption.value = currentUser.phone;
            const roleLabel = currentUserType === 'supervisor' ? 'ä¸»ç®¡' : 'ç®¡ç†å“¡';
            selfOption.textContent = `${currentUser.name} (${roleLabel}) - è‡ªå·±`;
            selectElement.appendChild(selfOption);
        }
        
        // æ·»åŠ æ•™ç·´é¸é …
        coaches.forEach(coach => {
            const option = document.createElement('option');
            option.value = coach.phone;
            option.textContent = `${coach.name} (${coach.phone})`;
            selectElement.appendChild(option);
        });
        
        // æ·»åŠ ç®¡ç†å“¡é¸é …ï¼ˆä¸»ç®¡/ç®¡ç†å“¡é é¢æ‰é¡¯ç¤ºï¼Œä¸”å·²éæ¿¾æ‰ä¸»ç®¡å’Œç®¡ç†å“¡ï¼‰
        if (isSupervisorOrManager) {
            admins.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.phone;
                option.textContent = `${admin.name} (${admin.phone})`;
                selectElement.appendChild(option);
            });
        }
        
        const totalCount = (isSupervisorOrManager && currentUser ? 1 : 0) + coaches.length + (isSupervisorOrManager ? admins.length : 0);
        const roleLabel = isSupervisorOrManager ? (currentUserType === 'supervisor' ? 'ä¸»ç®¡' : 'ç®¡ç†å“¡') : '';
        console.log(`âœ… ${logPrefix}å¡«å……å®Œæˆï¼Œå…± ${totalCount} å€‹å“¡å·¥ï¼ˆ${roleLabel}è‡ªå·±: ${isSupervisorOrManager && currentUser ? 1 : 0}, æ•™ç·´: ${coaches.length}, ç®¡ç†å“¡: ${isSupervisorOrManager ? admins.length : 0}ï¼‰`);
        
    } catch (error) {
        console.error(`âŒ å¡«å……${logPrefix}å¤±æ•—:`, error);
    }
}

/**
 * æ˜¾ç¤ºä¸»ç®¡å·¥æ™‚ç®¡ç†ç•Œé¢
 */
function showSupervisorWorkHours() {
    // âœ… å…ˆç²å–è¦é¡¯ç¤ºçš„å…ƒç´ ï¼Œé¿å…åœ¨ hideAllFeatures å¾Œæ‰¾ä¸åˆ°
    const supervisorWorkHoursSection = document.getElementById('supervisorWorkHoursSection');
    const supervisorSection = document.getElementById('supervisorSection');
    
    // âœ… éš±è—æ‰€æœ‰ç•Œé¢ï¼Œä½†æ’é™¤ä¸»ç®¡å·¥æ™‚ç®¡ç†ç•Œé¢
    if (window.App && window.App.hideAllFeatures) {
        window.App.hideAllFeatures('supervisorWorkHoursSection');
    }
    
    // âœ… ç¢ºä¿ä¸»ç®¡sectionæ˜¯æ´»å‹•çš„
    if (supervisorSection && !supervisorSection.classList.contains('active')) {
        supervisorSection.classList.add('active');
        supervisorSection.style.setProperty('display', 'block', 'important');
        console.log('âœ… å·²æ¿€æ´»ä¸»ç®¡section');
    }
    
    // âœ… éš±è—ä¸»èœå–®ï¼ˆfeature-gridï¼‰
    const featureGrid = supervisorSection?.querySelector('.feature-grid');
    if (featureGrid) {
        featureGrid.style.display = 'none';
    }
    
    if (supervisorWorkHoursSection) {
        supervisorWorkHoursSection.classList.remove('hidden');
        // âœ… ä½¿ç”¨ setProperty èˆ‡ 'important' ä¾†è¦†è“‹ CSS çš„ !important è¦å‰‡
        supervisorWorkHoursSection.style.setProperty('display', 'block', 'important');
        supervisorWorkHoursSection.style.setProperty('visibility', 'visible', 'important');
        supervisorWorkHoursSection.classList.add('active');
        
        // âœ… ä½¿ç”¨ setTimeout ç¢ºä¿ DOM æ›´æ–°å¾Œå†åˆå§‹åŒ–
        setTimeout(() => {
            console.log('â° æ˜¾ç¤ºä¸»ç®¡å·¥æ™‚ç®¡ç†ç•Œé¢', {
                hasHiddenClass: supervisorWorkHoursSection.classList.contains('hidden'),
                display: window.getComputedStyle(supervisorWorkHoursSection).display,
                visibility: window.getComputedStyle(supervisorWorkHoursSection).visibility
            });
            
            // åˆå§‹åŒ–å·¥æ™‚ç®¡ç†ç•Œé¢
            if (window.WorkHoursFunctions && window.WorkHoursFunctions.initializeWorkHoursInterface) {
                window.WorkHoursFunctions.initializeWorkHoursInterface('supervisorWorkHours');
            }
        }, 50);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡å·¥æ™‚ç®¡ç†ç•Œé¢å…ƒç´ ');
    }
}

/**
 * æ˜¾ç¤ºä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢
 */
function showSupervisorAttendance() {
    // âœ… å…ˆç²å–è¦é¡¯ç¤ºçš„å…ƒç´ ï¼Œé¿å…åœ¨ hideAllFeatures å¾Œæ‰¾ä¸åˆ°
    const supervisorAttendanceSection = document.getElementById('supervisorAttendanceSection');
    const supervisorSection = document.getElementById('supervisorSection');
    
    if (!supervisorAttendanceSection) {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢å…ƒç´ ');
        return;
    }
    
    if (!supervisorSection) {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡sectionå…ƒç´ ');
        return;
    }
    
    // âœ… éš±è—æ‰€æœ‰ç•Œé¢ï¼Œä½†æ’é™¤ä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢
    if (window.App && window.App.hideAllFeatures) {
        window.App.hideAllFeatures('supervisorAttendanceSection');
    }
    
    // âœ… ç¢ºä¿ä¸»ç®¡sectionæ˜¯æ´»å‹•çš„
    if (!supervisorSection.classList.contains('active')) {
        supervisorSection.classList.add('active');
        supervisorSection.style.setProperty('display', 'block', 'important');
    }
    
    // âœ… éš±è—ä¸»èœå–®ï¼ˆfeature-gridï¼‰
    const featureGrid = supervisorSection?.querySelector('.feature-grid');
    if (featureGrid) {
        featureGrid.style.display = 'none';
    }
    
    // âœ… é¡¯ç¤ºä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢
        supervisorAttendanceSection.classList.remove('hidden');
    supervisorAttendanceSection.classList.add('active');
        supervisorAttendanceSection.style.setProperty('display', 'block', 'important');
        supervisorAttendanceSection.style.setProperty('visibility', 'visible', 'important');
        
            console.log('ğŸ“Š æ˜¾ç¤ºä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢');
    
    // âœ… åˆå§‹åŒ–ä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢
    initializeSupervisorAttendanceInterface();
}

/**
 * âœ… åˆå§‹åŒ–ä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢
 */
function initializeSupervisorAttendanceInterface() {
    console.log('ğŸ”„ åˆå§‹åŒ–ä¸»ç®¡å‡ºå¸­ç®¡ç†ç•Œé¢');
    
    // âœ… è¨­ç½®é»˜èªæ—¥æœŸç‚ºä»Šå¤©
    const dateInput = document.getElementById('supervisorAttendanceDate');
    if (dateInput) {
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        dateInput.value = dateString;
    }
    
    // âœ… å¡«å……åœ°é»é¸æ“‡å™¨ï¼ˆå¾ Class_location é›†åˆç²å–ï¼‰
    const locationSelect = document.getElementById('supervisorAttendanceLocation');
    if (locationSelect) {
        // âœ… å¾ Class_location é›†åˆç²å–åœ°é»
        if (window.App && typeof window.App.fetchClassLocations === 'function') {
            window.App.fetchClassLocations().then(locations => {
                if (locations && locations.length > 0) {
                    locationSelect.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>';
                    locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location;
                        option.textContent = location;
                        locationSelect.appendChild(option);
                    });
                    console.log(`âœ… å·²ç‚ºä¸»ç®¡å‡ºå¸­ç®¡ç†åŠ è¼‰ ${locations.length} å€‹åœ°é»ï¼ˆä¾†è‡ª Class_location é›†åˆï¼‰`);
    } else {
                    // å¦‚æœç²å–å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ
                    loadLocationsForSupervisorAttendance();
                }
            }).catch(error => {
                console.error('âŒ ç²å– Class_location åœ°é»å¤±æ•—:', error);
                loadLocationsForSupervisorAttendance();
            });
        } else {
            // å¦‚æœ API ä¸å¯ç”¨ï¼Œå˜—è©¦å¾èˆŠçš„ API ç²å–
            loadLocationsForSupervisorAttendance();
        }
    }
    
    // âœ… ç¶å®šåˆ·æ–°æŒ‰éˆ•äº‹ä»¶
    const refreshBtn = document.getElementById('refreshSupervisorAttendance');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            refreshSupervisorAttendanceBoard();
        });
    }
    
    // âœ… ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
    const deleteBtn = document.getElementById('deleteSupervisorAttendance');
    const confirmDeleteBtn = document.getElementById('confirmDeleteSupervisorAttendance');
    const cancelDeleteBtn = document.getElementById('cancelDeleteSupervisorAttendance');
    
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            window.enableDeleteMode('supervisorAttendanceTable');
            deleteBtn.style.display = 'none';
            if (confirmDeleteBtn) confirmDeleteBtn.style.display = 'inline-block';
            if (cancelDeleteBtn) cancelDeleteBtn.style.display = 'inline-block';
        });
    }
    
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async () => {
            await window.confirmDeleteRecords('supervisorAttendanceTable');
            confirmDeleteBtn.style.display = 'none';
            if (cancelDeleteBtn) cancelDeleteBtn.style.display = 'none';
            if (deleteBtn) deleteBtn.style.display = 'inline-block';
        });
    }
    
    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', () => {
            window.disableDeleteMode('supervisorAttendanceTable');
            cancelDeleteBtn.style.display = 'none';
            if (confirmDeleteBtn) confirmDeleteBtn.style.display = 'none';
            if (deleteBtn) deleteBtn.style.display = 'inline-block';
        });
    }
    
    // âœ… ç¶å®šæ—¥æœŸå’Œåœ°é»è®Šæ›´äº‹ä»¶
    if (dateInput) {
        dateInput.addEventListener('change', () => {
            refreshSupervisorAttendanceBoard();
        });
    }
    
    if (locationSelect) {
        locationSelect.addEventListener('change', () => {
            refreshSupervisorAttendanceBoard();
        });
    }
    
    // âœ… åˆå§‹åŒ–å‡ºå¸­æ¿
    refreshSupervisorAttendanceBoard();
}

/**
 * âœ… ç‚ºä¸»ç®¡å‡ºå¸­ç®¡ç†åŠ è¼‰åœ°é»æ•¸æ“šï¼ˆå¾ Class_location é›†åˆï¼‰
 */
async function loadLocationsForSupervisorAttendance() {
    try {
        const db = window.App?.getDatabaseConnector();
        if (!db) {
            console.warn('âš ï¸ DatabaseConnector æœªåˆå§‹åŒ–ï¼Œç„¡æ³•åŠ è¼‰åœ°é»');
            return;
        }

        // âœ… å¾ Class_location é›†åˆç²å–åœ°é»
        const response = await fetch(`${db.baseUrl}/class-locations`, {
            headers: db.getStandardHeaders()
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        const locations = result.locations || [];

        const locationSelect = document.getElementById('supervisorAttendanceLocation');
        if (locationSelect && locations.length > 0) {
            locationSelect.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>';
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
            console.log(`âœ… å·²ç‚ºä¸»ç®¡å‡ºå¸­ç®¡ç†åŠ è¼‰ ${locations.length} å€‹åœ°é»ï¼ˆä¾†è‡ª Class_location é›†åˆï¼‰`);
        }
    } catch (error) {
        console.error('âŒ åŠ è¼‰ Class_location åœ°é»æ•¸æ“šå¤±æ•—:', error);
    }
}

/**
 * âœ… åˆ·æ–°ä¸»ç®¡å‡ºå¸­æ¿æ•¸æ“š
 */
function refreshSupervisorAttendanceBoard() {
    const dateInput = document.getElementById('supervisorAttendanceDate');
    const locationSelect = document.getElementById('supervisorAttendanceLocation');
    const container = document.getElementById('supervisorAttendanceTable');
    
    if (!container) {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡å‡ºå¸­æ¿å®¹å™¨');
        return;
    }
    
    const classDate = dateInput?.value || null;
    const location = locationSelect?.value || null;
    
    console.log('ğŸ”„ åˆ·æ–°ä¸»ç®¡å‡ºå¸­æ¿', { classDate, location });
    
    // èª¿ç”¨å‡ºå¸­æ¿åˆå§‹åŒ–å‡½æ•¸
    if (typeof window.initAttendanceBoard === 'function') {
        window.initAttendanceBoard('supervisorAttendanceTable', { classDate, location });
    } else {
        console.error('âŒ initAttendanceBoard å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ attendance-board.js å·²åŠ è¼‰');
        container.innerHTML = '<div class="text-red-500 p-4">å‡ºå¸­æ¿æ¨¡å¡ŠæœªåŠ è¼‰</div>';
    }
}

/**
 * æ˜¾ç¤ºä¸»ç®¡å ±è¡¨ç®¡ç†ç•Œé¢
 */
function showSupervisorReports() {
    // âœ… å…ˆç²å–è¦é¡¯ç¤ºçš„å…ƒç´ ï¼Œé¿å…åœ¨ hideAllFeatures å¾Œæ‰¾ä¸åˆ°
    const supervisorReportsSection = document.getElementById('supervisorReportsSection');
    const supervisorSection = document.getElementById('supervisorSection');
    
    // âœ… éš±è—æ‰€æœ‰ç•Œé¢ï¼Œä½†æ’é™¤ä¸»ç®¡å ±è¡¨ç®¡ç†ç•Œé¢
    if (window.App && window.App.hideAllFeatures) {
        window.App.hideAllFeatures('supervisorReportsSection');
    }
    
    // âœ… ç¢ºä¿ä¸»ç®¡sectionæ˜¯æ´»å‹•çš„
    if (supervisorSection && !supervisorSection.classList.contains('active')) {
        supervisorSection.classList.add('active');
        supervisorSection.style.setProperty('display', 'block', 'important');
    }
    
    // âœ… éš±è—ä¸»èœå–®ï¼ˆfeature-gridï¼‰
    const featureGrid = supervisorSection?.querySelector('.feature-grid');
    if (featureGrid) {
        featureGrid.style.display = 'none';
    }
    
    if (supervisorReportsSection) {
        supervisorReportsSection.classList.remove('hidden');
        // âœ… ä½¿ç”¨ setProperty èˆ‡ 'important' ä¾†è¦†è“‹ CSS çš„ !important è¦å‰‡
        supervisorReportsSection.style.setProperty('display', 'block', 'important');
        supervisorReportsSection.style.setProperty('visibility', 'visible', 'important');
        supervisorReportsSection.classList.add('active');
        
        setTimeout(() => {
            console.log('ğŸ“ˆ æ˜¾ç¤ºä¸»ç®¡å ±è¡¨ç®¡ç†ç•Œé¢');
        }, 50);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡å ±è¡¨ç®¡ç†ç•Œé¢å…ƒç´ ');
    }
}

/**
 * æ˜¾ç¤ºä¸»ç®¡å€‹äººè¨­ç½®ç•Œé¢
 */
function showSupervisorPersonalSettings() {
    // âœ… å…ˆç²å–è¦é¡¯ç¤ºçš„å…ƒç´ ï¼Œé¿å…åœ¨ hideAllFeatures å¾Œæ‰¾ä¸åˆ°
    const settingsInterface = document.getElementById('supervisorPersonalSettingsSection');
    const supervisorSection = document.getElementById('supervisorSection');
    
    // âœ… éš±è—æ‰€æœ‰ç•Œé¢ï¼Œä½†æ’é™¤ä¸»ç®¡å€‹äººè¨­ç½®ç•Œé¢
    if (window.App && window.App.hideAllFeatures) {
        window.App.hideAllFeatures('supervisorPersonalSettingsSection');
    }
    
    // âœ… ç¢ºä¿ä¸»ç®¡sectionæ˜¯æ´»å‹•çš„
    if (supervisorSection && !supervisorSection.classList.contains('active')) {
        supervisorSection.classList.add('active');
        supervisorSection.style.setProperty('display', 'block', 'important');
    }
    
    // âœ… éš±è—ä¸»èœå–®ï¼ˆfeature-gridï¼‰
    const featureGrid = supervisorSection?.querySelector('.feature-grid');
    if (featureGrid) {
        featureGrid.style.display = 'none';
    }
    
    if (settingsInterface) {
        settingsInterface.classList.remove('hidden');
        // âœ… ä½¿ç”¨ setProperty èˆ‡ 'important' ä¾†è¦†è“‹ CSS çš„ !important è¦å‰‡
        settingsInterface.style.setProperty('display', 'block', 'important');
        settingsInterface.style.setProperty('visibility', 'visible', 'important');
        settingsInterface.classList.add('active');
        
        setTimeout(() => {
            console.log('âš™ï¸ ä¸»ç®¡å€‹äººè¨­ç½®ç•Œé¢å·²é¡¯ç¤º');
            
            // åˆå§‹åŒ–å€‹äººè¨­ç½®ç•Œé¢ï¼ˆä½¿ç”¨æ•™ç·´é é¢çš„å…±ç”¨å‡½æ•¸ï¼‰
            if (window.initializePersonalSettings) {
                window.initializePersonalSettings('supervisor');
            } else {
                console.error('âŒ initializePersonalSettings å‡½æ•¸æœªå®šç¾©');
            }
        }, 50);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡å€‹äººè¨­ç½®ç•Œé¢å…ƒç´ ');
    }
}

// ===== ä¸»ç®¡æ•™ç·´æ›´è¡¨ç®¡ç†åŠŸèƒ½ =====

/**
 * é¡¯ç¤ºä¸»ç®¡æ›´è¡¨ç•Œé¢
 */
function showStaffRoster() {
    // âœ… éš±è—æ‰€æœ‰ç•Œé¢ï¼Œä½†æ’é™¤ä¸»ç®¡æ›´è¡¨ç•Œé¢
    if (window.App && window.App.hideAllFeatures) {
        window.App.hideAllFeatures('supervisorRosterSection');
    }
    
    // âœ… ç¢ºä¿ä¸»ç®¡sectionæ˜¯æ´»å‹•çš„
    const supervisorSection = document.getElementById('supervisorSection');
    if (supervisorSection && !supervisorSection.classList.contains('active')) {
        supervisorSection.classList.add('active');
    }
    
    // âœ… éš±è—ä¸»èœå–®ï¼ˆfeature-gridï¼‰
    const featureGrid = supervisorSection?.querySelector('.feature-grid');
    if (featureGrid) {
        featureGrid.style.display = 'none';
    }
    
    // é¡¯ç¤ºä¸»ç®¡æ›´è¡¨ç•Œé¢
    const supervisorRosterSection = document.getElementById('supervisorRosterSection');
    if (supervisorRosterSection) {
        supervisorRosterSection.classList.remove('hidden');
        // âœ… ä½¿ç”¨ setProperty èˆ‡ 'important' ä¾†è¦†è“‹ CSS çš„ !important è¦å‰‡
        supervisorRosterSection.style.setProperty('display', 'block', 'important');
        supervisorRosterSection.style.setProperty('visibility', 'visible', 'important');
        supervisorRosterSection.classList.add('active'); // ğŸ”¥ æ·»åŠ  active é¡
        
        // âœ… å¼·åˆ¶ç¢ºä¿çˆ¶å®¹å™¨ supervisorSection å¯è¦‹
        if (supervisorSection) {
            supervisorSection.classList.add('active');
            supervisorSection.style.setProperty('display', 'block', 'important');
            supervisorSection.style.setProperty('visibility', 'visible', 'important');
        }
        
        // âœ… ä½¿ç”¨ setTimeout ç¢ºä¿ DOM æ›´æ–°å¾Œå†åˆå§‹åŒ–
        setTimeout(() => {
            // âœ… å†æ¬¡ç¢ºä¿æ‰€æœ‰ç›¸é—œå…ƒç´ å¯è¦‹
            if (supervisorSection) {
                supervisorSection.classList.add('active');
                supervisorSection.style.setProperty('display', 'block', 'important');
                supervisorSection.style.setProperty('visibility', 'visible', 'important');
            }
            
            supervisorRosterSection.classList.remove('hidden');
            supervisorRosterSection.style.setProperty('display', 'block', 'important');
            supervisorRosterSection.style.setProperty('visibility', 'visible', 'important');
            supervisorRosterSection.classList.add('active');
            
            console.log('âœ… ä¸»ç®¡æ›´è¡¨ç•Œé¢å·²é¡¯ç¤º', {
                sectionId: supervisorRosterSection.id,
                hasHidden: supervisorRosterSection.classList.contains('hidden'),
                display: window.getComputedStyle(supervisorRosterSection).display,
                visibility: window.getComputedStyle(supervisorRosterSection).visibility,
                parentActive: supervisorSection?.classList.contains('active'),
                parentDisplay: supervisorSection ? window.getComputedStyle(supervisorSection).display : 'N/A',
                parentVisibility: supervisorSection ? window.getComputedStyle(supervisorSection).visibility : 'N/A'
            });
            
            // åˆå§‹åŒ–ä¸»ç®¡æ›´è¡¨ç•Œé¢
            initializeSupervisorRosterInterface();
        }, 100);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸»ç®¡æ›´è¡¨ç•Œé¢å…ƒç´ ');
    }
}

/**
 * åˆå§‹åŒ–ä¸»ç®¡æ›´è¡¨ç•Œé¢
 */
async function initializeSupervisorRosterInterface() {
    try {
        console.log('ğŸ”„ åˆå§‹åŒ–ä¸»ç®¡æ›´è¡¨ç•Œé¢');
        
        // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨
        initializeRosterMonthSelector();
        
        // å¡«å……æ•™ç·´é¸æ“‡å™¨
        await populateCoachSelect();
        
        // åˆå§‹åŒ–æ›´è¡¨çµ±è¨ˆåŠŸèƒ½
        initializeRosterStatistics();
        
        // âœ… å†æ¬¡ç¢ºä¿ä¸»ç®¡æ›´è¡¨ç•Œé¢å¯è¦‹ï¼ˆåœ¨åˆå§‹åŒ–æ•¸æ“šä¹‹å‰ï¼‰
        const supervisorRosterSectionForInit = document.getElementById('supervisorRosterSection');
        if (supervisorRosterSectionForInit) {
            supervisorRosterSectionForInit.classList.remove('hidden');
            supervisorRosterSectionForInit.style.setProperty('display', 'block', 'important');
            supervisorRosterSectionForInit.style.setProperty('visibility', 'visible', 'important');
            console.log('âœ… ç¢ºä¿ä¸»ç®¡æ›´è¡¨ç•Œé¢å¯è¦‹:', {
                hasHiddenClass: supervisorRosterSectionForInit.classList.contains('hidden'),
                display: window.getComputedStyle(supervisorRosterSectionForInit).display,
                visibility: window.getComputedStyle(supervisorRosterSectionForInit).visibility
            });
        }
        
        // âœ… ç¢ºä¿å®¹å™¨å¯è¦‹
        const calendarContainer = document.getElementById('staffRosterCalendars');
        if (calendarContainer) {
            calendarContainer.style.setProperty('display', 'block', 'important');
            calendarContainer.style.setProperty('visibility', 'visible', 'important');
        }
        
        // è‡ªå‹•è¼‰å…¥å…¨éƒ¨æ•™ç·´çš„æ›´è¡¨
        const coachSelect = document.getElementById('staffCoachSelect');
        if (coachSelect && coachSelect.options.length > 0) {
            // é¸æ“‡"å…¨éƒ¨æ•™ç·´"é¸é …ï¼ˆç¬¬ä¸€å€‹é¸é …ï¼‰
            coachSelect.selectedIndex = 0;
            const selectedValue = coachSelect.value;
            if (!selectedValue) {
                console.log('ğŸ”„ è‡ªå‹•è¼‰å…¥å…¨éƒ¨æ•™ç·´çš„æ›´è¡¨');
                await renderAllCoachesRoster();
            } else {
                console.log('ğŸ”„ è‡ªå‹•è¼‰å…¥æŒ‡å®šæ•™ç·´çš„æ›´è¡¨:', selectedValue);
                await renderCoachRoster(selectedValue);
            }
        } else {
            console.warn('âš ï¸ æ•™ç·´é¸æ“‡å™¨æœªæº–å‚™å¥½ï¼Œè·³éè‡ªå‹•è¼‰å…¥');
        }
        
        // âœ… æœ€å¾Œä¸€æ¬¡ç¢ºä¿ç•Œé¢å¯è¦‹ï¼ˆåˆå§‹åŒ–å®Œæˆå¾Œï¼‰
        if (supervisorRosterSectionForInit) {
            supervisorRosterSectionForInit.style.setProperty('display', 'block', 'important');
            supervisorRosterSectionForInit.style.setProperty('visibility', 'visible', 'important');
            supervisorRosterSectionForInit.classList.remove('hidden');
        }
        
        console.log('âœ… ä¸»ç®¡æ›´è¡¨ç•Œé¢åˆå§‹åŒ–å®Œæˆ', {
            sectionDisplay: supervisorRosterSectionForInit ? window.getComputedStyle(supervisorRosterSectionForInit).display : 'N/A',
            containerDisplay: calendarContainer ? window.getComputedStyle(calendarContainer).display : 'N/A'
        });
    } catch (error) {
        console.error('âŒ åˆå§‹åŒ–ä¸»ç®¡æ›´è¡¨ç•Œé¢å¤±æ•—:', error);
    }
}

/**
 * åˆå§‹åŒ–æ›´è¡¨æœˆä»½é¸æ“‡å™¨
 */
function initializeRosterMonthSelector() {
    try {
        console.log('ğŸ”„ é–‹å§‹åˆå§‹åŒ–æ›´è¡¨æœˆä»½é¸æ“‡å™¨');
        
        // æŸ¥æ‰¾ä¸»ç®¡é é¢çš„æœˆä»½é¸æ“‡å™¨ï¼ˆåœ¨ supervisorRosterSection å…§ï¼‰
        const supervisorSection = document.getElementById('supervisorRosterSection');
        let monthSelect = null;
        
        if (supervisorSection) {
            monthSelect = supervisorSection.querySelector('#rosterMonth');
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å…¨å±€æŸ¥æ‰¾
        if (!monthSelect) {
            monthSelect = document.getElementById('rosterMonth');
        }
        
        if (!monthSelect) {
            console.warn('âš ï¸ æ‰¾ä¸åˆ°æ›´è¡¨æœˆä»½é¸æ“‡å™¨ï¼ŒID: rosterMonth');
            console.log('ğŸ” ç•¶å‰é é¢æ‰€æœ‰ select å…ƒç´ :', document.querySelectorAll('select'));
            return;
        }
        console.log('âœ… æ‰¾åˆ°æ›´è¡¨æœˆä»½é¸æ“‡å™¨:', monthSelect);
        
        // ç”Ÿæˆæœˆä»½é¸é …ï¼ˆç•¶å‰æœˆä»½å‰4å€‹æœˆåˆ°å¾Œ6å€‹æœˆï¼‰
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;
        let monthOptions = '';
        
        for (let i = -4; i <= 6; i++) {
            const date = new Date(currentYear, currentMonth - 1 + i, 1);
            const optionYear = date.getFullYear();
            const optionMonth = date.getMonth() + 1;
            const selected = (optionYear === currentYear && optionMonth === currentMonth) ? 'selected' : '';
            monthOptions += `<option value="${optionYear}-${optionMonth.toString().padStart(2, '0')}" ${selected}>${optionYear}å¹´${optionMonth}æœˆ</option>`;
        }
        
        monthSelect.innerHTML = monthOptions;
        console.log('âœ… æ›´è¡¨æœˆä»½é¸æ“‡å™¨åˆå§‹åŒ–å®Œæˆ:', { 
            elementId: monthSelect.id, 
            optionsCount: monthSelect.options.length,
            currentValue: monthSelect.value,
            firstOption: monthSelect.options[0]?.textContent,
            lastOption: monthSelect.options[monthSelect.options.length-1]?.textContent
        });
    } catch (error) {
        console.error('âŒ åˆå§‹åŒ–æ›´è¡¨æœˆä»½é¸æ“‡å™¨å¤±æ•—:', error);
    }
}

/**
 * å¡«å……æ›´è¡¨ç®¡ç†æ•™ç·´é¸æ“‡å™¨
 */
async function populateCoachSelect() {
    return populateCoachSelectCommon('staffCoachSelect', {
        includeAllOption: true,
        allOptionText: 'å…¨éƒ¨å“¡å·¥',
        checkConnection: true,
        logPrefix: 'æ›´è¡¨æ•™ç·´é¸æ“‡å™¨'
    });
}

// è™•ç†æ•™ç·´é¸æ“‡è®ŠåŒ–
function onChangeStaffCoach() {
    const phone = (document.getElementById('staffCoachSelect') || {}).value || '';
    const userType = (localStorage.getItem('current_user_type') || '').toLowerCase();
    
    // âœ… å¦‚æœé¸æ“‡äº†"å…¨éƒ¨å“¡å·¥"ï¼ˆç©ºå€¼ï¼‰ï¼Œé¡¯ç¤ºæ‰€æœ‰å“¡å·¥çš„æ›´è¡¨
    if (!phone) {
        console.log('ğŸ”„ é¸æ“‡äº†"å…¨éƒ¨å“¡å·¥"ï¼Œé¡¯ç¤ºæ‰€æœ‰å“¡å·¥çš„æ›´è¡¨');
        renderAllCoachesRoster();
        return;
    }
    
    // æ¸²æŸ“é¸ä¸­å“¡å·¥çš„æ›´è¡¨
    renderCoachRoster(phone);
}

// ==================== æ‰¹é‡æ“ä½œå…¨å±€è®Šé‡ ====================

let batchWorkSelectedDates = new Set(); // Set<string> å·¥ä½œæ¨¡å¼é€‰ä¸­çš„æ—¥æœŸ
let batchOperationActive = false;

// âœ… å‡æœŸç±»å‹ç›¸å…³å…¨å±€å˜é‡
let currentLeaveType = null; // å½“å‰é€‰æ‹©çš„å‡æœŸç±»å‹
let leaveDatesByType = new Map(); // æŒ‰å‡æœŸç±»å‹å­˜å‚¨é€‰ä¸­çš„æ—¥æœŸ {leaveType: Set<dateString>}
let regularLeaveWeekday = null; // ä¾‹å‡é€‰æ‹©çš„æ˜ŸæœŸï¼ˆ0-6ï¼‰
let regularLeaveDateRange = { start: null, end: null }; // ä¾‹å‡çš„æ—¥æœŸèŒƒå›´

// âœ… æ–°çš„æ‰¹é‡æ“ä½œå…¨å±€å˜é‡
let batchDateRange = { start: null, end: null }; // æ—¥æœŸæ—¶é—´æ®µ
let batchOperationType = null; // æ“ä½œç±»å‹ï¼š'work' æˆ– 'leave' æˆ– 'clear'
let batchCurrentDisplayMonth = null; // å½“å‰æ˜¾ç¤ºçš„æœˆä»½ {year, month}
let batchFillTimeSlots = []; // å¡«å……æ—¶æ®µé…ç½®æ•°ç»„ [{slot1: {time, location}, slot2: {...}, slot3: {...}, weekdays: [0,1,2...], selectedDates: Set<string>}]
let batchSelectedWeekdays = new Set(); // é€‰ä¸­çš„æ˜ŸæœŸï¼ˆå·¥ä½œæ¨¡å¼ï¼‰
let batchLeaveSelectedWeekdays = new Set(); // é€‰ä¸­çš„æ˜ŸæœŸï¼ˆè¯·å‡æ¨¡å¼ï¼‰
let weekdaySelectionByType = new Map(); // è·Ÿè¸ªæ¯ä¸ªæ˜ŸæœŸåˆ—è¢«å“ªä¸ªæ“ä½œç±»å‹é€‰æ‹© {weekday: 'work' | 'leave'}
let currentActiveSlotIndex = 0; // å½“å‰æ´»åŠ¨çš„å¡«å……æ—¶æ®µç´¢å¼•ï¼ˆç”¨äºå•ç‹¬é€‰æ‹©æ—¥æœŸæ—¶çŸ¥é“å±äºå“ªä¸ªæ—¶æ®µï¼‰

// âœ… å‡æœŸç±»å‹é¢œè‰²é…ç½®ï¼ˆæš´éœ²åˆ° window å¯¹è±¡ï¼Œç¡®ä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ä¸€è‡´çš„é¢œè‰²ï¼‰
// âœ… æ ¹æ®å®é™…UIå›¾ç‰‡è°ƒæ•´é¢œè‰²
const LEAVE_TYPE_COLORS = {
    'regular': '#fef3c7',    // ä¾‹å‡ - é»„è‰²ï¼ˆä¸å›¾ç‰‡ä¸€è‡´ï¼‰
    'annual': '#dcfce7',     // å¹´å‡ - ç»¿è‰²ï¼ˆæ ¹æ®å›¾ç‰‡ä¿®æ”¹ï¼šä»è“è‰²æ”¹ä¸ºç»¿è‰²ï¼‰
    'maternity': '#fce7f3',  // äº§å‡ - ç²‰è‰²ï¼ˆä¸å›¾ç‰‡ä¸€è‡´ï¼‰
    'sick': '#fee2e2',      // ç—…å‡ - çº¢è‰²ï¼ˆæ ¹æ®å›¾ç‰‡ä¿®æ”¹ï¼šä»ç»¿è‰²æ”¹ä¸ºçº¢è‰²ï¼‰
    'nopaid': '#787a80',    // No Paid - ç°è‰²ï¼ˆæ ¹æ®å›¾ç‰‡ä¿®æ”¹ï¼šä»çº¢è‰²æ”¹ä¸ºç°è‰²ï¼‰
    'statutory': '#e0e7ff'   // æ³•å®šåŠ³å·¥å‡ - ç´«è‰²ï¼ˆä¸å›¾ç‰‡ä¸€è‡´ï¼‰
};

const LEAVE_TYPE_BORDER_COLORS = {
    'regular': '#fbbf24',    // ä¾‹å‡ - æ·±é»„è‰²è¾¹æ¡†
    'annual': '#22c55e',     // å¹´å‡ - æ·±ç»¿è‰²è¾¹æ¡†ï¼ˆæ ¹æ®å›¾ç‰‡ä¿®æ”¹ï¼‰
    'maternity': '#ec4899',  // äº§å‡ - æ·±ç²‰è‰²è¾¹æ¡†
    'sick': '#ef4444',      // ç—…å‡ - æ·±çº¢è‰²è¾¹æ¡†ï¼ˆæ ¹æ®å›¾ç‰‡ä¿®æ”¹ï¼‰
    'nopaid': '#4b5563',    // No Paid - æ·±ç°è‰²è¾¹æ¡†ï¼ˆæ ¹æ®å›¾ç‰‡ä¿®æ”¹ï¼‰
    'statutory': '#6366f1'   // æ³•å®šåŠ³å·¥å‡ - æ·±ç´«è‰²è¾¹æ¡†
};

// âœ… æš´éœ²åˆ° window å¯¹è±¡ï¼Œä¾›å…¶ä»–æ–‡ä»¶ä½¿ç”¨
if (typeof window !== 'undefined') {
    window.LEAVE_TYPE_COLORS = LEAVE_TYPE_COLORS;
    window.LEAVE_TYPE_BORDER_COLORS = LEAVE_TYPE_BORDER_COLORS;
}

/**
 * æ‰“å¼€æ‰¹é‡æ“ä½œæ¨¡æ€æ¡†ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
 */
function openBatchOperationModal() {
    const modal = document.getElementById('batchOperationModal');
    if (!modal) return;
    
    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å‘˜å·¥
    const coachSelect = document.getElementById('staffCoachSelect');
    const selectedPhone = coachSelect?.value || '';
    
    if (!selectedPhone) {
        alert('è«‹å…ˆé¸æ“‡è¦æ“ä½œçš„å“¡å·¥ï¼æ‰¹é‡æ“ä½œéœ€è¦å…ˆé¸æ“‡ä¸€å€‹å“¡å·¥ã€‚');
        return;
    }
    
    // é‡ç½®çŠ¶æ€
    batchWorkSelectedDates.clear(); // âœ… é‡ç½®å·¥ä½œæ¨¡å¼é€‰ä¸­çš„æ—¥æœŸ
    batchOperationActive = true;
    currentLeaveType = null;
    leaveDatesByType.clear();
    regularLeaveWeekday = null;
    regularLeaveDateRange = { start: null, end: null };
    batchDateRange = { start: null, end: null };
    batchOperationType = null;
    batchCurrentDisplayMonth = null;
    batchFillTimeSlots = [];
    batchSelectedWeekdays.clear();
    batchLeaveSelectedWeekdays.clear();
    weekdaySelectionByType.clear(); // âœ… é‡ç½®æ˜ŸæœŸåˆ—é€‰æ‹©è·Ÿè¸ª
    
    // é‡ç½®UI
    const startInput = document.getElementById('batchDateRangeStart');
    const endInput = document.getElementById('batchDateRangeEnd');
    const hintDiv = document.getElementById('batchDateRangeHint');
    if (startInput) startInput.value = '';
    if (endInput) endInput.value = '';
    
    // âœ… éšè—æ‰€æœ‰æ­¥éª¤
    const calendarSection = document.getElementById('batchCalendarSection');
    const operationTypeSection = document.getElementById('batchOperationTypeSection');
    const leaveTypeSection = document.getElementById('batchLeaveTypeSection');
    const workSettings = document.getElementById('batchWorkSettings');
    const leaveSettings = document.getElementById('batchLeaveSettings');
    const clearSettings = document.getElementById('batchClearSettings');
    
    if (calendarSection) {
        calendarSection.classList.add('hidden');
        calendarSection.style.display = 'none';
    }
    if (operationTypeSection) {
        operationTypeSection.classList.add('hidden');
        operationTypeSection.style.display = 'none';
    }
    if (leaveTypeSection) {
        leaveTypeSection.classList.add('hidden');
        leaveTypeSection.style.display = 'none';
    }
    if (workSettings) {
        workSettings.classList.add('hidden');
        workSettings.style.display = 'none';
    }
    if (leaveSettings) {
        leaveSettings.classList.add('hidden');
        leaveSettings.style.display = 'none';
    }
    if (clearSettings) {
        clearSettings.classList.add('hidden');
        clearSettings.style.display = 'none';
    }
    
    // âœ… æ˜¾ç¤ºæ—¥æœŸèŒƒå›´æç¤º
    if (hintDiv) hintDiv.style.display = 'block';
    
    // é‡ç½®æ“ä½œç±»å‹æŒ‰é’®
    const workBtn = document.getElementById('batchOperationTypeWork');
    const leaveBtn = document.getElementById('batchOperationTypeLeave');
    if (workBtn) {
        workBtn.style.borderColor = '#3b82f6';
        workBtn.style.background = '#fff';
        workBtn.style.color = '#3b82f6';
    }
    if (leaveBtn) {
        leaveBtn.style.borderColor = '#d1d5db';
        leaveBtn.style.background = '#fff';
        leaveBtn.style.color = '#6b7280';
    }
    
    // é‡ç½®å‡æœŸç±»å‹æŒ‰é’®
    document.querySelectorAll('.leave-type-btn').forEach(btn => {
        btn.style.borderColor = '#d1d5db';
        btn.style.background = '#fff';
    });
    
    // é‡ç½®æ˜ŸæœŸé€‰æ‹©æŒ‰é’®
    document.querySelectorAll('.batch-weekday-btn, .batch-leave-weekday-btn').forEach(btn => {
        btn.style.borderColor = '#d1d5db';
        btn.style.background = '#fff';
    });
    
    // âœ… æ¸…ç©ºå¡«å……æ—¶æ®µå®¹å™¨
    const fillContainer = document.getElementById('batchFillTimeSlotsContainer');
    if (fillContainer) {
        fillContainer.innerHTML = '';
    }
    
    // âœ… åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå¡«å……æ—¶æ®µï¼ˆé€šè¿‡è°ƒç”¨ addBatchFillTimeSlot æ¥åˆ›å»ºï¼‰
    batchFillTimeSlots = [];
    currentActiveSlotIndex = 0; // é‡ç½®å½“å‰æ´»åŠ¨æ—¶æ®µç´¢å¼•
    
    // âœ… ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å·²ç»æ¸²æŸ“åå†åˆ›å»ºç¬¬ä¸€ä¸ªå¡«å……æ—¶æ®µ
    setTimeout(() => {
        addBatchFillTimeSlot(); // åˆ›å»ºç¬¬ä¸€ä¸ªå¡«å……æ—¶æ®µ
    }, 100);
    
    // æ›´æ–°æ˜¾ç¤º
    updateBatchSelectionDisplay();
    
    // é‡ç½®ç¡®è®¤æŒ‰é’®
    const executeBtn = document.getElementById('batchExecuteBtn');
    if (executeBtn) executeBtn.disabled = true;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.classList.remove('hidden');
}

/**
 * å…³é—­æ‰¹é‡æ“ä½œæ¨¡æ€æ¡†
 */
function closeBatchOperationModal() {
    const modal = document.getElementById('batchOperationModal');
    if (!modal) return;
    
    batchOperationActive = false;
    batchWorkSelectedDates.clear(); // âœ… é‡ç½®å·¥ä½œæ¨¡å¼é€‰ä¸­çš„æ—¥æœŸ
    currentLeaveType = null;
    leaveDatesByType.clear();
    regularLeaveWeekday = null;
    regularLeaveDateRange = { start: null, end: null };
    weekdaySelectionByType.clear(); // âœ… é‡ç½®æ˜ŸæœŸåˆ—é€‰æ‹©è·Ÿè¸ª
    
    // ç§»é™¤æ—¥å†é€‰æ‹©æ ·å¼
    disableBatchDateSelection();
    
    // éšè—é¢„è§ˆ
    const preview = document.getElementById('batchPreview');
    if (preview) preview.classList.add('hidden');
    
    // âœ… é‡ç½®ç¡®è®¤æŒ‰é’®ï¼ˆä¼šæ ¹æ®æ—¥æœŸé€‰æ‹©çŠ¶æ€è‡ªåŠ¨æ›´æ–°ï¼‰
    const executeBtn = document.getElementById('batchExecuteBtn');
    if (executeBtn) executeBtn.disabled = true;
    
    // âœ… é‡ç½®å‡æœŸç±»å‹æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.leave-type-btn').forEach(btn => {
        btn.style.borderColor = '#d1d5db';
        btn.style.background = '#fff';
    });
    
    // âœ… éšè—æ‰€æœ‰å‡æœŸè®¾ç½®
    document.querySelectorAll('.leave-type-settings').forEach(el => {
        el.classList.add('hidden');
    });
    
    modal.classList.add('hidden');
}

/**
 * å¤„ç†æ¨¡æ€æ¡†ç‚¹å‡»äº‹ä»¶ï¼ˆç‚¹å‡»å¤–éƒ¨å…³é—­ï¼‰
 */
function handleBatchModalClick(event) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æ¨¡æ€æ¡†èƒŒæ™¯ï¼ˆä¸æ˜¯å†…å®¹åŒºåŸŸï¼‰ï¼Œåˆ™å…³é—­
    if (event.target.id === 'batchOperationModal') {
        closeBatchOperationModal();
    }
}

/**
 * å¤„ç†æ“ä½œæ¨¡å¼åˆ‡æ¢
 */
function handleBatchModeChange() {
    const mode = document.querySelector('input[name="batchMode"]:checked')?.value;
    
    // éšè—æ‰€æœ‰æ¨¡å¼å†…å®¹
    document.querySelectorAll('.batch-mode-content').forEach(el => {
        el.classList.add('hidden');
    });
    
    // æ˜¾ç¤ºå¯¹åº”æ¨¡å¼å†…å®¹
    if (mode === 'fill') {
        document.getElementById('batchFillSettings')?.classList.remove('hidden');
    } else if (mode === 'leave') {
        document.getElementById('batchLeaveSettings')?.classList.remove('hidden');
    } else if (mode === 'clear') {
        document.getElementById('batchClearSettings')?.classList.remove('hidden');
    }
    
    // é‡ç½®é¢„è§ˆ
    const preview = document.getElementById('batchPreview');
    if (preview) preview.classList.add('hidden');
    const executeBtn = document.getElementById('batchExecuteBtn');
    if (executeBtn) executeBtn.disabled = true;
}

/**
 * ç”Ÿæˆæ‰¹é‡æ“ä½œä¸“ç”¨æ—¥å†
 */
// âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šgenerateBatchOperationCalendar å’Œ renderBatchCalendar
// ç°åœ¨ä½¿ç”¨ generateBatchOperationCalendarForDateRange å’Œ renderBatchCalendarForDateRange

/**
 * ä»æ‰¹é‡æ“ä½œæ—¥å†åˆ‡æ¢æ—¥æœŸé€‰æ‹© - æ”¯æŒå‡æœŸç±»å‹
 */
function toggleBatchDateSelectionFromCalendar(day, element) {
    // âœ… è·å–æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆä»å…ƒç´ çš„ data-date å±æ€§æˆ–å½“å‰æœˆä»½ï¼‰
    let dateStr = element?.getAttribute('data-date');
    if (!dateStr) {
        // å¦‚æœæ²¡æœ‰ data-date å±æ€§ï¼Œä»å½“å‰æ˜¾ç¤ºçš„æœˆä»½æ„å»º
        if (batchCurrentDisplayMonth) {
            const year = batchCurrentDisplayMonth.year;
            const month = batchCurrentDisplayMonth.month;
            dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        } else {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
    }
    
    // âœ… æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦å·²è¢«å…¶ä»–ç±»å‹é€‰æ‹©
    const isWorkSelected = batchWorkSelectedDates.has(dateStr);
    let isLeaveSelected = false;
    let occupiedByLeaveType = null;
    
    // æ£€æŸ¥æ‰€æœ‰è¯·å‡ç±»å‹çš„é€‰ä¸­çŠ¶æ€
    for (let [leaveType, dates] of leaveDatesByType) {
        if (dates.has(dateStr)) {
            isLeaveSelected = true;
            occupiedByLeaveType = leaveType;
            break;
        }
    }
    
    // âœ… æ ¹æ®æ“ä½œç±»å‹å¤„ç†æ—¥æœŸé€‰æ‹©ï¼ˆç»Ÿä¸€é€»è¾‘ï¼šå…ˆå–æ¶ˆå…¶ä»–ç±»å‹ï¼Œå†åˆ‡æ¢å½“å‰ç±»å‹ï¼‰
    if (batchOperationType === 'work') {
        // âœ… å·¥ä½œæ¨¡å¼ï¼šä½¿ç”¨å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µçš„ selectedDates
        // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦è¢«ä»»ä½•å¡«å……æ—¶æ®µé€‰ä¸­
        let selectedBySlotIndex = null;
        for (let i = 0; i < batchFillTimeSlots.length; i++) {
            if (batchFillTimeSlots[i].selectedDates && batchFillTimeSlots[i].selectedDates.has(dateStr)) {
                selectedBySlotIndex = i;
                break;
            }
        }
        
        // âœ… ç¡®ä¿å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µæœ‰ selectedDates å­—æ®µ
        if (batchFillTimeSlots.length > 0 && currentActiveSlotIndex < batchFillTimeSlots.length) {
            const activeSlot = batchFillTimeSlots[currentActiveSlotIndex];
            if (!activeSlot.selectedDates) {
                activeSlot.selectedDates = new Set();
            }
            
            if (selectedBySlotIndex === currentActiveSlotIndex) {
                // å½“å‰æ´»åŠ¨æ—¶æ®µå·²é€‰ä¸­ï¼šå–æ¶ˆé€‰æ‹©
                activeSlot.selectedDates.delete(dateStr);
                // åŒæ—¶ä»å…¨å±€ batchWorkSelectedDates ä¸­ç§»é™¤ï¼ˆå¦‚æœä¸å†è¢«ä»»ä½•æ—¶æ®µé€‰ä¸­ï¼‰
                let stillSelected = false;
                for (let i = 0; i < batchFillTimeSlots.length; i++) {
                    if (i !== currentActiveSlotIndex && batchFillTimeSlots[i].selectedDates && 
                        batchFillTimeSlots[i].selectedDates.has(dateStr)) {
                        stillSelected = true;
                        break;
                    }
                }
                // æ£€æŸ¥æ˜¯å¦è¢«ä»»ä½•æ—¶æ®µçš„æ˜ŸæœŸé€‰æ‹©é€‰ä¸­
                for (let i = 0; i < batchFillTimeSlots.length; i++) {
                    if (batchFillTimeSlots[i].weekdays && batchFillTimeSlots[i].weekdays.length > 0) {
                        const dateObj = new Date(dateStr);
                        const weekday = dateObj.getDay();
                        if (batchFillTimeSlots[i].weekdays.includes(weekday)) {
                            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨èŒƒå›´å†…
                            if (batchDateRange.start && batchDateRange.end) {
                                const start = new Date(batchDateRange.start);
                                const end = new Date(batchDateRange.end);
                                if (dateObj >= start && dateObj <= end) {
                                    stillSelected = true;
                                    break;
                                }
                            }
                        }
                    }
                }
                if (!stillSelected) {
                    batchWorkSelectedDates.delete(dateStr);
                }
            } else {
                // å½“å‰æ´»åŠ¨æ—¶æ®µæœªé€‰ä¸­ï¼š
                // âœ… å¦‚æœè¢«å…¶ä»–ç±»å‹å ç”¨ï¼Œå…ˆå–æ¶ˆå…¶ä»–ç±»å‹
                if (isLeaveSelected && occupiedByLeaveType) {
                    // å–æ¶ˆè¯·å‡ç±»å‹çš„å ç”¨
                    if (leaveDatesByType.has(occupiedByLeaveType)) {
                        leaveDatesByType.get(occupiedByLeaveType).delete(dateStr);
                        if (leaveDatesByType.get(occupiedByLeaveType).size === 0) {
                            leaveDatesByType.delete(occupiedByLeaveType);
                        }
                    }
                }
                // âœ… å¦‚æœè¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œå…ˆå–æ¶ˆå…¶ä»–æ—¶æ®µçš„é€‰ä¸­
                if (selectedBySlotIndex !== null && selectedBySlotIndex !== currentActiveSlotIndex) {
                    batchFillTimeSlots[selectedBySlotIndex].selectedDates.delete(dateStr);
                    // æ£€æŸ¥æ˜¯å¦è¿˜éœ€è¦ä¿ç•™åœ¨ batchWorkSelectedDates ä¸­
                    let stillSelected = false;
                    for (let i = 0; i < batchFillTimeSlots.length; i++) {
                        if (i !== selectedBySlotIndex && batchFillTimeSlots[i].selectedDates && 
                            batchFillTimeSlots[i].selectedDates.has(dateStr)) {
                            stillSelected = true;
                            break;
                        }
                    }
                    // æ£€æŸ¥æ˜¯å¦è¢«ä»»ä½•æ—¶æ®µçš„æ˜ŸæœŸé€‰æ‹©é€‰ä¸­
                    for (let i = 0; i < batchFillTimeSlots.length; i++) {
                        if (batchFillTimeSlots[i].weekdays && batchFillTimeSlots[i].weekdays.length > 0) {
                            const dateObj = new Date(dateStr);
                            const weekday = dateObj.getDay();
                            if (batchFillTimeSlots[i].weekdays.includes(weekday)) {
                                if (batchDateRange.start && batchDateRange.end) {
                                    const start = new Date(batchDateRange.start);
                                    const end = new Date(batchDateRange.end);
                                    if (dateObj >= start && dateObj <= end) {
                                        stillSelected = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    if (!stillSelected) {
                        batchWorkSelectedDates.delete(dateStr);
                    }
                }
                // è®¾ç½®ä¸ºå½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µ
                activeSlot.selectedDates.add(dateStr);
                batchWorkSelectedDates.add(dateStr);
            }
        }
        
        // âœ… æ›´æ–°æ—¥å†æ˜¾ç¤º
        generateBatchOperationCalendarForDateRange();
        updateBatchSelectionDisplay();
        updateBatchExecuteButtonState();
    } else if (batchOperationType === 'leave' && currentLeaveType) {
        // è¯·å‡æ¨¡å¼ï¼šä½¿ç”¨ leaveDatesByType
        if (!leaveDatesByType.has(currentLeaveType)) {
            leaveDatesByType.set(currentLeaveType, new Set());
        }
        
        const dates = leaveDatesByType.get(currentLeaveType);
        
        if (dates.has(dateStr)) {
            // å½“å‰ç±»å‹å·²é€‰ä¸­ï¼šå–æ¶ˆé€‰æ‹©
            dates.delete(dateStr);
            if (dates.size === 0) {
                leaveDatesByType.delete(currentLeaveType);
            }
        } else {
            // å½“å‰ç±»å‹æœªé€‰ä¸­ï¼š
            // âœ… å¦‚æœè¢«å…¶ä»–ç±»å‹å ç”¨ï¼Œå…ˆå–æ¶ˆå…¶ä»–ç±»å‹
            if (isWorkSelected) {
                // å–æ¶ˆå·¥ä½œæ¨¡å¼çš„å ç”¨
                batchWorkSelectedDates.delete(dateStr);
            }
            if (isLeaveSelected && occupiedByLeaveType && occupiedByLeaveType !== currentLeaveType) {
                // å–æ¶ˆå…¶ä»–è¯·å‡ç±»å‹çš„å ç”¨
                if (leaveDatesByType.has(occupiedByLeaveType)) {
                    leaveDatesByType.get(occupiedByLeaveType).delete(dateStr);
                    if (leaveDatesByType.get(occupiedByLeaveType).size === 0) {
                        leaveDatesByType.delete(occupiedByLeaveType);
                    }
                }
            }
            // è®¾ç½®ä¸ºå½“å‰è¯·å‡ç±»å‹
            dates.add(dateStr);
        }
        
        // âœ… æ›´æ–°æ—¥å†æ˜¾ç¤º
        generateBatchOperationCalendarForDateRange();
        updateBatchCalendarLeaveHighlight();
        
        // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
        updateBatchSelectionDisplay();
        updateBatchExecuteButtonState();
    }
}

/**
 * å¯ç”¨æ—¥å†æ—¥æœŸé€‰æ‹©ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œç”¨äºä¸»æ—¥å†ï¼‰
 */
function enableBatchDateSelection() {
    const calendar = document.getElementById('staffRosterCalendars');
    if (!calendar) return;
    
    const cells = calendar.querySelectorAll('.cal-cell');
    cells.forEach(cell => {
        const dayElement = cell.querySelector('.cal-day');
        if (!dayElement) return;
        
        const day = parseInt(dayElement.textContent);
        if (!day || isNaN(day)) return;
        
        // æ·»åŠ å¯é€‰æ‹©æ ·å¼
        cell.classList.add('batch-selectable');
        
        // âœ… æ£€æŸ¥æ˜¯å¦å·²ç»é€‰ä¸­ï¼ˆéœ€è¦æ„å»ºå®Œæ•´çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼‰
        const monthSelect = document.getElementById('rosterMonth');
        let year, month;
        if (monthSelect?.value) {
            const parts = monthSelect.value.split('-').map(Number);
            year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
            month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
        } else {
            const now = new Date();
            year = now.getFullYear();
            month = now.getMonth() + 1;
        }
        // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDates
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
        if (!cell.hasAttribute('data-batch-listener')) {
            cell.setAttribute('data-batch-listener', 'true');
            cell.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†ã€é€‰æ‹©æ¡†æˆ–æŒ‰é’®ï¼Œä¸è§¦å‘é€‰æ‹©
                if (e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'SELECT' || 
                    e.target.tagName === 'BUTTON' ||
                    e.target.closest('input') ||
                    e.target.closest('select') ||
                    e.target.closest('button')) {
                    return;
                }
                
                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
                
                toggleBatchDateSelection(day, cell);
            });
        }
    });
}

/**
 * ç¦ç”¨æ—¥å†æ—¥æœŸé€‰æ‹©ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œç”¨äºä¸»æ—¥å†ï¼‰
 */
function disableBatchDateSelection() {
    const calendar = document.getElementById('staffRosterCalendars');
    if (!calendar) return;
    
    const cells = calendar.querySelectorAll('.cal-cell');
    cells.forEach(cell => {
        cell.classList.remove('batch-selectable', 'batch-selected');
        cell.removeAttribute('data-batch-listener');
    });
}

/**
 * âœ… åˆ‡æ¢æ—¥æœŸé€‰æ‹©çŠ¶æ€ï¼ˆä»ä¸»æ—¥å†ï¼‰- æ”¯æŒå‡æœŸç±»å‹
 */
function toggleBatchDateSelection(day, cellElement) {
    // âœ… è·å–å½“å‰å¹´ä»½å’Œæœˆä»½
    const monthSelect = document.getElementById('rosterMonth');
    let year, month;
    if (monthSelect?.value) {
        const parts = monthSelect.value.split('-').map(Number);
        year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
        month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
    } else {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
    }
    
    // âœ… æ„å»ºå®Œæ•´çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDatesï¼Œç»Ÿä¸€ä½¿ç”¨æ–°çš„é€»è¾‘
    
    // âœ… å‡æœŸç±»å‹é€‰æ‹©é€»è¾‘ï¼ˆä½¿ç”¨ä¸Šé¢å·²ç»è·å–çš„ year, month, dateStrï¼‰
    
    // åˆå§‹åŒ–è¯¥å‡æœŸç±»å‹çš„æ—¥æœŸé›†åˆ
    if (!leaveDatesByType.has(currentLeaveType)) {
        leaveDatesByType.set(currentLeaveType, new Set());
    }
    
    const dates = leaveDatesByType.get(currentLeaveType);
    
    if (dates.has(dateStr)) {
        // å–æ¶ˆé€‰æ‹©
        dates.delete(dateStr);
        if (dates.size === 0) {
            leaveDatesByType.delete(currentLeaveType);
        }
    } else {
        // é€‰æ‹©
        dates.add(dateStr);
    }
    
    // æ›´æ–°æ—¥å†é«˜äº®æ˜¾ç¤º
    updateLeaveHighlightInCalendar();
    updateBatchCalendarLeaveHighlight();
    
    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    updateBatchSelectionDisplay();
}

/**
 * âœ… æ›´æ–°é€‰æ‹©æ˜¾ç¤ºï¼ˆæ”¯æŒå‡æœŸç±»å‹å’Œå®Œæ•´æ—¥æœŸå­—ç¬¦ä¸²ï¼‰
 */
function updateBatchSelectionDisplay() {
    const countElement = document.getElementById('selectedDatesCount');
    const listElement = document.getElementById('batchSelectedDatesList');
    const executeBtn = document.getElementById('batchExecuteBtn');
    
    if (!countElement || !listElement) return;
    
    // âœ… æ ¹æ®æ“ä½œç±»å‹æ”¶é›†é€‰ä¸­çš„æ—¥æœŸ
    let count = 0;
    let allDates = [];
    
    if (batchOperationType === 'work') {
        // å·¥ä½œæ¨¡å¼ï¼šä½¿ç”¨ batchWorkSelectedDates
        count = batchWorkSelectedDates.size;
        allDates = Array.from(batchWorkSelectedDates).map(dateStr => {
            if (typeof dateStr !== 'string' || !dateStr.includes('-')) {
                console.warn('Invalid dateStr in batchWorkSelectedDates:', dateStr);
                return null;
            }
            const parts = dateStr.split('-');
            const day = parseInt(parts[2]);
            if (isNaN(day)) {
                console.warn('Invalid day in dateStr:', dateStr);
                return null;
            }
            return { day, dateStr };
        }).filter(item => item !== null);
    } else if (batchOperationType === 'leave' && currentLeaveType) {
        // è¯·å‡æ¨¡å¼ï¼šä½¿ç”¨ leaveDatesByType
        if (leaveDatesByType.has(currentLeaveType)) {
            const dates = leaveDatesByType.get(currentLeaveType);
            count = dates.size;
            dates.forEach(dateStr => {
                if (typeof dateStr !== 'string' || !dateStr.includes('-')) {
                    console.warn('Invalid dateStr in leaveDatesByType:', dateStr);
                    return;
                }
                const parts = dateStr.split('-');
                const day = parseInt(parts[2]);
                if (!isNaN(day)) {
                    allDates.push({ day, dateStr, leaveType: currentLeaveType });
                }
            });
        }
    } else {
        // âœ… ä½¿ç”¨æ–°çš„é€»è¾‘ï¼šbatchWorkSelectedDates å’Œ leaveDatesByType
        // åˆå¹¶æ‰€æœ‰é€‰ä¸­çš„æ—¥æœŸ
        const allSelectedDates = new Set();
        batchWorkSelectedDates.forEach(date => allSelectedDates.add(date));
        leaveDatesByType.forEach((dates, leaveType) => {
            dates.forEach(date => allSelectedDates.add(date));
        });
        count = allSelectedDates.size;
        allDates = Array.from(allSelectedDates).map(dateStr => {
            if (typeof dateStr !== 'string' || !dateStr.includes('-')) {
                console.warn('Invalid dateStr:', dateStr);
                return null;
            }
            const parts = dateStr.split('-');
            const day = parseInt(parts[2]);
            if (isNaN(day)) {
                console.warn('Invalid day in dateStr:', dateStr);
                return null;
            }
            return { day, dateStr };
        }).filter(item => item !== null);
    }
    
    countElement.textContent = `å·²é€‰æ‹©ï¼š${count}ä¸ªæ—¥æœŸ`;
    
    if (count === 0) {
        listElement.innerHTML = '<p class="batch-hint">è¯·åœ¨ä¸‹æ–¹æ—¥å†ä¸­ç‚¹å‡»æ—¥æœŸè¿›è¡Œé€‰æ‹©</p>';
        // âœ… æ²¡æœ‰é€‰æ‹©æ—¥æœŸæ—¶ï¼Œç¦ç”¨ç¡®è®¤æ‰§è¡ŒæŒ‰é’®
        if (executeBtn) {
            executeBtn.disabled = true;
        }
    } else {
        // âœ… æŒ‰æ—¥æœŸæ’åºï¼ˆä½¿ç”¨å®Œæ•´æ—¥æœŸå­—ç¬¦ä¸²ï¼‰
        allDates.sort((a, b) => {
            const dateA = new Date(a.dateStr || `${a.day}`);
            const dateB = new Date(b.dateStr || `${b.day}`);
            return dateA - dateB;
        });
        
        // ç”Ÿæˆæ—¥æœŸæ ‡ç­¾åˆ—è¡¨
        const leaveTypeNames = { 
            regular: 'ä¾‹å‡', 
            annual: 'å¹´å‡', 
            maternity: 'äº§å‡', 
            sick: 'ç—…å‡', 
            nopaid: 'No Paid', 
            statutory: 'æ³•å®šåŠ³å·¥å‡' 
        };
        
        listElement.innerHTML = allDates.map(({ day, dateStr, leaveType }) => {
            const typeLabel = leaveType ? ` (${leaveTypeNames[leaveType] || leaveType})` : '';
            // âœ… ä½¿ç”¨ dateStr ä½œä¸ºåˆ é™¤å‚æ•°
            const removeParam = dateStr || day;
            return `<span class="batch-selected-date-tag">
                ${day}æ—¥${typeLabel}
                <span class="remove-date" onclick="removeBatchDateByStr('${removeParam}')">Ã—</span>
            </span>`;
        }).join('');
        
        // âœ… æœ‰é€‰æ‹©æ—¥æœŸæ—¶ï¼Œè‡ªåŠ¨å¯ç”¨ç¡®è®¤æ‰§è¡ŒæŒ‰é’®ï¼ˆä½†éœ€è¦è°ƒç”¨ updateBatchExecuteButtonStateï¼‰
        if (executeBtn) {
            updateBatchExecuteButtonState();
        }
    }
}

/**
 * ç§»é™¤é€‰ä¸­çš„æ—¥æœŸ - æ”¯æŒå‡æœŸç±»å‹
 */
function removeBatchDate(day) {
    // âœ… å¦‚æœé€‰æ‹©äº†å‡æœŸç±»å‹ï¼Œä» leaveDatesByType ä¸­ç§»é™¤
    if (currentLeaveType) {
        const monthSelect = document.getElementById('rosterMonth');
        let year, month;
        if (monthSelect?.value) {
            const parts = monthSelect.value.split('-').map(Number);
            year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
            month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
        } else {
            const now = new Date();
            year = now.getFullYear();
            month = now.getMonth() + 1;
        }
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // ä»æ‰€æœ‰å‡æœŸç±»å‹ä¸­ç§»é™¤è¯¥æ—¥æœŸ
        for (let [leaveType, dates] of leaveDatesByType) {
            if (dates.has(dateStr)) {
                dates.delete(dateStr);
                if (dates.size === 0) {
                    leaveDatesByType.delete(leaveType);
                }
            }
        }
        
        // âœ… æ›´æ–°æ—¥å†é«˜äº®æ˜¾ç¤ºï¼ˆåŒ…æ‹¬é¢œè‰²ï¼‰
        updateLeaveHighlightInCalendar();
        updateBatchCalendarLeaveHighlight();
    } else {
        // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDates
    }
    
    updateBatchSelectionDisplay();
    updateBatchExecuteButtonState();
}

/**
 * âœ… é€šè¿‡æ—¥æœŸå­—ç¬¦ä¸²ç§»é™¤é€‰ä¸­çš„æ—¥æœŸ
 */
function removeBatchDateByStr(dateStr) {
    // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDates
    // ç°åœ¨ä½¿ç”¨ toggleBatchDateSelectionFromCalendar æ¥å¤„ç†æ—¥æœŸé€‰æ‹©/å–æ¶ˆ
    if (typeof dateStr === 'string' && dateStr.includes('-')) {
        // å°è¯•ä»æ‰¹é‡æ“ä½œæ—¥å†ä¸­æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ å¹¶è§¦å‘ç‚¹å‡»
        const batchCalendar = document.getElementById('batchOperationCalendar');
        if (batchCalendar) {
            const dayElement = batchCalendar.querySelector(`.batch-calendar-day[data-date="${dateStr}"]`);
            if (dayElement) {
                const day = parseInt(dayElement.getAttribute('data-day'));
                if (!isNaN(day)) {
                    toggleBatchDateSelectionFromCalendar(day, dayElement);
                }
            }
        }
    } else {
        // å¦‚æœä¼ å…¥çš„ä¸æ˜¯æ—¥æœŸå­—ç¬¦ä¸²ï¼Œå°è¯•ä½œä¸ºæ•°å­—å¤„ç†
        removeBatchDate(dateStr);
    }
}

/**
 * æ¸…ç©ºé€‰æ‹© - æ”¯æŒå‡æœŸç±»å‹
 */
function clearBatchSelection() {
    // âœ… å¦‚æœé€‰æ‹©äº†å‡æœŸç±»å‹ï¼Œæ¸…ç©º leaveDatesByType
    if (currentLeaveType) {
        leaveDatesByType.clear();
        // âœ… æ›´æ–°æ—¥å†é«˜äº®æ˜¾ç¤ºï¼ˆåŒ…æ‹¬é¢œè‰²ï¼‰
        updateLeaveHighlightInCalendar();
        updateBatchCalendarLeaveHighlight();
    } else {
        // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDates
    }
    
    updateBatchSelectionDisplay();
}

/**
 * é€‰æ‹©å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰- æ”¯æŒå‡æœŸç±»å‹
 */
function selectWeekdays() {
    const monthSelect = document.getElementById('rosterMonth');
    if (!monthSelect || !monthSelect.value) return;
    
    let year, month;
    if (monthSelect.value) {
        const parts = monthSelect.value.split('-').map(Number);
        year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
        month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
    } else {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
    }
    
    const daysInMonth = new Date(year, month, 0).getDate();
    
    // âœ… å¦‚æœé€‰æ‹©äº†å‡æœŸç±»å‹ï¼Œæ·»åŠ åˆ° leaveDatesByType
    if (currentLeaveType) {
        if (!leaveDatesByType.has(currentLeaveType)) {
            leaveDatesByType.set(currentLeaveType, new Set());
        }
        const dates = leaveDatesByType.get(currentLeaveType);
        dates.clear();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const weekday = date.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            if (weekday >= 1 && weekday <= 5) { // å‘¨ä¸€åˆ°å‘¨äº”
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dates.add(dateStr);
            }
        }
        
        // âœ… æ›´æ–°æ—¥å†é«˜äº®æ˜¾ç¤ºï¼ˆåŒ…æ‹¬é¢œè‰²ï¼‰
        updateLeaveHighlightInCalendar();
        updateBatchCalendarLeaveHighlight();
    } else {
        // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDates
    }
    
    updateBatchSelectionDisplay();
}

/**
 * é€‰æ‹©å‘¨æœ«ï¼ˆå‘¨å…­å’Œå‘¨æ—¥ï¼‰- æ”¯æŒå‡æœŸç±»å‹
 */
function selectWeekends() {
    const monthSelect = document.getElementById('rosterMonth');
    if (!monthSelect || !monthSelect.value) return;
    
    let year, month;
    if (monthSelect.value) {
        const parts = monthSelect.value.split('-').map(Number);
        year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
        month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
    } else {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
    }
    
    const daysInMonth = new Date(year, month, 0).getDate();
    
    // âœ… å¦‚æœé€‰æ‹©äº†å‡æœŸç±»å‹ï¼Œæ·»åŠ åˆ° leaveDatesByType
    if (currentLeaveType) {
        if (!leaveDatesByType.has(currentLeaveType)) {
            leaveDatesByType.set(currentLeaveType, new Set());
        }
        const dates = leaveDatesByType.get(currentLeaveType);
        dates.clear();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const weekday = date.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
            if (weekday === 0 || weekday === 6) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dates.add(dateStr);
            }
        }
        
        // âœ… æ›´æ–°æ—¥å†é«˜äº®æ˜¾ç¤ºï¼ˆåŒ…æ‹¬é¢œè‰²ï¼‰
        updateLeaveHighlightInCalendar();
        updateBatchCalendarLeaveHighlight();
    } else {
        // âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†ä½¿ç”¨ batchSelectedDates
    }
    
    updateBatchSelectionDisplay();
}

/**
 * âœ… æ›´æ–°æ‰¹é‡æ“ä½œæ—¥å†çš„é€‰æ‹©çŠ¶æ€ï¼ˆæ˜¾ç¤ºè¢«å ç”¨çš„ç±»å‹ï¼Œä½†åŒä¸€æ—¥æœŸåªèƒ½è¢«ä¸€ä¸ªç±»å‹é€‰æ‹©ï¼‰
 */
function updateBatchCalendarSelection() {
    const batchCalendar = document.getElementById('batchOperationCalendar');
    if (!batchCalendar) return;
    
    const dayElements = batchCalendar.querySelectorAll('.batch-calendar-day[data-date]');
    dayElements.forEach(element => {
        const dateStr = element.getAttribute('data-date');
        if (!dateStr) return;
        
        // âœ… æ£€æŸ¥è¯¥æ—¥æœŸè¢«å“ªä¸ªç±»å‹å ç”¨
        const isWorkSelected = batchWorkSelectedDates.has(dateStr);
        let isLeaveSelected = false;
        let leaveTypeForDate = null;
        
        // æ£€æŸ¥æ‰€æœ‰è¯·å‡ç±»å‹çš„é€‰ä¸­çŠ¶æ€ï¼ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå ç”¨çš„ç±»å‹ï¼‰
        for (let [leaveType, dates] of leaveDatesByType) {
            if (dates.has(dateStr)) {
                isLeaveSelected = true;
                leaveTypeForDate = leaveType;
                break;
            }
        }
        
        // âœ… å½“å‰æ“ä½œç±»å‹çš„é€‰ä¸­çŠ¶æ€
        let isCurrentTypeSelected = false;
        let selectedBySlotIndex = null; // è¢«å“ªä¸ªå¡«å……æ—¶æ®µé€‰ä¸­ï¼ˆå·¥ä½œæ¨¡å¼ï¼‰
        if (batchOperationType === 'work') {
            const weekday = new Date(dateStr).getDay();
            
            // âœ… 1. æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦è¢«æŸä¸ªå¡«å……æ—¶æ®µå•ç‹¬é€‰æ‹©ï¼ˆselectedDatesï¼‰
            for (let i = 0; i < batchFillTimeSlots.length; i++) {
                if (batchFillTimeSlots[i].selectedDates && batchFillTimeSlots[i].selectedDates.has(dateStr)) {
                    selectedBySlotIndex = i;
                    break;
                }
            }
            
            // âœ… 2. å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦é€šè¿‡æŸä¸ªå¡«å……æ—¶æ®µçš„æ˜ŸæœŸåˆ—é€‰æ‹©è¢«é€‰ä¸­
            if (selectedBySlotIndex === null && isWorkSelected) {
                // ç›´æ¥æ£€æŸ¥ batchFillTimeSlots æ•°ç»„ä¸­çš„ weekdays
                for (let i = 0; i < batchFillTimeSlots.length; i++) {
                    if (batchFillTimeSlots[i].weekdays && batchFillTimeSlots[i].weekdays.includes(weekday)) {
                        // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨æ—¥æœŸèŒƒå›´å†…ï¼Œå¹¶ä¸”æ˜ŸæœŸåŒ¹é…
                        if (batchDateRange.start && batchDateRange.end) {
                            const dateObj = new Date(dateStr);
                            const start = new Date(batchDateRange.start);
                            const end = new Date(batchDateRange.end);
                            if (dateObj >= start && dateObj <= end) {
                                selectedBySlotIndex = i;
                                break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„å¡«å……æ—¶æ®µ
                            }
                        }
                    }
                }
            }
            
            // âœ… å¦‚æœè¢«å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œåˆ™é«˜äº®æ˜¾ç¤º
            if (selectedBySlotIndex === currentActiveSlotIndex) {
                isCurrentTypeSelected = true;
            } else if (selectedBySlotIndex !== null) {
                // å¦‚æœè¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œåˆ™å˜æ·¡æ˜¾ç¤º
                isCurrentTypeSelected = false;
            } else if (isWorkSelected) {
                // å¦‚æœåªæ˜¯è¢«å·¥ä½œæ¨¡å¼é€‰ä¸­ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å¡«å……æ—¶æ®µï¼Œåˆ™é«˜äº®æ˜¾ç¤ºï¼ˆå¯èƒ½æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼é€‰æ‹©çš„ï¼‰
                isCurrentTypeSelected = true;
            }
        } else if (batchOperationType === 'leave' && currentLeaveType) {
            if (leaveDatesByType.has(currentLeaveType)) {
                isCurrentTypeSelected = leaveDatesByType.get(currentLeaveType).has(dateStr);
            }
        }
        
        // âœ… æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦è¢«å…¶ä»–ç±»å‹å ç”¨
        let isOccupiedByOtherType = false;
        let occupiedTypeName = '';
        if (batchOperationType === 'work' && isLeaveSelected) {
            isOccupiedByOtherType = true;
            const leaveTypeNames = { 
                regular: 'ä¾‹å‡', 
                annual: 'å¹´å‡', 
                maternity: 'äº§å‡', 
                sick: 'ç—…å‡', 
                nopaid: 'No Paid', 
                statutory: 'æ³•å®šåŠ³å·¥å‡' 
            };
            occupiedTypeName = leaveTypeNames[leaveTypeForDate] || leaveTypeForDate;
        } else if (batchOperationType === 'leave' && currentLeaveType) {
            if (isWorkSelected) {
                isOccupiedByOtherType = true;
                occupiedTypeName = 'å·¥ä½œæ¨¡å¼';
            } else if (isLeaveSelected && leaveTypeForDate !== currentLeaveType) {
                isOccupiedByOtherType = true;
                const leaveTypeNames = { 
                    regular: 'ä¾‹å‡', 
                    annual: 'å¹´å‡', 
                    maternity: 'äº§å‡', 
                    sick: 'ç—…å‡', 
                    nopaid: 'No Paid', 
                    statutory: 'æ³•å®šåŠ³å·¥å‡' 
                };
                occupiedTypeName = leaveTypeNames[leaveTypeForDate] || leaveTypeForDate;
            }
        }
        
        // âœ… ç§»é™¤æ‰€æœ‰é€‰ä¸­ç›¸å…³çš„ç±»
        element.classList.remove('batch-calendar-work-selected', 'batch-calendar-leave-selected', 
            'batch-calendar-current-selected', 'batch-calendar-occupied');
        element.classList.remove('batch-calendar-leave-regular', 'batch-calendar-leave-annual', 
            'batch-calendar-leave-maternity', 'batch-calendar-leave-sick', 
            'batch-calendar-leave-nopaid', 'batch-calendar-leave-statutory');
        
        // âœ… æ¯ä¸ªæ—¥æœŸæ ¼å­å§‹ç»ˆæ˜¾ç¤ºå®ƒå®é™…è¢«å“ªä¸ªç±»å‹é€‰æ‹©çš„é¢œè‰²
        // å…ˆç§»é™¤æ‰€æœ‰å¯èƒ½çš„ç±»
        element.classList.remove('batch-calendar-work-selected', 'batch-calendar-leave-selected', 
            'batch-calendar-current-selected', 'batch-calendar-occupied');
        element.classList.remove('batch-calendar-leave-regular', 'batch-calendar-leave-annual', 
            'batch-calendar-leave-maternity', 'batch-calendar-leave-sick', 
            'batch-calendar-leave-nopaid', 'batch-calendar-leave-statutory');
        
        if (isWorkSelected) {
            // è¢«å·¥ä½œæ¨¡å¼é€‰ä¸­ï¼šæ˜¾ç¤ºå·¥ä½œæ¨¡å¼é¢œè‰²
            element.classList.add('batch-calendar-work-selected');
            // âœ… å¦‚æœè¢«å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µå•ç‹¬é€‰ä¸­ï¼Œé«˜äº®æ˜¾ç¤ºï¼›å¦‚æœè¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œå˜æ·¡æ˜¾ç¤º
            if (selectedBySlotIndex === currentActiveSlotIndex) {
                // å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­ï¼šé«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
                element.classList.add('batch-calendar-current-selected');
                element.removeAttribute('title');
                element.style.cursor = '';
            } else if (selectedBySlotIndex !== null) {
                // è¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼šå˜æ·¡æ˜¾ç¤º
                element.classList.add('batch-calendar-occupied');
                element.setAttribute('title', `å·²è¢«å¡«å……æ—¶æ®µ ${selectedBySlotIndex + 1} é€‰æ‹©ï¼Œç‚¹å‡»å¯åˆ‡æ¢`);
                element.style.cursor = 'pointer';
            } else if (isCurrentTypeSelected) {
                // é€šè¿‡æ˜ŸæœŸé€‰æ‹©æˆ–å…¶ä»–æ–¹å¼é€‰ä¸­ï¼šé«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
                element.classList.add('batch-calendar-current-selected');
                element.removeAttribute('title');
                element.style.cursor = '';
            } else {
                // å…¶ä»–æƒ…å†µï¼šå˜æ·¡æ˜¾ç¤º
                element.classList.add('batch-calendar-occupied');
                element.setAttribute('title', 'å·²è¢«å·¥ä½œæ¨¡å¼é€‰æ‹©ï¼Œç‚¹å‡»å¯åˆ‡æ¢');
                element.style.cursor = 'pointer';
            }
        } else if (isLeaveSelected && leaveTypeForDate) {
            // è¢«è¯·å‡ç±»å‹é€‰ä¸­ï¼šæ˜¾ç¤ºè¯¥è¯·å‡ç±»å‹çš„é¢œè‰²
            element.classList.add('batch-calendar-leave-selected');
            element.classList.add(`batch-calendar-leave-${leaveTypeForDate}`);
            if (isCurrentTypeSelected && currentLeaveType === leaveTypeForDate) {
                // å½“å‰æ“ä½œç±»å‹æ˜¯è¯¥è¯·å‡ç±»å‹ï¼šé«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
                element.classList.add('batch-calendar-current-selected');
                element.removeAttribute('title');
                element.style.cursor = '';
            } else {
                // å½“å‰æ“ä½œç±»å‹ä¸æ˜¯è¯¥è¯·å‡ç±»å‹ï¼šå˜æ·¡æ˜¾ç¤º
                element.classList.add('batch-calendar-occupied');
                const leaveTypeNames = { 
                    regular: 'ä¾‹å‡', 
                    annual: 'å¹´å‡', 
                    maternity: 'äº§å‡', 
                    sick: 'ç—…å‡', 
                    nopaid: 'No Paid', 
                    statutory: 'æ³•å®šåŠ³å·¥å‡' 
                };
                const typeName = leaveTypeNames[leaveTypeForDate] || leaveTypeForDate;
                element.setAttribute('title', `å·²è¢«${typeName}é€‰æ‹©ï¼Œç‚¹å‡»å¯åˆ‡æ¢`);
                element.style.cursor = 'pointer';
            }
        } else {
            element.removeAttribute('title');
            element.style.cursor = '';
        }
    });
}

/**
 * åŠ è½½åœ°ç‚¹é€‰é¡¹åˆ°æ‰¹é‡æ“ä½œç•Œé¢
 */
async function loadBatchLocationOptions() {
    try {
        const locations = await getLocationList();
        
        // å¡«å……æ‰€æœ‰åœ°ç‚¹é€‰æ‹©å™¨
        for (let i = 1; i <= 3; i++) {
            const select = document.getElementById(`batchLocation${i}`);
            if (select) {
                select.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°ç‚¹</option>' +
                    locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            }
        }
    } catch (error) {
        console.error('åŠ è½½åœ°ç‚¹åˆ—è¡¨å¤±è´¥:', error);
    }
}

/**
 * é¢„è§ˆæ‰¹é‡æ“ä½œï¼ˆå¯é€‰åŠŸèƒ½ï¼Œä¸å½±å“æ‰§è¡Œï¼‰
 */
function previewBatchOperation() {
    // âœ… æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ—¥æœŸï¼ˆä½¿ç”¨æ–°çš„é€»è¾‘ï¼‰
    const allSelectedDates = new Set();
    batchWorkSelectedDates.forEach(date => allSelectedDates.add(date));
    leaveDatesByType.forEach((dates) => {
        dates.forEach(date => allSelectedDates.add(date));
    });
    if (allSelectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ—¥æœŸ');
        return;
    }
    
    const mode = document.querySelector('input[name="batchMode"]:checked')?.value;
    if (!mode) return;
    
    const previewElement = document.getElementById('batchPreview');
    const previewContent = document.getElementById('batchPreviewContent');
    
    if (!previewElement || !previewContent) return;
    
    // âœ… ä½¿ç”¨å·²æ”¶é›†çš„ allSelectedDates
    let previewHTML = '';
    const datesArray = Array.from(allSelectedDates).sort();
    
    if (mode === 'fill') {
        previewHTML = generateFillPreview(datesArray);
    } else if (mode === 'leave') {
        previewHTML = generateLeavePreview(datesArray);
    } else if (mode === 'clear') {
        previewHTML = generateClearPreview(datesArray);
    }
    
    previewContent.innerHTML = previewHTML;
    previewElement.classList.remove('hidden');
    
    // âœ… é¢„è§ˆä¸å†æ§åˆ¶ç¡®è®¤æ‰§è¡ŒæŒ‰é’®çš„å¯ç”¨çŠ¶æ€ï¼ŒæŒ‰é’®ä¼šæ ¹æ®æ—¥æœŸé€‰æ‹©è‡ªåŠ¨å¯ç”¨
}

/**
 * ç”Ÿæˆå¡«å……é¢„è§ˆ
 */
function generateFillPreview(datesArray) {
    const slot1 = document.getElementById('batchSlot1')?.checked;
    const slot2 = document.getElementById('batchSlot2')?.checked;
    const slot3 = document.getElementById('batchSlot3')?.checked;
    const time1 = document.getElementById('batchTime1')?.value || '';
    const loc1 = document.getElementById('batchLocation1')?.value || '';
    const time2 = document.getElementById('batchTime2')?.value || '';
    const loc2 = document.getElementById('batchLocation2')?.value || '';
    const time3 = document.getElementById('batchTime3')?.value || '';
    const loc3 = document.getElementById('batchLocation3')?.value || '';
    const conflictMode = document.querySelector('input[name="batchConflict"]:checked')?.value;
    
    let slotsCount = 0;
    if (slot1) slotsCount++;
    if (slot2) slotsCount++;
    if (slot3) slotsCount++;
    
    const totalSlots = datesArray.length * slotsCount;
    
    let html = `<div style="margin-bottom: 16px; padding: 12px; background: #e0f2fe; border-radius: 8px;">
        <strong>æ“ä½œç»Ÿè®¡ï¼š</strong><br>
        - ç›®æ ‡æ—¥æœŸï¼š${datesArray.length}ä¸ª<br>
        - å°†ä¿®æ”¹æ—¶æ®µï¼š${totalSlots}ä¸ª<br>
        - å†²çªå¤„ç†ï¼š${conflictMode === 'overwrite' ? 'è¦†ç›–å·²æœ‰æ•°æ®' : conflictMode === 'skip' ? 'è·³è¿‡å·²æœ‰æ•°æ®' : 'ä»…å¡«å……ç©ºç™½æ—¶æ®µ'}
    </div>`;
    
    html += '<div style="max-height: 200px; overflow-y: auto;">';
    datesArray.forEach(day => {
        const dateStr = `${day}æ—¥`;
        let operations = [];
        
        if (slot1 && (time1 || loc1)) {
            operations.push(`ä¸Šåˆï¼š${time1 || '(æ— æ—¶é—´)'} | ${loc1 || '(æ— åœ°ç‚¹)'}`);
        }
        if (slot2 && (time2 || loc2)) {
            operations.push(`ä¸­åˆï¼š${time2 || '(æ— æ—¶é—´)'} | ${loc2 || '(æ— åœ°ç‚¹)'}`);
        }
        if (slot3 && (time3 || loc3)) {
            operations.push(`ä¸‹åˆï¼š${time3 || '(æ— æ—¶é—´)'} | ${loc3 || '(æ— åœ°ç‚¹)'}`);
        }
        
        if (operations.length > 0) {
            html += `<div class="batch-preview-item new">
                <strong>${dateStr}</strong>ï¼š${operations.join('ï¼›')}
            </div>`;
        }
    });
    html += '</div>';
    
    return html;
}

/**
 * ç”Ÿæˆè¯·å‡é¢„è§ˆï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
 */
function generateLeavePreview(datesArray) {
    let html = `<div style="margin-bottom: 16px; padding: 12px; background: #e0f2fe; border-radius: 8px;">
        <strong>æ“ä½œç»Ÿè®¡ï¼š</strong><br>
        - ç›®æ ‡æ—¥æœŸï¼š${datesArray.length}ä¸ª<br>
        - æ“ä½œå†…å®¹ï¼šå°†é€‰ä¸­æ—¥æœŸæ ‡è®°ä¸ºè¯·å‡ï¼ˆunavailable = trueï¼‰
    </div>`;
    
    html += '<div style="max-height: 200px; overflow-y: auto;">';
    datesArray.forEach(day => {
        html += `<div class="batch-preview-item">
            <strong>${day}æ—¥</strong>ï¼šæ ‡è®°ä¸ºè¯·å‡
        </div>`;
    });
    html += '</div>';
    
    return html;
}

/**
 * ç”Ÿæˆæ¸…é™¤é¢„è§ˆ
 */
function generateClearPreview(datesArray) {
    const slot1 = document.getElementById('batchClearSlot1')?.checked;
    const slot2 = document.getElementById('batchClearSlot2')?.checked;
    const slot3 = document.getElementById('batchClearSlot3')?.checked;
    const clearTime = document.getElementById('batchClearTime')?.checked;
    const clearLocation = document.getElementById('batchClearLocation')?.checked;
    const clearLeave = document.getElementById('batchClearLeave')?.checked;
    
    let slots = [];
    if (slot1) slots.push('ä¸Šåˆ');
    if (slot2) slots.push('ä¸­åˆ');
    if (slot3) slots.push('ä¸‹åˆ');
    
    let clearItems = [];
    if (clearTime) clearItems.push('æ—¶é—´');
    if (clearLocation) clearItems.push('åœ°ç‚¹');
    if (clearLeave) clearItems.push('è¯·å‡çŠ¶æ€');
    
    let html = `<div style="margin-bottom: 16px; padding: 12px; background: #e0f2fe; border-radius: 8px;">
        <strong>æ“ä½œç»Ÿè®¡ï¼š</strong><br>
        - ç›®æ ‡æ—¥æœŸï¼š${datesArray.length}ä¸ª<br>
        - æ¸…é™¤æ—¶æ®µï¼š${slots.join('ã€') || 'æ— '}<br>
        - æ¸…é™¤å†…å®¹ï¼š${clearItems.join('ã€') || 'æ— '}
    </div>`;
    
    html += '<div style="max-height: 200px; overflow-y: auto;">';
    datesArray.forEach(day => {
        html += `<div class="batch-preview-item">
            <strong>${day}æ—¥</strong>ï¼šæ¸…é™¤${slots.join('ã€') || 'æ‰€æœ‰'}æ—¶æ®µçš„${clearItems.join('ã€') || 'æ•°æ®'}
        </div>`;
    });
    html += '</div>';
    
    return html;
}

/**
 * æ‰§è¡Œæ‰¹é‡æ“ä½œï¼ˆæ–°ç‰ˆæœ¬ - ç›´æ¥æ›´æ–°åç«¯ï¼‰
 */
function executeBatchOperation() {
    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å‘˜å·¥
    const coachSelect = document.getElementById('staffCoachSelect');
    const selectedPhone = coachSelect?.value || '';
    
    if (!selectedPhone) {
        alert('è«‹å…ˆé¸æ“‡è¦æ“ä½œçš„å“¡å·¥ï¼');
        return;
    }
    
    // âœ… è·å–å‘˜å·¥åç§°ï¼ˆå»æ‰ç”µè¯å·ç ï¼‰
    let employeeName = '';
    if (coachSelect && coachSelect.options) {
        const selectedOption = Array.from(coachSelect.options).find(opt => opt.value === selectedPhone);
        if (selectedOption) {
            const fullText = selectedOption.textContent || selectedOption.text || '';
            // âœ… æå–åç§°éƒ¨åˆ†ï¼ˆå»æ‰ç”µè¯å·ç ï¼Œæ ¼å¼é€šå¸¸æ˜¯ "å§“å (ç”µè¯å·ç )"ï¼‰
            const match = fullText.match(/^([^(]+)/);
            employeeName = match ? match[1].trim() : fullText.trim();
        }
    }
    
    // æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
    if (batchOperationType === 'work') {
        executeBatchWork(selectedPhone, employeeName);
    } else if (batchOperationType === 'leave') {
        executeBatchLeaveNew(selectedPhone, employeeName);
    } else if (batchOperationType === 'clear') {
        executeBatchClearNew(selectedPhone, employeeName);
    } else {
        alert('è«‹å…ˆé¸æ“‡æ“ä½œé¡å‹ï¼ˆå·¥ä½œæˆ–è«‹å‡ï¼‰ï¼');
    }
}

/**
 * âœ… æ‰§è¡Œæ‰¹é‡å·¥ä½œï¼ˆå¡«å……æ—¶æ®µæ•°æ®ï¼‰
 */
async function executeBatchWork(phone, employeeName) {
    if (batchWorkSelectedDates.size === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦æ“ä½œçš„æ—¥æœŸï¼');
        return;
    }
    
    // âœ… æ”¶é›†å¡«å……æ—¶æ®µé…ç½®ï¼ˆä»UIä¸­è¯»å–ï¼‰
    const fillSlotConfigs = collectBatchFillSlotConfigs();
    
    if (fillSlotConfigs.length === 0) {
        alert('è«‹å…ˆè¨­ç½®å¡«å……æ™‚æ®µå…§å®¹ï¼');
        return;
    }
    
    // âœ… æ”¶é›†æ‰€æœ‰éœ€è¦æ›´æ–°çš„æ—¥æœŸ
    // å¦‚æœé…ç½®äº†æ˜ŸæœŸï¼Œä¸ºæ—¥æœŸèŒƒå›´å†…çš„æ‰€æœ‰åŒ¹é…æ˜ŸæœŸç”Ÿæˆæ—¥æœŸ
    // å¦åˆ™ï¼Œåªä½¿ç”¨ batchWorkSelectedDates ä¸­çš„æ—¥æœŸ
    const datesToUpdate = new Set();
    
    fillSlotConfigs.forEach(fillSlot => {
        if (fillSlot.weekdays && fillSlot.weekdays.length > 0) {
            // âœ… å¦‚æœé…ç½®äº†æ˜ŸæœŸï¼Œä¸ºæ—¥æœŸèŒƒå›´å†…çš„æ‰€æœ‰åŒ¹é…æ˜ŸæœŸç”Ÿæˆæ—¥æœŸ
            const start = new Date(batchDateRange.start);
            const end = new Date(batchDateRange.end);
            const current = new Date(start);
            
            while (current <= end) {
                const weekday = current.getDay();
                if (fillSlot.weekdays.includes(weekday)) {
                    const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                    datesToUpdate.add(dateStr);
                }
                current.setDate(current.getDate() + 1);
            }
        } else {
            // âœ… å¦‚æœæ²¡æœ‰é…ç½®æ˜ŸæœŸï¼Œä½¿ç”¨è¯¥å¡«å……æ—¶æ®µå•ç‹¬é€‰æ‹©çš„æ—¥æœŸï¼ˆselectedDatesï¼‰
            const slotConfig = batchFillTimeSlots[fillSlot.slotIndex];
            if (slotConfig && slotConfig.selectedDates) {
                slotConfig.selectedDates.forEach(dateStr => {
                    const dateObj = new Date(dateStr);
                    const start = new Date(batchDateRange.start);
                    const end = new Date(batchDateRange.end);
                    if (dateObj >= start && dateObj <= end) {
                        datesToUpdate.add(dateStr);
                    }
                });
            }
        }
    });
    
    if (datesToUpdate.size === 0) {
        alert('æ²’æœ‰å¯æ›´æ–°çš„æ—¥æœŸï¼è«‹æª¢æŸ¥æ—¥æœŸé¸æ“‡å’Œæ˜ŸæœŸè¨­ç½®ã€‚');
        return;
    }
    
    // éå†æ‰€æœ‰å¡«å……æ—¶æ®µé…ç½®
    const rosterEntries = [];
    
    fillSlotConfigs.forEach(fillSlot => {
        datesToUpdate.forEach(dateStr => {
            // âœ… å¦‚æœé…ç½®äº†æ˜ŸæœŸï¼Œå†æ¬¡æ£€æŸ¥æ˜ŸæœŸæ˜¯å¦åŒ¹é…ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
            if (fillSlot.weekdays && fillSlot.weekdays.length > 0) {
                const dateObj = new Date(dateStr);
                const weekday = dateObj.getDay();
                if (!fillSlot.weekdays.includes(weekday)) {
                    return; // è·³è¿‡ä¸åŒ¹é…çš„æ—¥æœŸ
                }
            } else if (fillSlot.selectedDates && fillSlot.selectedDates.size > 0) {
                // âœ… å¦‚æœæ²¡æœ‰é…ç½®æ˜ŸæœŸï¼Œä½†é…ç½®äº†å•ç‹¬é€‰æ‹©çš„æ—¥æœŸï¼Œåªå¤„ç†è¿™äº›æ—¥æœŸ
                if (!fillSlot.selectedDates.has(dateStr)) {
                    return; // è·³è¿‡ä¸åœ¨è¯¥å¡«å……æ—¶æ®µå•ç‹¬é€‰æ‹©æ—¥æœŸä¸­çš„æ—¥æœŸ
                }
            }
            
            // âœ… æ£€æŸ¥æ—¶æ®µæ˜¯å¦è¢«é€‰ä¸­ï¼ˆä»checkboxè¯»å–ï¼‰
            if (fillSlot.selectedSlots.includes(1) && fillSlot.slot1 && fillSlot.slot1.time && fillSlot.slot1.location) {
                // âœ… ç»Ÿä¸€æ—¶é—´æ ¼å¼ï¼šå°† "hh:mm-hh:mm" è½¬æ¢ä¸º "hhmm-hhmm"ï¼ˆä¸"ç¡®è®¤æ›´è¡¨"ä¸€è‡´ï¼‰
                let timeValue = fillSlot.slot1.time;
                if (timeValue.includes(':')) {
                    timeValue = timeValue.replace(/:/g, '');
                }
                rosterEntries.push({
                    date: dateStr,
                    slot: 1,
                    time: timeValue,
                    location: fillSlot.slot1.location,
                    unavailable: false,
                    isClicked: false
                });
            }
            if (fillSlot.selectedSlots.includes(2) && fillSlot.slot2 && fillSlot.slot2.time && fillSlot.slot2.location) {
                // âœ… ç»Ÿä¸€æ—¶é—´æ ¼å¼ï¼šå°† "hh:mm-hh:mm" è½¬æ¢ä¸º "hhmm-hhmm"ï¼ˆä¸"ç¡®è®¤æ›´è¡¨"ä¸€è‡´ï¼‰
                let timeValue = fillSlot.slot2.time;
                if (timeValue.includes(':')) {
                    timeValue = timeValue.replace(/:/g, '');
                }
                rosterEntries.push({
                    date: dateStr,
                    slot: 2,
                    time: timeValue,
                    location: fillSlot.slot2.location,
                    unavailable: false,
                    isClicked: false
                });
            }
            if (fillSlot.selectedSlots.includes(3) && fillSlot.slot3 && fillSlot.slot3.time && fillSlot.slot3.location) {
                // âœ… ç»Ÿä¸€æ—¶é—´æ ¼å¼ï¼šå°† "hh:mm-hh:mm" è½¬æ¢ä¸º "hhmm-hhmm"ï¼ˆä¸"ç¡®è®¤æ›´è¡¨"ä¸€è‡´ï¼‰
                let timeValue = fillSlot.slot3.time;
                if (timeValue.includes(':')) {
                    timeValue = timeValue.replace(/:/g, '');
                }
                rosterEntries.push({
                    date: dateStr,
                    slot: 3,
                    time: timeValue,
                    location: fillSlot.slot3.location,
                    unavailable: false,
                    isClicked: false
                });
            }
        });
    });
    
    if (rosterEntries.length === 0) {
        alert('æ²’æœ‰å¯æ›´æ–°çš„æ•¸æ“šï¼è«‹æª¢æŸ¥å¡«å……æ™‚æ®µè¨­ç½®ã€‚');
        return;
    }
    
    if (!confirm(`ç¢ºèªè¦å°å“¡å·¥ã€Œ${employeeName}ã€çš„ ${datesToUpdate.size} å€‹æ—¥æœŸåŸ·è¡Œæ‰¹é‡å¡«å……æ“ä½œå—ï¼Ÿ\nå°‡å‰µå»º/æ›´æ–° ${rosterEntries.length} æ¢æ›´è¡¨è¨˜éŒ„ã€‚`)) {
        return;
    }
    
    try {
        // æäº¤åˆ°åç«¯
        if (databaseConnector) {
            // âœ… ä¼ é€’employeeNameå‚æ•°ï¼Œç¡®ä¿nameæ ¼å¼æ­£ç¡®
            const result = await databaseConnector.submitBatchRoster(phone, rosterEntries, employeeName);
            console.log('âœ… æ‰¹é‡å¡«å……ä¿å­˜æˆåŠŸ:', result);
            alert(`âœ… æ‰¹é‡å¡«å……å®Œæˆï¼å·²å°‡ ${rosterEntries.length} æ¢è¨˜éŒ„ä¿å­˜åˆ°æ•¸æ“šåº«ã€‚\n\næ–°å¢: ${result.insertedCount || 0} æ¢\næ›´æ–°: ${result.modifiedCount || 0} æ¢`);
            
            // å…³é—­æ¨¡æ€æ¡†
            closeBatchOperationModal();
            
            // é‡æ–°åŠ è½½æ›´è¡¨æ•°æ®
            renderCoachRoster(phone);
            
            // å¦‚æœæœˆä»½æ›´è¡¨å·²é¡¯ç¤ºï¼Œè‡ªå‹•åˆ·æ–°
            const dailyLocationStatsContainer = document.getElementById('dailyLocationStats');
            if (dailyLocationStatsContainer && !dailyLocationStatsContainer.classList.contains('empty')) {
                const statsMonthElement = document.getElementById('statsMonth');
                if (statsMonthElement && statsMonthElement.value) {
                    const month = parseInt(statsMonthElement.value);
                    const year = new Date().getFullYear();
                    renderAllCoachesRoster(year, month);
                }
            }
        } else {
            alert('æ•¸æ“šåº«é€£æ¥æœªåˆå§‹åŒ–ï¼Œç„¡æ³•ä¿å­˜æ•¸æ“šï¼');
        }
    } catch (error) {
        console.error('æ‰¹é‡å¡«å……å¤±æ•—:', error);
        alert(`æ‰¹é‡å¡«å……å¤±æ•—ï¼š${error.message}`);
    }
}

/**
 * âœ… æ‰§è¡Œæ‰¹é‡è¯·å‡ï¼ˆæ–°ç‰ˆæœ¬ - ç›´æ¥æ›´æ–°åç«¯ï¼‰
 */
async function executeBatchLeaveNew(phone, employeeName) {
    if (!currentLeaveType) {
        alert('è«‹å…ˆé¸æ“‡å‡æœŸé¡å‹ï¼');
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰è¯·å‡æ—¥æœŸ
    const leaveDates = new Set();
    
    // ä» leaveDatesByType è·å–
    if (leaveDatesByType.has(currentLeaveType)) {
        leaveDatesByType.get(currentLeaveType).forEach(dateStr => {
            leaveDates.add(dateStr);
        });
    }
    
    // âœ… ä» leaveDatesByType è·å–ï¼ˆæ–°çš„é€»è¾‘ï¼‰
    leaveDatesByType.forEach((dates, leaveType) => {
        dates.forEach(dateStr => {
            const dateObj = new Date(dateStr);
            if (dateObj >= new Date(batchDateRange.start) && dateObj <= new Date(batchDateRange.end)) {
                leaveDates.add(dateStr);
            }
        });
    });
    
    // âœ… ä»é€‰ä¸­çš„æ˜ŸæœŸè·å–ï¼ˆè¯·å‡æ¨¡å¼ï¼‰
    if (batchLeaveSelectedWeekdays.size > 0 && batchDateRange.start && batchDateRange.end) {
        const start = new Date(batchDateRange.start);
        const end = new Date(batchDateRange.end);
        const current = new Date(start);
        
        while (current <= end) {
            if (batchLeaveSelectedWeekdays.has(current.getDay())) {
                const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                leaveDates.add(dateStr);
            }
            current.setDate(current.getDate() + 1);
        }
    }
    
    if (leaveDates.size === 0) {
        alert('è«‹å…ˆé¸æ“‡è«‹å‡æ—¥æœŸï¼');
        return;
    }
    
    if (!confirm(`ç¢ºèªè¦å°å“¡å·¥ã€Œ${employeeName}ã€çš„ ${leaveDates.size} å€‹æ—¥æœŸåŸ·è¡Œæ‰¹é‡è«‹å‡æ“ä½œå—ï¼Ÿ`)) {
        return;
    }
    
    // å‡†å¤‡æäº¤åˆ°åç«¯çš„æ•°æ®
    const leaveEntries = [];
    leaveDates.forEach(dateStr => {
        leaveEntries.push({
            date: dateStr,
            phone: phone,
            name: employeeName,
            leaveType: currentLeaveType,
            unavailable: true,
            isClicked: true,
            isSubmitted: false,
            isConfirmed: false,
            supervisorApproved: false,
            submittedBy: 'supervisor',
            updatedAt: new Date()
        });
    });
    
    try {
        // æäº¤åˆ°åç«¯
        if (databaseConnector) {
            const result = await databaseConnector.submitBatchLeave(phone, leaveEntries);
            console.log('âœ… æ‰¹é‡è¯·å‡ä¿å­˜æˆåŠŸ:', result);
            alert(`âœ… æ‰¹é‡è«‹å‡å®Œæˆï¼å·²å°‡ ${leaveDates.size} å€‹æ—¥æœŸæ¨™è¨˜ç‚ºè«‹å‡ï¼Œä¸¦å·²ä¿å­˜åˆ°æ•¸æ“šåº«ã€‚\n\næ–°å¢: ${result.insertedCount || 0} æ¢\næ›´æ–°: ${result.modifiedCount || 0} æ¢`);
        
        // å…³é—­æ¨¡æ€æ¡†
        closeBatchOperationModal();
        
            // é‡æ–°åŠ è½½æ›´è¡¨æ•°æ®
            renderCoachRoster(phone);
            
            // å¦‚æœæœˆä»½æ›´è¡¨å·²é¡¯ç¤ºï¼Œè‡ªå‹•åˆ·æ–°
            const dailyLocationStatsContainer = document.getElementById('dailyLocationStats');
            if (dailyLocationStatsContainer && !dailyLocationStatsContainer.classList.contains('empty')) {
                const statsMonthElement = document.getElementById('statsMonth');
                if (statsMonthElement && statsMonthElement.value) {
                    const month = parseInt(statsMonthElement.value);
                    const year = new Date().getFullYear();
                    renderAllCoachesRoster(year, month);
                }
            }
        } else {
            alert('æ•¸æ“šåº«é€£æ¥æœªåˆå§‹åŒ–ï¼Œç„¡æ³•ä¿å­˜æ•¸æ“šï¼');
        }
    } catch (error) {
        console.error('æ‰¹é‡è«‹å‡å¤±æ•—:', error);
        alert(`æ‰¹é‡è«‹å‡å¤±æ•—ï¼š${error.message}`);
    }
}

/**
 * âœ… æ‰§è¡Œæ‰¹é‡æ¸…é™¤ï¼ˆæ–°ç‰ˆæœ¬ - ç›´æ¥æ›´æ–°åç«¯ï¼‰
 */
async function executeBatchClearNew(phone, employeeName) {
    // âœ… æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ—¥æœŸï¼ˆä½¿ç”¨æ–°çš„é€»è¾‘ï¼‰
    const allSelectedDates = new Set();
    batchWorkSelectedDates.forEach(date => allSelectedDates.add(date));
    leaveDatesByType.forEach((dates) => {
        dates.forEach(date => allSelectedDates.add(date));
    });
    if (allSelectedDates.size === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦æ¸…é™¤çš„æ—¥æœŸï¼');
        return;
    }
    
    const slot1 = document.getElementById('batchClearSlot1')?.checked;
    const slot2 = document.getElementById('batchClearSlot2')?.checked;
    const slot3 = document.getElementById('batchClearSlot3')?.checked;
    const clearTime = document.getElementById('batchClearTime')?.checked;
    const clearLocation = document.getElementById('batchClearLocation')?.checked;
    const clearLeave = document.getElementById('batchClearLeave')?.checked;
    
    if (!clearTime && !clearLocation && !clearLeave) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …è¦æ¸…é™¤çš„å…§å®¹ï¼');
        return;
    }
    
    // âœ… æ”¶é›†æ‰€æœ‰éœ€è¦æ¸…é™¤çš„æ—¥æœŸï¼ˆä½¿ç”¨æ–°çš„é€»è¾‘ï¼šbatchWorkSelectedDates å’Œ leaveDatesByTypeï¼‰
    const datesToClear = new Set();
    batchWorkSelectedDates.forEach(dateStr => {
        const dateObj = new Date(dateStr);
        const start = new Date(batchDateRange.start);
        const end = new Date(batchDateRange.end);
        if (dateObj >= start && dateObj <= end) {
            datesToClear.add(dateStr);
        }
    });
    leaveDatesByType.forEach((dates) => {
        dates.forEach(dateStr => {
            const dateObj = new Date(dateStr);
            const start = new Date(batchDateRange.start);
            const end = new Date(batchDateRange.end);
            if (dateObj >= start && dateObj <= end) {
                datesToClear.add(dateStr);
            }
        });
    });
    
    if (!confirm(`ç¢ºèªè¦å°å“¡å·¥ã€Œ${employeeName}ã€çš„ ${datesToClear.size} å€‹æ—¥æœŸåŸ·è¡Œæ‰¹é‡æ¸…é™¤æ“ä½œå—ï¼Ÿ`)) {
        return;
    }
    
    try {
        // æ„å»ºæ¸…é™¤æ•°æ®
        const clearEntries = [];
        Array.from(datesToClear).forEach(dateStr => {
            const entry = { date: dateStr, phone: phone };
            if (clearTime) entry.clearTime = true;
            if (clearLocation) entry.clearLocation = true;
            if (clearLeave) entry.clearLeave = true;
            if (slot1) entry.slot1 = true;
            if (slot2) entry.slot2 = true;
            if (slot3) entry.slot3 = true;
            clearEntries.push(entry);
        });
        
        // æäº¤åˆ°åç«¯ï¼ˆéœ€è¦å®ç° submitBatchClear APIï¼‰
        if (databaseConnector && databaseConnector.submitBatchClear) {
            const result = await databaseConnector.submitBatchClear(phone, clearEntries);
            console.log('âœ… æ‰¹é‡æ¸…é™¤ä¿å­˜æˆåŠŸ:', result);
            alert(`âœ… æ‰¹é‡æ¸…é™¤å®Œæˆï¼å·²æ¸…é™¤ ${datesToClear.size} å€‹æ—¥æœŸçš„æ•¸æ“šã€‚`);
            
            // å…³é—­æ¨¡æ€æ¡†
            closeBatchOperationModal();
            
            // é‡æ–°åŠ è½½æ›´è¡¨æ•°æ®
            renderCoachRoster(phone);
        } else {
            // å¦‚æœæ²¡æœ‰åç«¯APIï¼Œä½¿ç”¨å‰ç«¯æ¸…é™¤ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
            alert('æ‰¹é‡æ¸…é™¤åŠŸèƒ½éœ€è¦å¾Œç«¯æ”¯æŒï¼Œè«‹è¯ç¹«é–‹ç™¼äººå“¡ã€‚');
        }
    } catch (error) {
        console.error('æ‰¹é‡æ¸…é™¤å¤±æ•—:', error);
        alert(`æ‰¹é‡æ¸…é™¤å¤±æ•—ï¼š${error.message}`);
    }
}


/**
 * âœ… é€‰æ‹©ä¾‹å‡çš„æ˜ŸæœŸ
 */
function selectRegularLeaveWeekday(weekday) {
    regularLeaveWeekday = weekday;
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    document.querySelectorAll('.weekday-btn').forEach(btn => {
        const btnWeekday = parseInt(btn.getAttribute('data-weekday'));
        if (btnWeekday === weekday) {
            btn.style.borderColor = '#3b82f6';
            btn.style.background = '#dbeafe';
        } else {
            btn.style.borderColor = '#d1d5db';
            btn.style.background = '#fff';
        }
    });
    
    // è·å–æ—¥æœŸèŒƒå›´
    const startDate = document.getElementById('regularLeaveStartDate')?.value;
    const endDate = document.getElementById('regularLeaveEndDate')?.value;
    
    if (!startDate || !endDate) {
        alert('è«‹å…ˆé¸æ“‡æ—¥æœŸæ™‚é–“æ®µ');
        return;
    }
    
    regularLeaveDateRange.start = startDate;
    regularLeaveDateRange.end = endDate;
    
    // è®¡ç®—å¹¶é«˜äº®æ˜¾ç¤ºæ—¥æœŸ
    highlightRegularLeaveDates();
    
    // âœ… ç¡®ä¿æ—¥å†ç«‹å³æ›´æ–°æ˜¾ç¤º
    setTimeout(() => {
        updateBatchCalendarLeaveHighlight();
        updateLeaveHighlightInCalendar();
    }, 100);
}

/**
 * âœ… é«˜äº®æ˜¾ç¤ºä¾‹å‡æ—¥æœŸï¼ˆæ”¯æŒè·¨æœˆä»½ï¼‰
 */
function highlightRegularLeaveDates() {
    if (regularLeaveWeekday === null || !regularLeaveDateRange.start || !regularLeaveDateRange.end) {
        console.log('âš ï¸ highlightRegularLeaveDates ç¼ºå°‘å¿…è¦å‚æ•°:', {
            regularLeaveWeekday,
            start: regularLeaveDateRange.start,
            end: regularLeaveDateRange.end
        });
        return;
    }
    
    // è§£ææ—¥æœŸèŒƒå›´å­—ç¬¦ä¸²ï¼ˆYYYY-MM-DD æ ¼å¼ï¼‰
    const [startYear, startMonth, startDay] = regularLeaveDateRange.start.split('-').map(Number);
    const [endYear, endMonth, endDay] = regularLeaveDateRange.end.split('-').map(Number);
    
    const start = new Date(startYear, startMonth - 1, startDay);
    const end = new Date(endYear, endMonth - 1, endDay);
    
    // åˆå§‹åŒ–ä¾‹å‡æ—¥æœŸé›†åˆ
    if (!leaveDatesByType.has('regular')) {
        leaveDatesByType.set('regular', new Set());
    }
    const regularDates = leaveDatesByType.get('regular');
    
    // æ¸…ç©ºä¹‹å‰çš„ä¾‹å‡æ—¥æœŸï¼ˆé‡æ–°è®¡ç®—ï¼‰
    regularDates.clear();
    
    // éå†æ—¥æœŸèŒƒå›´ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯¹åº”æ˜ŸæœŸçš„æ—¥æœŸï¼ˆåŒ…æ‹¬è·¨æœˆä»½çš„æ—¥æœŸï¼‰
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() === regularLeaveWeekday) {
            const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            regularDates.add(dateStr);
        }
    }
    
    console.log('âœ… ä¾‹å‡æ—¥æœŸè®¡ç®—å®Œæˆ:', {
        weekday: regularLeaveWeekday,
        weekdayName: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][regularLeaveWeekday],
        dateRange: `${regularLeaveDateRange.start} è‡³ ${regularLeaveDateRange.end}`,
        totalDates: regularDates.size,
        dates: Array.from(regularDates).sort()
    });
    
    // âœ… æ›´æ–°å½“å‰æœˆä»½çš„æ—¥å†æ˜¾ç¤º
    updateLeaveHighlightInCalendar();
    
    // âœ… æ›´æ–°æ‰¹é‡æ“ä½œæ—¥å†ï¼ˆå½“å‰æœˆä»½ï¼‰
    const batchCalendar = document.getElementById('batchOperationCalendar');
    if (batchCalendar) {
        updateBatchCalendarLeaveHighlight();
    }
    
    // âœ… å¦‚æœæ—¥æœŸèŒƒå›´è·¨è¶Šäº†å…¶ä»–æœˆä»½ï¼Œéœ€è¦æ›´æ–°é‚£äº›æœˆä»½çš„æ˜¾ç¤º
    // è·å–å½“å‰æŸ¥çœ‹çš„æœˆä»½
    const monthSelect = document.getElementById('rosterMonth');
    let currentYear, currentMonth;
    if (monthSelect?.value) {
        const parts = monthSelect.value.split('-').map(Number);
        currentYear = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
        currentMonth = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
    } else {
        const now = new Date();
        currentYear = now.getFullYear();
        currentMonth = now.getMonth() + 1;
    }
    
    console.log('âœ… ä¾‹å‡æ—¥æœŸèŒƒå›´:', {
        start: `${startYear}-${String(startMonth).padStart(2, '0')}`,
        end: `${endYear}-${String(endMonth).padStart(2, '0')}`,
        current: `${currentYear}-${String(currentMonth).padStart(2, '0')}`,
        totalDates: regularDates.size
    });
}

/**
 * âœ… æ›´æ–°æ‰¹é‡æ“ä½œæ—¥å†ä¸­çš„å‡æœŸé«˜äº®
 */
function updateBatchCalendarLeaveHighlight() {
    // âœ… è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸»è¦ç”¨äºå¤„ç†"ä¾‹å‡"åŠŸèƒ½ï¼ˆregularLeaveWeekdayï¼‰
    // æ–°çš„æ—¥å†æ¸²æŸ“é€»è¾‘å·²ç»åœ¨ renderBatchCalendarForDateRange ä¸­å¤„ç†äº†é¢œè‰²æ˜¾ç¤º
    // å¦‚æœæ‰¹é‡æ“ä½œæ—¥å†ä½¿ç”¨çš„æ˜¯æ–°çš„æ—¥æœŸèŒƒå›´æ¨¡å¼ï¼Œåˆ™é‡æ–°ç”Ÿæˆæ—¥å†ä»¥åº”ç”¨æ­£ç¡®çš„é¢œè‰²
    
    const calendar = document.getElementById('batchOperationCalendar');
    if (!calendar) {
        console.log('âš ï¸ updateBatchCalendarLeaveHighlight: æ‰¾ä¸åˆ°æ—¥å†å®¹å™¨');
        return;
    }
    
    // âœ… å¦‚æœæ‰¹é‡æ“ä½œæ—¥å†ä½¿ç”¨çš„æ˜¯æ–°çš„æ—¥æœŸèŒƒå›´æ¨¡å¼ï¼Œåˆ™é‡æ–°ç”Ÿæˆæ—¥å†ä»¥åº”ç”¨æ­£ç¡®çš„é¢œè‰²
    if (batchDateRange.start && batchDateRange.end) {
        generateBatchOperationCalendarForDateRange();
        return;
    }
    
    // âœ… ä»¥ä¸‹ä»£ç ä¿ç•™ç”¨äºå…¼å®¹æ—§çš„ä¸»æ—¥å†ï¼ˆéæ‰¹é‡æ“ä½œæ—¥å†ï¼‰
    const days = calendar.querySelectorAll('.batch-calendar-day');
    if (days.length === 0) {
        console.log('âš ï¸ updateBatchCalendarLeaveHighlight: æ—¥å†ä¸­æ²¡æœ‰æ—¥æœŸå…ƒç´ ');
        return;
    }
    
    const monthSelect = document.getElementById('rosterMonth');
    let year, month;
    if (monthSelect?.value) {
        const parts = monthSelect.value.split('-').map(Number);
        year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
        month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
    } else {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
    }
    
    console.log('ğŸ”„ updateBatchCalendarLeaveHighlight å¼€å§‹:', { year, month, daysCount: days.length });
    
    // âœ… å…ˆæ¸…é™¤æ‰€æœ‰å‡æœŸæ ·å¼ï¼ˆåŒ…æ‹¬å†…è”æ ·å¼å’ŒCSSç±»ï¼‰
    days.forEach(dayEl => {
        dayEl.classList.remove('leave-regular', 'leave-annual', 'leave-maternity', 'leave-sick', 'leave-nopaid', 'leave-statutory');
        dayEl.classList.remove('batch-calendar-leave-selected', 'batch-calendar-leave-regular', 'batch-calendar-leave-annual', 
            'batch-calendar-leave-maternity', 'batch-calendar-leave-sick', 'batch-calendar-leave-nopaid', 'batch-calendar-leave-statutory');
        dayEl.style.background = '';
        dayEl.style.borderColor = '';
        dayEl.style.borderWidth = '';
        dayEl.style.borderStyle = '';
        dayEl.title = '';
    });
    
    // âœ… é«˜äº®æ˜ŸæœŸåˆ—ï¼ˆä¾‹å‡åŠŸèƒ½ï¼‰- å…ˆæ‰§è¡Œï¼Œç¡®ä¿ä¾‹å‡æ—¥æœŸè¢«æ·»åŠ åˆ° leaveDatesByType
    if (regularLeaveWeekday !== null && regularLeaveDateRange.start && regularLeaveDateRange.end) {
        const startDateStr = regularLeaveDateRange.start; // YYYY-MM-DD æ ¼å¼
        const endDateStr = regularLeaveDateRange.end; // YYYY-MM-DD æ ¼å¼
        
        console.log('ğŸ” æ£€æŸ¥ä¾‹å‡æ˜ŸæœŸåˆ—é«˜äº®:', {
            weekday: regularLeaveWeekday,
            weekdayName: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][regularLeaveWeekday],
            start: startDateStr,
            end: endDateStr,
            currentMonth: `${year}-${String(month).padStart(2, '0')}`
        });
        
        // è§£ææ—¥æœŸèŒƒå›´
        const [startYear, startMonth, startDay] = startDateStr.split('-').map(Number);
        const [endYear, endMonth, endDay] = endDateStr.split('-').map(Number);
        
        // âœ… æ£€æŸ¥å½“å‰æœˆä»½æ˜¯å¦åœ¨æ—¥æœŸèŒƒå›´å†…
        // ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—å½“å‰æœˆä»½çš„æœ€åä¸€å¤©
        const currentMonthStart = new Date(year, month - 1, 1);
        // âœ… ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è·å–å½“å‰æœˆä»½çš„æœ€åä¸€å¤©
        const currentMonthEnd = new Date(year, month, 0); // ä¸‹ä¸ªæœˆçš„ç¬¬0å¤© = å½“å‰æœˆä»½çš„æœ€åä¸€å¤©
        
        const rangeStart = new Date(startYear, startMonth - 1, startDay);
        const rangeEnd = new Date(endYear, endMonth - 1, endDay);
        
        // âœ… éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        const isValidDate = (date) => !isNaN(date.getTime());
        
        if (!isValidDate(currentMonthStart) || !isValidDate(currentMonthEnd) || 
            !isValidDate(rangeStart) || !isValidDate(rangeEnd)) {
            console.error('âŒ æ—¥æœŸæ— æ•ˆ:', {
                currentMonthStart: isValidDate(currentMonthStart) ? currentMonthStart.toISOString().split('T')[0] : 'INVALID',
                currentMonthEnd: isValidDate(currentMonthEnd) ? currentMonthEnd.toISOString().split('T')[0] : 'INVALID',
                rangeStart: isValidDate(rangeStart) ? rangeStart.toISOString().split('T')[0] : 'INVALID',
                rangeEnd: isValidDate(rangeEnd) ? rangeEnd.toISOString().split('T')[0] : 'INVALID',
                year, month, startYear, startMonth, startDay, endYear, endMonth, endDay
            });
            return;
        }
        
        console.log('ğŸ” æ—¥æœŸèŒƒå›´æ¯”è¾ƒï¼ˆæ‰¹é‡æ“ä½œæ—¥å†ï¼‰:', {
            currentMonth: `${year}-${String(month).padStart(2, '0')}`,
            currentMonthStart: currentMonthStart.toISOString().split('T')[0],
            currentMonthEnd: currentMonthEnd.toISOString().split('T')[0],
            rangeStart: rangeStart.toISOString().split('T')[0],
            rangeEnd: rangeEnd.toISOString().split('T')[0],
            condition1: currentMonthStart <= rangeEnd,
            condition2: currentMonthEnd >= rangeStart,
            willHighlight: currentMonthStart <= rangeEnd && currentMonthEnd >= rangeStart
        });
        
        // å¦‚æœå½“å‰æœˆä»½ä¸æ—¥æœŸèŒƒå›´æœ‰é‡å 
        if (currentMonthStart <= rangeEnd && currentMonthEnd >= rangeStart) {
            console.log('âœ… å½“å‰æœˆä»½åœ¨æ—¥æœŸèŒƒå›´å†…ï¼Œå¼€å§‹é«˜äº®æ˜ŸæœŸåˆ—');
            
            // é«˜äº®æ•´ä¸ªæ˜ŸæœŸåˆ—
            let highlightedCount = 0;
            days.forEach(dayEl => {
                const day = parseInt(dayEl.textContent);
                if (!day || isNaN(day)) return;
                
                const date = new Date(year, month - 1, day);
                const dateDayOfWeek = date.getDay();
                
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…é€‰æ‹©çš„æ˜ŸæœŸ
                if (dateDayOfWeek === regularLeaveWeekday) {
                    // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨æ—¥æœŸèŒƒå›´å†…ï¼ˆåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œä¸è€ƒè™‘æ—¶é—´ï¼‰
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dateObj = new Date(year, month - 1, day);
                    const rangeStartObj = new Date(startYear, startMonth - 1, startDay);
                    const rangeEndObj = new Date(endYear, endMonth - 1, endDay);
                    
                    // é‡ç½®æ—¶é—´éƒ¨åˆ†ä¸º0ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
                    dateObj.setHours(0, 0, 0, 0);
                    rangeStartObj.setHours(0, 0, 0, 0);
                    rangeEndObj.setHours(23, 59, 59, 999);
                    
                    if (dateObj >= rangeStartObj && dateObj <= rangeEndObj) {
                        // æ·»åŠ åˆ° leaveDatesByTypeï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                        if (!leaveDatesByType.has('regular')) {
                            leaveDatesByType.set('regular', new Set());
                        }
                        leaveDatesByType.get('regular').add(dateStr);
                        
                        // âœ… æ·»åŠ ä¾‹å‡æ ·å¼ï¼ˆåªä½¿ç”¨CSSç±»ï¼Œä¸ä½¿ç”¨å†…è”æ ·å¼è®¾ç½®è¾¹æ¡†ï¼‰
                        dayEl.classList.add('leave-regular', 'batch-calendar-leave-selected', 'batch-calendar-leave-regular');
                        highlightedCount++;
                        
                        console.log(`âœ… é«˜äº®æ—¥æœŸ: ${dateStr} (æ˜ŸæœŸ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dateDayOfWeek]})`);
                    }
                }
            });
            
            console.log(`âœ… æ˜ŸæœŸåˆ—é«˜äº®å®Œæˆï¼Œå…±é«˜äº® ${highlightedCount} ä¸ªæ—¥æœŸ`);
        } else {
            console.log('âš ï¸ å½“å‰æœˆä»½ä¸åœ¨æ—¥æœŸèŒƒå›´å†…');
        }
    }
    
    // âœ… æ”¶é›†è¯¥æ—¥æœŸæ‰€æœ‰å‡æœŸç±»å‹å¹¶åº”ç”¨æ ·å¼
    days.forEach(dayEl => {
        const day = parseInt(dayEl.textContent);
        if (!day || isNaN(day)) return;
        
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const leaveTypesForThisDate = [];
        
        // æ£€æŸ¥è¯¥æ—¥æœŸæœ‰å“ªäº›å‡æœŸç±»å‹
        for (let [leaveType, dates] of leaveDatesByType) {
            if (dates.has(dateStr)) {
                leaveTypesForThisDate.push(leaveType);
            }
        }
        
        // âœ… å¦‚æœæœ‰å‡æœŸï¼Œåº”ç”¨æ ·å¼ï¼ˆä¼˜å…ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªå‡æœŸç±»å‹çš„é¢œè‰²ï¼Œåªä½¿ç”¨CSSç±»ï¼Œä¸ä½¿ç”¨å†…è”æ ·å¼ï¼‰
        if (leaveTypesForThisDate.length > 0) {
            const primaryLeaveType = leaveTypesForThisDate[0];
            dayEl.classList.add(`leave-${primaryLeaveType}`, 'batch-calendar-leave-selected', `batch-calendar-leave-${primaryLeaveType}`);
            
            // âœ… å¦‚æœæœ‰å¤šä¸ªå‡æœŸç±»å‹ï¼Œæ·»åŠ æ ‡é¢˜æç¤º
            if (leaveTypesForThisDate.length > 1) {
                dayEl.title = `å‡æœŸç±»å‹: ${leaveTypesForThisDate.map(t => {
                    const names = { regular: 'ä¾‹å‡', annual: 'å¹´å‡', maternity: 'äº§å‡', sick: 'ç—…å‡', nopaid: 'No Paid', statutory: 'æ³•å®šåŠ³å·¥å‡' };
                    return names[t] || t;
                }).join(', ')}`;
            }
        }
    });
    
    console.log('âœ… updateBatchCalendarLeaveHighlight å®Œæˆ');
}

/**
 * âœ… æ›´æ–°ä¸»æ—¥å†ä¸­çš„å‡æœŸé«˜äº®
 */
function updateLeaveHighlightInCalendar() {
    const calendar = document.getElementById('staffRosterCalendars');
    if (!calendar) return;
    
    const cells = calendar.querySelectorAll('.cal-cell');
    const monthSelect = document.getElementById('rosterMonth');
    let year, month;
    if (monthSelect?.value) {
        const parts = monthSelect.value.split('-').map(Number);
        year = parts[0] && !isNaN(parts[0]) ? parts[0] : new Date().getFullYear();
        month = parts[1] && !isNaN(parts[1]) ? parts[1] : new Date().getMonth() + 1;
    } else {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
    }
    
    // âœ… å…ˆæ¸…é™¤æ‰€æœ‰å‡æœŸæ ·å¼
    cells.forEach(cell => {
        cell.classList.remove('leave-regular', 'leave-annual', 'leave-maternity', 'leave-sick', 'leave-nopaid', 'leave-statutory');
        cell.style.background = '';
        cell.style.borderColor = '';
        cell.style.borderWidth = '';
        cell.style.borderStyle = '';
    });
    
    // âœ… æ”¶é›†è¯¥æ—¥æœŸæ‰€æœ‰å‡æœŸç±»å‹å¹¶åº”ç”¨æ ·å¼
    cells.forEach(cell => {
        const dayElement = cell.querySelector('.cal-day');
        if (!dayElement) return;
        
        const day = parseInt(dayElement.textContent);
        if (!day || isNaN(day)) return;
        
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const leaveTypesForThisDate = [];
        
        // æ£€æŸ¥è¯¥æ—¥æœŸæœ‰å“ªäº›å‡æœŸç±»å‹
        for (let [leaveType, dates] of leaveDatesByType) {
            if (dates.has(dateStr)) {
                leaveTypesForThisDate.push(leaveType);
            }
        }
        
        // âœ… å¦‚æœæœ‰å‡æœŸï¼Œåº”ç”¨æ ·å¼ï¼ˆä¼˜å…ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªå‡æœŸç±»å‹çš„é¢œè‰²ï¼Œåªä½¿ç”¨CSSç±»ï¼Œä¸ä½¿ç”¨å†…è”æ ·å¼ï¼‰
        if (leaveTypesForThisDate.length > 0) {
            const primaryLeaveType = leaveTypesForThisDate[0];
            cell.classList.add(`leave-${primaryLeaveType}`);
            // âœ… ä¸ä½¿ç”¨å†…è”æ ·å¼ï¼Œè®©CSSç±»æ¥æ§åˆ¶é¢œè‰²
        }
    });
    
    // âœ… é«˜äº®æ˜ŸæœŸåˆ—ï¼ˆä¾‹å‡åŠŸèƒ½ï¼‰
    if (regularLeaveWeekday !== null && regularLeaveDateRange.start && regularLeaveDateRange.end) {
        const startDateStr = regularLeaveDateRange.start; // YYYY-MM-DD æ ¼å¼
        const endDateStr = regularLeaveDateRange.end; // YYYY-MM-DD æ ¼å¼
        
        // è§£ææ—¥æœŸèŒƒå›´
        const [startYear, startMonth, startDay] = startDateStr.split('-').map(Number);
        const [endYear, endMonth, endDay] = endDateStr.split('-').map(Number);
        
        // âœ… æ£€æŸ¥å½“å‰æœˆä»½æ˜¯å¦åœ¨æ—¥æœŸèŒƒå›´å†…
        // ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—å½“å‰æœˆä»½çš„æœ€åä¸€å¤©
        const currentMonthStart = new Date(year, month - 1, 1);
        // âœ… ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è·å–å½“å‰æœˆä»½çš„æœ€åä¸€å¤©
        const currentMonthEnd = new Date(year, month, 0); // ä¸‹ä¸ªæœˆçš„ç¬¬0å¤© = å½“å‰æœˆä»½çš„æœ€åä¸€å¤©
        
        const rangeStart = new Date(startYear, startMonth - 1, startDay);
        const rangeEnd = new Date(endYear, endMonth - 1, endDay);
        
        // âœ… éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        const isValidDate = (date) => !isNaN(date.getTime());
        
        if (!isValidDate(currentMonthStart) || !isValidDate(currentMonthEnd) || 
            !isValidDate(rangeStart) || !isValidDate(rangeEnd)) {
            console.error('âŒ æ—¥æœŸæ— æ•ˆï¼ˆä¸»æ—¥å†ï¼‰:', {
                currentMonthStart: isValidDate(currentMonthStart) ? currentMonthStart.toISOString().split('T')[0] : 'INVALID',
                currentMonthEnd: isValidDate(currentMonthEnd) ? currentMonthEnd.toISOString().split('T')[0] : 'INVALID',
                rangeStart: isValidDate(rangeStart) ? rangeStart.toISOString().split('T')[0] : 'INVALID',
                rangeEnd: isValidDate(rangeEnd) ? rangeEnd.toISOString().split('T')[0] : 'INVALID',
                year, month, startYear, startMonth, startDay, endYear, endMonth, endDay
            });
            return;
        }
        
        console.log('ğŸ” æ—¥æœŸèŒƒå›´æ¯”è¾ƒï¼ˆä¸»æ—¥å†ï¼‰:', {
            currentMonth: `${year}-${String(month).padStart(2, '0')}`,
            currentMonthStart: currentMonthStart.toISOString().split('T')[0],
            currentMonthEnd: currentMonthEnd.toISOString().split('T')[0],
            rangeStart: rangeStart.toISOString().split('T')[0],
            rangeEnd: rangeEnd.toISOString().split('T')[0],
            condition1: currentMonthStart <= rangeEnd,
            condition2: currentMonthEnd >= rangeStart,
            willHighlight: currentMonthStart <= rangeEnd && currentMonthEnd >= rangeStart
        });
        
        // å¦‚æœå½“å‰æœˆä»½ä¸æ—¥æœŸèŒƒå›´æœ‰é‡å 
        if (currentMonthStart <= rangeEnd && currentMonthEnd >= rangeStart) {
            // é«˜äº®æ•´ä¸ªæ˜ŸæœŸåˆ—
            cells.forEach(cell => {
                const dayElement = cell.querySelector('.cal-day');
                if (!dayElement) return;
                
                const day = parseInt(dayElement.textContent);
                if (!day || isNaN(day)) return;
                
                const date = new Date(year, month - 1, day);
                const dateDayOfWeek = date.getDay();
                
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…é€‰æ‹©çš„æ˜ŸæœŸ
                if (dateDayOfWeek === regularLeaveWeekday) {
                    // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨æ—¥æœŸèŒƒå›´å†…ï¼ˆåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œä¸è€ƒè™‘æ—¶é—´ï¼‰
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dateObj = new Date(year, month - 1, day);
                    const rangeStartObj = new Date(startYear, startMonth - 1, startDay);
                    const rangeEndObj = new Date(endYear, endMonth - 1, endDay);
                    
                    // é‡ç½®æ—¶é—´éƒ¨åˆ†ä¸º0ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
                    dateObj.setHours(0, 0, 0, 0);
                    rangeStartObj.setHours(0, 0, 0, 0);
                    rangeEndObj.setHours(23, 59, 59, 999);
                    
                    if (dateObj >= rangeStartObj && dateObj <= rangeEndObj) {
                        // æ·»åŠ åˆ° leaveDatesByTypeï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                        if (!leaveDatesByType.has('regular')) {
                            leaveDatesByType.set('regular', new Set());
                        }
                        leaveDatesByType.get('regular').add(dateStr);
                        
                        // æ·»åŠ ä¾‹å‡æ ·å¼
                        cell.classList.add('leave-regular');
                        cell.style.background = LEAVE_TYPE_COLORS['regular'] || '#fef3c7';
                        cell.style.borderColor = LEAVE_TYPE_BORDER_COLORS['regular'] || '#fbbf24';
                        cell.style.borderWidth = '2px';
                        cell.style.borderStyle = 'solid';
                    }
                }
            });
        }
    }
}


// å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
/**
 * é¸ä¸­æ‰¹é‡æ“ä½œæ—¥æ›†ä¸­æŸå€‹æ˜ŸæœŸåˆ—çš„æ‰€æœ‰æ—¥æœŸ
 */
// âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šselectBatchWeekdayColumn
// ç°åœ¨ä½¿ç”¨ toggleBatchWeekday æˆ– toggleBatchLeaveWeekday æ¥å¤„ç†æ˜ŸæœŸåˆ—é€‰æ‹©

window.openBatchOperationModal = openBatchOperationModal;
window.closeBatchOperationModal = closeBatchOperationModal;
window.handleBatchModalClick = handleBatchModalClick;
window.clearBatchSelection = clearBatchSelection;
window.selectWeekdays = selectWeekdays;
window.selectWeekends = selectWeekends;
window.removeBatchDate = removeBatchDate;
window.previewBatchOperation = previewBatchOperation;
window.executeBatchOperation = executeBatchOperation;
window.toggleBatchDateSelectionFromCalendar = toggleBatchDateSelectionFromCalendar;
// âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†å¯¼å‡º generateBatchOperationCalendar å’Œ selectBatchWeekdayColumn
window.selectLeaveType = selectLeaveType;
window.selectRegularLeaveWeekday = selectRegularLeaveWeekday;

/**
 * âœ… ä¾‹å‡æ—¥æœŸèŒƒå›´æ”¹å˜æ—¶çš„å¤„ç†
 */
function onRegularLeaveDateChange() {
    // å¦‚æœå·²ç»é€‰æ‹©äº†æ˜ŸæœŸï¼Œç«‹å³æ›´æ–°é«˜äº®
    if (regularLeaveWeekday !== null) {
        const startDate = document.getElementById('regularLeaveStartDate')?.value;
        const endDate = document.getElementById('regularLeaveEndDate')?.value;
        
        if (startDate && endDate) {
            regularLeaveDateRange.start = startDate;
            regularLeaveDateRange.end = endDate;
            highlightRegularLeaveDates();
        }
    }
}

window.onRegularLeaveDateChange = onRegularLeaveDateChange;

// ===== æ–°çš„æ‰¹é‡æ“ä½œåŠŸèƒ½ =====

/**
 * âœ… å¤„ç†æ—¥æœŸæ—¶é—´æ®µå˜åŒ–
 */
function onBatchDateRangeChange() {
    const startInput = document.getElementById('batchDateRangeStart');
    const endInput = document.getElementById('batchDateRangeEnd');
    const hintDiv = document.getElementById('batchDateRangeHint');
    const calendarSection = document.getElementById('batchCalendarSection');
    const operationTypeSection = document.getElementById('batchOperationTypeSection');
    
    if (!startInput || !endInput) return;
    
    const startDate = startInput.value;
    const endDate = endInput.value;
    
    // éªŒè¯æ—¥æœŸèŒƒå›´
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (start > end) {
            alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸï¼');
            endInput.value = '';
            return;
        }
        
        // ä¿å­˜æ—¥æœŸèŒƒå›´
        batchDateRange.start = startDate;
        batchDateRange.end = endDate;
        
        // âœ… æ—¥æœŸèŒƒå›´é€‰æ‹©å§‹ç»ˆæ˜¾ç¤ºï¼Œä¸éšè—ï¼ˆæ–¹ä¾¿åç»­ä¿®æ”¹ï¼‰
        // âœ… æ˜¾ç¤ºæ“ä½œç±»å‹é€‰æ‹©ï¼ˆæ—¥å†å’Œè®¾ç½®å†…å®¹ç­‰é€‰æ‹©æ“ä½œç±»å‹åå†æ˜¾ç¤ºï¼‰
        if (hintDiv) {
            hintDiv.style.display = 'block'; // âœ… ä¿æŒæ˜¾ç¤ºï¼Œä¸éšè—
        }
        if (operationTypeSection) {
            operationTypeSection.classList.remove('hidden');
            operationTypeSection.style.display = 'block';
        }
        
        // âœ… ä¸ç«‹å³æ˜¾ç¤ºæ—¥å†ï¼Œç­‰ç”¨æˆ·é€‰æ‹©æ“ä½œç±»å‹åå†æ˜¾ç¤º
        // å¦‚æœå·²ç»é€‰æ‹©äº†æ“ä½œç±»å‹ï¼Œåˆ™æ˜¾ç¤ºæ—¥å†
        if (batchOperationType === 'work') {
            if (calendarSection) {
                calendarSection.classList.remove('hidden');
                calendarSection.style.display = 'block';
            }
            const workSettings = document.getElementById('batchWorkSettings');
            if (workSettings) {
                workSettings.classList.remove('hidden');
                workSettings.style.display = 'block';
            }
            // ç”Ÿæˆæ—¥å†ï¼ˆæ”¯æŒå¤šæœˆä»½ï¼‰
            generateBatchOperationCalendarForDateRange();
        } else if (batchOperationType === 'leave' && currentLeaveType) {
            // å¦‚æœå·²ç»é€‰æ‹©äº†è¯·å‡ç±»å‹å’Œå‡æœŸç±»å‹ï¼Œåˆ™æ˜¾ç¤ºæ—¥å†å’Œè¯·å‡è®¾ç½®
            const leaveTypeSection = document.getElementById('batchLeaveTypeSection');
            if (leaveTypeSection) {
                leaveTypeSection.classList.remove('hidden');
                leaveTypeSection.style.display = 'block';
            }
            if (calendarSection) {
                calendarSection.classList.remove('hidden');
                calendarSection.style.display = 'block';
            }
            const leaveSettings = document.getElementById('batchLeaveSettings');
            if (leaveSettings) {
                leaveSettings.classList.remove('hidden');
                leaveSettings.style.display = 'block';
            }
            // ç”Ÿæˆæ—¥å†ï¼ˆæ”¯æŒå¤šæœˆä»½ï¼‰
            generateBatchOperationCalendarForDateRange();
        }
    } else {
        // å¦‚æœæ—¥æœŸä¸å®Œæ•´ï¼Œéšè—åç»­æ­¥éª¤
        if (calendarSection) calendarSection.classList.add('hidden');
        if (operationTypeSection) operationTypeSection.classList.add('hidden');
        if (hintDiv) hintDiv.style.display = 'block';
    }
}

/**
 * âœ… ä¸ºæ—¥æœŸèŒƒå›´ç”Ÿæˆæ—¥å†ï¼ˆæ”¯æŒå¤šæœˆä»½ï¼‰
 */
function generateBatchOperationCalendarForDateRange() {
    const calendarContainer = document.getElementById('batchOperationCalendar');
    if (!calendarContainer || !batchDateRange.start || !batchDateRange.end) return;
    
    const start = new Date(batchDateRange.start);
    const end = new Date(batchDateRange.end);
    
    // è·å–å½“å‰é€‰æ‹©çš„å‘˜å·¥
    const coachSelect = document.getElementById('staffCoachSelect');
    const selectedPhone = coachSelect?.value || '';
    if (!selectedPhone) return;
    
    let employeeName = '';
    if (coachSelect && coachSelect.options) {
        const selectedOption = Array.from(coachSelect.options).find(opt => opt.value === selectedPhone);
        if (selectedOption) {
            employeeName = selectedOption.textContent || selectedOption.text || '';
        }
    }
    
    // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„æœˆä»½
    const monthsToShow = [];
    let currentMonth = new Date(start.getFullYear(), start.getMonth(), 1);
    const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
    
    while (currentMonth <= endMonth) {
        monthsToShow.push({
            year: currentMonth.getFullYear(),
            month: currentMonth.getMonth() + 1
        });
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
    }
    
    // å¦‚æœæ²¡æœ‰å½“å‰æ˜¾ç¤ºçš„æœˆä»½ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœˆä»½
    if (!batchCurrentDisplayMonth && monthsToShow.length > 0) {
        batchCurrentDisplayMonth = monthsToShow[0];
    }
    
    // ç”Ÿæˆæ—¥å†HTML
    let html = '';
    
    // å¦‚æœæœ‰å¤šä¸ªæœˆä»½ï¼Œæ˜¾ç¤ºå·¦å³ç®­å¤´
    if (monthsToShow.length > 1) {
        const currentIndex = monthsToShow.findIndex(m => 
            m.year === batchCurrentDisplayMonth.year && m.month === batchCurrentDisplayMonth.month
        );
        
        html += `<div class="batch-calendar-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">`;
        if (currentIndex > 0) {
            html += `<button type="button" class="btn-secondary" onclick="batchNavigateMonth(-1)" style="padding: 8px 16px;">
                <i class="fas fa-chevron-left"></i> ä¸Šä¸€æœˆ
            </button>`;
        } else {
            html += `<div></div>`;
        }
        
        html += `<div style="font-weight: 600; font-size: 16px;">${batchCurrentDisplayMonth.year}å¹´${batchCurrentDisplayMonth.month}æœˆ</div>`;
        
        if (currentIndex < monthsToShow.length - 1) {
            html += `<button type="button" class="btn-secondary" onclick="batchNavigateMonth(1)" style="padding: 8px 16px;">
                ä¸‹ä¸€æœˆ <i class="fas fa-chevron-right"></i>
            </button>`;
        } else {
            html += `<div></div>`;
        }
        html += `</div>`;
    }
    
    // ç”Ÿæˆå½“å‰æœˆä»½çš„æ—¥å†
    if (batchCurrentDisplayMonth) {
        html += renderBatchCalendarForDateRange(
            batchCurrentDisplayMonth.year, 
            batchCurrentDisplayMonth.month, 
            start, 
            end,
            employeeName
        );
    }
    
    calendarContainer.innerHTML = html;
    
    // åº”ç”¨å·²é€‰æ‹©çš„æ—¥æœŸé«˜äº®
    updateBatchCalendarSelection();
}

/**
 * âœ… æ¸²æŸ“æŒ‡å®šæœˆä»½çš„æ—¥å†ï¼ˆå¸¦æ—¥æœŸèŒƒå›´é™åˆ¶ï¼‰
 */
function renderBatchCalendarForDateRange(year, month, rangeStart, rangeEnd, employeeName = '') {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    
    let html = `<div class="batch-calendar-header">`;
    if (employeeName) {
        html += `<div style="margin-bottom: 4px; font-size: 14px; color: #6b7280; font-weight: 500;">å“¡å·¥ï¼š${employeeName}</div>`;
    }
    html += `</div>`;
    
    html += `<div class="batch-calendar-grid">`;
    
    // âœ… æ£€æŸ¥æ‰€æœ‰å¡«å……æ—¶æ®µçš„æ˜ŸæœŸé€‰æ‹©ï¼Œç¡®å®šå“ªäº›æ˜ŸæœŸåˆ—éœ€è¦é«˜äº®
    const selectedWeekdays = new Set();
    const selectedWeekdaysBySlot = new Map(); // è·Ÿè¸ªæ¯ä¸ªæ˜ŸæœŸåˆ—è¢«å“ªä¸ªå¡«å……æ—¶æ®µé€‰ä¸­ {weekday: [slotIndex1, slotIndex2, ...]}
    if (batchOperationType === 'work') {
        const fillSlotConfigs = collectBatchFillSlotConfigs();
        fillSlotConfigs.forEach(config => {
            if (config.weekdays && config.weekdays.length > 0) {
                config.weekdays.forEach(weekday => {
                    selectedWeekdays.add(weekday);
                    if (!selectedWeekdaysBySlot.has(weekday)) {
                        selectedWeekdaysBySlot.set(weekday, []);
                    }
                    selectedWeekdaysBySlot.get(weekday).push(config.slotIndex);
                });
            }
        });
    } else if (batchOperationType === 'leave' && currentLeaveType) {
        // è¯·å‡æ¨¡å¼ï¼šæ£€æŸ¥è¯·å‡æ˜ŸæœŸé€‰æ‹©
        batchLeaveSelectedWeekdays.forEach(weekday => selectedWeekdays.add(weekday));
    }
    
    // æ˜ŸæœŸæ ‡é¢˜ï¼ˆé«˜äº®é€‰ä¸­çš„æ˜ŸæœŸåˆ—ï¼Œå½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µçš„æ˜ŸæœŸåˆ—é«˜äº®ï¼Œå…¶ä»–å˜æ·¡ï¼‰
    weekdays.forEach((day, index) => {
        const isWeekdaySelected = selectedWeekdays.has(index);
        const weekdayClass = isWeekdaySelected ? 'batch-calendar-weekday batch-calendar-weekday-selected' : 'batch-calendar-weekday';
        // âœ… æ£€æŸ¥è¯¥æ˜ŸæœŸåˆ—æ˜¯å¦è¢«å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­
        let isCurrentSlotSelected = false;
        if (batchOperationType === 'work' && selectedWeekdaysBySlot.has(index)) {
            const slotIndices = selectedWeekdaysBySlot.get(index);
            isCurrentSlotSelected = slotIndices.includes(currentActiveSlotIndex);
        }
        // âœ… å¦‚æœè¢«å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œé«˜äº®æ˜¾ç¤ºï¼›å¦‚æœè¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œå˜æ·¡æ˜¾ç¤º
        let weekdayStyle = '';
        if (isWeekdaySelected) {
            if (isCurrentSlotSelected) {
                weekdayStyle = 'background: #eff6ff; color: #1e40af; font-weight: 600; opacity: 1;';
            } else if (batchOperationType === 'work' && selectedWeekdaysBySlot.has(index)) {
                weekdayStyle = 'background: #eff6ff; color: #1e40af; font-weight: 500; opacity: 0.5;';
            } else {
                weekdayStyle = 'background: #eff6ff; color: #1e40af; font-weight: 600;';
            }
        }
        html += `<div class="${weekdayClass}" style="${weekdayStyle}">${day}</div>`;
    });
    
    // å¡«å……å¼€å§‹å‰çš„ç©ºç™½
    for (let i = 0; i < startDayOfWeek; i++) {
        html += `<div class="batch-calendar-day batch-calendar-empty"></div>`;
    }
    
    // ç”Ÿæˆæ—¥æœŸ
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dateObj = new Date(dateStr);
        
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨èŒƒå›´å†…
        const isInRange = dateObj >= rangeStart && dateObj <= rangeEnd;
        
        // âœ… æ£€æŸ¥è¯¥æ—¥æœŸè¢«å“ªä¸ªç±»å‹å ç”¨ï¼ˆåŒä¸€æ—¥æœŸåªèƒ½è¢«ä¸€ä¸ªç±»å‹é€‰æ‹©ï¼‰
        const isWorkSelected = batchWorkSelectedDates.has(dateStr);
        let isLeaveSelected = false;
        let leaveTypeForDate = null;
        
        // æ£€æŸ¥æ‰€æœ‰è¯·å‡ç±»å‹çš„é€‰ä¸­çŠ¶æ€ï¼ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå ç”¨çš„ç±»å‹ï¼‰
        for (let [leaveType, dates] of leaveDatesByType) {
            if (dates.has(dateStr)) {
                isLeaveSelected = true;
                leaveTypeForDate = leaveType;
                break;
            }
        }
        
        // âœ… å½“å‰æ“ä½œç±»å‹çš„é€‰ä¸­çŠ¶æ€ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦å¯ä»¥ç‚¹å‡»åˆ‡æ¢ï¼‰
        let isCurrentTypeSelected = false;
        let selectedBySlotIndex = null; // è¢«å“ªä¸ªå¡«å……æ—¶æ®µé€‰ä¸­ï¼ˆå·¥ä½œæ¨¡å¼ï¼‰
        if (batchOperationType === 'work') {
            const weekday = dateObj.getDay();
            
            // âœ… 1. æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦è¢«æŸä¸ªå¡«å……æ—¶æ®µå•ç‹¬é€‰æ‹©ï¼ˆselectedDatesï¼‰
            for (let i = 0; i < batchFillTimeSlots.length; i++) {
                if (batchFillTimeSlots[i].selectedDates && batchFillTimeSlots[i].selectedDates.has(dateStr)) {
                    selectedBySlotIndex = i;
                    break;
                }
            }
            
            // âœ… 2. å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦é€šè¿‡æŸä¸ªå¡«å……æ—¶æ®µçš„æ˜ŸæœŸåˆ—é€‰æ‹©è¢«é€‰ä¸­
            // æ³¨æ„ï¼šç”±äº toggleBatchSlotWeekday å·²ç»å°†æ˜ŸæœŸåˆ—é€‰æ‹©çš„æ—¥æœŸæ·»åŠ åˆ° selectedDates ä¸­ï¼Œ
            // æ‰€ä»¥è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä½œä¸ºå¤‡ç”¨æ£€æŸ¥ï¼Œä»¥é˜²æŸäº›æƒ…å†µä¸‹ selectedDates æ²¡æœ‰æ­£ç¡®æ›´æ–°
            if (selectedBySlotIndex === null && isWorkSelected && isInRange) {
                // ç›´æ¥æ£€æŸ¥ batchFillTimeSlots æ•°ç»„ä¸­çš„ weekdays
                for (let i = 0; i < batchFillTimeSlots.length; i++) {
                    if (batchFillTimeSlots[i].weekdays && batchFillTimeSlots[i].weekdays.includes(weekday)) {
                        // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨æ—¥æœŸèŒƒå›´å†…ï¼Œå¹¶ä¸”æ˜ŸæœŸåŒ¹é…
                        // å¦‚æœè¯¥æ—¥æœŸåœ¨ batchWorkSelectedDates ä¸­ï¼Œå¹¶ä¸”æ˜ŸæœŸåŒ¹é…ï¼Œåˆ™è®¤ä¸ºæ˜¯è¯¥å¡«å……æ—¶æ®µé€šè¿‡æ˜ŸæœŸåˆ—é€‰æ‹©çš„
                        selectedBySlotIndex = i;
                        break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„å¡«å……æ—¶æ®µï¼ˆå¦‚æœæœ‰å¤šä¸ªå¡«å……æ—¶æ®µé€‰æ‹©äº†åŒä¸€ä¸ªæ˜ŸæœŸåˆ—ï¼Œä¼˜å…ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªï¼‰
                    }
                }
            }
            
            // âœ… å¦‚æœè¢«å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œåˆ™é«˜äº®æ˜¾ç¤º
            if (selectedBySlotIndex === currentActiveSlotIndex) {
                isCurrentTypeSelected = true;
            } else if (selectedBySlotIndex !== null) {
                // å¦‚æœè¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œåˆ™å˜æ·¡æ˜¾ç¤º
                isCurrentTypeSelected = false;
            } else if (isWorkSelected) {
                // å¦‚æœåªæ˜¯è¢«å·¥ä½œæ¨¡å¼é€‰ä¸­ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å¡«å……æ—¶æ®µï¼Œåˆ™é«˜äº®æ˜¾ç¤ºï¼ˆå¯èƒ½æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼é€‰æ‹©çš„ï¼‰
                isCurrentTypeSelected = true;
            }
        } else if (batchOperationType === 'leave' && currentLeaveType) {
            if (leaveDatesByType.has(currentLeaveType)) {
                isCurrentTypeSelected = leaveDatesByType.get(currentLeaveType).has(dateStr);
            }
        }
        
        // âœ… æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦è¢«å…¶ä»–ç±»å‹å ç”¨ï¼ˆä¸æ˜¯å½“å‰æ“ä½œç±»å‹ï¼‰
        let isOccupiedByOtherType = false;
        let occupiedTypeName = '';
        if (batchOperationType === 'work' && isLeaveSelected) {
            isOccupiedByOtherType = true;
            const leaveTypeNames = { 
                regular: 'ä¾‹å‡', 
                annual: 'å¹´å‡', 
                maternity: 'äº§å‡', 
                sick: 'ç—…å‡', 
                nopaid: 'No Paid', 
                statutory: 'æ³•å®šåŠ³å·¥å‡' 
            };
            occupiedTypeName = leaveTypeNames[leaveTypeForDate] || leaveTypeForDate;
        } else if (batchOperationType === 'leave' && currentLeaveType) {
            if (isWorkSelected) {
                isOccupiedByOtherType = true;
                occupiedTypeName = 'å·¥ä½œæ¨¡å¼';
            } else if (isLeaveSelected && leaveTypeForDate !== currentLeaveType) {
                isOccupiedByOtherType = true;
                const leaveTypeNames = { 
                    regular: 'ä¾‹å‡', 
                    annual: 'å¹´å‡', 
                    maternity: 'äº§å‡', 
                    sick: 'ç—…å‡', 
                    nopaid: 'No Paid', 
                    statutory: 'æ³•å®šåŠ³å·¥å‡' 
                };
                occupiedTypeName = leaveTypeNames[leaveTypeForDate] || leaveTypeForDate;
            }
        }
        
        const weekday = date.getDay();
        const isWeekend = weekday === 0 || weekday === 6;
        
        // âœ… æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦å±äºé€‰ä¸­çš„æ˜ŸæœŸåˆ—
        const isWeekdaySelected = selectedWeekdays.has(weekday);
        
        let classes = 'batch-calendar-day';
        if (isWeekend) classes += ' batch-calendar-weekend';
        
        // âœ… æ¯ä¸ªæ—¥æœŸæ ¼å­å§‹ç»ˆæ˜¾ç¤ºå®ƒå®é™…è¢«å“ªä¸ªç±»å‹é€‰æ‹©çš„é¢œè‰²
        // 1. å…ˆç¡®å®šæ—¥æœŸå®é™…è¢«å“ªä¸ªç±»å‹é€‰æ‹©ï¼ˆä»æ•°æ®ä¸­æŸ¥æ‰¾ï¼‰
        // 2. å¦‚æœè¢«å½“å‰æ“ä½œç±»å‹é€‰æ‹©ï¼Œåˆ™é«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
        // 3. å¦‚æœè¢«å…¶ä»–ç±»å‹é€‰æ‹©ï¼Œåˆ™å˜æ·¡æ˜¾ç¤ºï¼ˆé™ä½é€æ˜åº¦ï¼‰
        
        if (isWorkSelected) {
            // è¢«å·¥ä½œæ¨¡å¼é€‰ä¸­ï¼šæ˜¾ç¤ºå·¥ä½œæ¨¡å¼é¢œè‰²
            classes += ' batch-calendar-work-selected';
            // âœ… å¦‚æœè¢«å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­ï¼ˆå•ç‹¬é€‰æ‹©æˆ–é€šè¿‡æ˜ŸæœŸåˆ—é€‰æ‹©ï¼‰ï¼Œé«˜äº®æ˜¾ç¤ºï¼›å¦‚æœè¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼Œå˜æ·¡æ˜¾ç¤º
            if (selectedBySlotIndex === currentActiveSlotIndex) {
                // å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µé€‰ä¸­ï¼šé«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
                classes += ' batch-calendar-current-selected';
            } else if (selectedBySlotIndex !== null) {
                // è¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­ï¼šå˜æ·¡æ˜¾ç¤º
                classes += ' batch-calendar-occupied';
            } else if (isCurrentTypeSelected) {
                // é€šè¿‡å…¶ä»–æ–¹å¼é€‰ä¸­ï¼ˆå¯èƒ½æ˜¯é€šè¿‡å…¨å±€æ˜ŸæœŸé€‰æ‹©ï¼‰ï¼šé«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
                classes += ' batch-calendar-current-selected';
            } else {
                // å…¶ä»–æƒ…å†µï¼šå˜æ·¡æ˜¾ç¤º
                classes += ' batch-calendar-occupied';
            }
        } else if (isLeaveSelected && leaveTypeForDate) {
            // è¢«è¯·å‡ç±»å‹é€‰ä¸­ï¼šæ˜¾ç¤ºè¯¥è¯·å‡ç±»å‹çš„é¢œè‰²
            classes += ' batch-calendar-leave-selected';
            classes += ` batch-calendar-leave-${leaveTypeForDate}`;
            if (isCurrentTypeSelected && currentLeaveType === leaveTypeForDate) {
                // å½“å‰æ“ä½œç±»å‹æ˜¯è¯¥è¯·å‡ç±»å‹ï¼šé«˜äº®æ˜¾ç¤ºï¼ˆå®Œæ•´é¢œè‰²ï¼‰
                classes += ' batch-calendar-current-selected';
            } else {
                // å½“å‰æ“ä½œç±»å‹ä¸æ˜¯è¯¥è¯·å‡ç±»å‹ï¼šå˜æ·¡æ˜¾ç¤º
                classes += ' batch-calendar-occupied';
            }
        }
        
        if (isWeekdaySelected && isInRange) classes += ' batch-calendar-weekday-selected-day'; // é«˜äº®é€‰ä¸­æ˜ŸæœŸåˆ—çš„æ—¥æœŸ
        if (!isInRange) classes += ' batch-calendar-disabled';
        
        // âœ… æ·»åŠ  title æç¤ºï¼Œæ˜¾ç¤ºè¢«å“ªä¸ªç±»å‹å ç”¨ï¼ˆæç¤ºç”¨æˆ·å¯ä»¥ç‚¹å‡»åˆ‡æ¢ï¼‰
        const titleAttr = isOccupiedByOtherType && !isCurrentTypeSelected ? ` title="å·²è¢«${occupiedTypeName}é€‰æ‹©ï¼Œç‚¹å‡»å¯åˆ‡æ¢"` : '';
        
        // âœ… æ‰€æœ‰åœ¨èŒƒå›´å†…çš„æ—¥æœŸéƒ½å¯ä»¥ç‚¹å‡»ï¼ˆåŒ…æ‹¬è¢«å…¶ä»–ç±»å‹å ç”¨çš„æ—¥æœŸï¼‰
        const canClick = isInRange;
        
        // âœ… ä¸è®¾ç½®å†…è”æ ·å¼ï¼Œè®©CSSç±»æ¥æ§åˆ¶é¢œè‰²å’Œé€æ˜åº¦
        const inlineStyle = !isInRange ? 'opacity: 0.4; cursor: not-allowed; background: #f3f4f6;' : '';
        
        html += `<div class="${classes}" 
            data-day="${day}" 
            data-date="${dateStr}"
            ${canClick ? `onclick="toggleBatchDateSelectionFromCalendar(${day}, this)"` : ''}
            ${titleAttr}
            ${inlineStyle ? `style="${inlineStyle}"` : ''}>
            ${day}
        </div>`;
    }
    
    html += `</div>`;
    
    return html;
}

/**
 * âœ… åˆ‡æ¢æœˆä»½å¯¼èˆª
 */
function batchNavigateMonth(direction) {
    if (!batchDateRange.start || !batchDateRange.end) return;
    
    const start = new Date(batchDateRange.start);
    const end = new Date(batchDateRange.end);
    
    // è®¡ç®—æ‰€æœ‰éœ€è¦æ˜¾ç¤ºçš„æœˆä»½
    const monthsToShow = [];
    let currentMonth = new Date(start.getFullYear(), start.getMonth(), 1);
    const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
    
    while (currentMonth <= endMonth) {
        monthsToShow.push({
            year: currentMonth.getFullYear(),
            month: currentMonth.getMonth() + 1
        });
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
    }
    
    const currentIndex = monthsToShow.findIndex(m => 
        m.year === batchCurrentDisplayMonth.year && m.month === batchCurrentDisplayMonth.month
    );
    
    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < monthsToShow.length) {
        batchCurrentDisplayMonth = monthsToShow[newIndex];
        generateBatchOperationCalendarForDateRange();
    }
}

/**
 * âœ… é€‰æ‹©æ“ä½œç±»å‹ï¼ˆå·¥ä½œ/è¯·å‡ï¼‰
 */
function selectBatchOperationType(type) {
    batchOperationType = type;
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    const workBtn = document.getElementById('batchOperationTypeWork');
    const leaveBtn = document.getElementById('batchOperationTypeLeave');
    
    if (workBtn && leaveBtn) {
        if (type === 'work') {
            workBtn.style.borderColor = '#3b82f6';
            workBtn.style.background = '#eff6ff';
            workBtn.style.color = '#3b82f6';
            leaveBtn.style.borderColor = '#d1d5db';
            leaveBtn.style.background = '#fff';
            leaveBtn.style.color = '#6b7280';
            
            // âœ… æ˜¾ç¤ºæ—¥å†ï¼ˆåœ¨é€‰æ‹©æ“ä½œç±»å‹åæ˜¾ç¤ºï¼‰
            const calendarSection = document.getElementById('batchCalendarSection');
            if (calendarSection) {
                calendarSection.classList.remove('hidden');
                calendarSection.style.display = 'block';
            }
            
            // âœ… æ˜¾ç¤ºå·¥ä½œè®¾ç½®ï¼ˆåœ¨æ—¥å†ä¹‹åï¼‰
            const workSettings = document.getElementById('batchWorkSettings');
            const leaveSettings = document.getElementById('batchLeaveSettings');
            const leaveTypeSection = document.getElementById('batchLeaveTypeSection');
            if (workSettings) {
                workSettings.classList.remove('hidden');
                workSettings.style.display = 'block';
            }
            if (leaveSettings) {
                leaveSettings.classList.add('hidden');
                leaveSettings.style.display = 'none';
            }
            if (leaveTypeSection) {
                leaveTypeSection.classList.add('hidden');
                leaveTypeSection.style.display = 'none';
            }
            
            // ç”Ÿæˆæ—¥å†ï¼ˆæ”¯æŒå¤šæœˆä»½ï¼‰
            generateBatchOperationCalendarForDateRange();
            
            // âœ… ç¡®ä¿ç¬¬ä¸€ä¸ªå¡«å……æ—¶æ®µå­˜åœ¨ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
            setTimeout(() => {
                const firstSlot = document.querySelector('.batch-fill-time-slot[data-slot-index="0"]');
                if (!firstSlot) {
                    // å¦‚æœç¬¬ä¸€ä¸ªå¡«å……æ—¶æ®µä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                    addBatchFillTimeSlot();
                } else {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨å’Œåœ°ç‚¹é€‰é¡¹
                    const startHourSelects = firstSlot.querySelectorAll('.batch-time-start-hour');
                    const locationSelects = firstSlot.querySelectorAll('.batch-location-select');
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼ˆæ—¶é—´é€‰æ‹©å™¨æ˜¯å¦æœ‰é€‰é¡¹ï¼Œåœ°ç‚¹é€‰æ‹©å™¨æ˜¯å¦æœ‰é€‰é¡¹ï¼‰
                    const needsInit = startHourSelects.length > 0 && startHourSelects[0].options.length <= 1;
                    if (needsInit) {
                        initializeBatchTimeSelectorsForSlot(0);
                        loadBatchLocationOptionsForSlot(0);
                    }
                }
                
                // âœ… æ›´æ–°ç¡®è®¤æ‰§è¡ŒæŒ‰é’®çŠ¶æ€
                updateBatchExecuteButtonState();
            }, 100);
        } else if (type === 'leave') {
            leaveBtn.style.borderColor = '#3b82f6';
            leaveBtn.style.background = '#eff6ff';
            leaveBtn.style.color = '#3b82f6';
            workBtn.style.borderColor = '#d1d5db';
            workBtn.style.background = '#fff';
            workBtn.style.color = '#6b7280';
            
            // âœ… æ˜¾ç¤ºå‡æœŸç±»å‹é€‰æ‹©ï¼ˆåœ¨æ—¥å†ä¹‹å‰ï¼‰
            const leaveTypeSection = document.getElementById('batchLeaveTypeSection');
            if (leaveTypeSection) {
                leaveTypeSection.classList.remove('hidden');
                leaveTypeSection.style.display = 'block';
            }
            
            // âœ… éšè—å·¥ä½œè®¾ç½®ï¼Œéšè—è¯·å‡è®¾ç½®ï¼ˆç­‰é€‰æ‹©å‡æœŸç±»å‹åå†æ˜¾ç¤ºï¼‰
            const workSettings = document.getElementById('batchWorkSettings');
            const leaveSettings = document.getElementById('batchLeaveSettings');
            if (workSettings) {
                workSettings.classList.add('hidden');
                workSettings.style.display = 'none';
            }
            if (leaveSettings) {
                leaveSettings.classList.add('hidden');
                leaveSettings.style.display = 'none';
            }
            
            // âœ… æ˜¾ç¤ºæ—¥å†ï¼ˆåœ¨é€‰æ‹©æ“ä½œç±»å‹åæ˜¾ç¤ºï¼‰
            const calendarSection = document.getElementById('batchCalendarSection');
            if (calendarSection) {
                calendarSection.classList.remove('hidden');
                calendarSection.style.display = 'block';
            }
            
            // âœ… é‡æ–°ç”Ÿæˆæ—¥å†ä»¥æ›´æ–°é«˜äº®æ˜¾ç¤º
            generateBatchOperationCalendarForDateRange();
        }
    }
    
    // âœ… é‡æ–°ç”Ÿæˆæ—¥å†ä»¥æ›´æ–°é«˜äº®æ˜¾ç¤ºï¼ˆç¡®ä¿åˆ‡æ¢ç±»å‹æ—¶æ­£ç¡®æ˜¾ç¤ºï¼‰
    generateBatchOperationCalendarForDateRange();
    
    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    updateBatchExecuteButtonState();
}

/**
 * âœ… åˆ‡æ¢æ˜ŸæœŸé€‰æ‹©ï¼ˆå·¥ä½œæ¨¡å¼ï¼‰
 */
function toggleBatchWeekday(weekday) {
    const btn = document.querySelector(`.batch-weekday-btn[data-weekday="${weekday}"]`);
    if (!btn) return;
    
    const isSelected = batchSelectedWeekdays.has(weekday);
    
    // âœ… ç§»é™¤å†²çªæ£€æŸ¥ï¼šå…è®¸åˆ‡æ¢æ˜ŸæœŸåˆ—ï¼ˆä¼šå…ˆå–æ¶ˆå…¶ä»–ç±»å‹ï¼Œå†è®¾ç½®ä¸ºå½“å‰ç±»å‹ï¼‰
    
    if (isSelected) {
        batchSelectedWeekdays.delete(weekday);
        btn.style.borderColor = '#d1d5db';
        btn.style.background = '#fff';
        // âœ… æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–å·¥ä½œæ¨¡å¼çš„æ˜ŸæœŸé€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ¸…é™¤è·Ÿè¸ªçŠ¶æ€
        const allWorkBtns = document.querySelectorAll(`.batch-weekday-btn[data-weekday="${weekday}"]`);
        let hasOtherSelection = false;
        allWorkBtns.forEach(b => {
            if (b !== btn && (b.style.borderColor === 'rgb(59, 130, 246)' || b.style.borderColor === '#3b82f6' || 
                b.style.background === 'rgb(239, 246, 255)' || b.style.background === '#eff6ff')) {
                hasOtherSelection = true;
            }
        });
        // ä¹Ÿæ£€æŸ¥å·¥ä½œæ¨¡å¼çš„å¡«å……æ—¶æ®µæ˜ŸæœŸé€‰æ‹©
        const allSlotBtns = document.querySelectorAll(`.batch-slot-weekday-btn[data-weekday="${weekday}"]`);
        allSlotBtns.forEach(b => {
            if (b.style.borderColor === 'rgb(59, 130, 246)' || b.style.borderColor === '#3b82f6' || 
                b.style.background === 'rgb(239, 246, 255)' || b.style.background === '#eff6ff') {
                hasOtherSelection = true;
            }
        });
        if (!hasOtherSelection) {
            weekdaySelectionByType.delete(weekday);
        }
    } else {
        batchSelectedWeekdays.add(weekday);
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#eff6ff';
        // âœ… æ ‡è®°è¯¥æ˜ŸæœŸåˆ—è¢«å·¥ä½œæ¨¡å¼é€‰æ‹©
        weekdaySelectionByType.set(weekday, 'work');
    }
    
    // âœ… æ ¹æ®é€‰ä¸­çš„æ˜ŸæœŸè‡ªåŠ¨é€‰æ‹©æ—¥æœŸèŒƒå›´å†…çš„å¯¹åº”æ—¥æœŸï¼ˆå­˜å‚¨å®Œæ•´æ—¥æœŸå­—ç¬¦ä¸²ï¼‰
    if (batchDateRange.start && batchDateRange.end) {
        const start = new Date(batchDateRange.start);
        const end = new Date(batchDateRange.end);
        const current = new Date(start);
        
        while (current <= end) {
            if (current.getDay() === weekday) {
                const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                if (isSelected) {
                    // å–æ¶ˆé€‰æ‹©ï¼šç§»é™¤æ—¥æœŸï¼ˆåªç§»é™¤å·¥ä½œæ¨¡å¼çš„æ—¥æœŸï¼‰
                    batchWorkSelectedDates.delete(dateStr);
                } else {
                    // âœ… é€‰æ‹©ï¼šå¦‚æœè¢«å…¶ä»–ç±»å‹å ç”¨ï¼Œå…ˆå–æ¶ˆå…¶ä»–ç±»å‹ï¼Œå†è®¾ç½®ä¸ºå·¥ä½œæ¨¡å¼
                    // æ£€æŸ¥æ˜¯å¦è¢«è¯·å‡ç±»å‹å ç”¨
                    for (let [leaveType, dates] of leaveDatesByType) {
                        if (dates.has(dateStr)) {
                            // å–æ¶ˆè¯·å‡ç±»å‹çš„å ç”¨
                            dates.delete(dateStr);
                            if (dates.size === 0) {
                                leaveDatesByType.delete(leaveType);
                            }
                        }
                    }
                    // è®¾ç½®ä¸ºå·¥ä½œæ¨¡å¼
                    batchWorkSelectedDates.add(dateStr);
                }
            }
            current.setDate(current.getDate() + 1);
        }
        
        // âœ… æ›´æ–°æ—¥å†æ˜¾ç¤ºï¼ˆé‡æ–°ç”Ÿæˆæ‰€æœ‰æœˆä»½çš„æ—¥å†ï¼‰
        generateBatchOperationCalendarForDateRange();
    }
    
    updateBatchSelectionDisplay();
    updateBatchExecuteButtonState();
}

/**
 * âœ… åˆ‡æ¢æ˜ŸæœŸé€‰æ‹©ï¼ˆè¯·å‡æ¨¡å¼ï¼‰
 */
function toggleBatchLeaveWeekday(weekday) {
    const btn = document.querySelector(`.batch-leave-weekday-btn[data-weekday="${weekday}"]`);
    if (!btn) return;
    
    // âœ… æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
    const isSelected = batchLeaveSelectedWeekdays.has(weekday);
    
    // âœ… ç§»é™¤å†²çªæ£€æŸ¥ï¼šå…è®¸åˆ‡æ¢æ˜ŸæœŸåˆ—ï¼ˆä¼šå…ˆå–æ¶ˆå…¶ä»–ç±»å‹ï¼Œå†è®¾ç½®ä¸ºå½“å‰ç±»å‹ï¼‰
    
    if (isSelected) {
        batchLeaveSelectedWeekdays.delete(weekday);
        btn.style.borderColor = '#d1d5db';
        btn.style.background = '#fff';
        // âœ… æ¸…é™¤è·Ÿè¸ªçŠ¶æ€
        weekdaySelectionByType.delete(weekday);
    } else {
        batchLeaveSelectedWeekdays.add(weekday);
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#eff6ff';
        // âœ… æ ‡è®°è¯¥æ˜ŸæœŸåˆ—è¢«è¯·å‡æ¨¡å¼é€‰æ‹©
        weekdaySelectionByType.set(weekday, 'leave');
    }
    
    // âœ… æ ¹æ®é€‰ä¸­çš„æ˜ŸæœŸè‡ªåŠ¨é€‰æ‹©æ—¥æœŸèŒƒå›´å†…çš„å¯¹åº”æ—¥æœŸï¼ˆæˆ–ç§»é™¤ï¼‰
    if (batchDateRange.start && batchDateRange.end && currentLeaveType) {
        const start = new Date(batchDateRange.start);
        const end = new Date(batchDateRange.end);
        const current = new Date(start);
        
        if (!leaveDatesByType.has(currentLeaveType)) {
            leaveDatesByType.set(currentLeaveType, new Set());
        }
        
        while (current <= end) {
            if (current.getDay() === weekday) {
                const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                if (isSelected) {
                    // å–æ¶ˆé€‰ä¸­æ˜ŸæœŸæ—¶ï¼Œç§»é™¤æ—¥æœŸï¼ˆåªç§»é™¤å½“å‰å‡æœŸç±»å‹çš„æ—¥æœŸï¼‰
                    leaveDatesByType.get(currentLeaveType).delete(dateStr);
                } else {
                    // âœ… é€‰ä¸­æ˜ŸæœŸæ—¶ï¼šå¦‚æœè¢«å…¶ä»–ç±»å‹å ç”¨ï¼Œå…ˆå–æ¶ˆå…¶ä»–ç±»å‹ï¼Œå†è®¾ç½®ä¸ºå½“å‰è¯·å‡ç±»å‹
                    // æ£€æŸ¥æ˜¯å¦è¢«å·¥ä½œæ¨¡å¼å ç”¨
                    if (batchWorkSelectedDates.has(dateStr)) {
                        // å–æ¶ˆå·¥ä½œæ¨¡å¼çš„å ç”¨
                        batchWorkSelectedDates.delete(dateStr);
                    }
                    // æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–è¯·å‡ç±»å‹å ç”¨
                    for (let [leaveType, dates] of leaveDatesByType) {
                        if (leaveType !== currentLeaveType && dates.has(dateStr)) {
                            // å–æ¶ˆå…¶ä»–è¯·å‡ç±»å‹çš„å ç”¨
                            dates.delete(dateStr);
                            if (dates.size === 0) {
                                leaveDatesByType.delete(leaveType);
                            }
                        }
                    }
                    // è®¾ç½®ä¸ºå½“å‰è¯·å‡ç±»å‹
                    leaveDatesByType.get(currentLeaveType).add(dateStr);
                }
            }
            current.setDate(current.getDate() + 1);
        }
        
        // âœ… æ›´æ–°æ—¥å†æ˜¾ç¤ºï¼ˆé‡æ–°ç”Ÿæˆæ‰€æœ‰æœˆä»½çš„æ—¥å†ï¼‰
        generateBatchOperationCalendarForDateRange();
        updateBatchCalendarLeaveHighlight();
    }
    
    updateBatchSelectionDisplay();
    updateBatchExecuteButtonState();
}

/**
 * âœ… æ·»åŠ å¡«å……æ—¶æ®µ
 */
function addBatchFillTimeSlot() {
    const container = document.getElementById('batchFillTimeSlotsContainer');
    if (!container) return;
    
    const slotIndex = batchFillTimeSlots.length;
    batchFillTimeSlots.push({
        slot1: { time: '', location: '' },
        slot2: { time: '', location: '' },
        slot3: { time: '', location: '' },
        weekdays: [],
        selectedDates: new Set() // âœ… æ¯ä¸ªå¡«å……æ—¶æ®µç‹¬ç«‹è·Ÿè¸ªå•ç‹¬é€‰æ‹©çš„æ—¥æœŸ
    });
    
    // âœ… è®¾ç½®æ–°æ·»åŠ çš„å¡«å……æ—¶æ®µä¸ºå½“å‰æ´»åŠ¨æ—¶æ®µ
    currentActiveSlotIndex = slotIndex;
    
    const slotDiv = document.createElement('div');
    slotDiv.className = 'batch-fill-time-slot';
    slotDiv.setAttribute('data-slot-index', slotIndex);
    // âœ… æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè®¾ç½®å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µ
    slotDiv.addEventListener('click', function(e) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–è¾“å…¥æ¡†ï¼Œä¸æ”¹å˜æ´»åŠ¨æ—¶æ®µ
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' ||
            e.target.closest('button') || e.target.closest('input') || e.target.closest('select')) {
            return;
        }
        currentActiveSlotIndex = slotIndex;
        // âœ… æ›´æ–°æ‰€æœ‰å¡«å……æ—¶æ®µçš„è§†è§‰æ ‡è¯†ï¼ˆé«˜äº®å½“å‰æ´»åŠ¨æ—¶æ®µï¼‰
        document.querySelectorAll('.batch-fill-time-slot').forEach((slot, idx) => {
            if (idx === slotIndex) {
                slot.style.border = '2px solid #3b82f6';
                slot.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
            } else {
                slot.style.border = '1px solid #e5e7eb';
                slot.style.boxShadow = 'none';
            }
        });
        // âœ… æ›´æ–°æ‰€æœ‰å¡«å……æ—¶æ®µçš„æ˜ŸæœŸåˆ—æŒ‰é’®æ ·å¼ï¼ˆå½“å‰æ´»åŠ¨æ—¶æ®µé«˜äº®ï¼Œå…¶ä»–å˜æ·¡ï¼‰
        document.querySelectorAll('.batch-slot-weekday-btn').forEach(btn => {
            const btnSlotIndex = parseInt(btn.getAttribute('data-slot-index'));
            const isSelected = btn.style.borderColor === 'rgb(59, 130, 246)' || btn.style.borderColor === '#3b82f6' || 
                             btn.style.background === 'rgb(239, 246, 255)' || btn.style.background === '#eff6ff';
            if (isSelected) {
                if (btnSlotIndex === slotIndex) {
                    // å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µï¼šé«˜äº®æ˜¾ç¤º
                    btn.style.borderColor = '#3b82f6';
                    btn.style.background = '#eff6ff';
                    btn.style.opacity = '1';
                    btn.style.fontWeight = '600';
                } else {
                    // å…¶ä»–å¡«å……æ—¶æ®µï¼šå˜æ·¡æ˜¾ç¤º
                    btn.style.borderColor = '#3b82f6';
                    btn.style.background = '#eff6ff';
                    btn.style.opacity = '0.5';
                    btn.style.fontWeight = '500';
                }
            }
        });
        // âœ… é‡æ–°ç”Ÿæˆæ—¥å†ä»¥æ›´æ–°é¢œè‰²æ˜¾ç¤º
        generateBatchOperationCalendarForDateRange();
    });
    slotDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h5 style="margin: 0;">å¡«å……æ—¶æ®µ ${slotIndex + 1}</h5>
            <button type="button" class="btn-secondary btn-sm" onclick="removeBatchFillTimeSlot(${slotIndex})">åˆ é™¤</button>
        </div>
        
        <!-- é€‰æ‹©æ˜ŸæœŸåˆ—ï¼ˆæ¯ä¸ªå¡«å……æ—¶æ®µç‹¬ç«‹ï¼‰ -->
        <div class="form-group" style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">é€‰æ‹©æ˜ŸæœŸï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ç›´æ¥ç‚¹å‡»æ—¥å†é€‰æ‹©ï¼‰ï¼š</label>
            <div class="batch-weekday-selector" data-slot-index="${slotIndex}" style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button type="button" class="batch-slot-weekday-btn" data-weekday="0" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(0, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">æ—¥</button>
                <button type="button" class="batch-slot-weekday-btn" data-weekday="1" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(1, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">ä¸€</button>
                <button type="button" class="batch-slot-weekday-btn" data-weekday="2" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(2, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">äºŒ</button>
                <button type="button" class="batch-slot-weekday-btn" data-weekday="3" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(3, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">ä¸‰</button>
                <button type="button" class="batch-slot-weekday-btn" data-weekday="4" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(4, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">å››</button>
                <button type="button" class="batch-slot-weekday-btn" data-weekday="5" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(5, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">äº”</button>
                <button type="button" class="batch-slot-weekday-btn" data-weekday="6" data-slot-index="${slotIndex}" onclick="toggleBatchSlotWeekday(6, ${slotIndex})" style="padding: 10px 18px; border: 2px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 500;">å…­</button>
            </div>
        </div>
        
        <div class="batch-time-location-settings">
            <div class="batch-slot-setting">
                <h6 style="margin: 0 0 8px 0; font-size: 14px;">ä¸Šåˆæ—¶æ®µè®¾ç½®</h6>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px;">æ—¶é—´ï¼š</label>
                    <div class="time-selector-group" style="display: flex; gap: 8px; align-items: center;">
                        <select class="batch-time-start-hour form-control" style="width: 80px;" data-slot="1" data-slot-index="${slotIndex}">
                            <option value="">æ™‚</option>
                        </select>
                        <span>:</span>
                        <select class="batch-time-start-min form-control" style="width: 80px;" data-slot="1" data-slot-index="${slotIndex}">
                            <option value="">åˆ†</option>
                        </select>
                        <span>-</span>
                        <select class="batch-time-end-hour form-control" style="width: 80px;" data-slot="1" data-slot-index="${slotIndex}">
                            <option value="">æ™‚</option>
                        </select>
                        <span>:</span>
                        <select class="batch-time-end-min form-control" style="width: 80px;" data-slot="1" data-slot-index="${slotIndex}">
                            <option value="">åˆ†</option>
                        </select>
                        <input type="hidden" class="batch-time-value" data-slot="1" data-slot-index="${slotIndex}">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px;">åœ°ç‚¹ï¼š</label>
                    <select class="batch-location-select form-control" data-slot="1" data-slot-index="${slotIndex}">
                        <option value="">è¯·é€‰æ‹©åœ°ç‚¹</option>
                    </select>
                </div>
            </div>
            <div class="batch-slot-setting">
                <h6 style="margin: 0 0 8px 0; font-size: 14px;">ä¸­åˆæ—¶æ®µè®¾ç½®</h6>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px;">æ—¶é—´ï¼š</label>
                    <div class="time-selector-group" style="display: flex; gap: 8px; align-items: center;">
                        <select class="batch-time-start-hour form-control" style="width: 80px;" data-slot="2" data-slot-index="${slotIndex}">
                            <option value="">æ™‚</option>
                        </select>
                        <span>:</span>
                        <select class="batch-time-start-min form-control" style="width: 80px;" data-slot="2" data-slot-index="${slotIndex}">
                            <option value="">åˆ†</option>
                        </select>
                        <span>-</span>
                        <select class="batch-time-end-hour form-control" style="width: 80px;" data-slot="2" data-slot-index="${slotIndex}">
                            <option value="">æ™‚</option>
                        </select>
                        <span>:</span>
                        <select class="batch-time-end-min form-control" style="width: 80px;" data-slot="2" data-slot-index="${slotIndex}">
                            <option value="">åˆ†</option>
                        </select>
                        <input type="hidden" class="batch-time-value" data-slot="2" data-slot-index="${slotIndex}">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px;">åœ°ç‚¹ï¼š</label>
                    <select class="batch-location-select form-control" data-slot="2" data-slot-index="${slotIndex}">
                        <option value="">è¯·é€‰æ‹©åœ°ç‚¹</option>
                    </select>
                </div>
            </div>
            <div class="batch-slot-setting">
                <h6 style="margin: 0 0 8px 0; font-size: 14px;">ä¸‹åˆæ—¶æ®µè®¾ç½®</h6>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px;">æ—¶é—´ï¼š</label>
                    <div class="time-selector-group" style="display: flex; gap: 8px; align-items: center;">
                        <select class="batch-time-start-hour form-control" style="width: 80px;" data-slot="3" data-slot-index="${slotIndex}">
                            <option value="">æ™‚</option>
                        </select>
                        <span>:</span>
                        <select class="batch-time-start-min form-control" style="width: 80px;" data-slot="3" data-slot-index="${slotIndex}">
                            <option value="">åˆ†</option>
                        </select>
                        <span>-</span>
                        <select class="batch-time-end-hour form-control" style="width: 80px;" data-slot="3" data-slot-index="${slotIndex}">
                            <option value="">æ™‚</option>
                        </select>
                        <span>:</span>
                        <select class="batch-time-end-min form-control" style="width: 80px;" data-slot="3" data-slot-index="${slotIndex}">
                            <option value="">åˆ†</option>
                        </select>
                        <input type="hidden" class="batch-time-value" data-slot="3" data-slot-index="${slotIndex}">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 4px;">åœ°ç‚¹ï¼š</label>
                    <select class="batch-location-select form-control" data-slot="3" data-slot-index="${slotIndex}">
                        <option value="">è¯·é€‰æ‹©åœ°ç‚¹</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(slotDiv);
    
    // âœ… å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå¡«å……æ—¶æ®µï¼Œè®¾ç½®ä¸ºæ´»åŠ¨çŠ¶æ€
    if (slotIndex === 0) {
        slotDiv.style.border = '2px solid #3b82f6';
        slotDiv.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
        currentActiveSlotIndex = 0;
    } else {
        slotDiv.style.border = '1px solid #e5e7eb';
        slotDiv.style.boxShadow = 'none';
    }
    
    // âœ… æ›´æ–°æ‰€æœ‰å¡«å……æ—¶æ®µçš„æ˜ŸæœŸåˆ—æŒ‰é’®æ ·å¼ï¼ˆå½“å‰æ´»åŠ¨æ—¶æ®µé«˜äº®ï¼Œå…¶ä»–å˜æ·¡ï¼‰
    setTimeout(() => {
        document.querySelectorAll('.batch-slot-weekday-btn').forEach(btn => {
            const btnSlotIndex = parseInt(btn.getAttribute('data-slot-index'));
            const isSelected = btn.style.borderColor === 'rgb(59, 130, 246)' || btn.style.borderColor === '#3b82f6' || 
                             btn.style.background === 'rgb(239, 246, 255)' || btn.style.background === '#eff6ff';
            if (isSelected) {
                if (btnSlotIndex === currentActiveSlotIndex) {
                    // å½“å‰æ´»åŠ¨å¡«å……æ—¶æ®µï¼šé«˜äº®æ˜¾ç¤º
                    btn.style.opacity = '1';
                    btn.style.fontWeight = '600';
                } else {
                    // å…¶ä»–å¡«å……æ—¶æ®µï¼šå˜æ·¡æ˜¾ç¤º
                    btn.style.opacity = '0.5';
                    btn.style.fontWeight = '500';
                }
            }
        });
    }, 100);
    
    // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨å’Œåœ°ç‚¹é€‰é¡¹
    initializeBatchTimeSelectorsForSlot(slotIndex);
    loadBatchLocationOptionsForSlot(slotIndex);
    
    // âœ… é‡æ–°ç”Ÿæˆæ—¥å†ä»¥æ›´æ–°é¢œè‰²æ˜¾ç¤º
    generateBatchOperationCalendarForDateRange();
}

/**
 * âœ… åˆ é™¤å¡«å……æ—¶æ®µ
 */
function removeBatchFillTimeSlot(slotIndex) {
    const slotDiv = document.querySelector(`.batch-fill-time-slot[data-slot-index="${slotIndex}"]`);
    if (slotDiv) {
        // âœ… æ¸…ç†è¯¥å¡«å……æ—¶æ®µçš„ selectedDatesï¼ˆä» batchWorkSelectedDates ä¸­ç§»é™¤ï¼‰
        if (batchFillTimeSlots[slotIndex] && batchFillTimeSlots[slotIndex].selectedDates) {
            batchFillTimeSlots[slotIndex].selectedDates.forEach(dateStr => {
                // æ£€æŸ¥æ˜¯å¦è¿˜è¢«å…¶ä»–å¡«å……æ—¶æ®µé€‰ä¸­
                let stillSelected = false;
                for (let i = 0; i < batchFillTimeSlots.length; i++) {
                    if (i !== slotIndex && batchFillTimeSlots[i].selectedDates && 
                        batchFillTimeSlots[i].selectedDates.has(dateStr)) {
                        stillSelected = true;
                        break;
                    }
                }
                // æ£€æŸ¥æ˜¯å¦è¢«ä»»ä½•æ—¶æ®µçš„æ˜ŸæœŸé€‰æ‹©é€‰ä¸­
                for (let i = 0; i < batchFillTimeSlots.length; i++) {
                    if (i !== slotIndex && batchFillTimeSlots[i].weekdays && batchFillTimeSlots[i].weekdays.length > 0) {
                        const dateObj = new Date(dateStr);
                        const weekday = dateObj.getDay();
                        if (batchFillTimeSlots[i].weekdays.includes(weekday)) {
                            if (batchDateRange.start && batchDateRange.end) {
                                const start = new Date(batchDateRange.start);
                                const end = new Date(batchDateRange.end);
                                if (dateObj >= start && dateObj <= end) {
                                    stillSelected = true;
                                    break;
                                }
                            }
                        }
                    }
                }
                if (!stillSelected) {
                    batchWorkSelectedDates.delete(dateStr);
                }
            });
        }
        
        slotDiv.remove();
        batchFillTimeSlots.splice(slotIndex, 1);
        
        // âœ… å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ´»åŠ¨æ—¶æ®µï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæ—¶æ®µ
        if (currentActiveSlotIndex === slotIndex) {
            currentActiveSlotIndex = 0;
        } else if (currentActiveSlotIndex > slotIndex) {
            // å¦‚æœåˆ é™¤çš„æ—¶æ®µåœ¨å½“å‰æ´»åŠ¨æ—¶æ®µä¹‹å‰ï¼Œéœ€è¦è°ƒæ•´ç´¢å¼•
            currentActiveSlotIndex--;
        }
        
        // é‡æ–°ç¼–å·
        document.querySelectorAll('.batch-fill-time-slot').forEach((div, index) => {
            div.setAttribute('data-slot-index', index);
            const title = div.querySelector('h5');
            if (title) title.textContent = `å¡«å……æ—¶æ®µ ${index + 1}`;
        });
        
        // âœ… æ›´æ–°æ´»åŠ¨æ—¶æ®µçš„è§†è§‰æ ‡è¯†
        document.querySelectorAll('.batch-fill-time-slot').forEach((slot, idx) => {
            if (idx === currentActiveSlotIndex) {
                slot.style.border = '2px solid #3b82f6';
                slot.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
            } else {
                slot.style.border = '1px solid #e5e7eb';
                slot.style.boxShadow = 'none';
            }
        });
        
        // âœ… é‡æ–°ç”Ÿæˆæ—¥å†ä»¥æ›´æ–°é¢œè‰²æ˜¾ç¤º
        generateBatchOperationCalendarForDateRange();
    }
}

/**
 * âœ… æ›´æ–°ç¡®è®¤æ‰§è¡ŒæŒ‰é’®çŠ¶æ€
 */
function updateBatchExecuteButtonState() {
    const executeBtn = document.getElementById('batchExecuteBtn');
    if (!executeBtn) return;
    
    let canExecute = false;
    
    if (batchOperationType === 'work') {
        // âœ… å·¥ä½œæ¨¡å¼ï¼šéœ€è¦è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¥æœŸï¼ˆåŒ…æ‹¬é€šè¿‡æ˜ŸæœŸé…ç½®ç”Ÿæˆçš„æ—¥æœŸï¼‰ï¼Œä¸”æœ‰å¡«å……æ—¶æ®µé…ç½®
        const fillSlotConfigs = collectBatchFillSlotConfigs();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥æœŸï¼ˆåŒ…æ‹¬ç›´æ¥é€‰æ‹©çš„æ—¥æœŸå’Œé€šè¿‡æ˜ŸæœŸé…ç½®ç”Ÿæˆçš„æ—¥æœŸï¼‰
        let hasDates = batchWorkSelectedDates.size > 0;
        
        // âœ… å¦‚æœé…ç½®äº†æ˜ŸæœŸï¼Œæ£€æŸ¥æ˜¯å¦ä¼šåœ¨æ—¥æœŸèŒƒå›´å†…ç”Ÿæˆæ—¥æœŸ
        if (!hasDates && fillSlotConfigs.length > 0 && batchDateRange.start && batchDateRange.end) {
            fillSlotConfigs.forEach(fillSlot => {
                if (fillSlot.weekdays && fillSlot.weekdays.length > 0) {
                    // æ£€æŸ¥æ—¥æœŸèŒƒå›´å†…æ˜¯å¦æœ‰åŒ¹é…çš„æ˜ŸæœŸ
                    const start = new Date(batchDateRange.start);
                    const end = new Date(batchDateRange.end);
                    const current = new Date(start);
                    
                    while (current <= end) {
                        const weekday = current.getDay();
                        if (fillSlot.weekdays.includes(weekday)) {
                            hasDates = true;
                            return; // æ‰¾åˆ°åŒ¹é…çš„æ—¥æœŸï¼Œé€€å‡ºå¾ªç¯
                        }
                        current.setDate(current.getDate() + 1);
                    }
                }
            });
        }
        
        // âœ… æ£€æŸ¥å¡«å……æ—¶æ®µé…ç½®æ˜¯å¦æœ‰æ•ˆï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªæ—¶æ®µæœ‰æ—¶é—´å’Œåœ°ç‚¹ï¼‰
        let hasValidConfig = false;
        fillSlotConfigs.forEach(config => {
            if (config.selectedSlots.length > 0) {
                // æ£€æŸ¥é€‰ä¸­çš„æ—¶æ®µæ˜¯å¦æœ‰æ—¶é—´å’Œåœ°ç‚¹
                if (config.selectedSlots.includes(1) && config.slot1 && config.slot1.time && config.slot1.location) {
                    hasValidConfig = true;
                }
                if (config.selectedSlots.includes(2) && config.slot2 && config.slot2.time && config.slot2.location) {
                    hasValidConfig = true;
                }
                if (config.selectedSlots.includes(3) && config.slot3 && config.slot3.time && config.slot3.location) {
                    hasValidConfig = true;
                }
            }
        });
        
        canExecute = hasDates && hasValidConfig;
    } else if (batchOperationType === 'leave') {
        // è¯·å‡æ¨¡å¼ï¼šéœ€è¦é€‰æ‹©å‡æœŸç±»å‹å’Œè‡³å°‘ä¸€ä¸ªæ—¥æœŸ
        let hasDates = false;
        if (leaveDatesByType.has(currentLeaveType) && leaveDatesByType.get(currentLeaveType).size > 0) {
            hasDates = true;
        } else if (batchLeaveSelectedWeekdays.size > 0) {
            hasDates = true;
        }
        canExecute = currentLeaveType !== null && hasDates;
    } else if (batchOperationType === 'clear') {
        // âœ… æ¸…é™¤æ¨¡å¼ï¼šéœ€è¦è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¥æœŸï¼ˆä½¿ç”¨æ–°çš„é€»è¾‘ï¼‰
        const hasWorkDates = batchWorkSelectedDates.size > 0;
        let hasLeaveDates = false;
        leaveDatesByType.forEach((dates) => {
            if (dates.size > 0) hasLeaveDates = true;
        });
        canExecute = hasWorkDates || hasLeaveDates;
    }
    
    executeBtn.disabled = !canExecute;
    
    // âœ… è°ƒè¯•æ—¥å¿—
    if (batchOperationType === 'work') {
        let hasDatesForLog = batchWorkSelectedDates.size > 0;
        const fillSlotConfigs = collectBatchFillSlotConfigs();
        if (!hasDatesForLog && fillSlotConfigs.length > 0 && batchDateRange.start && batchDateRange.end) {
            fillSlotConfigs.forEach(fillSlot => {
                if (fillSlot.weekdays && fillSlot.weekdays.length > 0) {
                    const start = new Date(batchDateRange.start);
                    const end = new Date(batchDateRange.end);
                    const current = new Date(start);
                    while (current <= end) {
                        const weekday = current.getDay();
                        if (fillSlot.weekdays.includes(weekday)) {
                            hasDatesForLog = true;
                            return;
                        }
                        current.setDate(current.getDate() + 1);
                    }
                }
            });
        }
        console.log('ğŸ” æ›´æ–°æŒ‰é’®çŠ¶æ€:', {
            batchOperationType,
            batchWorkSelectedDatesSize: batchWorkSelectedDates.size,
            leaveDatesByTypeSize: Array.from(leaveDatesByType.values()).reduce((sum, dates) => sum + dates.size, 0),
            hasDates: hasDatesForLog,
            fillSlotConfigsCount: collectBatchFillSlotConfigs().length,
            canExecute
        });
    }
}

/**
 * âœ… ä¸ºæŒ‡å®šå¡«å……æ—¶æ®µåˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
 */
function initializeBatchTimeSelectorsForSlot(slotIndex) {
    const slotDiv = document.querySelector(`.batch-fill-time-slot[data-slot-index="${slotIndex}"]`);
    if (!slotDiv) return;
    
    // è·å–æ‰€æœ‰æ—¶é—´é€‰æ‹©å™¨
    const startHourSelects = slotDiv.querySelectorAll('.batch-time-start-hour');
    const startMinSelects = slotDiv.querySelectorAll('.batch-time-start-min');
    const endHourSelects = slotDiv.querySelectorAll('.batch-time-end-hour');
    const endMinSelects = slotDiv.querySelectorAll('.batch-time-end-min');
    const timeInputs = slotDiv.querySelectorAll('.batch-time-value');
    
    // å¡«å……å°æ—¶é€‰é¡¹ï¼ˆ0-23ï¼‰
    startHourSelects.forEach(select => {
        if (select.options.length <= 1) {
            for (let h = 0; h < 24; h++) {
                const option = document.createElement('option');
                option.value = String(h).padStart(2, '0');
                option.textContent = String(h).padStart(2, '0');
                select.appendChild(option);
            }
        }
    });
    
    endHourSelects.forEach(select => {
        if (select.options.length <= 1) {
            for (let h = 0; h < 24; h++) {
                const option = document.createElement('option');
                option.value = String(h).padStart(2, '0');
                option.textContent = String(h).padStart(2, '0');
                select.appendChild(option);
            }
        }
    });
    
    // å¡«å……åˆ†é’Ÿé€‰é¡¹ï¼ˆ0-59ï¼Œæ¯5åˆ†é’Ÿä¸€ä¸ªï¼‰
    startMinSelects.forEach(select => {
        if (select.options.length <= 1) {
            for (let m = 0; m < 60; m += 5) {
                const option = document.createElement('option');
                option.value = String(m).padStart(2, '0');
                option.textContent = String(m).padStart(2, '0');
                select.appendChild(option);
            }
        }
    });
    
    endMinSelects.forEach(select => {
        if (select.options.length <= 1) {
            for (let m = 0; m < 60; m += 5) {
                const option = document.createElement('option');
                option.value = String(m).padStart(2, '0');
                option.textContent = String(m).padStart(2, '0');
                select.appendChild(option);
            }
        }
    });
    
    // ç»‘å®šæ—¶é—´é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
    startHourSelects.forEach((select, index) => {
        select.addEventListener('change', function() {
            updateBatchTimeValue(slotIndex, parseInt(this.dataset.slot));
        });
    });
    
    startMinSelects.forEach((select, index) => {
        select.addEventListener('change', function() {
            updateBatchTimeValue(slotIndex, parseInt(this.dataset.slot));
        });
    });
    
    endHourSelects.forEach((select, index) => {
        select.addEventListener('change', function() {
            updateBatchTimeValue(slotIndex, parseInt(this.dataset.slot));
        });
    });
    
    endMinSelects.forEach((select, index) => {
        select.addEventListener('change', function() {
            updateBatchTimeValue(slotIndex, parseInt(this.dataset.slot));
        });
    });
}

/**
 * âœ… æ›´æ–°æ‰¹é‡æ—¶é—´å€¼
 */
function updateBatchTimeValue(slotIndex, slot) {
    const slotDiv = document.querySelector(`.batch-fill-time-slot[data-slot-index="${slotIndex}"]`);
    if (!slotDiv) return;
    
    const startHour = slotDiv.querySelector(`.batch-time-start-hour[data-slot="${slot}"]`)?.value || '';
    const startMin = slotDiv.querySelector(`.batch-time-start-min[data-slot="${slot}"]`)?.value || '';
    const endHour = slotDiv.querySelector(`.batch-time-end-hour[data-slot="${slot}"]`)?.value || '';
    const endMin = slotDiv.querySelector(`.batch-time-end-min[data-slot="${slot}"]`)?.value || '';
    const timeInput = slotDiv.querySelector(`.batch-time-value[data-slot="${slot}"]`);
    
    if (startHour && startMin && endHour && endMin) {
        const timeValue = `${startHour}:${startMin}-${endHour}:${endMin}`;
        if (timeInput) timeInput.value = timeValue;
        
        // æ›´æ–° batchFillTimeSlots
        if (batchFillTimeSlots[slotIndex]) {
            const slotKey = `slot${slot}`;
            if (batchFillTimeSlots[slotIndex][slotKey]) {
                batchFillTimeSlots[slotIndex][slotKey].time = timeValue;
            }
        }
        
        // âœ… æ›´æ–°ç¡®è®¤æ‰§è¡ŒæŒ‰é’®çŠ¶æ€
        updateBatchExecuteButtonState();
    }
}

/**
 * âœ… ä¸ºæŒ‡å®šå¡«å……æ—¶æ®µåŠ è½½åœ°ç‚¹é€‰é¡¹
 */
async function loadBatchLocationOptionsForSlot(slotIndex) {
    const slotDiv = document.querySelector(`.batch-fill-time-slot[data-slot-index="${slotIndex}"]`);
    if (!slotDiv) return;
    
    const locationSelects = slotDiv.querySelectorAll('.batch-location-select');
    
    try {
        const db = window.App?.getDatabaseConnector();
        if (!db) return;
        
        const locations = await db.fetchLocations();
        
        locationSelects.forEach(select => {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"è¯·é€‰æ‹©åœ°ç‚¹"ï¼‰
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // æ·»åŠ åœ°ç‚¹é€‰é¡¹
            if (locations && locations.length > 0) {
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    select.appendChild(option);
                });
            }
            
            // ç»‘å®šå˜åŒ–äº‹ä»¶
            select.addEventListener('change', function() {
                const slot = parseInt(this.dataset.slot);
                if (batchFillTimeSlots[slotIndex]) {
                    const slotKey = `slot${slot}`;
                    if (batchFillTimeSlots[slotIndex][slotKey]) {
                        batchFillTimeSlots[slotIndex][slotKey].location = this.value;
                    }
                }
                
                // âœ… æ›´æ–°ç¡®è®¤æ‰§è¡ŒæŒ‰é’®çŠ¶æ€
                updateBatchExecuteButtonState();
            });
        });
    } catch (error) {
        console.error('âŒ è¼‰å…¥åœ°é»é¸é …å¤±æ•—:', error);
    }
}

/**
 * âœ… ä¿®æ”¹ selectLeaveType å‡½æ•°ï¼Œåœ¨é€‰æ‹©å‡æœŸç±»å‹åæ˜¾ç¤ºæ—¥å†å’Œè¯·å‡è®¾ç½®
 */
function selectLeaveType(leaveType) {
    currentLeaveType = leaveType;
    
    // âœ… å®šä¹‰ä¸æ—¥å†æ ¼å­ä¸€è‡´çš„é¢œè‰²ï¼ˆä¸CSSä¸­çš„é¢œè‰²åŒ¹é…ï¼‰
    const CALENDAR_LEAVE_COLORS = {
        'regular': { bg: '#fbbf24', text: '#78350f' },      // ä¾‹å‡ - é»„è‰²
        'annual': { bg: '#10b981', text: 'white' },         // å¹´å‡ - ç»¿è‰²
        'maternity': { bg: '#ec4899', text: 'white' },      // äº§å‡ - ç²‰è‰²
        'sick': { bg: '#ef4444', text: 'white' },           // ç—…å‡ - çº¢è‰²
        'nopaid': { bg: '#6b7280', text: 'white' },         // No Paid - ç°è‰²
        'statutory': { bg: '#8b5cf6', text: 'white' }        // æ³•å®šåŠ³å·¥å‡ - ç´«è‰²
    };
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    document.querySelectorAll('.leave-type-btn').forEach(btn => {
        btn.style.borderColor = '#d1d5db';
        btn.style.background = '#fff';
        btn.style.color = '#374151';
    });
    
    const selectedBtn = document.querySelector(`.leave-type-btn[data-leave-type="${leaveType}"]`);
    if (selectedBtn) {
        const colors = CALENDAR_LEAVE_COLORS[leaveType] || { bg: '#3b82f6', text: 'white' };
        selectedBtn.style.borderColor = colors.bg;
        selectedBtn.style.background = colors.bg;
        selectedBtn.style.color = colors.text;
    }
    
    // âœ… æ˜¾ç¤ºæ—¥å†ï¼ˆåœ¨é€‰æ‹©å‡æœŸç±»å‹åæ˜¾ç¤ºï¼‰
    const calendarSection = document.getElementById('batchCalendarSection');
    if (calendarSection) {
        calendarSection.classList.remove('hidden');
        calendarSection.style.display = 'block';
    }
    
    // âœ… æ˜¾ç¤ºè¯·å‡è®¾ç½®ï¼ˆåœ¨æ—¥å†ä¹‹åï¼‰
    const leaveSettings = document.getElementById('batchLeaveSettings');
    if (leaveSettings) {
        leaveSettings.classList.remove('hidden');
        leaveSettings.style.display = 'block';
    }
    
    // æ˜¾ç¤ºæ˜ŸæœŸé€‰æ‹©
    const weekdaySelection = document.getElementById('batchLeaveWeekdaySelection');
    if (weekdaySelection) {
        weekdaySelection.classList.remove('hidden');
        weekdaySelection.style.display = 'block';
    }
    
    // âœ… é‡æ–°ç”Ÿæˆæ—¥å†ä»¥æ›´æ–°é«˜äº®æ˜¾ç¤ºï¼ˆç¡®ä¿é€‰æ‹©å‡æœŸç±»å‹æ—¶æ­£ç¡®æ˜¾ç¤ºï¼‰
    generateBatchOperationCalendarForDateRange();
    
    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    updateBatchExecuteButtonState();
}

// å¯¼å‡ºæ–°å‡½æ•°åˆ°å…¨å±€
window.onBatchDateRangeChange = onBatchDateRangeChange;

window.openBatchOperationModal = openBatchOperationModal;
window.closeBatchOperationModal = closeBatchOperationModal;
window.handleBatchModalClick = handleBatchModalClick;
window.clearBatchSelection = clearBatchSelection;
window.selectWeekdays = selectWeekdays;
window.selectWeekends = selectWeekends;
window.removeBatchDate = removeBatchDate;
window.previewBatchOperation = previewBatchOperation;
window.executeBatchOperation = executeBatchOperation;
window.toggleBatchDateSelectionFromCalendar = toggleBatchDateSelectionFromCalendar;
// âœ… å·²ç§»é™¤æ—§ä»£ç ï¼šä¸å†å¯¼å‡º generateBatchOperationCalendar å’Œ selectBatchWeekdayColumn
window.selectLeaveType = selectLeaveType;
window.selectRegularLeaveWeekday = selectRegularLeaveWeekday;
window.onBatchDateRangeChange = onBatchDateRangeChange;
window.selectBatchOperationType = selectBatchOperationType;
window.toggleBatchWeekday = toggleBatchWeekday;
window.toggleBatchLeaveWeekday = toggleBatchLeaveWeekday;
window.addBatchFillTimeSlot = addBatchFillTimeSlot;
window.removeBatchFillTimeSlot = removeBatchFillTimeSlot;
window.initializeBatchTimeSelectorsForSlot = initializeBatchTimeSelectorsForSlot;
window.batchNavigateMonth = batchNavigateMonth;

/**
 * âœ… ä¾‹å‡æ—¥æœŸèŒƒå›´æ”¹å˜æ—¶çš„å¤„ç†
 */
function onRegularLeaveDateChange() {
    // å¦‚æœå·²ç»é€‰æ‹©äº†æ˜ŸæœŸï¼Œç«‹å³æ›´æ–°é«˜äº®
    if (regularLeaveWeekday !== null) {
        const startDate = document.getElementById('regularLeaveStartDate')?.value;
        const endDate = document.getElementById('regularLeaveEndDate')?.value;
        
        if (startDate && endDate) {
            regularLeaveDateRange.start = startDate;
            regularLeaveDateRange.end = endDate;
            highlightRegularLeaveDates();
        }
    }
}

window.onRegularLeaveDateChange = onRegularLeaveDateChange;


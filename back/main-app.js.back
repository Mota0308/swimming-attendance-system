// ä¸»æ‡‰ç”¨ç¨‹åº - å…±é€šåŠŸèƒ½å’Œèº«ä»½æª¢æ¸¬

// å…¨å±€è®Šé‡è²æ˜
// æ³¨æ„ï¼šé€™äº›è®Šé‡æœƒè¢« coach-functions.js å’Œ supervisor-functions.js ä½¿ç”¨
let currentUser = null;
let currentUserType = null;
let securityManager = null;
let databaseConnector = null;
let locations = [];
let clubs = [];

// ä¾è³´æ³¨å…¥è¼”åŠ©å‡½æ•¸
function safeCallAppFunction(functionName, ...args) {
    if (window.App && window.App[functionName]) {
        return window.App[functionName](...args);
    } else {
        console.error(`âŒ App.${functionName} æœªå®šç¾©`);
        return null;
    }
}

// å‰µå»ºå…¨å±€æ‡‰ç”¨ç¨‹åºå°è±¡ï¼Œæä¾›ä¾è³´æ³¨å…¥
window.App = {
    // å…¨å±€è®Šé‡
    getCurrentUser: () => {
        // å¾ localStorage ç²å–å®Œæ•´çš„ç”¨æˆ¶æ•¸æ“š
        const savedUserData = localStorage.getItem('current_user_data');
        if (savedUserData) {
            try {
                const userData = JSON.parse(savedUserData);
                return {
                    phone: currentUser,
                    name: userData.name || localStorage.getItem('current_user_name') || '',
                    type: currentUserType,
                    bankAccount: userData.bankAccount || '',
                    bankName: userData.bankName || ''
                };
            } catch (error) {
                console.error('âŒ è§£æç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            }
        }
        
        // å‚™ç”¨æ–¹æ¡ˆï¼šè¿”å›åŸºæœ¬ä¿¡æ¯
        return {
            phone: currentUser,
            name: localStorage.getItem('current_user_name') || '',
            type: currentUserType,
            bankAccount: '',
            bankName: ''
        };
    },
    getCurrentUserType: () => currentUserType,
    getLocations: () => locations,
    getClubs: () => clubs,
    getSecurityManager: () => securityManager,
    getDatabaseConnector: () => databaseConnector,
    
    // åŸºç¤å‡½æ•¸
    hideAllSections: () => hideAllSections(),
    hideAllFeatures: () => hideAllFeatures(),
    showLoading: (show) => showLoading(show),
    getRoleDisplayName: (role) => getRoleDisplayName(role),
    loadLocationsAndClubs: () => loadLocationsAndClubs(),
    
    // è¨­ç½®å‡½æ•¸
    setCurrentUser: (user) => { currentUser = user; },
    setCurrentUserType: (type) => { currentUserType = type; },
    setLocations: (locs) => { locations = locs; },
    setClubs: (clubsList) => { clubs = clubsList; },
    
    // çµ±ä¸€çš„æ•¸æ“šåº«è¨ªå•å‡½æ•¸
    fetchAttendance: async (month, location, club) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.fetchAttendance(month, location, club);
        } catch (error) {
            console.error('âŒ ç²å–å‡ºå¸­è¨˜éŒ„å¤±æ•—:', error);
            return null;
        }
    },
    
    
    // æ–°å¢å·¥æ™‚ç®¡ç†ç›¸é—œå‡½æ•¸
    fetchStaffWorkHours: async (phone, year, month, location, club, editorType) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchStaffWorkHours(phone, year, month, location, club, editorType);
        } catch (error) {
            console.error('âŒ ç²å–å·¥æ™‚è¨˜éŒ„å¤±æ•—:', error);
            return [];
        }
    },
    
    saveStaffWorkHours: async (records, submittedBy, submittedByName, submittedByType) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.saveStaffWorkHours(records, submittedBy, submittedByName, submittedByType);
        } catch (error) {
            console.error('âŒ ä¿å­˜å·¥æ™‚è¨˜éŒ„å¤±æ•—:', error);
            return null;
        }
    },
    
    fetchLocationClubs: async () => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchLocationClubs();
        } catch (error) {
            console.error('âŒ ç²å–åœ°é»æ³³æœƒçµ„åˆå¤±æ•—:', error);
            return [];
        }
    },
    
    // æ¯”è¼ƒå·¥æ™‚è¨˜éŒ„
    compareWorkHours: async (phone, year, month) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.compareWorkHours(phone, year, month);
        } catch (error) {
            console.error('âŒ æ¯”è¼ƒå·¥æ™‚è¨˜éŒ„å¤±æ•—:', error);
            return [];
        }
    },
    
    fetchClassTypes: async () => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchClassTypes();
        } catch (error) {
            console.error('âŒ ç²å–èª²ç¨‹é¡å‹å¤±æ•—:', error);
            return [];
        }
    },
    
    fetchClassFormats: async (classType) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchClassFormats(classType);
        } catch (error) {
            console.error('âŒ ç²å–èª²å ‚å½¢å¼å¤±æ•—:', error);
            return [];
        }
    },
    
    fetchInstructorLevels: async (classType, classFormat) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchInstructorLevels(classType, classFormat);
        } catch (error) {
            console.error('âŒ ç²å–å°å¸«ç´šåˆ¥å¤±æ•—:', error);
            return [];
        }
    },
    
    fetchPricing: async (classType, classFormat, instructorLevel) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.fetchPricing(classType, classFormat, instructorLevel);
        } catch (error) {
            console.error('âŒ ç²å–åƒ¹æ ¼å¤±æ•—:', error);
            return null;
        }
    },
    
    createStudentBill: async (billData) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.createStudentBill(billData);
        } catch (error) {
            console.error('âŒ å‰µå»ºå­¸ç”Ÿè³¬å–®å¤±æ•—:', error);
            return null;
        }
    },
    
    // è©¦å ‚å‰µå»º
    createTrialBill: async (payload) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.createTrialBill(payload);
        } catch (error) {
            console.error('âŒ å‰µå»ºè©¦å ‚è¨˜éŒ„å¤±æ•—:', error);
            return null;
        }
    },
    
    fetchCoaches: async (options = {}) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchCoaches(options);
        } catch (error) {
            console.error('âŒ ç²å–æ•™ç·´åˆ—è¡¨å¤±æ•—:', error);
            return [];
        }
    },
    
    fetchAdmins: async () => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchAdmins();
        } catch (error) {
            console.error('âŒ ç²å–ç®¡ç†å“¡åˆ—è¡¨å¤±æ•—:', error);
            return [];
        }
    },
    
    fetchRoster: async (month, phone) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchRoster(month, phone);
        } catch (error) {
            console.error('âŒ ç²å–æ›´è¡¨æ•¸æ“šå¤±æ•—:', error);
            return [];
        }
    },
    
    fetchLocations: async () => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return [];
        }
        try {
            return await db.fetchLocations();
        } catch (error) {
            console.error('âŒ ç²å–åœ°é»åˆ—è¡¨å¤±æ•—:', error);
            return [];
        }
    },
    
    // æ•¸æ“šåº«é€£æ¥ç‹€æ…‹æª¢æŸ¥
    checkDatabaseConnection: () => {
        const db = databaseConnector;
        if (!db) {
            return { connected: false, error: 'DatabaseConnector æœªåˆå§‹åŒ–' };
        }
        return db.connectionStatus || { connected: false, error: 'é€£æ¥ç‹€æ…‹æœªçŸ¥' };
    },
    
    // é‡æ–°æª¢æŸ¥æ•¸æ“šåº«é€£æ¥
    reconnectDatabase: async () => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return false;
        }
        try {
            await db.checkConnection();
            return db.connectionStatus.connected;
        } catch (error) {
            console.error('âŒ é‡æ–°é€£æ¥æ•¸æ“šåº«å¤±æ•—:', error);
            return false;
        }
    },
    
    // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯
    updateUserInfo: async (phone, updateData) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.updateUserInfo(phone, updateData);
        } catch (error) {
            console.error('âŒ æ›´æ–°ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
            return null;
        }
    },
    
    // å‰µå»ºæ–°å“¡å·¥
    createEmployee: async (employeeData) => {
        const db = databaseConnector;
        if (!db) {
            console.error('âŒ DatabaseConnector æœªåˆå§‹åŒ–');
            return null;
        }
        try {
            return await db.createEmployee(employeeData);
        } catch (error) {
            console.error('âŒ å‰µå»ºå“¡å·¥å¤±æ•—:', error);
            return null;
        }
    },
    
    // å·¥æ™‚ç®¡ç†æ¬Šé™æ§åˆ¶
    canEditWorkHours: (targetPhone, targetType, currentUserPhone, currentUserType) => {
        // ä¸»ç®¡å¯ä»¥ç·¨è¼¯æ‰€æœ‰äºº
        if (currentUserType === 'supervisor') return true;
        
        // âœ… ç®¡ç†å“¡å¯ä»¥ç·¨è¼¯æ•™ç·´ï¼Œä¹Ÿå¯ä»¥ç·¨è¼¯è‡ªå·±
        if (currentUserType === 'admin') {
            // å¦‚æœé¸æ“‡çš„æ˜¯è‡ªå·±ï¼Œè¿”å› trueï¼ˆå¯ä»¥ç·¨è¼¯è‡ªå·±çš„è¨˜éŒ„ï¼‰
            if (targetPhone === currentUserPhone) return true;
            // å¦‚æœç›®æ¨™æ˜¯æ•™ç·´ï¼Œè¿”å› trueï¼ˆå¯ç·¨è¼¯æ•™ç·´çš„è¨˜éŒ„ï¼‰
            if (targetType === 'coach') return true;
            // å…¶ä»–æƒ…æ³è¿”å› falseï¼ˆä¸èƒ½ç·¨è¼¯å…¶ä»–ç®¡ç†å“¡æˆ–ä¸»ç®¡ï¼‰
            return false;
        }
        
        // âœ… æ•™ç·´å¯ä»¥ç·¨è¼¯è‡ªå·±çš„è¨˜éŒ„
        if (currentUserType === 'coach') {
            return targetPhone === currentUserPhone;
        }
        
        return false;
    },
    
    // ç²å–å¯ç·¨è¼¯çš„å“¡å·¥åˆ—è¡¨
    getEditableEmployees: async () => {
        const currentUserType = window.App.getCurrentUserType();
        const currentUser = window.App.getCurrentUser();
        const currentUserPhone = currentUser.phone;
        
        let employees = [];
        
        if (currentUserType === 'supervisor') {
            // ä¸»ç®¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰å“¡å·¥ï¼ˆæ•™ç·´ã€ç®¡ç†å“¡ã€ä¸»ç®¡ï¼‰ï¼Œä¸¦å°‡è‡ªå·±æ”¾åœ¨é¦–ä½
            const coaches = await window.App.fetchCoaches();
            const admins = await window.App.fetchAdmins();
            const currentSupervisor = {
                phone: currentUser.phone,
                name: currentUser.name,
                type: 'supervisor',
                bankAccount: currentUser.bankAccount || '',
                bankName: currentUser.bankName || ''
            };
            employees = [currentSupervisor, ...coaches, ...admins];
        } else if (currentUserType === 'admin') {
            // ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°æ•™ç·´å’Œè‡ªå·±ï¼ˆä½†è‡ªå·±çš„è¨˜éŒ„æ˜¯åªè®€çš„ï¼‰
            const coaches = await window.App.fetchCoaches();
            const currentAdmin = {
                phone: currentUser.phone,
                name: currentUser.name,
                type: 'admin',
                bankAccount: currentUser.bankAccount || '',
                bankName: currentUser.bankName || ''
            };
            employees = [currentAdmin, ...coaches];
        } else if (currentUserType === 'coach') {
            // æ•™ç·´åªèƒ½çœ‹åˆ°è‡ªå·±
            employees = [currentUser];
        }
        
        return employees;
    }
};

/**
 * æ£€æŸ¥ç™»å…¥çŠ¶æ€
 */
function checkLoginStatus() {
    const savedPhone = localStorage.getItem('current_user_phone');
    const savedUserType = localStorage.getItem('current_user_type');
    
    if (savedPhone && savedUserType) {
        currentUser = savedPhone;
        currentUserType = savedUserType;
        
        // å…ˆæ›´æ–°ç”¨æˆ¶ä¿¡æ¯
        updateUserInfo();
        
        // æ ¹æ“šç”¨æˆ¶é¡å‹é¡¯ç¤ºå°æ‡‰ç•Œé¢
        switch(savedUserType) {
            case 'coach':
                if (typeof showCoachSection === 'function') {
        showCoachSection();
                } else {
                    console.error('âŒ showCoachSection å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ coach-functions.js å·²åŠ è¼‰');
                }
                break;
            case 'supervisor':
                if (typeof showSupervisorSection === 'function') {
                    showSupervisorSection();
                } else {
                    console.error('âŒ showSupervisorSection å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ supervisor-functions.js å·²åŠ è¼‰');
                }
                break;
            case 'admin':
                showAdminSection();
                break;
            case 'parent':
                showStudentSection();
                break;
            default:
                if (typeof showCoachSection === 'function') {
                    showCoachSection();
                } else {
                    console.error('âŒ showCoachSection å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ coach-functions.js å·²åŠ è¼‰');
                }
                break;
        }
    }
}

/**
 * å¤„ç†ç™»å…¥
 */
async function handleLogin(event) {
    event.preventDefault();
    
    const phone = document.getElementById('phoneInput').value.trim();
    const password = document.getElementById('passwordInput').value.trim();
    const role = document.getElementById('roleSelect').value;

    console.log('ğŸ” é–‹å§‹ç™»å…¥æµç¨‹:', { phone, role });
    
    if (!phone || !password) {
        showLoginMessage('è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼å’Œå¯†ç¢¼', 'error');
        return;
    }
    
    // å®‰å…¨æ£€æŸ¥
    if (securityManager && !securityManager.checkLoginAttempts(phone)) {
        showLoginMessage('ç™»å…¥å˜—è©¦éå¤šï¼Œè«‹15åˆ†é˜å¾Œå†è©¦', 'error');
        return;
    }
    
    // é€Ÿç‡é™åˆ¶æ£€æŸ¥
    if (securityManager && !securityManager.checkRateLimit(phone, 5, 60000)) {
        showLoginMessage('è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        return;
    }
    
    if (window.App && window.App.showLoading) {
        window.App.showLoading(true);
    }
    
    try {
        const loginResult = await authenticateUser(phone, password, role);
        
        if (loginResult.success) {
            // è®°å½•æˆåŠŸçš„ç™»å½•å°è¯•
            if (securityManager) {
            securityManager.recordLoginAttempt(phone, true);
            }
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            currentUser = phone;
            currentUserType = role;
            localStorage.setItem('current_user_phone', phone);
            localStorage.setItem('current_user_type', role);
            localStorage.setItem('current_user_data', JSON.stringify(loginResult.user));
            
            // è¨­ç½®ç”¨æˆ¶å§“åæ ¼å¼ç‚º usertype_phoneï¼ˆèˆ‡å¾Œç«¯ä¿æŒä¸€è‡´ï¼‰
            const userName = loginResult.user.name || `${role}_${phone}`;
            localStorage.setItem('current_user_name', userName);
            
            console.log('âœ… ç™»å…¥æˆåŠŸ:', { phone, role });
            
            // å…ˆæ›´æ–°ç”¨æˆ¶ä¿¡æ¯
            updateUserInfo();
            updateDatabaseConnectionStatus();
            
            // æ ¹æ“šç”¨æˆ¶è§’è‰²é¡¯ç¤ºå°æ‡‰çš„ç•Œé¢
            switch(role) {
                case 'coach':
                    if (typeof showCoachSection === 'function') {
            showCoachSection();
                    } else {
                        console.error('âŒ showCoachSection å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ coach-functions.js å·²åŠ è¼‰');
                        // å˜—è©¦é‡æ–°åŠ è¼‰è…³æœ¬
                        console.log('ğŸ”„ å˜—è©¦é‡æ–°åŠ è¼‰ coach-functions.js...');
                        const script = document.createElement('script');
                        script.src = 'coach-functions.js';
                        script.onload = () => {
                            console.log('âœ… coach-functions.js é‡æ–°åŠ è¼‰æˆåŠŸ');
                            if (typeof showCoachSection === 'function') {
                                showCoachSection();
                            }
                        };
                        script.onerror = () => {
                            console.error('âŒ coach-functions.js é‡æ–°åŠ è¼‰å¤±æ•—');
                        };
                        document.head.appendChild(script);
                    }
                    break;
                case 'supervisor':
                    if (typeof showSupervisorSection === 'function') {
                    showSupervisorSection();
                    } else {
                        console.error('âŒ showSupervisorSection å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ supervisor-functions.js å·²åŠ è¼‰');
                    }
                    break;
                case 'admin':
                    showAdminSection();
                    break;
                case 'parent':
                    showStudentSection();
                    break;
                default:
                    if (typeof showCoachSection === 'function') {
                    showCoachSection();
                    } else {
                        console.error('âŒ showCoachSection å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ coach-functions.js å·²åŠ è¼‰');
                    }
                    break;
            }
            
            // å¦‚æœæ˜¯ä¸»ç®¡ï¼Œé åŠ è¼‰ç›¸é—œæ•¸æ“š
            if (role === 'supervisor' && databaseConnector && typeof databaseConnector.preloadSupervisorData === 'function') {
                console.log('ğŸ”„ ä¸»ç®¡ç™»å…¥ï¼Œé–‹å§‹é åŠ è¼‰æ•¸æ“š...');
                databaseConnector.preloadSupervisorData();
            }
            
            showLoginMessage('ç™»å…¥æˆåŠŸï¼', 'success');
            
        } else {
            // è®°å½•å¤±è´¥çš„ç™»å½•å°è¯•
            if (securityManager) {
            securityManager.recordLoginAttempt(phone, false);
            }
            throw new Error(loginResult.message || 'ç™»å…¥å¤±æ•—');
        }
    } catch (error) {
        console.error('âŒ ç™»å…¥å¤±æ•—:', error);
        showLoginMessage(error.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æ†‘è­‰', 'error');
    } finally {
        if (window.App && window.App.showLoading) {
            window.App.showLoading(false);
        }
    }
}

/**
 * ç”¨æˆ·è®¤è¯ - éªŒè¯ç™»å½•èº«ä»½ä¸æ•°æ®åº“typeçš„åŒ¹é…
 */
async function authenticateUser(phone, password, role) {
    try {
        console.log('ğŸ” é–‹å§‹ç”¨æˆ¶èªè­‰:', { phone, role });
        console.log('ğŸ“¤ ç™¼é€ç™»å…¥è«‹æ±‚åˆ°å¾Œç«¯ API...');
        // è°ƒç”¨åç«¯APIéªŒè¯staff_accounté›†åˆä¸­çš„è´¦å·
        const response = await fetch('https://swimming-attendance-system-production.up.railway.app/auth/login', {
            method: 'POST',
            headers: databaseConnector ? databaseConnector.getStandardHeaders() : {
                'Content-Type': 'application/json',
                'X-API-Public-Key': 'ttdrcccy',
                'X-API-Private-Key': '2b207365-cbf0-4e42-a3bf-f932c84557c4'
            },
            body: JSON.stringify({
                phone: phone,
                password: password,
                userType: role  // ç¡®ä¿ç™»å½•èº«ä»½ä¸æ•°æ®åº“typeå®Œå…¨åŒ¹é…
            })
        });
        
        if (!response.ok) {
            let errorMessage = 'è®¤è¯å¤±è´¥';
            try {
                const errorData = await response.json();
                errorMessage = errorData.message || errorMessage;
            } catch (parseError) {
                console.warn('âš ï¸ ç„¡æ³•è§£æéŒ¯èª¤éŸ¿æ‡‰:', parseError);
            }
            console.log('âš ï¸ è®¤è¯å¤±è´¥:', errorMessage);
            return {
                success: false,
                message: errorMessage
            };
        }
        
        const data = await response.json();
        console.log('ğŸ“¥ æ”¶åˆ°å¾Œç«¯éŸ¿æ‡‰:', { status: response.status, statusText: response.statusText, ok: response.ok });
        console.log('âœ… ç™»å…¥æˆåŠŸ - å¾Œç«¯è¿”å›æ•¸æ“š:', data);
        
        return {
            success: true,
            user: data.user || data,
            message: data.message || 'è®¤è¯æˆåŠŸ'
        };
        
    } catch (error) {
        console.error('âŒ èªè­‰å¤±æ•—:', error);
        return {
            success: false,
            message: error.message
        };
    }
}

/**
 * è™•ç†ç”¨æˆ¶ç™»å‡º
 */
function handleLogout() {
    try {
    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
            console.log('ğŸ”„ é–‹å§‹ç™»å‡ºæµç¨‹...');
            
            // æ¸…é™¤å…¨å±€è®Šé‡
        currentUser = null;
        currentUserType = null;
            locations = [];
            clubs = [];
            
            // æ¸…é™¤æœ¬åœ°å­˜å„²
            const storageKeys = [
                'current_user_phone',
                'current_user_type', 
                'current_user_name',
                'current_user_data'
            ];
            
            storageKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // æ¸…é™¤æ›´è¡¨æ•¸æ“šç·©å­˜
            if (typeof clearRosterDataCache === 'function') {
                clearRosterDataCache();
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå¼·åˆ¶æ¸…ç†æ‰€æœ‰ç•Œé¢ç‹€æ…‹
            hideAllSections();
            hideAllFeatures();
            
            // éš±è—æ‰€æœ‰åŠŸèƒ½ç•Œé¢
            const allInterfaces = document.querySelectorAll('.feature-interface, .interface-section');
            allInterfaces.forEach(interface => {
                interface.classList.add('hidden');
                interface.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰ active é¡
            document.querySelectorAll('.section, .feature-interface, .interface-section').forEach(el => {
                el.classList.remove('active');
            });
            
            // é¡¯ç¤ºç™»å…¥ç•Œé¢
        showLoginSection();
        
            // ğŸ”¥ æ–°å¢ï¼šå¼·åˆ¶åˆ·æ–°é é¢ä»¥ç¢ºä¿ç‹€æ…‹å®Œå…¨é‡ç½®
            // ä½†æ˜¯å…ˆæ¸…é™¤ç·©å­˜
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            console.log('âœ… ç”¨æˆ¶å·²æˆåŠŸç™»å‡º');
        }
    } catch (error) {
        console.error('âŒ ç™»å‡ºéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
        // å³ä½¿ç™¼ç”ŸéŒ¯èª¤ï¼Œä¹Ÿå˜—è©¦é¡¯ç¤ºç™»å…¥ç•Œé¢
        try {
            hideAllSections();
            hideAllFeatures();
            showLoginSection();
        } catch (showError) {
            console.error('âŒ ç„¡æ³•é¡¯ç¤ºç™»å…¥ç•Œé¢:', showError);
        }
    }
}

/**
 * æ˜¾ç¤ºç™»å½•ç•Œé¢
 */
function showLoginSection() {
    hideAllSections();
    document.getElementById('loginSection').classList.add('active');
    
    // æ¸…ç©ºç™»å½•è¡¨å•
    document.getElementById('phoneInput').value = '';
    document.getElementById('passwordInput').value = '';
    document.getElementById('roleSelect').value = 'coach';
    
    // æ¸…ç©ºæ¶ˆæ¯
    showLoginMessage('', '');
}

/**
 * æ˜¾ç¤ºä¸»ç•Œé¢ - èª¿ç”¨å°æ‡‰çš„åŠŸèƒ½æ¨¡çµ„
 * æ³¨æ„ï¼šshowCoachSection å’Œ showSupervisorSection å‡½æ•¸å®šç¾©åœ¨å°æ‡‰çš„åŠŸèƒ½æ¨¡çµ„ä¸­
 */

function showAdminSection() {
    // ä½¿ç”¨ä¾è³´æ³¨å…¥ï¼Œèª¿ç”¨ admin-functions.js ä¸­çš„å‡½æ•¸
    if (typeof window.showAdminSectionFromAdminFunctions === 'function') {
        window.showAdminSectionFromAdminFunctions();
    } else {
        console.error('âŒ admin-functions.js æœªæ­£ç¢ºåŠ è¼‰');
        // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥é¡¯ç¤ºç®¡ç†å“¡ç•Œé¢
    hideAllSections();
    document.getElementById('adminSection').classList.add('active');
    updateAdminUserInfo();
        console.log('âœ… é¡¯ç¤ºç®¡ç†å“¡ç•Œé¢ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰');
    }
}

function showStudentSection() {
    hideAllSections();
    document.getElementById('studentSection').classList.add('active');
    updateStudentUserInfo();
    console.log('âœ… é¡¯ç¤ºå­¸ç”Ÿç•Œé¢');
}

function hideAllSections() {
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => {
        section.classList.remove('active');
    });
}

function updateAdminUserInfo() {
    // ä½¿ç”¨ä¾è³´æ³¨å…¥ï¼Œèª¿ç”¨ admin-functions.js ä¸­çš„å‡½æ•¸
    if (typeof window.updateAdminUserInfoFromAdminFunctions === 'function') {
        window.updateAdminUserInfoFromAdminFunctions();
    } else {
        console.error('âŒ admin-functions.js æœªæ­£ç¢ºåŠ è¼‰');
        // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ›´æ–°ç”¨æˆ¶ä¿¡æ¯
    const userPhoneElement = document.getElementById('userPhone');
    const userTypeElement = document.getElementById('userType');
    
    if (userPhoneElement) {
        userPhoneElement.textContent = currentUser || '';
    }
    if (userTypeElement) {
        userTypeElement.textContent = getRoleDisplayName(currentUserType) || '';
        }
    }
}

function updateStudentUserInfo() {
    const userPhoneElement = document.getElementById('userPhone');
    const userTypeElement = document.getElementById('userType');
    
    if (userPhoneElement) {
        userPhoneElement.textContent = currentUser || '';
    }
    if (userTypeElement) {
        userTypeElement.textContent = getRoleDisplayName(currentUserType) || '';
    }
}

function getRoleDisplayName(role) {
    const roleNames = {
        'coach': 'æ•™ç·´',
        'supervisor': 'ä¸»ç®¡',
        'admin': 'ç®¡ç†å“¡',
        'parent': 'å­¸ç”Ÿ'
    };
    return roleNames[role] || role;
}

/**
 * æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
 */
function updateUserInfo() {
    const userPhoneElements = document.querySelectorAll('#userPhone, #displayUserPhone');
    const userRoleElement = document.getElementById('displayUserRole');
    const loginTimeElement = document.getElementById('loginTime');
    const userRoleDisplayElement = document.getElementById('userRoleDisplay');
    
    userPhoneElements.forEach(element => {
        if (element) element.textContent = currentUser || '';
    });
    
    if (userRoleElement) {
        const roleNames = {
            'parent': 'å­¸ç”Ÿ',
            'coach': 'æ•™ç·´',
            'supervisor': 'ä¸»ç®¡',
            'admin': 'ç®¡ç†å“¡'
        };
        userRoleElement.textContent = roleNames[currentUserType] || currentUserType;
    }
    
    if (userRoleDisplayElement) {
        const roleNames = {
            'parent': 'å­¸ç”Ÿå¹³å°',
            'coach': 'æ•™ç·´å¹³å°',
            'supervisor': 'ä¸»ç®¡å¹³å°',
            'admin': 'ç®¡ç†å¹³å°'
        };
        userRoleDisplayElement.textContent = roleNames[currentUserType] || 'ç®¡ç†å¹³å°';
    }
    
    if (loginTimeElement) {
        loginTimeElement.textContent = new Date().toLocaleString('zh-TW');
    }
}

/**
 * æ˜¾ç¤ºç™»å½•æ¶ˆæ¯
 */
function showLoginMessage(message, type) {
    const messageElement = document.getElementById('loginMessage');
    if (messageElement) {
        messageElement.textContent = message;
        messageElement.className = `message ${type}`;
        
        if (message) {
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.className = 'message';
            }, 5000);
        }
    }
}

/**
 * æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
 */
function showLoading(show) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        if (show) {
            loadingOverlay.classList.remove('hidden');
        } else {
            loadingOverlay.classList.add('hidden');
        }
    }
}

/**
 * åŠ è½½åœ°ç‚¹å’Œæ³³ä¼šæ•°æ®
 */
async function loadLocationsAndClubs() {
    try {
        if (!databaseConnector) {
            console.warn('âš ï¸ æ•°æ®åº“è¿æ¥å™¨ä¸å¯ç”¨');
            return;
        }
        
        console.log('ğŸ”„ å¼€å§‹åŠ è½½åœ°ç‚¹å’Œæ³³ä¼šæ•°æ®...');
        
        // ä»ç¼“å­˜è·å–æ•°æ®
        const cachedLocations = databaseConnector.getCachedData('locations');
        const cachedClubs = databaseConnector.getCachedData('clubs');
        
        if (cachedLocations && cachedLocations.length > 0) {
            locations = cachedLocations;
            console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„åœ°ç‚¹æ•°æ®:', locations);
        }
        
        if (cachedClubs && cachedClubs.length > 0) {
            clubs = cachedClubs;
            console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„æ³³ä¼šæ•°æ®:', clubs);
        }
        
        // æ›´æ–°UI
        populateLocationSelects();
        
        console.log('âœ… åœ°ç‚¹å’Œæ³³ä¼šæ•°æ®åŠ è½½å®Œæˆ');
        
    } catch (error) {
        console.error('âŒ åŠ è½½åœ°ç‚¹å’Œæ³³ä¼šæ•°æ®å¤±è´¥:', error);
        
    }
}

/**
 * å¡«å……åœ°ç‚¹é€‰æ‹©å™¨
 */
function populateLocationSelects() {
    const locationSelects = [
        'attendanceLocation',
        'locationSelect',
        'coachWorkLocation'
    ];
    
    locationSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            // ä¿å­˜å½“å‰é€‰æ‹©
            const currentValue = select.value;
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
            select.innerHTML = '<option value="">è«‹é¸æ“‡åœ°é»</option>';
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
            if (currentValue) {
                select.value = currentValue;
            }
        }
    });
    
    // å¡«å……æ³³ä¼šé€‰æ‹©å™¨
    populateClubSelects();
}

/**
 * å¡«å……æ³³ä¼šé€‰æ‹©å™¨
 */
function populateClubSelects() {
    const clubSelects = [
        'attendanceClub',
        'clubSelect',
        'coachWorkClub'
    ];
    
    clubSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            // ä¿å­˜å½“å‰é€‰æ‹©
            const currentValue = select.value;
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ³³æœƒ</option>';
            
            clubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club;
                option.textContent = club;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
            if (currentValue) {
                select.value = currentValue;
            }
        }
    });
}

/**
 * æ›´æ–°æ•°æ®åº“è¿æ¥çŠ¶æ€æ˜¾ç¤º
 */
function updateDatabaseConnectionStatus() {
    if (!databaseConnector) return;
    
    const status = databaseConnector.getConnectionStatus();
    
    const statusElement = document.getElementById('dbConnectionStatus');
    const lastSyncElement = document.getElementById('lastSyncTime');
    const cacheInfoElement = document.getElementById('cacheInfo');
    
    if (statusElement) {
        statusElement.textContent = status.connected ? 'å·²é€£æ¥' : 'æœªé€£æ¥';
        statusElement.style.color = status.connected ? '#10b981' : '#ef4444';
    }
    
    if (lastSyncElement && status.lastSync) {
        lastSyncElement.textContent = new Date(status.lastSync).toLocaleString('zh-TW');
    }
    
    if (cacheInfoElement) {
        cacheInfoElement.textContent = `${status.cacheSize} å€‹ç·©å­˜é …ç›®`;
    }
}

/**
 * åˆ·æ–°æ•°æ®åº“è¿æ¥
 */
async function refreshDatabaseConnection() {
    if (!databaseConnector) return;
    
    if (window.App && window.App.showLoading) {
        window.App.showLoading(true);
    }
    
    try {
        await databaseConnector.reconnect();
        updateDatabaseConnectionStatus();
        await loadLocationsAndClubs();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        const statusElement = document.getElementById('dbConnectionStatus');
        if (statusElement) {
            const originalText = statusElement.textContent;
            statusElement.textContent = 'åˆ·æ–°æˆåŠŸ';
            statusElement.style.color = '#10b981';
            
            setTimeout(() => {
                updateDatabaseConnectionStatus();
            }, 2000);
        }
        
    } catch (error) {
        console.error('âŒ åˆ·æ–°æ•°æ®åº“è¿æ¥å¤±è´¥:', error);
        
        const statusElement = document.getElementById('dbConnectionStatus');
        if (statusElement) {
            statusElement.textContent = 'åˆ·æ–°å¤±è´¥';
            statusElement.style.color = '#ef4444';
            
            setTimeout(() => {
                updateDatabaseConnectionStatus();
            }, 2000);
        }
    } finally {
        if (window.App && window.App.showLoading) {
            window.App.showLoading(false);
        }
    }
}

/**
 * éšè—æ‰€æœ‰åŠŸèƒ½ç•Œé¢
 */
function hideAllFeatures() {
    // éš±è—æ•™ç·´åŠŸèƒ½ç•Œé¢
    const featureInterfaces = document.querySelectorAll('.feature-interface');
    featureInterfaces.forEach(interface => {
        interface.classList.add('hidden');
        interface.classList.remove('active'); // ğŸ”¥ ç§»é™¤ active é¡
    });
    
    // éš±è—ä¸»ç®¡åŠŸèƒ½ç•Œé¢
    const supervisorInterfaces = document.querySelectorAll('.interface-section');
    supervisorInterfaces.forEach(interface => {
        interface.classList.add('hidden');
        interface.classList.remove('active'); // ğŸ”¥ ç§»é™¤ active é¡
    });
}

// å¼·åˆ¶èª¿æ•´æ—¥æ›†æ–¹æ ¼é«˜åº¦ = å¯¬åº¦ï¼Œç¢ºä¿é‹ªæ»¿å®¹å™¨ä¸”ä¸è®Šå½¢
function adjustCalendarSizing(containerEl) {
    try {
        if (!containerEl) return;
        const grid = containerEl.querySelector('.cal.grid-7');
        if (!grid) return;
        const cells = grid.querySelectorAll('.cal-cell');
        if (!cells.length) return;
        // ä½¿ç”¨ç¬¬ä¸€å€‹å–®å…ƒæ ¼çš„å¯¦éš›å¯¬åº¦ä½œç‚ºé«˜åº¦
        const firstCell = cells[0];
        const cellWidth = firstCell.getBoundingClientRect().width;
        cells.forEach(c => { c.style.height = `${Math.max(60, Math.round(cellWidth))}px`; });
    } catch (_) {}
}

// é é¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    
    // æª¢æŸ¥å¿…è¦çš„è…³æœ¬æ˜¯å¦å·²åŠ è¼‰
    setTimeout(() => {
        if (typeof showCoachSection !== 'function') {
            console.error('âŒ coach-functions.js æœªæ­£ç¢ºåŠ è¼‰');
        }
        if (typeof showSupervisorSection !== 'function') {
            console.error('âŒ supervisor-functions.js æœªæ­£ç¢ºåŠ è¼‰');
        }
    }, 100);
    
    // æª¢æŸ¥ URL åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const phone = urlParams.get('phone');
    const password = urlParams.get('password');
    const role = urlParams.get('role');
    
    if (phone && password && role) {
        console.log('ğŸ” ç™¼ç¾ URL åƒæ•¸:', { phone, role });
        
        // è‡ªå‹•å¡«å……è¡¨å–®
        const phoneInput = document.getElementById('phoneInput');
        const passwordInput = document.getElementById('passwordInput');
        const roleSelect = document.getElementById('roleSelect');
        
        if (phoneInput) phoneInput.value = phone;
        if (passwordInput) passwordInput.value = password;
        if (roleSelect) roleSelect.value = role;
        
        console.log('ğŸ“ è¡¨å–®å·²è‡ªå‹•å¡«å……');
        
        // è‡ªå‹•ç™»å…¥
        console.log('ğŸ”„ é–‹å§‹è‡ªå‹•ç™»å…¥...');
        const loginForm = document.querySelector('form');
        if (loginForm) {
            const event = new Event('submit');
            loginForm.dispatchEvent(event);
        }
    } else {
        console.log('ğŸ” æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
        checkLoginStatus();
    }
    
    // åˆå§‹åŒ–å®‰å…¨ç®¡ç†å™¨
    if (typeof SecurityManager !== 'undefined') {
        securityManager = new SecurityManager();
        console.log('ğŸ”’ å®‰å…¨ç®¡ç†å™¨å·²åˆå§‹åŒ–');
    }
    
    // åˆå§‹åŒ–æ•¸æ“šåº«é€£æ¥å™¨
    if (typeof DatabaseConnector !== 'undefined') {
        databaseConnector = new DatabaseConnector();
        console.log('ğŸ—„ï¸ æ•¸æ“šåº«é€£æ¥å™¨å·²åˆå§‹åŒ–');
        
        // ç­‰å¾… DatabaseConnector å®Œå…¨åˆå§‹åŒ–å¾Œå†æª¢æŸ¥é€£æ¥ç‹€æ…‹
        setTimeout(async () => {
            await databaseConnector.checkConnection();
            console.log('âœ… DatabaseConnector é€£æ¥æª¢æŸ¥å®Œæˆ');
        }, 100);
    } else {
        console.error('âŒ DatabaseConnector é¡æœªå®šç¾©');
    }
    
    const loginForm = document.getElementById('loginForm');
if (loginForm) {
    loginForm.addEventListener('submit', handleLogin);
    console.log('ğŸ”— ç™»å…¥è¡¨å–®äº‹ä»¶å·²ç¶å®š');
}

    // ç¶å®šæ‰€æœ‰ç™»å‡ºæŒ‰éˆ•äº‹ä»¶
    const logoutButtons = [
        'logoutBtn',           // æ•™ç·´ç•Œé¢
        'supervisorLogoutBtn', // ä¸»ç®¡ç•Œé¢
        'adminLogoutBtn',      // ç®¡ç†å“¡ç•Œé¢
        'studentLogoutBtn'     // å­¸ç”Ÿç•Œé¢
    ];
    
    logoutButtons.forEach(buttonId => {
        const logoutBtn = document.getElementById(buttonId);
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
            console.log(`ğŸ”— ${buttonId} ç™»å‡ºæŒ‰éˆ•äº‹ä»¶å·²ç¶å®š`);
        } else {
            console.warn(`âš ï¸ æ‰¾ä¸åˆ°ç™»å‡ºæŒ‰éˆ•: ${buttonId}`);
    }
    });

    // ç¶å®šåŠŸèƒ½æŒ‰éˆ•äº‹ä»¶
    document.addEventListener('click', function(e) {
        console.log('ğŸ–±ï¸ é»æ“Šäº‹ä»¶è§¸ç™¼:', e.target);
        
        if (e.target.closest('[data-feature]')) {
            const feature = e.target.closest('[data-feature]').getAttribute('data-feature');
            console.log('ğŸ¯ æª¢æ¸¬åˆ°åŠŸèƒ½æŒ‰éˆ•:', feature);
            
            switch(feature) {
                // æ•™ç·´åŠŸèƒ½
                case 'attendance':
                    console.log('ğŸ“Š åŸ·è¡Œå‡ºå¸­ç®¡ç†');
                    showAttendanceManagement();
                    break;
                case 'work-hours-roster':
                    console.log('ğŸ“…â° åŸ·è¡Œå·¥æ™‚è¨˜éŒ„èˆ‡æ›´è¡¨ï¼ˆæ•™ç·´ï¼‰');
                    showCombinedCoachWorkHoursRoster();
                    break;
                case 'work-hours':
                    console.log('â° åŸ·è¡Œå·¥æ™‚ç®¡ç†ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ï¼‰');
                    // æ ¹æ“šç”¨æˆ¶é¡å‹é¡¯ç¤ºä¸åŒçš„å·¥æ™‚ç®¡ç†ç•Œé¢
                    if (currentUserType === 'coach') {
                        // æ•™ç·´é é¢ä½¿ç”¨ coachWorkHours å‰ç¶´
                        if (typeof showWorkHours === 'function') {
                            showWorkHours();
                        } else {
                            console.error('âŒ showWorkHours å‡½æ•¸æœªå®šç¾©');
                        }
                    } else if (currentUserType === 'supervisor') {
                        // ä¸»ç®¡é é¢
                        if (typeof showSupervisorWorkHours === 'function') {
                            showSupervisorWorkHours();
                        } else {
                            console.error('âŒ showSupervisorWorkHours å‡½æ•¸æœªå®šç¾©');
                        }
                    } else if (currentUserType === 'admin') {
                        // ç®¡ç†å“¡é é¢
                        if (typeof showAdminWorkHours === 'function') {
                            showAdminWorkHours();
                        } else {
                            console.error('âŒ showAdminWorkHours å‡½æ•¸æœªå®šç¾©');
                        }
                    }
                    break;
                case 'roster':
                    // ğŸ”¥ èˆŠç‰ˆæœ¬ï¼šä¿ç•™ä½œç‚ºå¾Œå‚™ï¼Œä½†å„ªå…ˆä½¿ç”¨æ–°çµ±ä¸€ç•Œé¢
                    console.log('ğŸ“… åŸ·è¡Œæ•™ç·´æ›´è¡¨ï¼ˆèˆŠç‰ˆæœ¬ï¼Œå·²æ£„ç”¨ï¼Œè«‹ä½¿ç”¨ work-hours-rosterï¼‰');
                    // é‡å®šå‘åˆ°æ–°çµ±ä¸€ç•Œé¢
                    if (typeof showCombinedCoachWorkHoursRoster === 'function') {
                        showCombinedCoachWorkHoursRoster();
                    } else if (typeof showCoachRoster === 'function') {
                        // å¾Œå‚™æ–¹æ¡ˆï¼šä½¿ç”¨èˆŠç•Œé¢
                        showCoachRoster();
                    } else {
                        console.error('âŒ æ›´è¡¨åŠŸèƒ½æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ç›¸é—œå‡½æ•¸å·²åŠ è¼‰');
                    }
                    break;
                case 'personal-settings':
                    console.log('âš™ï¸ åŸ·è¡Œå€‹äººè¨­ç½®');
                    if (typeof showPersonalSettings === 'function') {
                        showPersonalSettings();
                    } else {
                        console.error('âŒ showPersonalSettings å‡½æ•¸æœªå®šç¾©');
                    }
                    break;
                
                // ä¸»ç®¡åŠŸèƒ½
                case 'supervisor-attendance':
                    console.log('ğŸ“Š åŸ·è¡Œä¸»ç®¡å‡ºå¸­ç®¡ç†');
                    showSupervisorAttendance();
                    break;
                case 'supervisor-work-hours-roster':
                    console.log('ğŸ“…â° åŸ·è¡Œå·¥æ™‚è¨˜éŒ„èˆ‡æ›´è¡¨ï¼ˆä¸»ç®¡ï¼‰');
                    showCombinedSupervisorWorkHoursRoster();
                    break;
                case 'supervisor-work-hours':
                    console.log('â° åŸ·è¡Œä¸»ç®¡å·¥æ™‚ç®¡ç†ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ï¼‰');
                    showSupervisorWorkHours();
                    break;
                case 'supervisor-roster':
                    console.log('ğŸ“… åŸ·è¡Œä¸»ç®¡æ›´è¡¨ç®¡ç†ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ï¼‰');
                    showStaffRoster();
                    break;
                case 'supervisor-reports':
                    console.log('ğŸ“ˆ åŸ·è¡Œä¸»ç®¡å ±è¡¨ç®¡ç†');
                    showSupervisorReports();
                    break;
                case 'supervisor-personal-settings':
                    console.log('âš™ï¸ åŸ·è¡Œä¸»ç®¡å€‹äººè¨­ç½®');
                    if (typeof showSupervisorPersonalSettings === 'function') {
                        showSupervisorPersonalSettings();
                    } else {
                        console.error('âŒ showSupervisorPersonalSettings å‡½æ•¸æœªå®šç¾©');
                    }
                    break;
                case 'supervisor-misc':
                    console.log('ğŸ”§ åŸ·è¡Œä¸»ç®¡é›œé …');
                    if (typeof showSupervisorMisc === 'function') {
                        showSupervisorMisc();
                    } else {
                        console.error('âŒ showSupervisorMisc å‡½æ•¸æœªå®šç¾©');
                    }
                    break;
                
                // ç®¡ç†å“¡åŠŸèƒ½
                case 'admin-work-hours-roster':
                    console.log('ğŸ“…â° åŸ·è¡Œå·¥æ™‚è¨˜éŒ„èˆ‡æ›´è¡¨ï¼ˆç®¡ç†å“¡ï¼‰');
                    showCombinedAdminWorkHoursRoster();
                    break;
                case 'admin-roster':
                    console.log('ğŸ“… åŸ·è¡Œç®¡ç†å“¡æ›´è¡¨ç®¡ç†ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ï¼‰');
                    if (typeof window.showAdminRoster === 'function') {
                        window.showAdminRoster();
                    } else {
                        console.error('âŒ showAdminRoster å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ admin-functions.js å·²åŠ è¼‰');
                    }
                    break;
                case 'admin-work-hours':
                    console.log('â° åŸ·è¡Œç®¡ç†å“¡å·¥æ™‚ç®¡ç†ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ï¼‰');
                    if (typeof window.showAdminWorkHours === 'function') {
                        window.showAdminWorkHours();
                    } else {
                        console.error('âŒ showAdminWorkHours å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ admin-functions.js å·²åŠ è¼‰');
                    }
                    break;
                case 'admin-personal-settings':
                    console.log('âš™ï¸ åŸ·è¡Œç®¡ç†å“¡å€‹äººè¨­ç½®');
                    if (typeof window.showAdminPersonalSettings === 'function') {
                        window.showAdminPersonalSettings();
                    } else {
                        console.error('âŒ showAdminPersonalSettings å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ admin-functions.js å·²åŠ è¼‰');
                    }
                    break;
                case 'admin-misc':
                    console.log('ğŸ”§ åŸ·è¡Œç®¡ç†å“¡é›œé …');
                    if (typeof window.showAdminMisc === 'function') {
                        window.showAdminMisc();
                    } else {
                        console.error('âŒ showAdminMisc å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿ admin-functions.js å·²åŠ è¼‰');
                    }
                    break;
                case 'data-management':
                    console.log('ğŸ“Š åŸ·è¡Œè³‡æ–™ç®¡ç†');
                    if (typeof window.showDataTab === 'function') {
                        window.showDataTab('employee');
                    } else {
                        console.error('âŒ showDataTab å‡½æ•¸æœªå®šç¾©ï¼Œè«‹ç¢ºä¿æœ‰è³‡æ–™ç®¡ç†åŠŸèƒ½');
                    }
                    break;
            }
        }
    });
    
    console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
});

// è¦–çª—å°ºå¯¸è®Šæ›´æ™‚ï¼Œé‡æ–°èª¿æ•´æ—¥æ›†å°ºå¯¸
window.addEventListener('resize', () => {
    // ğŸ”¥ å„ªåŒ–ï¼šèª¿æ•´æ‰€æœ‰å¯èƒ½çš„æ—¥æ›†å®¹å™¨ï¼ˆåŒ…æ‹¬æ–°çµ±ä¸€ç•Œé¢çš„å®¹å™¨ï¼‰
    const calendars = [
        document.getElementById('workHoursCalendar'),
        document.getElementById('rosterCalendar'), // èˆŠå®¹å™¨ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        document.getElementById('coachRosterDisplay'), // æ–°çµ±ä¸€ç•Œé¢å®¹å™¨
        document.getElementById('supervisorRosterDisplay'),
        document.getElementById('adminRosterDisplay')
    ];
    
    calendars.forEach(calendar => {
        if (calendar) {
            adjustCalendarSizing(calendar);
        }
    });
});

// å°‡ä¸»è¦å‡½æ•¸å°å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­çš„onclickäº‹ä»¶å¯ä»¥è¨ªå•
// æ³¨æ„ï¼šæ•™ç·´å’Œä¸»ç®¡ç›¸é—œå‡½æ•¸å·²ç§»è‡³å°æ‡‰çš„åŠŸèƒ½æ¨¡çµ„ä¸­å°å‡º
window.hideAllFeatures = hideAllFeatures;
window.refreshDatabaseConnection = refreshDatabaseConnection;

// æ³¨æ„ï¼šä¸»ç®¡ç›¸é—œå‡½æ•¸å·²ç§»è‡³ supervisor-functions.js ä¸­å®šç¾©å’Œå°å‡º
// é€™è£¡ä¸å†é‡è¤‡å°å‡ºï¼Œé¿å…è¡çª


// ===== è³‡æ–™ç®¡ç†åŠŸèƒ½ =====
window.showDataTab = async function(tab) {
  if (tab === 'workhours') {
    await renderWorkHoursSummaryTable();
    return;
  }
  const tabs = document.querySelectorAll('.data-tabs button');
  tabs.forEach(btn => btn.classList.remove('active'));
  const idx = tab === 'employee' ? 0 : tab === 'formal' ? 1 : 2;
  tabs[idx]?.classList.add('active');

  let data = [];
  let config = { search: [] };
  if(tab === 'employee') {
    data = await window.App.getEmployees();
    config.search = [
      { field: 'name', label: 'å§“å', type: 'input' },
      { field: 'phone', label: 'é›»è©±', type: 'input' },
      // å›ºå®šä¸­æ–‡æ¨™ç±¤ + è‹±æ–‡å€¼çš„è§’è‰²ä¸‹æ‹‰
      { field: 'type', label: 'è§’è‰²', type: 'select', options: [
        { value: 'admin', label: 'ç®¡ç†å“¡' },
        { value: 'supervisor', label: 'ä¸»ç®¡' },
        { value: 'coach', label: 'æ•™ç·´' }
      ] },
      // å›ºå®šæ€§åˆ¥ä¸‹æ‹‰
      { field: 'gender', label: 'æ€§åˆ¥', type: 'select', options: [
        { value: 'M', label: 'ç”·' },
        { value: 'F', label: 'å¥³' }
      ] }
    ];
  } else if(tab === 'formal') {
    data = await window.App.getFormalMembers();
    config.search = [
      { field: 'name', label: 'å§“å', type: 'input' },
      { field: 'phone', label: 'é›»è©±', type: 'input' },
      { field: 'status', label: 'ç‹€æ…‹', type: 'select', optionsFn: d=>[...new Set(d.map(i=>i.status||'æœªçŸ¥'))].sort() }
    ];
  } else if(tab === 'trial') {
    data = await window.App.getTrialBills();
    config.search = [
      { field: 'name', label: 'å§“å', type: 'input' },
      { field: 'phone', label: 'é›»è©±', type: 'input' },
      { field: 'trialDate', label: 'è©¦å ‚æ—¥æœŸ', type: 'input' },
      { field: 'platform', label: 'ä¾†æº/å¹³è‡º', type: 'select', optionsFn: d=>[...new Set(d.map(i=>i.platform||'æœªçŸ¥'))].sort() }
    ];
  }
  window.renderDataSearch(config.search, data);
  window.renderDataTable(tab, data, config);
  window.currentRawData = data; window.currentDataTab = tab; window.currentSearchConfig = config.search;
};
window.renderDataSearch = function(config, data) {
  const zone = document.getElementById('dataSearchZone');
  if(!zone) return;
  zone.innerHTML = '';
  if(!config||!config.length) return;
  config.forEach(sconf => {
    let ctrl,label=document.createElement('label'); label.textContent=sconf.label; label.style.fontWeight='600';
    if(sconf.type==='input') {
      ctrl=document.createElement('input');
      ctrl.className='data-search-input';
      ctrl.placeholder='æœå°‹'+sconf.label;
      ctrl.oninput=window.onDataSearchChanged;
    } else if(sconf.type==='select') {
      ctrl=document.createElement('select');
      ctrl.className='data-search-select';
      ctrl.onchange=window.onDataSearchChanged;
      let opts=(sconf.options||[]);
      if(sconf.optionsFn) opts=sconf.optionsFn(window.currentRawData||[]);
      // æ”¯æ´å­—ä¸²æˆ– {value,label}
      const renderOption = (o)=>{
        if(typeof o==='object' && o!==null) return `<option value="${o.value}">${o.label??o.value}</option>`;
        return `<option value="${o}">${o}</option>`;
      };
      ctrl.innerHTML=`<option value="">å…¨éƒ¨</option>`+opts.map(renderOption).join('');
    }
    ctrl.dataset.field=sconf.field; ctrl.dataset.type=sconf.type;
    const wrap=document.createElement('div');wrap.style.display='flex';wrap.style.flexDirection='column';wrap.appendChild(label);wrap.appendChild(ctrl);
    zone.appendChild(wrap);
  });
};
window.onDataSearchChanged=function(){
  let filters=Array.from(document.querySelectorAll('#dataSearchZone input,#dataSearchZone select')).reduce((acc,el)=>{acc[el.dataset.field]=el.value;return acc;},{});let filtered=window.currentRawData.filter(row=>Object.keys(filters).every(field=>{let val=filters[field];if(!val)return true;let dataVal=row[field];if(!dataVal)return false;return (field==='phone'||field==='name'||field==='trialDate')?dataVal.toString().includes(val):dataVal==val;}));window.renderDataTable(window.currentDataTab,filtered,{search:window.currentSearchConfig});};
window.renderDataTable=function(tab,data,config){const zone=document.getElementById('dataTableZone');if(!zone)return;zone.innerHTML='';if(!data||!data.length){zone.innerHTML='<div class="data-no-data">æš«ç„¡è³‡æ–™</div>';return;}let keys=Object.keys(data[0]).filter(k=>!['password','_id'].includes(k));let ths=keys.map(k=>`<th>${k}</th>`).join('');let trs=data.map(row=>'<tr>'+keys.map(k=>`<td>${row[k]===undefined?'':row[k]}</td>`).join('')+'</tr>').join('');zone.innerHTML=`<table class="data-data-table"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;};
// è³‡æ–™ç®¡ç†å¡ç‰‡é»æ“Šäº‹ä»¶ç¶å®š
for(const el of document.querySelectorAll('.feature-card[data-feature="data-management"]')){el.onclick=()=>{if(window.App&&window.App.hideAllFeatures)window.App.hideAllFeatures();document.getElementById('dataManagementSection').classList.remove('hidden');window.showDataTab('employee');};}
// Appæš´éœ²æŸ¥è©¢æ–¹æ³•
window.App.getEmployees = async () => {
    let db = window.App.getDatabaseConnector();
    if (!db) return [];
    let res = await db.fetchAdmins();
    let arr = Array.isArray(res) ? res : res.admins || [];
    return arr.filter(x => ['admin','supervisor','coach'].includes((x.type||x.userType)));
  };
window.App.getFormalMembers=async()=>{let db=window.App.getDatabaseConnector();if(!db)return[];let resp=await fetch(db.baseUrl+'/students',{headers:db.getStandardHeaders()});let d=await resp.json();return d.students||[];};
window.App.getTrialBills=async()=>{let db=window.App.getDatabaseConnector();if(!db)return[];let resp=await fetch(db.baseUrl+'/trial-bill/all',{headers:db.getStandardHeaders()});let d=await resp.json();return d.trials||[];};

// ===== å·¥æ™‚è¨˜éŒ„èˆ‡æ›´è¡¨çµ±ä¸€ç•Œé¢ =====
function showCombinedCoachWorkHoursRoster(){
    hideAllFeatures();
    const s=document.getElementById('coachWorkHoursRosterSection');
    if(s){
        s.classList.remove('hidden');
        // ğŸ”¥ ä¿®å¾©ï¼šå¢åŠ å»¶é²æ™‚é–“ï¼ˆ150msï¼‰ï¼Œç¢ºä¿ DOM å…ƒç´ å·²å®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ï¼ˆæ›´è¡¨ï¼‰
            const monthSelect = document.getElementById('coachRosterMonthSelect');
            if (monthSelect) {
                initializeMonthSelect('coachRosterMonthSelect');
                console.log('âœ… æˆåŠŸåˆå§‹åŒ–æ›´è¡¨æœˆä»½é¸æ“‡å™¨');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°æ›´è¡¨æœˆä»½é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => {
                    const retrySelect = document.getElementById('coachRosterMonthSelect');
                    if (retrySelect) {
                        initializeMonthSelect('coachRosterMonthSelect');
                        console.log('âœ… é‡è©¦æˆåŠŸï¼šåˆå§‹åŒ–æ›´è¡¨æœˆä»½é¸æ“‡å™¨');
                    } else {
                        console.error('âŒ é‡è©¦å¾Œä»æ‰¾ä¸åˆ°æ›´è¡¨æœˆä»½é¸æ“‡å™¨');
                    }
                }, 200);
            }
            
            // åˆå§‹åŒ–å¹´ä»½å’Œæœˆä»½é¸æ“‡å™¨ï¼ˆå·¥æ™‚è¨˜éŒ„è¡¨ï¼‰
            const yearSelect = document.getElementById('coachWorkHoursYearSelect');
            const workMonthSelect = document.getElementById('coachWorkHoursMonthSelect');
            console.log('ğŸ” æª¢æŸ¥å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨:', {
                yearSelect: !!yearSelect,
                workMonthSelect: !!workMonthSelect,
                sectionVisible: !s.classList.contains('hidden')
            });
            
            if (yearSelect && workMonthSelect) {
                initializeWorkHoursDateSelectors('coachWorkHoursYearSelect','coachWorkHoursMonthSelect');
                console.log('âœ… æˆåŠŸåˆå§‹åŒ–å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => {
                    const retryYear = document.getElementById('coachWorkHoursYearSelect');
                    const retryMonth = document.getElementById('coachWorkHoursMonthSelect');
                    if (retryYear && retryMonth) {
                        initializeWorkHoursDateSelectors('coachWorkHoursYearSelect','coachWorkHoursMonthSelect');
                        console.log('âœ… é‡è©¦æˆåŠŸï¼šåˆå§‹åŒ–å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨');
                    } else {
                        console.error('âŒ é‡è©¦å¾Œä»æ‰¾ä¸åˆ°å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨');
                        console.error('ğŸ” èª¿è©¦ä¿¡æ¯:', {
                            retryYear: !!retryYear,
                            retryMonth: !!retryMonth,
                            sectionExists: !!document.getElementById('coachWorkHoursRosterSection'),
                            sectionVisible: !document.getElementById('coachWorkHoursRosterSection')?.classList.contains('hidden')
                        });
                    }
                }, 200);
            }
        }, 150);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ° coachWorkHoursRosterSection');
    }
}
function showCombinedAdminWorkHoursRoster(){
    hideAllFeatures();
    const s=document.getElementById('adminWorkHoursRosterSection');
    if(s){
        s.classList.remove('hidden');
        // ğŸ”¥ ä¿®å¾©ï¼šå¢åŠ å»¶é²æ™‚é–“ä¸¦æ·»åŠ é‡è©¦é‚è¼¯ï¼Œç¢ºä¿ DOM å…ƒç´ å·²å®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            // åˆå§‹åŒ–å“¡å·¥é¸æ“‡å™¨
            const employeeSelect = document.getElementById('adminEmployeeSelect');
            if (employeeSelect) {
                initializeCombinedEmployeeSelect('adminEmployeeSelect');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°å“¡å·¥é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => initializeCombinedEmployeeSelect('adminEmployeeSelect'), 200);
            }
            
            // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ï¼ˆæ›´è¡¨ï¼‰
            const monthSelect = document.getElementById('adminRosterMonthSelect');
            if (monthSelect) {
                initializeMonthSelect('adminRosterMonthSelect');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°æ›´è¡¨æœˆä»½é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => initializeMonthSelect('adminRosterMonthSelect'), 200);
            }
            
            // åˆå§‹åŒ–å¹´ä»½å’Œæœˆä»½é¸æ“‡å™¨ï¼ˆå·¥æ™‚è¨˜éŒ„è¡¨ï¼‰
            const yearSelect = document.getElementById('adminWorkHoursYearSelect');
            const workMonthSelect = document.getElementById('adminWorkHoursMonthSelect');
            if (yearSelect && workMonthSelect) {
                initializeWorkHoursDateSelectors('adminWorkHoursYearSelect','adminWorkHoursMonthSelect');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => {
                    initializeWorkHoursDateSelectors('adminWorkHoursYearSelect','adminWorkHoursMonthSelect');
                }, 200);
            }
        }, 100);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ° adminWorkHoursRosterSection');
    }
}
function showCombinedSupervisorWorkHoursRoster(){
    hideAllFeatures();
    const s=document.getElementById('supervisorWorkHoursRosterSection');
    if(s){
        s.classList.remove('hidden');
        // ğŸ”¥ ä¿®å¾©ï¼šå¢åŠ å»¶é²æ™‚é–“ä¸¦æ·»åŠ é‡è©¦é‚è¼¯ï¼Œç¢ºä¿ DOM å…ƒç´ å·²å®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            // åˆå§‹åŒ–å“¡å·¥é¸æ“‡å™¨
            const employeeSelect = document.getElementById('supervisorEmployeeSelect');
            if (employeeSelect) {
                initializeCombinedEmployeeSelect('supervisorEmployeeSelect');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°å“¡å·¥é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => initializeCombinedEmployeeSelect('supervisorEmployeeSelect'), 200);
            }
            
            // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ï¼ˆæ›´è¡¨ï¼‰
            const monthSelect = document.getElementById('supervisorRosterMonthSelect');
            if (monthSelect) {
                initializeMonthSelect('supervisorRosterMonthSelect');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°æ›´è¡¨æœˆä»½é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => initializeMonthSelect('supervisorRosterMonthSelect'), 200);
            }
            
            // åˆå§‹åŒ–å¹´ä»½å’Œæœˆä»½é¸æ“‡å™¨ï¼ˆå·¥æ™‚è¨˜éŒ„è¡¨ï¼‰
            const yearSelect = document.getElementById('supervisorWorkHoursYearSelect');
            const workMonthSelect = document.getElementById('supervisorWorkHoursMonthSelect');
            if (yearSelect && workMonthSelect) {
                initializeWorkHoursDateSelectors('supervisorWorkHoursYearSelect','supervisorWorkHoursMonthSelect');
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°å·¥æ™‚è¨˜éŒ„è¡¨é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => {
                    initializeWorkHoursDateSelectors('supervisorWorkHoursYearSelect','supervisorWorkHoursMonthSelect');
                }, 200);
            }
            
            // åˆå§‹åŒ–çµ±è¨ˆæœˆä»½é¸æ“‡å™¨
            const sm=document.getElementById('supervisorStatsMonth');
            if(sm){
                const mn=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
                sm.innerHTML='';
                for(let i=1;i<=12;i++)sm.innerHTML+=`<option value="${i}">${mn[i-1]}</option>`;
                sm.value=new Date().getMonth()+1;
            } else {
                console.warn('âš ï¸ é¦–æ¬¡æœªæ‰¾åˆ°çµ±è¨ˆæœˆä»½é¸æ“‡å™¨ï¼Œå°‡é‡è©¦');
                setTimeout(() => {
                    const retrySm = document.getElementById('supervisorStatsMonth');
                    if(retrySm){
                        const mn=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
                        retrySm.innerHTML='';
                        for(let i=1;i<=12;i++)retrySm.innerHTML+=`<option value="${i}">${mn[i-1]}</option>`;
                        retrySm.value=new Date().getMonth()+1;
                    }
                }, 200);
            }
        }, 100);
    } else {
        console.error('âŒ æ‰¾ä¸åˆ° supervisorWorkHoursRosterSection');
    }
}
function initializeMonthSelect(id){
    const s=document.getElementById(id);
    if(!s){
        console.warn('âš ï¸ æ‰¾ä¸åˆ°æœˆä»½é¸æ“‡å™¨:', id);
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å†æ¬¡æŸ¥æ‰¾ï¼ˆå»¶é²é‡è©¦ï¼‰
        setTimeout(() => {
            const retryS = document.getElementById(id);
            if(retryS){
                const mn=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
                const cm=new Date().getMonth()+1;
                retryS.innerHTML='';
                for(let i=1;i<=12;i++){
                    retryS.innerHTML+=`<option value="${i}" ${i===cm?'selected':''}>${mn[i-1]}</option>`;
                }
                console.log('âœ… åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ï¼ˆé‡è©¦æˆåŠŸï¼‰:', id, 'ç•¶å‰å€¼:', retryS.value);
            } else {
                console.error('âŒ é‡è©¦å¾Œä»æ‰¾ä¸åˆ°æœˆä»½é¸æ“‡å™¨:', id);
            }
        }, 100);
        return;
    }
    const mn=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
    const cm=new Date().getMonth()+1;
    s.innerHTML='';
    for(let i=1;i<=12;i++){
        s.innerHTML+=`<option value="${i}" ${i===cm?'selected':''}>${mn[i-1]}</option>`;
    }
    console.log('âœ… åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨:', id, 'ç•¶å‰å€¼:', s.value);
}
function initializeWorkHoursDateSelectors(yid,mid){
    const ys=document.getElementById(yid);
    const ms=document.getElementById(mid);
    
    // ğŸ”¥ ä¿®å¾©ï¼šæ›´è©³ç´°çš„æ—¥èªŒå’Œé‡è©¦é‚è¼¯
    if(!ys){
        console.warn('âš ï¸ æ‰¾ä¸åˆ°å¹´ä»½é¸æ“‡å™¨:', yid);
        console.warn('ğŸ” èª¿è©¦ä¿¡æ¯:', {
            elementExists: !!document.getElementById(yid),
            sectionVisible: document.getElementById('coachWorkHoursRosterSection')?.classList.contains('hidden') === false,
            sectionExists: !!document.getElementById('coachWorkHoursRosterSection'),
            adminSectionVisible: document.getElementById('adminWorkHoursRosterSection')?.classList.contains('hidden') === false,
            supervisorSectionVisible: document.getElementById('supervisorWorkHoursRosterSection')?.classList.contains('hidden') === false
        });
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¤šæ¬¡é‡è©¦ï¼ˆå¢åŠ é‡è©¦æ¬¡æ•¸å’Œé–“éš”ï¼‰
        let retryCount = 0;
        const maxRetries = 8; // å¢åŠ åˆ°8æ¬¡
        const retryInterval = 150; // å¢åŠ åˆ°150ms
        
        const retryInitYear = () => {
            retryCount++;
            const retryYs = document.getElementById(yid);
            if(retryYs){
                const cy=new Date().getFullYear();
                retryYs.innerHTML='';
                for(let y=cy-1;y<=cy+1;y++){
                    retryYs.innerHTML+=`<option value="${y}">${y}å¹´</option>`;
                }
                retryYs.value=cy.toString();
                console.log(`âœ… åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨ï¼ˆé‡è©¦ ${retryCount}/${maxRetries} æˆåŠŸï¼‰:`, yid, 'ç•¶å‰å€¼:', retryYs.value);
            } else if(retryCount < maxRetries){
                console.log(`ğŸ”„ é‡è©¦åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨ (${retryCount}/${maxRetries}):`, yid);
                setTimeout(retryInitYear, retryInterval);
            } else {
                console.error('âŒ å¤šæ¬¡é‡è©¦å¾Œä»æ‰¾ä¸åˆ°å¹´ä»½é¸æ“‡å™¨:', yid);
                console.error('ğŸ” æœ€çµ‚èª¿è©¦ä¿¡æ¯:', {
                    elementId: yid,
                    elementExists: !!document.getElementById(yid),
                    parentSection: document.getElementById(yid)?.closest('.interface-section')?.id
                });
            }
        };
        setTimeout(retryInitYear, retryInterval);
    } else {
        const cy=new Date().getFullYear();
        ys.innerHTML='';
        for(let y=cy-1;y<=cy+1;y++){
            ys.innerHTML+=`<option value="${y}">${y}å¹´</option>`;
        }
        ys.value=cy.toString();
        console.log('âœ… åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨:', yid, 'ç•¶å‰å€¼:', ys.value);
    }
    
    if(!ms){
        console.warn('âš ï¸ æ‰¾ä¸åˆ°æœˆä»½é¸æ“‡å™¨:', mid);
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¤šæ¬¡é‡è©¦ï¼ˆå¢åŠ é‡è©¦æ¬¡æ•¸å’Œé–“éš”ï¼‰
        let retryCount = 0;
        const maxRetries = 8; // å¢åŠ åˆ°8æ¬¡
        const retryInterval = 150; // å¢åŠ åˆ°150ms
        
        const retryInitMonth = () => {
            retryCount++;
            const retryMs = document.getElementById(mid);
            if(retryMs){
                const mn=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
                const cm=new Date().getMonth()+1;
                retryMs.innerHTML='';
                for(let i=1;i<=12;i++){
                    retryMs.innerHTML+=`<option value="${i}" ${i===cm?'selected':''}>${mn[i-1]}</option>`;
                }
                retryMs.value=cm.toString();
                console.log(`âœ… åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ï¼ˆé‡è©¦ ${retryCount}/${maxRetries} æˆåŠŸï¼‰:`, mid, 'ç•¶å‰å€¼:', retryMs.value);
            } else if(retryCount < maxRetries){
                console.log(`ğŸ”„ é‡è©¦åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ (${retryCount}/${maxRetries}):`, mid);
                setTimeout(retryInitMonth, retryInterval);
            } else {
                console.error('âŒ å¤šæ¬¡é‡è©¦å¾Œä»æ‰¾ä¸åˆ°æœˆä»½é¸æ“‡å™¨:', mid);
                console.error('ğŸ” æœ€çµ‚èª¿è©¦ä¿¡æ¯:', {
                    elementId: mid,
                    elementExists: !!document.getElementById(mid),
                    parentSection: document.getElementById(mid)?.closest('.interface-section')?.id
                });
            }
        };
        setTimeout(retryInitMonth, retryInterval);
    } else {
        const mn=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
        const cm=new Date().getMonth()+1;
        ms.innerHTML='';
        for(let i=1;i<=12;i++){
            ms.innerHTML+=`<option value="${i}" ${i===cm?'selected':''}>${mn[i-1]}</option>`;
        }
        ms.value=cm.toString();
        console.log('âœ… åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨:', mid, 'ç•¶å‰å€¼:', ms.value);
    }
}
async function initializeCombinedEmployeeSelect(id){const s=document.getElementById(id);if(!s)return;const emps=await window.App.getEditableEmployees();s.innerHTML=emps.map(e=>`<option value="${e.phone}">${e.name} (${e.type})</option>`).join('');if(emps.length>0)s.value=emps[0].phone;}
window.showCombinedCoachWorkHoursRoster=showCombinedCoachWorkHoursRoster;window.showCombinedAdminWorkHoursRoster=showCombinedAdminWorkHoursRoster;window.showCombinedSupervisorWorkHoursRoster=showCombinedSupervisorWorkHoursRoster;

// ===== æ–°ç‰ˆï¼šåˆ†é–‹çš„æ›´è¡¨å’Œå·¥æ™‚è¨˜éŒ„è¡¨è¼‰å…¥å‡½æ•¸ =====
async function loadCoachRoster(forceRefresh = false) {
    const monthSelect = document.getElementById('coachRosterMonthSelect');
    if (!monthSelect) {
        console.warn('âš ï¸ æ•™ç·´æ›´è¡¨ï¼šæ‰¾ä¸åˆ°æœˆä»½é¸æ“‡å™¨');
        return;
    }
    if (!monthSelect.value) {
        console.warn('âš ï¸ æ•™ç·´æ›´è¡¨ï¼šæœªé¸æ“‡æœˆä»½ï¼Œç•¶å‰é¸æ“‡å™¨å€¼:', monthSelect.value);
        // å¦‚æœæ²’æœ‰å€¼ï¼Œå˜—è©¦è¨­ç½®ç‚ºç•¶å‰æœˆä»½
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = currentMonth.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®ç‚ºç•¶å‰æœˆä»½:', currentMonth);
    }
    const month = parseInt(monthSelect.value);
    const year = new Date().getFullYear();
    const display = document.getElementById('coachRosterDisplay');
    if (!display) return;
    
    // ğŸ”¥ ä¿®å¾©ï¼šæäº¤å¾Œé‡æ–°è¼‰å…¥æ™‚ï¼Œæ¸…é™¤ç·©å­˜ä»¥ç¢ºä¿ç²å–æœ€æ–°ç‹€æ…‹
    if (forceRefresh) {
        const phone = localStorage.getItem('current_user_phone') || '';
        const monthStr = `${year}-${String(month).padStart(2, '0')}`;
        const cacheKey = `${phone}_${monthStr}`;
        // æ¸…é™¤ç·©å­˜ï¼ˆå„ªå…ˆä½¿ç”¨å…¨å±€å‡½æ•¸ï¼‰
        if (typeof window.clearRosterDataCache === 'function') {
            window.clearRosterDataCache();
            console.log('ğŸ—‘ï¸ å¼·åˆ¶åˆ·æ–°ï¼šå·²æ¸…é™¤æ›´è¡¨ç·©å­˜ï¼ˆå…¨éƒ¨ï¼‰', { cacheKey, forceRefresh });
        } else if (typeof clearRosterDataCache === 'function') {
            clearRosterDataCache();
            console.log('ğŸ—‘ï¸ å¼·åˆ¶åˆ·æ–°ï¼šå·²æ¸…é™¤æ›´è¡¨ç·©å­˜ï¼ˆå…¨éƒ¨ï¼‰', { cacheKey, forceRefresh });
        } else {
            console.warn('âš ï¸ ç„¡æ³•æ¸…é™¤ç·©å­˜ï¼šclearRosterDataCache å‡½æ•¸ä¸å­˜åœ¨');
        }
    }
    
    display.innerHTML = '<div class="loading">è¼‰å…¥æ›´è¡¨ä¸­...</div>';
    
    try {
        // è¨­ç½®å…¨å±€é¸æ“‡å™¨ä»¥ä¾¿ç¾æœ‰å‡½æ•¸ä½¿ç”¨ï¼Œä½¿ç”¨ "YYYY-MM" æ ¼å¼
        const rosterMonthSelect = document.getElementById('rosterMonth');
        if (rosterMonthSelect) {
            rosterMonthSelect.value = `${year}-${String(month).padStart(2, '0')}`;
            console.log('âœ… è¨­ç½® rosterMonth å€¼:', rosterMonthSelect.value);
        }
        
        // ğŸ”¥ ä¿®å¾©ï¼šç›´æ¥èª¿ç”¨APIç²å–æ•¸æ“šä¸¦ç”Ÿæˆåˆ°æ­£ç¢ºå®¹å™¨ï¼Œé¿å…è¤‡è£½å°è‡´çš„ç‹€æ…‹ä¸ä¸€è‡´
        try {
            const db = window.App.getDatabaseConnector();
            if (!db) {
                display.innerHTML = '<div class="empty">æ•¸æ“šåº«é€£æ¥å¤±æ•—</div>';
                return;
            }
            
            // ç²å–ç•¶å‰ç”¨æˆ¶ä¿¡æ¯
            const currentUser = window.App.getCurrentUser();
            const employeePhone = currentUser ? currentUser.phone : '';
            
            if (!employeePhone) {
                display.innerHTML = '<div class="empty">ç„¡æ³•ç²å–ç•¶å‰ç”¨æˆ¶ä¿¡æ¯</div>';
                return;
            }
            
            // ç²å–æ›´è¡¨æ•¸æ“šï¼ˆä½¿ç”¨æœˆä»½å­—ç¬¦ä¸²æ ¼å¼ï¼‰
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            console.log('ğŸ” æ•™ç·´æ›´è¡¨ API è«‹æ±‚:', { monthStr, employeePhone });
            const rosterData = await window.App.fetchRoster(monthStr, employeePhone);
            console.log('ğŸ“Š æ•™ç·´æ›´è¡¨ API éŸ¿æ‡‰:', { 
                employeePhone, 
                monthStr, 
                dataType: Array.isArray(rosterData) ? 'array' : typeof rosterData,
                dataLength: Array.isArray(rosterData) ? rosterData.length : (rosterData?.roster?.length || 0)
            });
            
            // è™•ç†æ•¸æ“šæ ¼å¼
            let rosterList = [];
            if (Array.isArray(rosterData)) {
                rosterList = rosterData;
            } else if (rosterData && Array.isArray(rosterData.roster)) {
                rosterList = rosterData.roster;
            }
            
            // èšåˆç‚ºæŒ‰æ—¥æœŸåˆ†çµ„çš„Map
            const rosterByDay = new Map();
            (rosterList || []).forEach(item => {
                const dateStr = item?.date || item?.rosterDate || item?.day;
                if (!dateStr) {
                    console.warn('âš ï¸ è·³éç„¡æ—¥æœŸå­—æ®µçš„é …ç›®:', item);
                    return;
                }
                const d = new Date(dateStr);
                // ğŸ”¥ é©—è­‰æ—¥æœŸæ˜¯å¦å±¬æ–¼ç•¶å‰å¹´æœˆ
                if (isNaN(d.getTime())) {
                    console.warn('âš ï¸ ç„¡æ•ˆæ—¥æœŸæ ¼å¼:', dateStr);
                    return;
                }
                if (d.getFullYear() !== year || (d.getMonth() + 1) !== month) {
                    console.log('ğŸ” è·³éä¸å±¬æ–¼ç•¶å‰å¹´æœˆçš„æ—¥æœŸ:', {
                        dateStr,
                        parsedYear: d.getFullYear(),
                        parsedMonth: d.getMonth() + 1,
                        targetYear: year,
                        targetMonth: month
                    });
                    return;
                }
                const day = d.getDate();
                const time = item?.time || item?.timeRange || '';
                const location = item?.location || item?.place || '';
                const supervisorApproved = item?.supervisorApproved || false;
                const submittedBy = item?.submittedBy || 'unknown';
                const isSubmitted = item?.isSubmitted || false;
                const isConfirmed = item?.isConfirmed || false;
                // ğŸ”¥ ä¿®å¾©ï¼šå„ªå…ˆä½¿ç”¨ unavailableï¼Œç„¶å¾Œæ‰æ˜¯ isClicked
                const isClicked = item?.unavailable === true || item?.isClicked === true || false;
                const dayLocationKey = `${day}_${location || ''}`;
                if (!rosterByDay.has(dayLocationKey)) {
                    rosterByDay.set(dayLocationKey, []);
                }
                rosterByDay.get(dayLocationKey).push({ time, location, supervisorApproved, submittedBy, isSubmitted, isConfirmed, isClicked });
                console.log('âœ… æ·»åŠ æ›´è¡¨é …ç›®:', { day, dateStr, location, dayLocationKey, isSubmitted, isConfirmed, unavailable: item?.unavailable, isClicked });
            });
            
            console.log('ğŸ“Š æ›´è¡¨æ•¸æ“šè™•ç†å®Œæˆ:', {
                rosterListLength: rosterList.length,
                rosterByDaySize: rosterByDay.size,
                rosterByDayKeys: Array.from(rosterByDay.keys()),
                rosterByDayEntries: Array.from(rosterByDay.entries()).map(([key, items]) => ({
                    key,
                    itemsCount: items.length,
                    firstItem: items[0]
                }))
            });
            
            // æª¢æŸ¥æäº¤å’Œç¢ºèªç‹€æ…‹
            let isSubmitted = false;
            let isConfirmed = false;
            for (let [dayLocationKey, items] of rosterByDay) {
                if (items && items.length > 0) {
                    const firstItem = items[0];
                    if (firstItem?.isSubmitted === true) isSubmitted = true;
                    if (firstItem?.isConfirmed === true || firstItem?.supervisorApproved === true) isConfirmed = true;
                }
            }
            const isReadOnly = isSubmitted || isConfirmed;
            
            console.log('ğŸ“Š æ•™ç·´æ›´è¡¨ç‹€æ…‹:', { isSubmitted, isConfirmed, isReadOnly, rosterByDaySize: rosterByDay.size });
            
            // ğŸ”¥ å„ªåŒ–ï¼šç›´æ¥ç”Ÿæˆåˆ°ç›®æ¨™å®¹å™¨ï¼Œé¿å…è¤‡è£½å’Œé‡æ–°ç¶å®š
            if (typeof generateEditableRosterCalendar === 'function') {
                // ç›´æ¥æŒ‡å®šç›®æ¨™å®¹å™¨IDï¼Œç”Ÿæˆå‡½æ•¸æœƒç›´æ¥å¯«å…¥ä¸¦ç¶å®šäº‹ä»¶
                await generateEditableRosterCalendar(year, month, rosterByDay, true, isReadOnly, false, 'coachRosterDisplay');
                console.log('âœ… æ›´è¡¨å·²ç›´æ¥ç”Ÿæˆåˆ°ç›®æ¨™å®¹å™¨ï¼Œç‹€æ…‹:', { isSubmitted, isConfirmed, isReadOnly });
                
                // æª¢æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆ
                if (!display.innerHTML.trim()) {
                    display.innerHTML = '<div class="empty">ç„¡æ›´è¡¨æ•¸æ“š</div>';
                }
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°ç”Ÿæˆå‡½æ•¸');
                display.innerHTML = '<div class="empty">æ›´è¡¨æ¸²æŸ“åŠŸèƒ½æœªå°±ç·’</div>';
            }
        } catch (error) {
            console.error('è¼‰å…¥æ›´è¡¨å¤±æ•—:', error);
            display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    } catch (error) {
        console.error('è¼‰å…¥æ›´è¡¨å¤±æ•—:', error);
        display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

async function loadCoachWorkHours() {
    const yearSelect = document.getElementById('coachWorkHoursYearSelect');
    const monthSelect = document.getElementById('coachWorkHoursMonthSelect');
    if (!yearSelect || !monthSelect) {
        console.warn('âš ï¸ æ•™ç·´å·¥æ™‚ï¼šæ‰¾ä¸åˆ°å¹´ä»½æˆ–æœˆä»½é¸æ“‡å™¨');
        // å¦‚æœæ‰¾ä¸åˆ°é¸æ“‡å™¨ï¼Œå˜—è©¦é‡æ–°åˆå§‹åŒ–
        initializeWorkHoursDateSelectors('coachWorkHoursYearSelect', 'coachWorkHoursMonthSelect');
        return;
    }
    // å¦‚æœæ²’æœ‰å€¼ï¼Œè‡ªå‹•è¨­ç½®ç‚ºç•¶å‰å¹´æœˆ
    if (!yearSelect.value) {
        const currentYear = new Date().getFullYear();
        yearSelect.value = currentYear.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®å¹´ä»½ç‚ºç•¶å‰å¹´ä»½:', currentYear);
    }
    if (!monthSelect.value) {
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = currentMonth.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®æœˆä»½ç‚ºç•¶å‰æœˆä»½:', currentMonth);
    }
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value);
    const display = document.getElementById('coachWorkHoursDisplay');
    if (!display) {
        console.error('âŒ æ‰¾ä¸åˆ°å·¥æ™‚è¨˜éŒ„é¡¯ç¤ºå®¹å™¨');
        return;
    }
    
    display.innerHTML = '<div class="loading">è¼‰å…¥å·¥æ™‚è¨˜éŒ„ä¸­...</div>';
    
    try {
        // è¨­ç½®å…¨å±€é¸æ“‡å™¨
        const originalYearSelect = document.getElementById('coachWorkHoursYearSelect');
        const originalMonthSelect = document.getElementById('coachWorkHoursMonthSelect');
        if (originalYearSelect) originalYearSelect.value = year;
        if (originalMonthSelect) originalMonthSelect.value = month;
        
        // èª¿ç”¨å·¥æ™‚è¨˜éŒ„è¼‰å…¥å‡½æ•¸
        if (typeof WorkHoursFunctions !== 'undefined' && WorkHoursFunctions.loadWorkHoursData) {
            await WorkHoursFunctions.loadWorkHoursData();
            // generateWorkHoursTable æœƒç›´æ¥å¯«å…¥æ–°å®¹å™¨
            if (display.innerHTML.trim() && display.innerHTML !== '<div class="loading">è¼‰å…¥å·¥æ™‚è¨˜éŒ„ä¸­...</div>') {
                console.log('âœ… å·¥æ™‚è¨˜éŒ„è¡¨å·²è¼‰å…¥åˆ°æ–°å®¹å™¨');
            } else {
                display.innerHTML = '<div class="empty">ç„¡å·¥æ™‚è¨˜éŒ„æ•¸æ“š</div>';
            }
        } else {
            display.innerHTML = '<div class="empty">å·¥æ™‚è¨˜éŒ„åŠŸèƒ½æœªå°±ç·’</div>';
        }
    } catch (error) {
        console.error('è¼‰å…¥å·¥æ™‚è¨˜éŒ„å¤±æ•—:', error);
        display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

async function loadAdminRoster() {
    const employeeSelect = document.getElementById('adminEmployeeSelect');
    const monthSelect = document.getElementById('adminRosterMonthSelect');
    if (!employeeSelect || !monthSelect) {
        console.warn('âš ï¸ ç®¡ç†å“¡æ›´è¡¨ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„é¸æ“‡å™¨');
        return;
    }
    // å¦‚æœæ²’æœ‰å€¼ï¼Œè‡ªå‹•è¨­ç½®ç‚ºç•¶å‰æœˆä»½
    if (!monthSelect.value) {
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = currentMonth.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®ç‚ºç•¶å‰æœˆä»½:', currentMonth);
    }
    const employeePhone = employeeSelect.value;
    const month = parseInt(monthSelect.value);
    const year = new Date().getFullYear();
    const display = document.getElementById('adminRosterDisplay');
    if (!display) return;
    
    if (!employeePhone) {
        display.innerHTML = '<div class="empty">è«‹å…ˆé¸æ“‡å“¡å·¥</div>';
        return;
    }
    
    display.innerHTML = '<div class="loading">è¼‰å…¥æ›´è¡¨ä¸­...</div>';
    
    try {
        // è¨­ç½®å…¨å±€é¸æ“‡å™¨ï¼Œä½¿ç”¨ "YYYY-MM" æ ¼å¼
        const adminRosterMonthSelect = document.getElementById('adminRosterMonth');
        const rosterMonthSelect = document.getElementById('rosterMonth');
        if (adminRosterMonthSelect) {
            adminRosterMonthSelect.value = `${year}-${String(month).padStart(2, '0')}`;
        }
        if (rosterMonthSelect) {
            rosterMonthSelect.value = `${year}-${String(month).padStart(2, '0')}`;
            console.log('âœ… è¨­ç½® rosterMonth å€¼:', rosterMonthSelect.value);
        }
        
        // ç›´æ¥èª¿ç”¨APIç²å–æŒ‡å®šå“¡å·¥çš„æ›´è¡¨æ•¸æ“š
        try {
            const db = window.App.getDatabaseConnector();
            if (!db) {
                display.innerHTML = '<div class="empty">æ•¸æ“šåº«é€£æ¥å¤±æ•—</div>';
                return;
            }
            
            // ç²å–æ›´è¡¨æ•¸æ“šï¼ˆä½¿ç”¨æœˆä»½å­—ç¬¦ä¸²æ ¼å¼ï¼‰
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            const rosterData = await window.App.fetchRoster(monthStr, employeePhone);
            
            // è™•ç†æ•¸æ“šæ ¼å¼
            let rosterList = [];
            if (Array.isArray(rosterData)) {
                rosterList = rosterData;
            } else if (rosterData && Array.isArray(rosterData.roster)) {
                rosterList = rosterData.roster;
            }
            
            // èšåˆç‚ºæŒ‰æ—¥æœŸåˆ†çµ„çš„Map
            const rosterByDay = new Map();
            (rosterList || []).forEach(item => {
                const dateStr = item?.date || item?.rosterDate || item?.day;
                if (!dateStr) return;
                const d = new Date(dateStr);
                const day = d.getDate();
                if (!rosterByDay.has(day)) {
                    rosterByDay.set(day, []);
                }
                rosterByDay.get(day).push(item);
            });
            
            // æª¢æŸ¥åªè®€ç‹€æ…‹ï¼ˆå¦‚æœå·²æäº¤æˆ–ç¢ºèªï¼‰
            let isReadOnly = false;
            let isSubmitted = false;
            let isConfirmed = false;
            for (let [day, items] of rosterByDay) {
                if (items && items.length > 0) {
                    const firstItem = items[0];
                    if (firstItem?.isSubmitted === true) isSubmitted = true;
                    if (firstItem?.isConfirmed === true || firstItem?.supervisorApproved === true) isConfirmed = true;
                }
            }
            isReadOnly = isSubmitted || isConfirmed;
            
            // ğŸ”¥ å„ªåŒ–ï¼šç›´æ¥ç”Ÿæˆåˆ°ç›®æ¨™å®¹å™¨ï¼Œäº‹ä»¶å·²åœ¨ç”Ÿæˆå‡½æ•¸å…§ç¶å®š
            if (typeof generateAdminEditableRosterCalendar === 'function') {
                await generateAdminEditableRosterCalendar(year, month, rosterByDay, true, isReadOnly, false, 'adminRosterDisplay');
                console.log('âœ… æ›´è¡¨å·²ç›´æ¥ç”Ÿæˆåˆ°ç›®æ¨™å®¹å™¨ï¼Œç‹€æ…‹:', { isSubmitted, isConfirmed, isReadOnly });
                
                // æª¢æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆ
                if (!display.innerHTML.trim()) {
                    display.innerHTML = '<div class="empty">ç„¡æ›´è¡¨æ•¸æ“š</div>';
                }
            } else {
                display.innerHTML = '<div class="empty">æ›´è¡¨æ¸²æŸ“å‡½æ•¸æœªå°±ç·’</div>';
            }
        } catch (error) {
            console.error('è¼‰å…¥ç®¡ç†å“¡æ›´è¡¨å¤±æ•—:', error);
            display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    } catch (error) {
        console.error('è¼‰å…¥æ›´è¡¨å¤±æ•—:', error);
        display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

async function loadAdminWorkHours() {
    const employeeSelect = document.getElementById('adminEmployeeSelect');
    const yearSelect = document.getElementById('adminWorkHoursYearSelect');
    const monthSelect = document.getElementById('adminWorkHoursMonthSelect');
    if (!employeeSelect || !yearSelect || !monthSelect) {
        console.error('âŒ ç®¡ç†å“¡å·¥æ™‚ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„é¸æ“‡å™¨', {
            employeeSelect: !!employeeSelect,
            yearSelect: !!yearSelect,
            monthSelect: !!monthSelect
        });
        return;
    }
    // å¦‚æœæ²’æœ‰å€¼ï¼Œè‡ªå‹•è¨­ç½®ç‚ºç•¶å‰å¹´æœˆ
    if (!yearSelect.value) {
        const currentYear = new Date().getFullYear();
        yearSelect.value = currentYear.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®å¹´ä»½ç‚ºç•¶å‰å¹´ä»½:', currentYear);
    }
    if (!monthSelect.value) {
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = currentMonth.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®æœˆä»½ç‚ºç•¶å‰æœˆä»½:', currentMonth);
    }
    const employeePhone = employeeSelect.value;
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value);
    const display = document.getElementById('adminWorkHoursDisplay');
    if (!display) {
        console.error('âŒ æ‰¾ä¸åˆ°å·¥æ™‚è¨˜éŒ„é¡¯ç¤ºå®¹å™¨');
        return;
    }
    
    if (!employeePhone) {
        display.innerHTML = '<div class="empty">è«‹å…ˆé¸æ“‡å“¡å·¥</div>';
        return;
    }
    
    display.innerHTML = '<div class="loading">è¼‰å…¥å·¥æ™‚è¨˜éŒ„ä¸­...</div>';
    
    try {
        // è¨­ç½®å…¨å±€é¸æ“‡å™¨
        const workHoursEmployeeSelect = document.getElementById('workHoursEmployeeSelect');
        const workHoursYearSelect = document.getElementById('workHoursYearSelect');
        const workHoursMonthSelect = document.getElementById('workHoursMonthSelect');
        if (workHoursEmployeeSelect) workHoursEmployeeSelect.value = employeePhone;
        if (workHoursYearSelect) workHoursYearSelect.value = year;
        if (workHoursMonthSelect) workHoursMonthSelect.value = month;
        
        // èª¿ç”¨å·¥æ™‚è¨˜éŒ„è¼‰å…¥å‡½æ•¸
        if (typeof WorkHoursFunctions !== 'undefined' && WorkHoursFunctions.loadWorkHoursData) {
            await WorkHoursFunctions.loadWorkHoursData();
            // generateWorkHoursTable æœƒç›´æ¥å¯«å…¥æ–°å®¹å™¨
            if (display.innerHTML.trim() && display.innerHTML !== '<div class="loading">è¼‰å…¥å·¥æ™‚è¨˜éŒ„ä¸­...</div>') {
                console.log('âœ… å·¥æ™‚è¨˜éŒ„è¡¨å·²è¼‰å…¥åˆ°æ–°å®¹å™¨');
            } else {
                display.innerHTML = '<div class="empty">ç„¡å·¥æ™‚è¨˜éŒ„æ•¸æ“š</div>';
            }
        } else {
            display.innerHTML = '<div class="empty">å·¥æ™‚è¨˜éŒ„åŠŸèƒ½æœªå°±ç·’</div>';
        }
    } catch (error) {
        console.error('è¼‰å…¥å·¥æ™‚è¨˜éŒ„å¤±æ•—:', error);
        display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

async function loadSupervisorRoster() {
    const employeeSelect = document.getElementById('supervisorEmployeeSelect');
    const monthSelect = document.getElementById('supervisorRosterMonthSelect');
    if (!employeeSelect || !monthSelect) {
        console.warn('âš ï¸ ä¸»ç®¡æ›´è¡¨ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„é¸æ“‡å™¨');
        return;
    }
    // å¦‚æœæ²’æœ‰å€¼ï¼Œè‡ªå‹•è¨­ç½®ç‚ºç•¶å‰æœˆä»½
    if (!monthSelect.value) {
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = currentMonth.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®ç‚ºç•¶å‰æœˆä»½:', currentMonth);
    }
    const employeePhone = employeeSelect.value;
    const month = parseInt(monthSelect.value);
    const year = new Date().getFullYear();
    const display = document.getElementById('supervisorRosterDisplay');
    if (!display) return;
    
    if (!employeePhone) {
        display.innerHTML = '<div class="empty">è«‹å…ˆé¸æ“‡å“¡å·¥</div>';
        return;
    }
    
    display.innerHTML = '<div class="loading">è¼‰å…¥æ›´è¡¨ä¸­...</div>';
    
    try {
        // è¨­ç½®å…¨å±€é¸æ“‡å™¨ï¼Œä½¿ç”¨ "YYYY-MM" æ ¼å¼
        const staffCoachSelect = document.getElementById('staffCoachSelect');
        const rosterMonthSelect = document.getElementById('rosterMonth');
        if (staffCoachSelect) staffCoachSelect.value = employeePhone;
        if (rosterMonthSelect) {
            rosterMonthSelect.value = `${year}-${String(month).padStart(2, '0')}`;
            console.log('âœ… è¨­ç½® rosterMonth å€¼:', rosterMonthSelect.value);
        }
        
        // ğŸ”¥ ä¿®å¾©ï¼šç›´æ¥èª¿ç”¨APIç²å–æ›´è¡¨æ•¸æ“šä¸¦æ¸²æŸ“åˆ°æ–°å®¹å™¨
        try {
            const db = window.App.getDatabaseConnector();
            if (!db) {
                display.innerHTML = '<div class="empty">æ•¸æ“šåº«é€£æ¥å¤±æ•—</div>';
                return;
            }
            
            // ç²å–æ›´è¡¨æ•¸æ“šï¼ˆä½¿ç”¨æœˆä»½å­—ç¬¦ä¸²æ ¼å¼ï¼‰
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            console.log('ğŸ” ä¸»ç®¡æ›´è¡¨ API è«‹æ±‚:', { monthStr, employeePhone });
            const rosterData = await window.App.fetchRoster(monthStr, employeePhone);
            console.log('ğŸ“Š ä¸»ç®¡æ›´è¡¨ API éŸ¿æ‡‰:', { 
                employeePhone, 
                monthStr, 
                dataType: Array.isArray(rosterData) ? 'array' : typeof rosterData,
                dataLength: Array.isArray(rosterData) ? rosterData.length : (rosterData?.roster?.length || 0)
            });
            
            // è™•ç†æ•¸æ“šæ ¼å¼
            let rosterList = [];
            if (Array.isArray(rosterData)) {
                rosterList = rosterData;
            } else if (rosterData && Array.isArray(rosterData.roster)) {
                rosterList = rosterData.roster;
            }
            
            // ğŸ”¥ é©—è­‰ï¼šç¢ºä¿ç²å–çš„æ˜¯æ­£ç¢ºå“¡å·¥çš„æ•¸æ“šï¼ˆé€šéæª¢æŸ¥æ•¸æ“šä¸­çš„ phone å­—æ®µï¼Œå¦‚æœå­˜åœ¨ï¼‰
            if (rosterList.length > 0) {
                const firstItem = rosterList[0];
                if (firstItem?.phone && firstItem.phone !== employeePhone) {
                    console.warn('âš ï¸ æ•¸æ“šé©—è­‰è­¦å‘Šï¼šç²å–çš„æ•¸æ“šå¯èƒ½ä¸æ˜¯ç•¶å‰é¸æ“‡çš„å“¡å·¥', {
                        selectedEmployee: employeePhone,
                        dataEmployee: firstItem.phone
                    });
                } else {
                    console.log('âœ… æ•¸æ“šé©—è­‰é€šéï¼šç²å–çš„æ˜¯æ­£ç¢ºå“¡å·¥çš„æ•¸æ“š');
                }
            }
            
            // èšåˆç‚ºæŒ‰æ—¥æœŸåˆ†çµ„çš„Map
            const rosterByDay = new Map();
            (rosterList || []).forEach(item => {
                const dateStr = item?.date || item?.rosterDate || item?.day;
                if (!dateStr) return;
                const d = new Date(dateStr);
                // ğŸ”¥ ä¿®å¾©ï¼šé©—è­‰æ—¥æœŸæ˜¯å¦å±¬æ–¼ç•¶å‰å¹´æœˆï¼Œé¿å…é¡¯ç¤ºéŒ¯èª¤æœˆä»½çš„æ•¸æ“š
                if (d.getFullYear() !== year || (d.getMonth() + 1) !== month) {
                    console.warn('âš ï¸ è·³éä¸å±¬æ–¼ç•¶å‰å¹´æœˆçš„æ—¥æœŸ:', { dateStr, year, month, parsedYear: d.getFullYear(), parsedMonth: d.getMonth() + 1 });
                    return;
                }
                const day = d.getDate();
                const time = item?.time || item?.timeRange || '';
                const location = item?.location || item?.place || '';
                const supervisorApproved = item?.supervisorApproved || false;
                const submittedBy = item?.submittedBy || 'unknown';
                const isSubmitted = item?.isSubmitted || false;
                const isConfirmed = item?.isConfirmed || false;
                const isClicked = item?.isClicked || false;
                const dayLocationKey = `${day}_${location || ''}`;
                if (!rosterByDay.has(dayLocationKey)) {
                    rosterByDay.set(dayLocationKey, []);
                }
                rosterByDay.get(dayLocationKey).push({ time, location, supervisorApproved, submittedBy, isSubmitted, isConfirmed, isClicked });
            });
            
            console.log('ğŸ“Š ä¸»ç®¡æ›´è¡¨æ•¸æ“šè™•ç†å®Œæˆ:', {
                employeePhone,
                year,
                month,
                rosterListLength: rosterList.length,
                rosterByDaySize: rosterByDay.size,
                rosterByDayKeys: Array.from(rosterByDay.keys())
            });
            
            // æª¢æŸ¥åªè®€ç‹€æ…‹ï¼ˆå¦‚æœå·²æäº¤æˆ–ç¢ºèªï¼‰
            let isReadOnly = false;
            let isSubmitted = false;
            let isConfirmed = false;
            for (let [dayLocationKey, items] of rosterByDay) {
                if (items && items.length > 0) {
                    const firstItem = items[0];
                    if (firstItem?.isSubmitted === true) isSubmitted = true;
                    if (firstItem?.isConfirmed === true || firstItem?.supervisorApproved === true) isConfirmed = true;
                }
            }
            isReadOnly = isSubmitted || isConfirmed;
            
            // ğŸ”¥ ä¿®å¾©ï¼šç›´æ¥æ¸²æŸ“åˆ°æ–°å®¹å™¨ï¼Œé¿å…ä½¿ç”¨è‡¨æ™‚å®¹å™¨å°è‡´æ•¸æ“šæ··äº‚
            // æ·»åŠ èª¿è©¦æ—¥èªŒç¢ºèªæ•¸æ“šæ­£ç¢ºæ€§
            console.log('ğŸ” ä¸»ç®¡æ›´è¡¨è¼‰å…¥ä¿¡æ¯:', {
                employeePhone,
                year,
                month,
                monthStr,
                rosterListLength: rosterList.length,
                rosterByDaySize: rosterByDay.size
            });
            
            // ğŸ”¥ å„ªåŒ–ï¼šç›´æ¥ç”Ÿæˆåˆ°ç›®æ¨™å®¹å™¨ï¼Œé¿å…è¤‡è£½å’Œé‡æ–°ç¶å®š
            if (typeof generateEditableRosterCalendar === 'function') {
                // ç›´æ¥æŒ‡å®šç›®æ¨™å®¹å™¨IDï¼Œç”Ÿæˆå‡½æ•¸æœƒç›´æ¥å¯«å…¥ä¸¦ç¶å®šäº‹ä»¶
                await generateEditableRosterCalendar(year, month, rosterByDay, false, isReadOnly, false, 'supervisorRosterDisplay');
                console.log('âœ… ä¸»ç®¡æ›´è¡¨å·²ç›´æ¥ç”Ÿæˆåˆ°ç›®æ¨™å®¹å™¨ï¼Œå“¡å·¥:', employeePhone, 'ç‹€æ…‹:', { isSubmitted, isConfirmed, isReadOnly });
                
                // æª¢æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆ
                if (!display.innerHTML.trim()) {
                    display.innerHTML = '<div class="empty">ç„¡æ›´è¡¨æ•¸æ“š</div>';
                }
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°ç”Ÿæˆå‡½æ•¸');
                display.innerHTML = '<div class="empty">æ›´è¡¨æ¸²æŸ“åŠŸèƒ½æœªå°±ç·’</div>';
            }
        } catch (error) {
            console.error('è¼‰å…¥ä¸»ç®¡æ›´è¡¨å¤±æ•—:', error);
            display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    } catch (error) {
        console.error('è¼‰å…¥æ›´è¡¨å¤±æ•—:', error);
        display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

async function loadSupervisorWorkHours() {
    const employeeSelect = document.getElementById('supervisorEmployeeSelect');
    const yearSelect = document.getElementById('supervisorWorkHoursYearSelect');
    const monthSelect = document.getElementById('supervisorWorkHoursMonthSelect');
    if (!employeeSelect || !yearSelect || !monthSelect) {
        console.warn('âš ï¸ ä¸»ç®¡å·¥æ™‚ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„é¸æ“‡å™¨');
        return;
    }
    // å¦‚æœæ²’æœ‰å€¼ï¼Œè‡ªå‹•è¨­ç½®ç‚ºç•¶å‰å¹´æœˆ
    if (!yearSelect.value) {
        const currentYear = new Date().getFullYear();
        yearSelect.value = currentYear.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®å¹´ä»½ç‚ºç•¶å‰å¹´ä»½:', currentYear);
    }
    if (!monthSelect.value) {
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = currentMonth.toString();
        console.log('âœ… è‡ªå‹•è¨­ç½®æœˆä»½ç‚ºç•¶å‰æœˆä»½:', currentMonth);
    }
    const employeePhone = employeeSelect.value;
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value);
    const display = document.getElementById('supervisorWorkHoursDisplay');
    if (!display) return;
    
    if (!employeePhone) {
        display.innerHTML = '<div class="empty">è«‹å…ˆé¸æ“‡å“¡å·¥</div>';
        return;
    }
    
    display.innerHTML = '<div class="loading">è¼‰å…¥å·¥æ™‚è¨˜éŒ„ä¸­...</div>';
    
    try {
        // è¨­ç½®å…¨å±€é¸æ“‡å™¨
        const workHoursEmployeeSelect = document.getElementById('supervisorWorkHoursEmployeeSelect');
        const workHoursYearSelect = document.getElementById('supervisorWorkHoursYearSelect');
        const workHoursMonthSelect = document.getElementById('supervisorWorkHoursMonthSelect');
        if (workHoursEmployeeSelect) workHoursEmployeeSelect.value = employeePhone;
        if (workHoursYearSelect) workHoursYearSelect.value = year;
        if (workHoursMonthSelect) workHoursMonthSelect.value = month;
        
        // èª¿ç”¨å·¥æ™‚è¨˜éŒ„è¼‰å…¥å‡½æ•¸
        if (typeof WorkHoursFunctions !== 'undefined' && WorkHoursFunctions.loadWorkHoursData) {
            await WorkHoursFunctions.loadWorkHoursData();
            // generateWorkHoursTable æœƒç›´æ¥å¯«å…¥æ–°å®¹å™¨
            if (display.innerHTML.trim() && display.innerHTML !== '<div class="loading">è¼‰å…¥å·¥æ™‚è¨˜éŒ„ä¸­...</div>') {
                console.log('âœ… å·¥æ™‚è¨˜éŒ„è¡¨å·²è¼‰å…¥åˆ°æ–°å®¹å™¨');
            } else {
                display.innerHTML = '<div class="empty">ç„¡å·¥æ™‚è¨˜éŒ„æ•¸æ“š</div>';
            }
        } else {
            display.innerHTML = '<div class="empty">å·¥æ™‚è¨˜éŒ„åŠŸèƒ½æœªå°±ç·’</div>';
        }
    } catch (error) {
        console.error('è¼‰å…¥å·¥æ™‚è¨˜éŒ„å¤±æ•—:', error);
        display.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

function onSupervisorEmployeeSelectChange() {
    // å“¡å·¥é¸æ“‡æ”¹è®Šæ™‚æ¸…ç©ºé¡¯ç¤º
    const rosterDisplay = document.getElementById('supervisorRosterDisplay');
    const workHoursDisplay = document.getElementById('supervisorWorkHoursDisplay');
    if (rosterDisplay) rosterDisplay.innerHTML = '<div class="empty">è«‹é¸æ“‡æœˆä»½ä¸¦é»æ“Šã€Œè¼‰å…¥æ›´è¡¨ã€</div>';
    if (workHoursDisplay) workHoursDisplay.innerHTML = '<div class="empty">è«‹é¸æ“‡å¹´ä»½å’Œæœˆä»½ä¸¦é»æ“Šã€Œè¼‰å…¥å·¥æ™‚ã€</div>';
}

function onAdminEmployeeSelectChange() {
    // å“¡å·¥é¸æ“‡æ”¹è®Šæ™‚æ¸…ç©ºé¡¯ç¤º
    const rosterDisplay = document.getElementById('adminRosterDisplay');
    const workHoursDisplay = document.getElementById('adminWorkHoursDisplay');
    if (rosterDisplay) rosterDisplay.innerHTML = '<div class="empty">è«‹é¸æ“‡æœˆä»½ä¸¦é»æ“Šã€Œè¼‰å…¥æ›´è¡¨ã€</div>';
    if (workHoursDisplay) workHoursDisplay.innerHTML = '<div class="empty">è«‹é¸æ“‡å¹´ä»½å’Œæœˆä»½ä¸¦é»æ“Šã€Œè¼‰å…¥å·¥æ™‚ã€</div>';
}

window.loadCoachRoster = loadCoachRoster;
window.loadCoachWorkHours = loadCoachWorkHours;
window.loadAdminRoster = loadAdminRoster;
window.loadAdminWorkHours = loadAdminWorkHours;
window.loadSupervisorRoster = loadSupervisorRoster;
window.loadSupervisorWorkHours = loadSupervisorWorkHours;
window.onSupervisorEmployeeSelectChange = onSupervisorEmployeeSelectChange;
window.onAdminEmployeeSelectChange = onAdminEmployeeSelectChange;

async function renderWorkHoursSummaryTable() {
  const zone = document.getElementById('dataTableZone');
  zone.innerHTML = '<div class="loading">æ­£åœ¨åŠ è¼‰å·¥æ™‚è¨˜éŒ„...</div>';
  const employees = await window.App.getEmployees();
  const year = new Date().getFullYear(), month = new Date().getMonth()+1;
  // å½™æ•´æ‰€æœ‰åœ°é»æ³³æœƒ
  let allLocClubs = new Set(), allDates = new Set();
  const empRows = [];
  for (const emp of employees) {
    const list = await window.App.fetchStaffWorkHours(emp.phone, year, month);
    if(!list||!list.length) continue;
    list.forEach(r=>{
      if(r.location && r.club) allLocClubs.add(`${r.location}@${r.club}`);
      if(r.workDate) allDates.add(r.workDate);
    });
    empRows.push({emp, rows: list});
  }
  allLocClubs = [...allLocClubs].sort();
  allDates = [...allDates].sort();
  let html = '';
  for(const {emp, rows} of empRows) {
    html += `<div class="workhours-summary-block"><h4>${emp.name}</h4><div style="overflow:auto">`;
    html += '<table class="data-data-table"><thead><tr><th>æ—¥æœŸ</th>'+allLocClubs.map(lc=>`<th>${lc.replace('@','<br>')}</th>`).join('')+'<th>æ¯æ—¥å°è¨ˆ</th></tr></thead><tbody>';
    for(const d of allDates) {
      let row = `<td>${d}</td>`, rowSum = 0, hasContent = false;
      for(const lc of allLocClubs) {
        const [loc, club] = lc.split('@');
        const rec = rows.find(r=>r.workDate===d && r.location===loc && r.club===club);
        let val = rec && rec.totalHours ? +rec.totalHours : '';
        rowSum += Number(val)||0;
        if(Number(val)>0) hasContent = true;
        row += `<td>${val||''}</td>`;
      }
      if(hasContent)
        html += `<tr>${row}<td>${rowSum?rowSum:''}</td></tr>`;
    }
    let sumRow = '<td>ç¸½è¨ˆ</td>'; let totalAll = 0;
    for(const lc of allLocClubs) {
      const [loc, club] = lc.split('@');
      let sum = rows.filter(r=>r.location===loc && r.club===club).reduce((acc,r)=>acc+(Number(r.totalHours)||0),0);
      totalAll += sum;
      sumRow += `<td>${sum?sum:''}</td>`;
    }
    sumRow += `<td>${totalAll||''}</td>`;
    html += `<tr style="background:#f3f4f6;font-weight:bold">${sumRow}</tr>`;
    html += '</tbody></table></div></div>';
  }
  if(!html) html = '<div class="empty">ç„¡å·¥æ™‚è³‡æ–™</div>';
  zone.innerHTML = html;
}
<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swimsports - 學員報名系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-light': '#7978E9',
                        'primary-dark': '#4948B3',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #666;
        }
        
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #5D5CDE;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dark .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #7978E9;
        }
        
        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            user-select: none;
        }
        
        .calendar-day:not(.empty):not(.disabled):hover {
            background-color: #e9e9ff;
        }
        
        .dark .calendar-day:not(.empty):not(.disabled):hover {
            background-color: #3e3e60;
        }
        
        .calendar-day.selected {
            background-color: #5D5CDE !important;
            color: white !important;
        }
        
        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .dark .calendar-day.disabled {
            color: #666;
        }
        
        .calendar-day.empty {
            pointer-events: none;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Quick date selection buttons */
        .quick-select-btn {
            transition: all 0.2s;
        }
        
        /* Weekday selector styles */
        .weekday-selector {
            color: #374151;
            background-color: transparent;
            border: 1px solid transparent;
        }
        
        .weekday-selector:hover {
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            border-color: rgba(93, 92, 222, 0.3);
        }
        
        .weekday-selector.selected {
            background-color: #5D5CDE !important;
            color: white !important;
            font-weight: 600;
            border: 2px solid #4948B3 !important;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
        
        .dark .weekday-selector {
            color: #e5e7eb;
            background-color: transparent;
        }
        
        .dark .weekday-selector:hover {
            background-color: rgba(121, 120, 233, 0.2);
            color: #7978E9;
            border-color: rgba(121, 120, 233, 0.4);
        }
        
        .dark .weekday-selector.selected {
            background-color: #7978E9 !important;
            color: white !important;
            border: 2px solid #5D5CDE !important;
            box-shadow: 0 0 0 3px rgba(121, 120, 233, 0.2);
        }
        
        /* Location selector styles */
        .location-selector {
            color: #374151;
            background-color: transparent;
            border: 1px solid transparent;
        }
        
        .location-selector:hover {
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            border-color: rgba(93, 92, 222, 0.3);
        }
        
        .location-selector.selected {
            background-color: #5D5CDE !important;
            color: white !important;
            font-weight: 600;
            border: 2px solid #4948B3 !important;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
        
        .dark .location-selector {
            color: #e5e7eb;
            background-color: transparent;
        }
        
        .dark .location-selector:hover {
            background-color: rgba(121, 120, 233, 0.2);
            color: #7978E9;
            border-color: rgba(121, 120, 233, 0.4);
        }
        
        .dark .location-selector.selected {
            background-color: #7978E9 !important;
            color: white !important;
            border: 2px solid #5D5CDE !important;
            box-shadow: 0 0 0 3px rgba(121, 120, 233, 0.2);
        }
        
        /* Course type selector styles */
        .course-type-selector {
            color: #374151;
            background-color: transparent;
            border: 1px solid transparent;
        }
        
        .course-type-selector:hover {
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            border-color: rgba(93, 92, 222, 0.3);
        }
        
        .course-type-selector.selected {
            background-color: #5D5CDE !important;
            color: white !important;
            font-weight: 600;
            border: 2px solid #4948B3 !important;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
        
        .dark .course-type-selector {
            color: #e5e7eb;
            background-color: transparent;
        }
        
        .dark .course-type-selector:hover {
            background-color: rgba(121, 120, 233, 0.2);
            color: #7978E9;
            border-color: rgba(121, 120, 233, 0.4);
        }
        
        .dark .course-type-selector.selected {
            background-color: #7978E9 !important;
            color: white !important;
            border: 2px solid #5D5CDE !important;
            box-shadow: 0 0 0 3px rgba(121, 120, 233, 0.2);
        }
        
        /* Class format selector styles */
        .class-format-selector {
            color: #374151;
            background-color: transparent;
            border: 1px solid transparent;
        }
        
        .class-format-selector:hover {
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            border-color: rgba(93, 92, 222, 0.3);
        }
        
        .class-format-selector.selected {
            background-color: #5D5CDE !important;
            color: white !important;
            font-weight: 600;
            border: 2px solid #4948B3 !important;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
        
        .dark .class-format-selector {
            color: #e5e7eb;
            background-color: transparent;
        }
        
        .dark .class-format-selector:hover {
            background-color: rgba(121, 120, 233, 0.2);
            color: #7978E9;
            border-color: rgba(121, 120, 233, 0.4);
        }
        
        .dark .class-format-selector.selected {
            background-color: #7978E9 !important;
            color: white !important;
            border: 2px solid #5D5CDE !important;
            box-shadow: 0 0 0 3px rgba(121, 120, 233, 0.2);
        }
        
        /* Instructor type selector styles */
        .instructor-type-selector {
            color: #374151;
            background-color: transparent;
            border: 1px solid transparent;
        }
        
        .instructor-type-selector:hover {
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            border-color: rgba(93, 92, 222, 0.3);
        }
        
        .instructor-type-selector.selected {
            background-color: #5D5CDE !important;
            color: white !important;
            font-weight: 600;
            border: 2px solid #4948B3 !important;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
        
        .dark .instructor-type-selector {
            color: #e5e7eb;
            background-color: transparent;
        }
        
        .dark .instructor-type-selector:hover {
            background-color: rgba(121, 120, 233, 0.2);
            color: #7978E9;
            border-color: rgba(121, 120, 233, 0.4);
        }
        
        .dark .instructor-type-selector.selected {
            background-color: #7978E9 !important;
            color: white !important;
            border: 2px solid #5D5CDE !important;
            box-shadow: 0 0 0 3px rgba(121, 120, 233, 0.2);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-primary dark:text-primary-light mb-2">Swimsports - 學員報名系統</h1>
            <p class="text-gray-600 dark:text-gray-400">快速生成學員報名繳費訊息</p>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Form Inputs -->
            <div class="lg:col-span-2 bg-gray-50 dark:bg-gray-800 rounded-lg p-6 shadow">
                <h2 class="text-xl font-semibold mb-4 text-primary dark:text-primary-light border-b pb-2">學員及課程資料</h2>
                
                <form id="registrationForm" class="space-y-4">
                    <div>
                        <label for="registrationType" class="block text-sm font-medium mb-1">報名類型</label>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="registrationType" value="新生報名" class="form-radio h-5 w-5 text-primary" checked>
                                <span class="ml-2">新生報名</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="registrationType" value="學員續報" class="form-radio h-5 w-5 text-primary">
                                <span class="ml-2">學員續報</span>
                            </label>
                        </div>
                    </div>

                    <!-- 試堂資料 - 只在新生報名時顯示 -->
                    <div id="trialLessonInfo" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="trialInstructor" class="block text-sm font-medium mb-1">試堂導師</label>
                                <input type="text" id="trialInstructor" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                            </div>
                            <div>
                                <label for="trialDate" class="block text-sm font-medium mb-1">試堂日期</label>
                                
                                <!-- 預設日期顯示模式 -->
                                <div id="trialDateDisplay" class="flex gap-2">
                                    <div class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md border border-gray-300 dark:border-gray-600 p-2 text-base">
                                        <span id="trialDateText" class="text-gray-900 dark:text-gray-100"></span>
                                    </div>
                                    <button type="button" id="editTrialDateBtn" class="bg-primary hover:bg-primary-dark text-white rounded-md px-3 py-2 transition text-sm">
                                        修改
                                    </button>
                                </div>
                                
                                <!-- 日期選擇器模式 (初始隱藏) -->
                                <div id="trialDateSelector" class="hidden">
                                    <div class="flex gap-2 mb-3">
                                        <select id="trialYear" class="rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                            <option value="2024">2024年</option>
                                            <option value="2025" selected>2025年</option>
                                            <option value="2026">2026年</option>
                                        </select>
                                        <select id="trialMonth" class="rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                            <option value="1" selected>1月</option>
                                            <option value="2">2月</option>
                                            <option value="3">3月</option>
                                            <option value="4">4月</option>
                                            <option value="5">5月</option>
                                            <option value="6">6月</option>
                                            <option value="7">7月</option>
                                            <option value="8">8月</option>
                                            <option value="9">9月</option>
                                            <option value="10">10月</option>
                                            <option value="11">11月</option>
                                            <option value="12">12月</option>
                                        </select>
                                        <select id="trialDay" class="rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                            <option value="1" selected>1日</option>
                                            <!-- 其他日期选项将通过JavaScript动态生成 -->
                                        </select>
                                    </div>
                                    
                                    <!-- 迷你日曆 -->
                                    <div class="trial-mini-calendar bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-3">
                                        <!-- 月份導航 -->
                                        <div class="flex items-center justify-between mb-3">
                                            <button type="button" id="trialPrevMonthBtn" class="p-1 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </button>
                                            <div class="text-center">
                                                <h4 id="trialCalendarMonthYear" class="text-sm font-semibold text-gray-900 dark:text-gray-100"></h4>
                                            </div>
                                            <button type="button" id="trialNextMonthBtn" class="p-1 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </button>
                                        </div>
                                        
                                        <!-- 星期標題 -->
                                        <div class="grid grid-cols-7 gap-1 mb-2">
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">日</div>
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">一</div>
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">二</div>
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">三</div>
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">四</div>
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">五</div>
                                            <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">六</div>
                                        </div>
                                        
                                        <!-- 日期網格 -->
                                        <div id="trialCalendarGrid" class="grid grid-cols-7 gap-1">
                                            <!-- 日期將在這裡動態生成 -->
                                        </div>
                                    </div>
                                    
                                    <!-- 確認按鈕 -->
                                    <div class="flex gap-2 mt-3">
                                        <button type="button" id="confirmTrialDateBtn" class="flex-1 bg-primary hover:bg-primary-dark text-white rounded-md px-3 py-2 transition text-sm">
                                            確認日期
                                        </button>
                                        <button type="button" id="cancelTrialDateBtn" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded-md px-3 py-2 transition text-sm">
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 學員名稱部分 -->
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="block text-sm font-medium">學員姓名<span class="text-gray-500 text-xs ml-2">(選填)</span></label>
                            <button type="button" id="addStudentBtn" class="text-sm text-primary hover:text-primary-dark dark:text-primary-light dark:hover:text-white flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                新增學員
                            </button>
                        </div>
                        <div id="studentsContainer" class="space-y-2">
                            <div class="student-entry flex gap-2">
                                <input type="text" class="student-name flex-1 rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base" placeholder="學員姓名">
                                <input type="number" class="student-age w-20 rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base" placeholder="年齡" min="0" max="100">
                                <button type="button" class="remove-student-btn bg-red-500 hover:bg-red-600 text-white rounded-md px-3 py-1 text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">上課地點</label>
                        <div class="grid grid-cols-6 gap-1 p-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm">
                            <div class="location-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-location="堅尼地城游泳池" data-short="堅">堅</div>
                            <div class="location-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-location="維多利亞公園游泳池" data-short="維">維</div>
                            <div class="location-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-location="九龍公園游泳池" data-short="九">九</div>
                            <div class="location-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-location="荔枝角公園游泳池" data-short="美">美</div>
                            <div class="location-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-location="觀塘游泳池" data-short="觀">觀</div>
                            <div class="location-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-location="上門" data-short="上">上</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">課程類型</label>
                            <div class="grid grid-cols-4 gap-1 p-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm">
                                <div class="course-type-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-course-type="全年親子嬰兒班" data-short="親">親</div>
                                <div class="course-type-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-course-type="全年私人班" data-short="私">私</div>
                                <div class="course-type-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30 selected" data-course-type="指定導師課程（全年）" data-short="指">指</div>
                                <div class="course-type-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-course-type="全年團體泳班" data-short="團">團</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">課堂形式</label>
                            <div id="classFormatContainer" class="grid gap-1 p-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm">
                                <!-- 課堂形式選項將動態生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">導師級別</label>
                            <div id="instructorTypeContainer" class="grid gap-1 p-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm">
                                <!-- 導師級別選項將動態生成 -->
                            </div>
                        </div>
                        
                        <div>
                            <label for="instructorName" class="block text-sm font-medium mb-1">指定導師名稱 <small>(選填)</small></label>
                            <input type="text" id="instructorName" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="pricePerLesson" class="block text-sm font-medium mb-1">每堂收費</label>
                            <input type="number" id="pricePerLesson" value="225" min="1" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                        </div>
                        
                        <div id="studentSourceSection">
                            <label for="studentSource" class="block text-sm font-medium mb-1">學生來源</label>
                            <select id="studentSource" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                <option value="無">無</option>
                                <option value="朋友介紹">朋友介紹</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Google">Google</option>
                                <option value="小紅書">小紅書</option>
                                <option value="電話查詢">電話查詢</option>
                                <option value="何巴巴游泳池">何巴巴游泳池</option>
                                <option value="Baby Tiger">Baby Tiger</option>
                            </select>
                            
                            <!-- 朋友介紹輸入框 -->
                            <div id="referrerNameSection" class="mt-3 hidden">
                                <label for="referrerName" class="block text-sm font-medium mb-1">現有學員名字</label>
                                <input type="text" id="referrerName" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                            </div>
                        </div>
                    </div>

                    <div id="extraDiscountSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div id="groupDiscountSection">
                            <label for="groupDiscount" class="block text-sm font-medium mb-1">新生首次報名同行優惠</label>
                            <select id="groupDiscount" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                <option value="1">單人報名 (無折扣)</option>
                                <option value="2">2人同行 (95折)</option>
                                <option value="3">3人同行 (9折)</option>
                                <option value="4">4人同行 (85折)</option>
                            </select>
                        </div>
                        
                        <div id="referralDiscountSection">
                            <label for="referralDiscount" class="block text-sm font-medium mb-1">介紹朋友人數 (每位減$200)</label>
                            <div class="flex gap-2">
                                <select id="referralDiscount" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                    <option value="0">無介紹朋友</option>
                                    <option value="1">1位</option>
                                    <option value="2">2位</option>
                                    <option value="3">3位</option>
                                    <option value="4">4位</option>
                                    <option value="5">5位</option>
                                    <option value="6">6位</option>
                                    <option value="7">7位</option>
                                    <option value="8">8位</option>
                                    <option value="9">9位</option>
                                    <option value="10">10位</option>
                                </select>
                                <button type="button" id="addReferralBtn" class="bg-primary hover:bg-primary-dark text-white rounded-md px-3 py-2 transition flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 介紹朋友名單 -->
                    <div id="referralSection" class="hidden">
                        <h3 class="text-md font-medium mb-2">介紹朋友名單</h3>
                        <div id="referralContainer" class="space-y-2">
                            <!-- 介紹朋友輸入項將在這裡被生成 -->
                        </div>
                    </div>

                    <!-- 學期堂數規劃 -->
                    <div id="semesterPlanningSection" class="space-y-4">
                        <h3 class="text-md font-medium">學期堂數規劃</h3>
                        <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">每堂收費</label>
                                    <div class="text-lg font-semibold text-primary dark:text-primary-light" id="displayPricePerLesson">$225</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">學員人數</label>
                                    <div class="text-lg font-semibold text-primary dark:text-primary-light" id="displayStudentCount">1人</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">每期基本費用</label>
                                    <div class="text-sm text-gray-600 dark:text-gray-400" id="baseCostInfo">
                                        7堂: $1,575 (無折扣)<br>
                                        8堂: $1,710 → $1,625 (95折)<br>
                                        12堂: $2,700 → $2,430 (9折)<br>
                                        15堂: $3,375 → $2,869 (85折)
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                                <div class="period-planning">
                                    <label class="block text-xs font-medium mb-0.5">A學期 (1-2月)</label>
                                    <input type="number" class="period-lessons-input w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" 
                                           data-period="A學期 (1-2月)" min="0" value="0">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">
                                        <div class="period-cost">$0</div>
                                        <div class="period-discount-info"></div>
                                    </div>
                                </div>
                                <div class="period-planning">
                                    <label class="block text-xs font-medium mb-0.5">B學期 (3-4月)</label>
                                    <input type="number" class="period-lessons-input w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" 
                                           data-period="B學期 (3-4月)" min="0" value="0">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">
                                        <div class="period-cost">$0</div>
                                        <div class="period-discount-info"></div>
                                    </div>
                                </div>
                                <div class="period-planning">
                                    <label class="block text-xs font-medium mb-0.5">C學期 (5-6月)</label>
                                    <input type="number" class="period-lessons-input w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" 
                                           data-period="C學期 (5-6月)" min="0" value="0">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">
                                        <div class="period-cost">$0</div>
                                        <div class="period-discount-info"></div>
                                    </div>
                                </div>
                                <div class="period-planning">
                                    <label class="block text-xs font-medium mb-0.5">D學期 (7-8月)</label>
                                    <input type="number" class="period-lessons-input w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" 
                                           data-period="D學期 (7-8月)" min="0" value="0">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">
                                        <div class="period-cost">$0</div>
                                        <div class="period-discount-info"></div>
                                    </div>
                                </div>
                                <div class="period-planning">
                                    <label class="block text-xs font-medium mb-0.5">E學期 (9-10月)</label>
                                    <input type="number" class="period-lessons-input w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" 
                                           data-period="E學期 (9-10月)" min="0" value="8">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">
                                        <div class="period-cost">$1,710</div>
                                        <div class="period-discount-info">→ $1,625 (95折)</div>
                                    </div>
                                </div>
                                <div class="period-planning">
                                    <label class="block text-xs font-medium mb-0.5">F學期 (11-12月)</label>
                                    <input type="number" class="period-lessons-input w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" 
                                           data-period="F學期 (11-12月)" min="0" value="8">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 leading-tight">
                                        <div class="period-cost">$1,710</div>
                                        <div class="period-discount-info">→ $1,625 (95折)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 餘下堂數及截至日期 -->
                            <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label for="remainingLessons" class="block text-xs font-medium mb-0.5">餘下堂數 <small>(選填)</small></label>
                                        <input type="number" id="remainingLessons" min="0" class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1.5 text-sm" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-0.5">截至日期 <small>(選填)</small></label>
                                        
                                        <!-- 預設日期顯示模式 -->
                                        <div id="asOfDateDisplay" class="flex gap-2">
                                            <div class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md border border-gray-300 dark:border-gray-600 p-2 text-base">
                                                <span id="asOfDateText" class="text-gray-900 dark:text-gray-100">未設定</span>
                                            </div>
                                            <button type="button" id="editAsOfDateBtn" class="bg-primary hover:bg-primary-dark text-white rounded-md px-3 py-2 transition text-sm">
                                                設定
                                            </button>
                                        </div>
                                        
                                        <!-- 日期選擇器模式 (初始隱藏) -->
                                        <div id="asOfDateSelector" class="hidden">
                                            <div class="flex gap-2 mb-3">
                                                <select id="asOfYear" class="rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                                    <option value="2024">2024年</option>
                                                    <option value="2025" selected>2025年</option>
                                                    <option value="2026">2026年</option>
                                                </select>
                                                <select id="asOfMonth" class="rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                                    <option value="1" selected>1月</option>
                                                    <option value="2">2月</option>
                                                    <option value="3">3月</option>
                                                    <option value="4">4月</option>
                                                    <option value="5">5月</option>
                                                    <option value="6">6月</option>
                                                    <option value="7">7月</option>
                                                    <option value="8">8月</option>
                                                    <option value="9">9月</option>
                                                    <option value="10">10月</option>
                                                    <option value="11">11月</option>
                                                    <option value="12">12月</option>
                                                </select>
                                                <select id="asOfDay" class="rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                                    <option value="1" selected>1日</option>
                                                    <!-- 其他日期选项将通过JavaScript动态生成 -->
                                                </select>
                                            </div>
                                            
                                            <!-- 迷你日曆 -->
                                            <div class="asof-mini-calendar bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-3">
                                                <!-- 月份導航 -->
                                                <div class="flex items-center justify-between mb-3">
                                                    <button type="button" id="asOfPrevMonthBtn" class="p-1 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                        </svg>
                                                    </button>
                                                    <div class="text-center">
                                                        <h4 id="asOfCalendarMonthYear" class="text-sm font-semibold text-gray-900 dark:text-gray-100"></h4>
                                                    </div>
                                                    <button type="button" id="asOfNextMonthBtn" class="p-1 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                
                                                <!-- 星期標題 -->
                                                <div class="grid grid-cols-7 gap-1 mb-2">
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">日</div>
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">一</div>
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">二</div>
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">三</div>
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">四</div>
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">五</div>
                                                    <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">六</div>
                                                </div>
                                                
                                                <!-- 日期網格 -->
                                                <div id="asOfCalendarGrid" class="grid grid-cols-7 gap-1">
                                                    <!-- 日期將在這裡動態生成 -->
                                                </div>
                                            </div>
                                            
                                            <!-- 確認按鈕 -->
                                            <div class="flex gap-2 mt-3">
                                                <button type="button" id="confirmAsOfDateBtn" class="flex-1 bg-primary hover:bg-primary-dark text-white rounded-md px-3 py-2 transition text-sm">
                                                    確認日期
                                                </button>
                                                <button type="button" id="cancelAsOfDateBtn" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded-md px-3 py-2 transition text-sm">
                                                    取消
                                                </button>
                                                <button type="button" id="clearAsOfDateBtn" class="bg-red-500 hover:bg-red-600 text-white rounded-md px-3 py-2 transition text-sm">
                                                    清除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-600">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">預計總堂數: <span id="plannedTotalLessons" class="font-medium">16堂</span></div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400" id="consecutiveBonusInfo">連續2期優惠: 額外95折</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600 dark:text-gray-400">預計總費用</div>
                                        <div class="text-xl font-bold text-primary dark:text-primary-light" id="plannedTotalCost">$3,088</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 上課時間及日期 - 只在新生報名時顯示，且放在同行優惠下面 -->
                    <div id="classTimeSection" class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-md font-medium">上課時間及日期安排</h3>
                            <button type="button" id="addTimeSlotBtn" class="text-sm text-primary hover:text-primary-dark dark:text-primary-light dark:hover:text-white flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                新增時段
                            </button>
                        </div>
                        
                        <!-- 時段容器 -->
                        <div id="timeSlotsContainer" class="space-y-6">
                            <!-- 第一個時段 -->
                            <div class="time-slot bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-gray-800 dark:text-gray-200">時段 1</h4>
                                    <button type="button" class="remove-time-slot-btn bg-red-500 hover:bg-red-600 text-white rounded-md px-3 py-1 text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">上課時間</label>
                                        <input type="text" class="class-time w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base" placeholder="例：09:10-09:50">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">每日堂數</label>
                                        <select class="lessons-per-day w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                                            <option value="1">1堂</option>
                                            <option value="1.5">1.5堂</option>
                                            <option value="2">2堂</option>
                                            <option value="2.5">2.5堂</option>
                                            <option value="3">3堂</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 日曆部分 -->
                                <div>
                                    <div class="flex items-center justify-between mb-4">
                                        <label class="block text-sm font-medium">選擇上課日期</label>
                                        <div class="flex gap-2">
                                            <button type="button" class="clear-slot-dates px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-300 rounded">清除此時段</button>
                
                                        </div>
                                    </div>
                                    
                                    <!-- 單月日曆顯示 -->
                                    <div class="slot-calendar bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 mb-4">
                                        <!-- 月份導航 -->
                                        <div class="flex items-center justify-between mb-4">
                                            <button type="button" class="prev-month-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </button>
                                            <div class="text-center">
                                                <h3 class="current-month-year text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
                                            </div>
                                            <button type="button" class="next-month-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </button>
                                        </div>
                                        
                                        <!-- 星期標題 - 可點擊選擇 -->
                                        <div class="grid grid-cols-7 gap-1 mb-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-600 shadow-sm">
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="0" data-chinese="星期日">日</div>
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="1" data-chinese="星期一">一</div>
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="2" data-chinese="星期二">二</div>
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="3" data-chinese="星期三">三</div>
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="4" data-chinese="星期四">四</div>
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="5" data-chinese="星期五">五</div>
                                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="6" data-chinese="星期六">六</div>
                                        </div>
                                        
                                        <!-- 日期網格 -->
                                        <div class="calendar-grid grid grid-cols-7 gap-1 mb-4">
                                            <!-- 日期將在這裡動態生成 -->
                                        </div>
                                        
                                        <!-- 待約堂數控制 -->
                                        <div class="flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-600">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">本月待約堂數:</span>
                                            <div class="flex items-center gap-2">
                                                <button type="button" class="decrease-pending-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded text-sm">-</button>
                                                <input type="number" class="current-month-pending w-16 text-center rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1 text-sm" value="0" min="0">
                                                <button type="button" class="increase-pending-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded text-sm">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <h4 class="font-medium mb-2">此時段已選日期：</h4>
                                                <div class="slot-selected-dates text-sm text-gray-600 dark:text-gray-400">
                                                    暫未選擇日期
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm text-gray-600 dark:text-gray-400">時段堂數</div>
                                                <div class="text-2xl font-bold text-primary dark:text-primary-light slot-total-lessons">0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 總計顯示 -->
                        <div class="mt-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium mb-2 text-green-800 dark:text-green-200">所有時段總計：</h4>
                                    <div id="allSlotsSelectedDates" class="text-sm text-green-600 dark:text-green-400">
                                        暫未選擇日期
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-green-600 dark:text-green-400">總堂數</div>
                                    <div class="text-2xl font-bold text-green-700 dark:text-green-300" id="totalAllLessons">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center pt-4">
                        <button type="button" id="generateBtn" class="bg-primary hover:bg-primary-dark text-white font-medium rounded-md px-6 py-3 transition w-full md:w-auto">生成繳費訊息</button>
                    </div>
                </form>
            </div>
            
            <!-- Right Column: Output -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 shadow">
                <h2 class="text-xl font-semibold mb-4 text-primary dark:text-primary-light border-b pb-2">繳費訊息</h2>
                
                <div id="messageOutput" class="hidden fade-in">
                    <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600 mb-4">
                        <h3 class="font-semibold mb-2">生成的繳費訊息:</h3>
                        <textarea id="generatedMessage" class="w-full h-96 whitespace-pre-line text-gray-700 dark:text-gray-300 break-words mb-4 rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-4 text-base resize-y font-mono" placeholder="生成的訊息將在這裡顯示..."></textarea>
                        
                        <div class="flex gap-2">
                            <button id="copyBtn" class="bg-primary hover:bg-primary-dark text-white rounded-md px-4 py-2 transition text-sm flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                </svg>
                                複製訊息
                            </button>
                            <button id="editAgainBtn" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded-md px-4 py-2 transition text-sm">
                                重新編輯
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="summaryOutput" class="hidden fade-in">
                    <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                        <h3 class="font-semibold mb-2">收費摘要:</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>課程類型:</span>
                                <span id="summaryCourseType" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>導師:</span>
                                <span id="summaryInstructor" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>每堂收費:</span>
                                <span id="summaryPrice" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>總堂數:</span>
                                <span id="summaryLessons" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>學員人數:</span>
                                <span id="studentCount" class="font-medium"></span>
                            </div>
                            <div id="summaryGroupDiscountRow" class="flex justify-between hidden">
                                <span>多人同行折扣:</span>
                                <span id="summaryGroupDiscount" class="font-medium"></span>
                            </div>
                            <div id="summaryReferralDiscountRow" class="flex justify-between hidden">
                                <span>介紹朋友減免:</span>
                                <span id="summaryReferralDiscount" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between font-semibold text-base border-t pt-2 mt-2">
                                <span>總收費:</span>
                                <span id="summaryTotal" class="text-primary dark:text-primary-light"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loadingIndicator" class="hidden p-10 text-center">
                    <div class="spinner mx-auto mb-3"></div>
                    <p class="text-gray-600 dark:text-gray-400">生成繳費訊息中...</p>
                </div>
                
                <div id="instructionsSection" class="text-gray-600 dark:text-gray-400 mt-6">
                    <h3 class="font-medium text-gray-800 dark:text-gray-200 mb-2">使用說明:</h3>
                    <ol class="space-y-2 list-decimal pl-5 text-sm">
                        <li>選擇報名類型（新生/續報）</li>
                        <li>填寫學員及課程基本資料</li>
                        <li><strong>新生報名：</strong>在同行優惠下方填寫上課時間及選擇日期</li>
                        <li><strong>續報學員：</strong>填寫上課時間及選擇日期，然後生成繳費訊息</li>
                        <li>填寫上課時間，然後在日曆的星期標題列（日 一 二 三 四 五 六）中點擊選擇上課星期</li>
                        <li>在日曆中點擊選擇具體上課日期（只會顯示所選星期的日期）</li>
                        <li>如有介紹朋友，請填寫朋友姓名以獲得介紹優惠</li>
                        <li>點擊「生成繳費訊息」獲取結果</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // DOM Elements
        const registrationTypeRadios = document.querySelectorAll('input[name="registrationType"]');
        const trialLessonInfo = document.getElementById('trialLessonInfo');
        const classTimeSection = document.getElementById('classTimeSection');
        const trialYear = document.getElementById('trialYear');
        const trialMonth = document.getElementById('trialMonth');
        const trialDay = document.getElementById('trialDay');
        const calendarYear = document.getElementById('calendarYear');
        const selectedDatesContainer = document.getElementById('selectedDatesContainer');
        const totalSelectedDates = document.getElementById('totalSelectedDates');
        const clearDatesBtn = document.getElementById('clearDatesBtn');
        const selectExampleBtn = document.getElementById('selectExampleBtn');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const studentsContainer = document.getElementById('studentsContainer');
        const addReferralBtn = document.getElementById('addReferralBtn');
        const referralSection = document.getElementById('referralSection');
        const referralContainer = document.getElementById('referralContainer');
        const referralDiscount = document.getElementById('referralDiscount');
        
        // Single calendar elements
        const currentMonthYear = document.getElementById('currentMonthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const currentMonthPending = document.getElementById('currentMonthPending');
        const decreasePendingBtn = document.getElementById('decreasePendingBtn');
        const increasePendingBtn = document.getElementById('increasePendingBtn');

        const generateBtn = document.getElementById('generateBtn');
        const messageOutput = document.getElementById('messageOutput');
        const summaryOutput = document.getElementById('summaryOutput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const instructionsSection = document.getElementById('instructionsSection');
        const copyBtn = document.getElementById('copyBtn');
        const editAgainBtn = document.getElementById('editAgainBtn');
        // These elements no longer exist as they've been replaced with button selectors
        // const classFormat = document.getElementById('classFormat');
        // const courseType = document.getElementById('courseType');
        const studentSource = document.getElementById('studentSource');
        const referrerNameSection = document.getElementById('referrerNameSection');
        const groupDiscountSection = document.getElementById('groupDiscountSection');
        const referralDiscountSection = document.getElementById('referralDiscountSection');
        const studentSourceSection = document.getElementById('studentSourceSection');
        
        // Application state
        const state = {
            timeSlots: [], // Array to store time slot data
            timeSlotCounter: 1,
            selectedLocation: '堅尼地城游泳池', // Default location
            selectedCourseType: '指定導師課程（全年）', // Default course type
            selectedClassFormat: '指定導師小組班1:2-4', // Default class format
            selectedInstructorType: '主管導師', // Default instructor type
            weekdayMapping: {
                "星期一": 1,
                "星期二": 2,
                "星期三": 3,
                "星期四": 4,
                "星期五": 5,
                "星期六": 6,
                "星期日": 0
            },
            weekdayNames: ["日", "一", "二", "三", "四", "五", "六"],
            monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"]
        };

        // Debug function to check DOM elements
        function debugDOMElements() {
            const elements = {
                'registrationTypeRadios': registrationTypeRadios,
                'trialLessonInfo': trialLessonInfo,
                'classTimeSection': classTimeSection,
                'trialYear': trialYear,
                'trialMonth': trialMonth,
                'trialDay': trialDay,
                'addStudentBtn': addStudentBtn,
                'studentsContainer': studentsContainer,
                'addReferralBtn': addReferralBtn,
                'referralSection': referralSection,
                'referralContainer': referralContainer,
                'referralDiscount': referralDiscount,
                'generateBtn': generateBtn,
                'messageOutput': messageOutput,
                'summaryOutput': summaryOutput,
                'loadingIndicator': loadingIndicator,
                'instructionsSection': instructionsSection,
                'copyBtn': copyBtn,
                'editAgainBtn': editAgainBtn,
                'studentSource': studentSource
            };
            
            console.log('=== DOM Elements Debug ===');
            for (const [name, element] of Object.entries(elements)) {
                if (element === null || element === undefined) {
                    console.error(`❌ ${name} is ${element}`);
                } else if (element.length === 0) {
                    console.warn(`⚠️ ${name} is empty array/NodeList`);
                } else {
                    console.log(`✅ ${name} found`);
                }
            }
            console.log('=========================');
        }

        // Initialize the application
        function initializeApp() {
            console.log('🚀 Starting app initialization...');
            
            try {
                // Debug DOM elements first
                debugDOMElements();
                
                console.log('📅 Setting up trial date selector...');
                setupTrialDateSelector();
                
                console.log('🎧 Setting up event listeners...');
                setupEventListeners();
                
                console.log('🔄 Toggling trial lesson info...');
                toggleTrialLessonInfo();
                
                console.log('📝 Updating class format options...');
                updateClassFormatOptions();
                
                console.log('⏰ Initializing first time slot...');
                initializeFirstTimeSlot();
                
                console.log('✅ App initialization completed successfully!');
                
            } catch (error) {
                console.error('❌ Error during app initialization:', error);
                console.error('Error stack:', error.stack);
            }
        }

        // Time Slot Management Functions
        function initializeFirstTimeSlot() {
            try {
                // Get current date
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                // Create first time slot data with current date
                const firstSlot = {
                    id: 1,
                    selectedDates: [],
                    pendingLessons: {},
                    currentYear: currentYear,
                    currentMonth: currentMonth
                };
                state.timeSlots.push(firstSlot);
                
                // Setup first time slot with a small delay to ensure DOM is ready
                setTimeout(() => {
                    try {
                        setupTimeSlot(1);
                    } catch (e) {
                        console.log('Error setting up first time slot:', e);
                    }
                }, 50);
            } catch (error) {
                console.log('Error initializing first time slot:', error);
            }
        }

        function setupTimeSlot(slotId) {
            const slotIndex = state.timeSlots.findIndex(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotIndex];
            if (!slotElement || slotIndex === -1) return;
            
            // Setup calendar for this slot
            const calendarGrid = slotElement.querySelector('.calendar-grid');
            const currentMonthYear = slotElement.querySelector('.current-month-year');
            const prevBtn = slotElement.querySelector('.prev-month-btn');
            const nextBtn = slotElement.querySelector('.next-month-btn');
            const currentMonthPending = slotElement.querySelector('.current-month-pending');
            const decreaseBtn = slotElement.querySelector('.decrease-pending-btn');
            const increaseBtn = slotElement.querySelector('.increase-pending-btn');
            const weekdayRadios = slotElement.querySelectorAll('.weekday-radio');
            const clearSlotBtn = slotElement.querySelector('.clear-slot-dates');
            const exampleSlotBtn = slotElement.querySelector('.select-example-slot');
            
            // Navigation events
            prevBtn.addEventListener('click', () => navigateSlotMonth(slotId, -1));
            nextBtn.addEventListener('click', () => navigateSlotMonth(slotId, 1));
            
            // Pending lessons events
            currentMonthPending.addEventListener('input', () => handleSlotPendingInput(slotId));
            decreaseBtn.addEventListener('click', () => adjustSlotPending(slotId, -1));
            increaseBtn.addEventListener('click', () => adjustSlotPending(slotId, 1));
            
            // Weekday selector events
            const weekdaySelectors = slotElement.querySelectorAll('.weekday-selector');
            weekdaySelectors.forEach(selector => {
                selector.addEventListener('click', () => handleSlotWeekdaySelection(slotId, selector));
            });
            
            // Clear button
            clearSlotBtn.addEventListener('click', () => clearSlotDates(slotId));
            
            // Initial render
            renderSlotCalendar(slotId);
            updateSlotDisplay(slotId);
        }

        function navigateSlotMonth(slotId, direction) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            if (!slot) return;
            
            slot.currentMonth += direction;
            if (slot.currentMonth < 0) {
                slot.currentMonth = 11;
                slot.currentYear--;
            } else if (slot.currentMonth > 11) {
                slot.currentMonth = 0;
                slot.currentYear++;
            }
            
            renderSlotCalendar(slotId);
        }

        function renderSlotCalendar(slotId) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            const slotIndex = state.timeSlots.findIndex(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotIndex];
            if (!slot || !slotElement || slotIndex === -1) return;
            
            const calendarGrid = slotElement.querySelector('.calendar-grid');
            const currentMonthYear = slotElement.querySelector('.current-month-year');
            const currentMonthPending = slotElement.querySelector('.current-month-pending');
            
            // Update month/year display
            currentMonthYear.textContent = `${slot.currentYear}年${state.monthNames[slot.currentMonth]}`;
            
            // Clear calendar grid
            calendarGrid.innerHTML = '';
            
            // Get selected weekday for this slot (from stored data or selector)
            let selectedWeekdayNum = null;
            if (slot.selectedWeekday !== undefined) {
                selectedWeekdayNum = slot.selectedWeekday;
            } else {
                // Fallback to old radio button method for backward compatibility
                const selectedWeekdayInput = slotElement.querySelector('input[name^="weekday_"]:checked');
                const selectedWeekday = selectedWeekdayInput ? selectedWeekdayInput.value : null;
                selectedWeekdayNum = selectedWeekday ? state.weekdayMapping[selectedWeekday] : null;
            }
            
            // Get calendar info for current month
            const firstDayOfMonth = new Date(slot.currentYear, slot.currentMonth, 1).getDay();
            const daysInMonth = new Date(slot.currentYear, slot.currentMonth + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Create actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-sm py-2 text-center cursor-pointer border rounded transition-all duration-200';
                dayElement.textContent = day;
                
                // Get weekday for this date
                const date = new Date(slot.currentYear, slot.currentMonth, day);
                const dayWeekday = date.getDay();
                
                // Check if this date is already selected
                const dateString = formatDateString(slot.currentYear, slot.currentMonth, day);
                if (slot.selectedDates.includes(dateString)) {
                    dayElement.classList.add('selected');
                }
                
                // Check if weekday is selected and if this day matches
                if (selectedWeekdayNum === null) {
                    // No weekday selected - show all dates with white background for easy viewing
                    dayElement.classList.remove('disabled', 'cursor-not-allowed');
                    dayElement.classList.add('cursor-default');
                    dayElement.style.opacity = '1';
                    dayElement.style.color = '#374151'; // Dark gray text
                    dayElement.style.backgroundColor = 'white';
                    dayElement.classList.add('no-weekday-selected');
                    
                    // Disable click but keep visible
                    dayElement.style.pointerEvents = 'none';
                } else if (dayWeekday !== selectedWeekdayNum) {
                    // Day doesn't match selected weekday - disable it
                    dayElement.classList.add('disabled');
                    dayElement.classList.remove('cursor-pointer');
                    dayElement.classList.add('cursor-not-allowed');
                    dayElement.style.opacity = '0.3';
                    dayElement.style.color = '#ccc';
                    dayElement.style.backgroundColor = '';
                    dayElement.style.pointerEvents = 'none';
                } else {
                    // Day matches selected weekday - enable it
                    dayElement.classList.remove('disabled', 'cursor-not-allowed', 'no-weekday-selected');
                    dayElement.classList.add('cursor-pointer');
                    dayElement.style.opacity = '1';
                    dayElement.style.color = '';
                    dayElement.style.backgroundColor = '';
                    
                    // Add hover effect for enabled days
                    dayElement.addEventListener('mouseenter', () => {
                        if (!dayElement.classList.contains('selected')) {
                            dayElement.style.backgroundColor = '#e9e9ff';
                        }
                    });
                    
                    dayElement.addEventListener('mouseleave', () => {
                        if (!dayElement.classList.contains('selected')) {
                            dayElement.style.backgroundColor = '';
                        }
                    });
                    
                    // Add click event to toggle selection (only for enabled days)
                    dayElement.addEventListener('click', () => toggleSlotDateSelection(slotId, dayElement, slot.currentYear, slot.currentMonth, day));
                }
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Update pending lessons for current month
            const monthKey = `${slot.currentYear}-${slot.currentMonth + 1}`;
            const pendingValue = slot.pendingLessons[monthKey] || 0;
            currentMonthPending.value = pendingValue;
        }

        function toggleSlotDateSelection(slotId, dayElement, year, month, day) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            if (!slot) return;
            
            const dateString = formatDateString(year, month, day);
            
            // Toggle selected class
            dayElement.classList.toggle('selected');
            
            // Update the slot's selected dates array
            if (dayElement.classList.contains('selected')) {
                if (!slot.selectedDates.includes(dateString)) {
                    slot.selectedDates.push(dateString);
                }
            } else {
                const index = slot.selectedDates.indexOf(dateString);
                if (index > -1) {
                    slot.selectedDates.splice(index, 1);
                }
            }
            
            // Sort dates
            slot.selectedDates.sort();
            
            // Update displays
            updateSlotDisplay(slotId);
            updateAllSlotsDisplay();
        }

        function handleSlotWeekdaySelection(slotId, selector) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            const slotIndex = state.timeSlots.findIndex(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotIndex];
            if (!slot || !slotElement || slotIndex === -1) return;
            
            // Clear all weekday selections for this slot
            const allSelectors = slotElement.querySelectorAll('.weekday-selector');
            allSelectors.forEach(s => s.classList.remove('selected'));
            
            // Add selected class to clicked selector
            selector.classList.add('selected');
            
            // Store the selected weekday info for this slot
            slot.selectedWeekday = parseInt(selector.getAttribute('data-weekday'));
            slot.selectedWeekdayChinese = selector.getAttribute('data-chinese');
            
            // Clear existing selected dates when weekday changes
            slot.selectedDates = [];
            
            // Re-render calendar
            renderSlotCalendar(slotId);
            updateSlotDisplay(slotId);
            updateAllSlotsDisplay();
        }

        function handleSlotWeekdayChange(slotId) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            if (!slot) return;
            
            // Clear existing selected dates when weekday changes
            slot.selectedDates = [];
            
            // Re-render calendar
            renderSlotCalendar(slotId);
            updateSlotDisplay(slotId);
            updateAllSlotsDisplay();
        }

        function handleSlotPendingInput(slotId) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            const slotIndex = state.timeSlots.findIndex(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotIndex];
            if (!slot || !slotElement || slotIndex === -1) return;
            
            const currentMonthPending = slotElement.querySelector('.current-month-pending');
            const value = parseInt(currentMonthPending.value) || 0;
            const monthKey = `${slot.currentYear}-${slot.currentMonth + 1}`;
            slot.pendingLessons[monthKey] = value;
            
            updateSlotDisplay(slotId);
            updateAllSlotsDisplay();
        }

        function adjustSlotPending(slotId, delta) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            const slotIndex = state.timeSlots.findIndex(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotIndex];
            if (!slot || !slotElement || slotIndex === -1) return;
            
            const currentMonthPending = slotElement.querySelector('.current-month-pending');
            const currentValue = parseInt(currentMonthPending.value) || 0;
            const newValue = Math.max(0, currentValue + delta);
            
            currentMonthPending.value = newValue;
            handleSlotPendingInput(slotId);
        }

        function updateSlotDisplay(slotId) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotId - 1];
            if (!slot || !slotElement) return;
            
            const slotSelectedDates = slotElement.querySelector('.slot-selected-dates');
            const slotTotalLessons = slotElement.querySelector('.slot-total-lessons');
            const lessonsPerDaySelect = slotElement.querySelector('.lessons-per-day');
            
            // Calculate lessons for this slot
            const lessonsPerDay = parseFloat(lessonsPerDaySelect.value || 1);
            const selectedDatesLessons = slot.selectedDates.length * lessonsPerDay;
            const pendingLessonsTotal = Object.values(slot.pendingLessons).reduce((sum, count) => sum + count, 0);
            const totalSlotLessons = selectedDatesLessons + pendingLessonsTotal;
            
            // Update slot total
            slotTotalLessons.textContent = totalSlotLessons.toFixed(1).replace(/\.0$/, '');
            
            // Update slot dates display
            if (slot.selectedDates.length === 0 && pendingLessonsTotal === 0) {
                slotSelectedDates.innerHTML = '暫未選擇日期';
                slotSelectedDates.className = 'slot-selected-dates text-sm text-gray-500 dark:text-gray-400';
            } else {
                slotSelectedDates.innerHTML = '';
                slotSelectedDates.className = 'slot-selected-dates text-sm text-gray-600 dark:text-gray-400';
                
                // Group dates by month
                const datesByMonth = {};
                slot.selectedDates.forEach(dateString => {
                    const [year, month, day] = dateString.split('-').map(Number);
                    const monthKey = `${year}-${month + 1}`;
                    
                    if (!datesByMonth[monthKey]) {
                        datesByMonth[monthKey] = [];
                    }
                    datesByMonth[monthKey].push(day);
                });
                
                // Display grouped dates
                Object.keys(datesByMonth).sort().forEach(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    const monthName = state.monthNames[month - 1];
                    const monthElement = document.createElement('div');
                    monthElement.innerHTML = `<span class="font-medium">${year}年${monthName}:</span> ${datesByMonth[monthKey].sort((a, b) => a - b).join(', ')}日`;
                    slotSelectedDates.appendChild(monthElement);
                });
                
                // Add pending lessons
                Object.entries(slot.pendingLessons).forEach(([monthKey, count]) => {
                    if (count > 0) {
                        const [year, month] = monthKey.split('-').map(Number);
                        const monthName = state.monthNames[month - 1];
                        const pendingElement = document.createElement('div');
                        pendingElement.innerHTML = `<span class="font-medium">${year}年${monthName} 待約:</span> ${count}堂`;
                        slotSelectedDates.appendChild(pendingElement);
                    }
                });
            }
        }

        function updateAllSlotsDisplay() {
            const allSlotsContainer = document.getElementById('allSlotsSelectedDates');
            const totalAllLessons = document.getElementById('totalAllLessons');
            
            let grandTotal = 0;
            let hasAnyData = false;
            
            allSlotsContainer.innerHTML = '';
            
            state.timeSlots.forEach((slot, index) => {
                const slotElement = document.querySelector(`.time-slot:nth-child(${index + 1})`);
                if (!slotElement) return;
                
                const lessonsPerDaySelect = slotElement.querySelector('.lessons-per-day');
                const classTimeInput = slotElement.querySelector('.class-time');
                const weekdayInput = slotElement.querySelector('input[name^="weekday_"]:checked');
                
                const lessonsPerDay = parseFloat(lessonsPerDaySelect.value || 1);
                const selectedDatesLessons = slot.selectedDates.length * lessonsPerDay;
                const pendingLessonsTotal = Object.values(slot.pendingLessons).reduce((sum, count) => sum + count, 0);
                const slotTotal = selectedDatesLessons + pendingLessonsTotal;
                
                grandTotal += slotTotal;
                
                if (slotTotal > 0) {
                    hasAnyData = true;
                    const slotDiv = document.createElement('div');
                    
                    // Get weekday text from slot data or fallback to old method
                    let weekdayText = '未選擇';
                    if (slot.selectedWeekdayChinese) {
                        weekdayText = slot.selectedWeekdayChinese;
                    } else if (weekdayInput) {
                        weekdayText = weekdayInput.value;
                    }
                    
                    const timeText = classTimeInput.value.trim() || '未填寫';
                    slotDiv.innerHTML = `<span class="font-medium">時段 ${index + 1} (${weekdayText} ${timeText}):</span> ${slotTotal.toFixed(1).replace(/\.0$/, '')}堂`;
                    allSlotsContainer.appendChild(slotDiv);
                }
            });
            
            if (!hasAnyData) {
                allSlotsContainer.innerHTML = '暫未選擇日期';
                allSlotsContainer.className = 'text-sm text-gray-500 dark:text-gray-400';
            } else {
                allSlotsContainer.className = 'text-sm text-green-600 dark:text-green-400';
            }
            
            totalAllLessons.textContent = grandTotal.toFixed(1).replace(/\.0$/, '');
        }

        function clearSlotDates(slotId) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            if (!slot) return;
            
            slot.selectedDates = [];
            slot.pendingLessons = {};
            
            renderSlotCalendar(slotId);
            updateSlotDisplay(slotId);
            updateAllSlotsDisplay();
        }

        function selectSlotExampleDates(slotId) {
            const slot = state.timeSlots.find(s => s.id === slotId);
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotId - 1];
            if (!slot || !slotElement) return;
            
            // Clear existing dates first
            clearSlotDates(slotId);
            
            // Get selected weekday
            const weekdayInput = slotElement.querySelector('input[name^="weekday_"]:checked');
            if (!weekdayInput) return;
            
            const weekdayNum = state.weekdayMapping[weekdayInput.value];
            const calendarYearSelect = slotElement.querySelector('.calendar-year');
            const year = parseInt(calendarYearSelect.value);
            
            // Select dates for January and February
            for (let month = 0; month < 2; month++) {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayWeekday = date.getDay();
                    
                    if (dayWeekday === weekdayNum) {
                        const dateString = formatDateString(year, month, day);
                        slot.selectedDates.push(dateString);
                    }
                }
            }
            
            renderSlotCalendar(slotId);
            updateSlotDisplay(slotId);
            updateAllSlotsDisplay();
        }

        // Set up event listeners
        function setupEventListeners() {
            try {
                // Registration type change
                if (registrationTypeRadios && registrationTypeRadios.length > 0) {
                    registrationTypeRadios.forEach(radio => {
                        if (radio) radio.addEventListener('change', toggleTrialLessonInfo);
                    });
                }
                
                // Trial date selectors
                if (trialYear) trialYear.addEventListener('change', updateTrialDayOptions);
                if (trialMonth) trialMonth.addEventListener('change', updateTrialDayOptions);
                
                // As-of date selectors
                const asOfYear = document.getElementById('asOfYear');
                const asOfMonth = document.getElementById('asOfMonth');
                if (asOfYear) asOfYear.addEventListener('change', updateAsOfDayOptions);
                if (asOfMonth) asOfMonth.addEventListener('change', updateAsOfDayOptions);
                
                // Add student button
                if (addStudentBtn) addStudentBtn.addEventListener('click', addNewStudent);
                
                // Add referral button
                if (addReferralBtn) addReferralBtn.addEventListener('click', updateReferralFields);
                
                // Referral count change
                if (referralDiscount) referralDiscount.addEventListener('change', updateReferralFields);
                
                // Generate message button
                if (generateBtn) generateBtn.addEventListener('click', generateMessage);
                
                // Copy button
                if (copyBtn) copyBtn.addEventListener('click', copyMessageToClipboard);
                
                // Edit again button
                if (editAgainBtn) editAgainBtn.addEventListener('click', editAgain);
                
                // Class format and course type changes are now handled by button selectors
                // No need for dropdown event listeners
                
                // Student source change
                if (studentSource) studentSource.addEventListener('change', toggleReferrerNameSection);
                
                // Location selector setup
                setupLocationSelector();
                
                // Course type and class format selector setup
                setupCourseSelectors();
                
                // Instructor type selector setup
                setupInstructorTypeSelector();
                
                // Setup initial remove buttons state
                setTimeout(() => {
                    try {
                        updateRemoveStudentButtons();
                    } catch (e) {
                        console.log('Error updating remove student buttons:', e);
                    }
                }, 100);
                
                // Add time slot button
                const addTimeSlotBtn = document.getElementById('addTimeSlotBtn');
                if (addTimeSlotBtn) addTimeSlotBtn.addEventListener('click', addNewTimeSlot);
                
                // Setup semester planning section
                setupSemesterPlanning();
                
                // Setup as-of date selector
                setupAsOfDateSelector();
                
            } catch (error) {
                console.log('Error setting up event listeners:', error);
            }
        }

        // Setup location selector
        function setupLocationSelector() {
            const locationSelectors = document.querySelectorAll('.location-selector');
            
            // Set default selection to 堅尼地城游泳池
            locationSelectors.forEach((selector, index) => {
                if (index === 0) { // First selector (堅)
                    selector.classList.add('selected');
                }
                
                selector.addEventListener('click', () => {
                    // Clear all selections
                    locationSelectors.forEach(s => s.classList.remove('selected'));
                    
                    // Add selected class to clicked selector
                    selector.classList.add('selected');
                    
                    // Update state
                    state.selectedLocation = selector.getAttribute('data-location');
                });
            });
        }

        // Toggle referrer name section based on student source
        function toggleReferrerNameSection() {
            const selectedSource = studentSource.value;
            if (selectedSource === '朋友介紹') {
                referrerNameSection.classList.remove('hidden');
            } else {
                referrerNameSection.classList.add('hidden');
                document.getElementById('referrerName').value = '';
            }
        }

        // Pricing matrix for course type and class format combinations
        const pricingMatrix = {
            '全年親子嬰兒班': {
                '私人班1:1': 350,
                '私人班1:2': 280,
                '嬰幼兒小組班1:3-5': 220,
                '指定導師小組班1:2-4': 260,
                '指定導師中班1:4-6': 240,
                '指定導師高班1:5-8': 220,
                '指定導師泳隊1:6-12': 200,
                '全年團體泳班 初班 1:3-5': 200,
                '全年團體泳班 中班 1:4-6': 180,
                '全年團體泳班 高班 1:6-12': 160
            },
            '全年私人班': {
                '私人班1:1': 320,
                '私人班1:2': 250,
                '嬰幼兒小組班1:3-5': 200,
                '指定導師小組班1:2-4': 240,
                '指定導師中班1:4-6': 220,
                '指定導師高班1:5-8': 200,
                '指定導師泳隊1:6-12': 180,
                '全年團體泳班 初班 1:3-5': 180,
                '全年團體泳班 中班 1:4-6': 160,
                '全年團體泳班 高班 1:6-12': 140
            },
            '指定導師課程（全年）': {
                '私人班1:1': 300,
                '私人班1:2': 260,
                '嬰幼兒小組班1:3-5': 210,
                '指定導師小組班1:2-4': 225,
                '指定導師中班1:4-6': 200,
                '指定導師高班1:5-8': 180,
                '指定導師泳隊1:6-12': 160,
                '全年團體泳班 初班 1:3-5': 170,
                '全年團體泳班 中班 1:4-6': 150,
                '全年團體泳班 高班 1:6-12': 130
            },
            '全年團體泳班': {
                '私人班1:1': 280,
                '私人班1:2': 220,
                '嬰幼兒小組班1:3-5': 170,
                '指定導師小組班1:2-4': 190,
                '指定導師中班1:4-6': 170,
                '指定導師高班1:5-8': 150,
                '指定導師泳隊1:6-12': 130,
                '全年團體泳班 初班 1:3-5': 180,
                '全年團體泳班 中班 1:4-6': 160,
                '全年團體泳班 高班 1:6-12': 140
            }
        };

        // Function to update pricing based on course type, class format, and instructor type
        function updatePricingBasedOnSelection() {
            const selectedCourseType = state.selectedCourseType;
            const selectedClassFormat = state.selectedClassFormat;
            const selectedInstructorType = state.selectedInstructorType;
            const priceInput = document.getElementById('pricePerLesson');
            
            let newPrice = null;
            
            // New pricing system for specific course types with instructor-based pricing
            if (selectedCourseType === '全年私人班') {
                const privatePricing = {
                    '私人班1:1': {
                        '資深導師': 580,
                        '主管導師': 480,
                        '女導師': 480,
                        '高級導師': 380,
                        '初級導師': 330
                    },
                    '私人班1:2': {
                        '資深導師': 375,
                        '主管導師': 315,
                        '女導師': 315,
                        '高級導師': 265,
                        '初級導師': 225
                    },
                    '幼兒私人班1:1': {
                        '資深導師': 580,
                        '主管導師': 480,
                        '女導師': 480
                    },
                    '幼兒私人班1:2': {
                        '資深導師': 375,
                        '主管導師': 315,
                        '女導師': 315
                    }
                };
                
                if (privatePricing[selectedClassFormat] && privatePricing[selectedClassFormat][selectedInstructorType]) {
                    newPrice = privatePricing[selectedClassFormat][selectedInstructorType];
                }
            } else if (selectedCourseType === '全年親子嬰兒班') {
                const babyPricing = {
                    '私人班1:1': {
                        '資深導師': 580,
                        '高級導師': 350
                    },
                    '私人班1:2': {
                        '資深導師': 380,
                        '高級導師': 250
                    },
                    '嬰幼兒小組班1:3-5': {
                        '資深導師': 280,
                        '高級導師': 220
                    },
                    '恆常泳班1:4-7': {
                        '固定泳班導師': 180
                    }
                };
                
                if (babyPricing[selectedClassFormat] && babyPricing[selectedClassFormat][selectedInstructorType]) {
                    newPrice = babyPricing[selectedClassFormat][selectedInstructorType];
                }
            } else if (selectedCourseType === '全年團體泳班') {
                // All 全年團體泳班 courses are $180
                newPrice = 180;
            } else if (selectedCourseType === '指定導師課程（全年）' && 
                ['指定導師小組班1:2-4', '指定導師中班1:4-6', '指定導師高班1:5-8', '指定導師泳隊1:6-12'].includes(selectedClassFormat)) {
                
                // Use instructor-based pricing
                const instructorPricing = {
                    '資深導師': 250,
                    '主管導師': 225,
                    '女導師': 225,
                    '高級導師': 195,
                    '初級導師': 175
                };
                
                if (instructorPricing[selectedInstructorType]) {
                    newPrice = instructorPricing[selectedInstructorType];
                }
            } else {
                // Use the original pricing matrix for other combinations (keeping for compatibility)
                if (pricingMatrix[selectedCourseType] && pricingMatrix[selectedCourseType][selectedClassFormat]) {
                    newPrice = pricingMatrix[selectedCourseType][selectedClassFormat];
                }
            }
            
            // Update price if we found a match
            if (newPrice !== null) {
                priceInput.value = newPrice;
            }
        }

        // Update class format and instructor options based on course type (legacy function - now handled by selectors)
        function updateClassFormatOptions() {
            // This function is now handled by the new selector system
            // Just update the instructor type selectors and pricing
            updateInstructorTypeSelectors();
            updatePricingBasedOnSelection();
        }
        
        function updateInstructorOptionsForFormat() {
            // This function is now handled by the selector system
            // Just update the instructor type selectors and pricing
            updateInstructorTypeSelectors();
            updatePricingBasedOnSelection();
        }

        // Setup trial date selector
        function setupTrialDateSelector() {
            // Set current date as default
            setCurrentDateAsDefault();
            
            // Populate trial day options initially
            updateTrialDayOptions();
            
            // Setup trial date events
            setupTrialDateEvents();
        }
        
        function setCurrentDateAsDefault() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1; // JavaScript months are 0-indexed
            const currentDay = today.getDate();
            
            // Set default values
            trialYear.value = currentYear;
            trialMonth.value = currentMonth;
            
            // Update day options first
            updateTrialDayOptions();
            
            // Then set the day
            trialDay.value = currentDay;
            
            // Update display text
            updateTrialDateDisplay();
        }
        
        function updateTrialDateDisplay() {
            const year = trialYear.value;
            const month = trialMonth.value;
            const day = trialDay.value;
            
            const trialDateText = document.getElementById('trialDateText');
            trialDateText.textContent = `${year}年${month}月${day}日`;
        }
        
        function setupTrialDateEvents() {
            // Trial date selector elements
            const trialDateDisplay = document.getElementById('trialDateDisplay');
            const trialDateSelector = document.getElementById('trialDateSelector');
            const editTrialDateBtn = document.getElementById('editTrialDateBtn');
            const confirmTrialDateBtn = document.getElementById('confirmTrialDateBtn');
            const cancelTrialDateBtn = document.getElementById('cancelTrialDateBtn');
            const trialCalendarMonthYear = document.getElementById('trialCalendarMonthYear');
            const trialCalendarGrid = document.getElementById('trialCalendarGrid');
            const trialPrevMonthBtn = document.getElementById('trialPrevMonthBtn');
            const trialNextMonthBtn = document.getElementById('trialNextMonthBtn');
            
            // State for trial calendar
            state.trialCalendar = {
                currentYear: parseInt(trialYear.value),
                currentMonth: parseInt(trialMonth.value) - 1,
                selectedDate: {
                    year: parseInt(trialYear.value),
                    month: parseInt(trialMonth.value) - 1,
                    day: parseInt(trialDay.value)
                }
            };
            
            // Edit button click
            editTrialDateBtn.addEventListener('click', () => {
                // Update state with current values
                state.trialCalendar.currentYear = parseInt(trialYear.value);
                state.trialCalendar.currentMonth = parseInt(trialMonth.value) - 1;
                state.trialCalendar.selectedDate = {
                    year: parseInt(trialYear.value),
                    month: parseInt(trialMonth.value) - 1,
                    day: parseInt(trialDay.value)
                };
                
                trialDateDisplay.classList.add('hidden');
                trialDateSelector.classList.remove('hidden');
                renderTrialCalendar();
            });
            
            // Confirm button click
            confirmTrialDateBtn.addEventListener('click', () => {
                // Update selectors with calendar selection
                trialYear.value = state.trialCalendar.selectedDate.year;
                trialMonth.value = state.trialCalendar.selectedDate.month + 1;
                updateTrialDayOptions();
                trialDay.value = state.trialCalendar.selectedDate.day;
                
                // Update display text
                updateTrialDateDisplay();
                
                // Hide selector, show display
                trialDateSelector.classList.add('hidden');
                trialDateDisplay.classList.remove('hidden');
            });
            
            // Cancel button click
            cancelTrialDateBtn.addEventListener('click', () => {
                trialDateSelector.classList.add('hidden');
                trialDateDisplay.classList.remove('hidden');
            });
            
            // Calendar navigation
            trialPrevMonthBtn.addEventListener('click', () => {
                state.trialCalendar.currentMonth--;
                if (state.trialCalendar.currentMonth < 0) {
                    state.trialCalendar.currentMonth = 11;
                    state.trialCalendar.currentYear--;
                }
                renderTrialCalendar();
            });
            
            trialNextMonthBtn.addEventListener('click', () => {
                state.trialCalendar.currentMonth++;
                if (state.trialCalendar.currentMonth > 11) {
                    state.trialCalendar.currentMonth = 0;
                    state.trialCalendar.currentYear++;
                }
                renderTrialCalendar();
            });
            
            // Listen to selector changes to update display
            trialYear.addEventListener('change', () => {
                updateTrialDayOptions();
                updateTrialDateDisplay();
            });
            trialMonth.addEventListener('change', () => {
                updateTrialDayOptions();
                updateTrialDateDisplay();
            });
            trialDay.addEventListener('change', updateTrialDateDisplay);
        }
        
        function renderTrialCalendar() {
            const trialCalendarMonthYear = document.getElementById('trialCalendarMonthYear');
            const trialCalendarGrid = document.getElementById('trialCalendarGrid');
            
            // Update month/year display
            trialCalendarMonthYear.textContent = `${state.trialCalendar.currentYear}年${state.monthNames[state.trialCalendar.currentMonth]}`;
            
            // Clear calendar grid
            trialCalendarGrid.innerHTML = '';
            
            // Get calendar info for current month
            const firstDayOfMonth = new Date(state.trialCalendar.currentYear, state.trialCalendar.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.trialCalendar.currentYear, state.trialCalendar.currentMonth + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'text-center p-2';
                trialCalendarGrid.appendChild(emptyDay);
            }
            
            // Create actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'text-center text-sm p-2 cursor-pointer border rounded transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-600';
                dayElement.textContent = day;
                
                // Check if this date is the selected date
                if (state.trialCalendar.selectedDate.year === state.trialCalendar.currentYear &&
                    state.trialCalendar.selectedDate.month === state.trialCalendar.currentMonth &&
                    state.trialCalendar.selectedDate.day === day) {
                    dayElement.classList.add('bg-primary', 'text-white');
                    dayElement.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-600');
                }
                
                // Add click event to select date
                dayElement.addEventListener('click', () => {
                    // Remove selection from all days
                    trialCalendarGrid.querySelectorAll('div').forEach(d => {
                        d.classList.remove('bg-primary', 'text-white');
                        if (d.textContent && d.classList.contains('cursor-pointer')) {
                            d.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-600');
                        }
                    });
                    
                    // Add selection to clicked day
                    dayElement.classList.add('bg-primary', 'text-white');
                    dayElement.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-600');
                    
                    // Update selected date
                    state.trialCalendar.selectedDate = {
                        year: state.trialCalendar.currentYear,
                        month: state.trialCalendar.currentMonth,
                        day: day
                    };
                });
                
                trialCalendarGrid.appendChild(dayElement);
            }
        }

        // Update trial day options based on selected year and month
        function updateTrialDayOptions() {
            const year = parseInt(trialYear.value);
            const month = parseInt(trialMonth.value) - 1; // JavaScript months are 0-indexed
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Save current day selection if possible
            const currentDay = parseInt(trialDay.value) || 1;
            
            // Clear existing options
            trialDay.innerHTML = '';
            
            // Add new day options
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}日`;
                trialDay.appendChild(option);
            }
            
            // Restore previous day selection if valid, otherwise select day 1
            if (currentDay <= daysInMonth) {
                trialDay.value = currentDay;
            } else {
                trialDay.value = 1;
            }
        }

        // Toggle trial lesson info and class time section based on registration type
        function toggleTrialLessonInfo() {
            const isNewStudent = document.querySelector('input[name="registrationType"]:checked').value === '新生報名';
            
            if (isNewStudent) {
                trialLessonInfo.classList.remove('hidden');
                classTimeSection.classList.remove('hidden');
                studentSourceSection.classList.remove('hidden');
                
                // Show new student discounts
                if (groupDiscountSection) groupDiscountSection.classList.remove('hidden');
                if (referralDiscountSection) referralDiscountSection.classList.add('hidden');
                
                // Show entire extra discount section for new students
                const extraDiscountSection = document.getElementById('extraDiscountSection');
                if (extraDiscountSection) extraDiscountSection.classList.remove('hidden');
            } else {
                trialLessonInfo.classList.add('hidden');
                classTimeSection.classList.remove('hidden'); // 學員續報也需要上課時間及日期
                studentSourceSection.classList.add('hidden');
                
                // Show continuing student discounts
                if (groupDiscountSection) groupDiscountSection.classList.add('hidden');
                if (referralDiscountSection) referralDiscountSection.classList.remove('hidden');
                
                // Show entire extra discount section for continuing students too
                const extraDiscountSection = document.getElementById('extraDiscountSection');
                if (extraDiscountSection) extraDiscountSection.classList.remove('hidden');
            }
        }

        // Referral Management Functions
        function updateReferralFields() {
            const count = parseInt(referralDiscount.value);
            
            // Show/hide referral section based on count
            if (count > 0) {
                referralSection.classList.remove('hidden');
                
                // Update number of referral input fields
                const currentFields = referralContainer.querySelectorAll('.referral-entry');
                const currentCount = currentFields.length;
                
                if (count > currentCount) {
                    // Add more fields
                    for (let i = currentCount; i < count; i++) {
                        addReferralField();
                    }
                } else if (count < currentCount) {
                    // Remove excess fields
                    for (let i = currentCount - 1; i >= count; i--) {
                        currentFields[i].remove();
                    }
                }
            } else {
                referralSection.classList.add('hidden');
                referralContainer.innerHTML = '';
            }
        }

        function addReferralField() {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'referral-entry flex gap-2';
            
            entryDiv.innerHTML = `
                <input type="text" class="referral-name w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base" placeholder="介紹朋友姓名">
            `;
            
            referralContainer.appendChild(entryDiv);
        }

        // Student Management Functions
        function addNewStudent() {
            const firstEntry = studentsContainer.querySelector('.student-entry');
            const newEntry = firstEntry.cloneNode(true);
            
            // Reset values
            newEntry.querySelector('.student-name').value = '';
            newEntry.querySelector('.student-age').value = '';
            
            // Add to container
            studentsContainer.appendChild(newEntry);
            updateRemoveStudentButtons();
            
            // Add event listener for remove button
            const removeBtn = newEntry.querySelector('.remove-student-btn');
            removeBtn.addEventListener('click', function() {
                newEntry.remove();
                updateRemoveStudentButtons();
            });
        }

        function updateRemoveStudentButtons() {
            const entries = studentsContainer.querySelectorAll('.student-entry');
            const removeButtons = studentsContainer.querySelectorAll('.remove-student-btn');
            
            // Enable/disable remove buttons based on number of entries
            removeButtons.forEach(btn => {
                if (entries.length <= 1) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                    btn.addEventListener('click', function() {
                        btn.closest('.student-entry').remove();
                        updateRemoveStudentButtons();
                    });
                }
            });
        }

        // Single Calendar Functions
        function generateCalendars() {
            // Initialize single calendar with current state
            state.currentYear = parseInt(calendarYear.value);
            state.currentMonth = 0; // Start with January
            
            // Setup navigation event listeners
            setupCalendarNavigation();
            
            // Render the current month
            renderCurrentMonth();
            
            // Refresh selected dates display
            refreshSelectedDates();
        }
        
        function setupCalendarNavigation() {
            // Remove existing event listeners to prevent duplicates
            prevMonthBtn.removeEventListener('click', navigateToPrevMonth);
            nextMonthBtn.removeEventListener('click', navigateToNextMonth);
            
            // Add new event listeners
            prevMonthBtn.addEventListener('click', navigateToPrevMonth);
            nextMonthBtn.addEventListener('click', navigateToNextMonth);
            
            // Setup pending lessons controls
            setupPendingLessonsControls();
        }
        
        function navigateToPrevMonth() {
            state.currentMonth--;
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            }
            renderCurrentMonth();
        }
        
        function navigateToNextMonth() {
            state.currentMonth++;
            if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            renderCurrentMonth();
        }
        
        function renderCurrentMonth() {
            // Update month/year display
            currentMonthYear.textContent = `${state.currentYear}年${state.monthNames[state.currentMonth]}`;
            
            // Clear calendar grid
            calendarGrid.innerHTML = '';
            
            // Get selected weekday
            const selectedWeekdayInput = document.querySelector('input[name="weekday"]:checked');
            const selectedWeekday = selectedWeekdayInput ? selectedWeekdayInput.value : null;
            const selectedWeekdayNum = selectedWeekday ? state.weekdayMapping[selectedWeekday] : null;
            
            // Get calendar info for current month
            const firstDayOfMonth = new Date(state.currentYear, state.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Create actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-sm py-2 text-center';
                dayElement.textContent = day;
                
                // Get weekday for this date
                const date = new Date(state.currentYear, state.currentMonth, day);
                const dayWeekday = date.getDay();
                
                // Check if this date is already selected
                const dateString = formatDateString(state.currentYear, state.currentMonth, day);
                if (state.selectedDates.includes(dateString)) {
                    dayElement.classList.add('selected');
                }
                
                // Check if this day matches the selected weekday
                if (selectedWeekdayNum !== null && dayWeekday !== selectedWeekdayNum) {
                    // Day doesn't match selected weekday - disable it
                    dayElement.classList.add('disabled');
                    dayElement.style.opacity = '0.3';
                    dayElement.style.cursor = 'not-allowed';
                } else {
                    // Day matches selected weekday or no weekday selected - enable it
                    dayElement.classList.remove('disabled');
                    dayElement.style.opacity = '1';
                    dayElement.style.cursor = 'pointer';
                    
                    // Add click event to toggle selection (only for enabled days)
                    dayElement.addEventListener('click', () => toggleDateSelection(dayElement, state.currentYear, state.currentMonth, day));
                }
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Update pending lessons for current month
            updateCurrentMonthPending();
        }
        
        function setupPendingLessonsControls() {
            // Remove existing event listeners
            currentMonthPending.removeEventListener('input', handlePendingInput);
            decreasePendingBtn.removeEventListener('click', decreasePending);
            increasePendingBtn.removeEventListener('click', increasePending);
            
            // Add new event listeners
            currentMonthPending.addEventListener('input', handlePendingInput);
            decreasePendingBtn.addEventListener('click', decreasePending);
            increasePendingBtn.addEventListener('click', increasePending);
        }
        
        function handlePendingInput() {
            const value = parseInt(currentMonthPending.value) || 0;
            const monthKey = `${state.currentYear}-${state.currentMonth + 1}`;
            state.pendingLessons[monthKey] = value;
            updateTotalLessons();
        }
        
        function decreasePending() {
            const currentValue = parseInt(currentMonthPending.value) || 0;
            if (currentValue > 0) {
                currentMonthPending.value = currentValue - 1;
                handlePendingInput();
            }
        }
        
        function increasePending() {
            const currentValue = parseInt(currentMonthPending.value) || 0;
            currentMonthPending.value = currentValue + 1;
            handlePendingInput();
        }
        
        function updateCurrentMonthPending() {
            const monthKey = `${state.currentYear}-${state.currentMonth + 1}`;
            const pendingValue = state.pendingLessons[monthKey] || 0;
            currentMonthPending.value = pendingValue;
        }



        function toggleDateSelection(dayElement, year, month, day) {
            const dateString = formatDateString(year, month, day);
            
            // Toggle selected class
            dayElement.classList.toggle('selected');
            
            // Update the selected dates array
            if (dayElement.classList.contains('selected')) {
                // Add date if not already in the array
                if (!state.selectedDates.includes(dateString)) {
                    state.selectedDates.push(dateString);
                }
            } else {
                // Remove date if in the array
                const index = state.selectedDates.indexOf(dateString);
                if (index > -1) {
                    state.selectedDates.splice(index, 1);
                }
            }
            
            // Sort dates
            state.selectedDates.sort();
            
            // Refresh the display
            refreshSelectedDates();
        }

        function refreshSelectedDates() {
            // Update selected dates display
            selectedDatesContainer.innerHTML = '';
            
            if (state.selectedDates.length === 0 && !hasPendingLessons()) {
                const noDateElement = document.createElement('div');
                noDateElement.textContent = '暫未選擇日期';
                noDateElement.className = 'text-gray-500 dark:text-gray-400';
                selectedDatesContainer.appendChild(noDateElement);
            } else {
                // Group dates by month
                const datesByMonth = {};
                
                state.selectedDates.forEach(dateString => {
                    const [year, month, day] = dateString.split('-').map(Number);
                    const monthKey = `${year}-${month + 1}`;
                    
                    if (!datesByMonth[monthKey]) {
                        datesByMonth[monthKey] = [];
                    }
                    
                    datesByMonth[monthKey].push(day);
                });
                
                // Display grouped dates - ensure chronological order by month
                Object.keys(datesByMonth).sort().forEach(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    const monthName = state.monthNames[month - 1];
                    
                    const monthElement = document.createElement('div');
                    monthElement.innerHTML = `<span class="font-medium">${year}年${monthName}:</span> ${datesByMonth[monthKey].sort((a, b) => a - b).join(', ')}日`;
                    selectedDatesContainer.appendChild(monthElement);
                });
                
                // Add pending lessons for each month
                Object.entries(state.pendingLessons).forEach(([monthKey, count]) => {
                    if (count > 0) {
                        const [year, month] = monthKey.split('-').map(Number);
                        const monthName = state.monthNames[month - 1];
                        
                        const pendingElement = document.createElement('div');
                        pendingElement.innerHTML = `<span class="font-medium">${year}年${monthName} 待約:</span> ${count}堂`;
                        selectedDatesContainer.appendChild(pendingElement);
                    }
                });
            }
            
            // Calculate actual lessons considering the lessons per day and pending lessons
            const totalLessons = calculateTotalLessons();
            
            // Update total count
            totalSelectedDates.textContent = totalLessons.toFixed(1).replace(/\.0$/, '');
        }

        function hasPendingLessons() {
            return Object.values(state.pendingLessons).some(count => count > 0);
        }

        function updateTotalLessons() {
            refreshSelectedDates();
        }

        function calculateTotalLessons() {
            // Calculate total lessons from all time slots
            let grandTotal = 0;
            
            if (!state.timeSlots || state.timeSlots.length === 0) {
                return 0;
            }
            
            state.timeSlots.forEach((slot, index) => {
                const slotElements = document.querySelectorAll('.time-slot');
                const slotElement = slotElements[index];
                if (!slotElement || !slot) return;
                
                const lessonsPerDaySelect = slotElement.querySelector('.lessons-per-day');
                if (!lessonsPerDaySelect) return;
                
                const lessonsPerDay = parseFloat(lessonsPerDaySelect.value || 1);
                const selectedDatesLessons = (slot.selectedDates || []).length * lessonsPerDay;
                const pendingLessonsTotal = Object.values(slot.pendingLessons || {}).reduce((sum, count) => sum + count, 0);
                
                grandTotal += selectedDatesLessons + pendingLessonsTotal;
            });
            
            return grandTotal;
        }

        function clearAllDates() {
            // Clear the selected dates array
            state.selectedDates = [];
            
            // Remove selected class from all days
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Reset pending lessons
            state.pendingLessons = {};
            document.querySelectorAll('.pending-lessons-input').forEach(input => {
                input.value = 0;
            });
            
            // Refresh the display
            refreshSelectedDates();
        }

        function selectExampleDates() {
            // Clear existing dates first
            clearAllDates();
            
            // Get the selected year and weekdays
            const year = parseInt(calendarYear.value);
            const selectedWeekdays = [];
            
            // Get selected weekdays from checkboxes
            document.querySelectorAll('input[name="weekdays"]:checked').forEach(checkbox => {
                const weekdayName = checkbox.value;
                const weekdayNum = state.weekdayMapping[weekdayName];
                selectedWeekdays.push(weekdayNum);
            });
            
            if (selectedWeekdays.length === 0) {
                // If no weekdays are selected, default to Saturday
                selectedWeekdays.push(6); // Saturday
            }
            
            // Select dates for January and February
            for (let month = 0; month < 2; month++) {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const weekday = date.getDay();
                    
                    if (selectedWeekdays.includes(weekday)) {
                        const dateString = formatDateString(year, month, day);
                        state.selectedDates.push(dateString);
                    }
                }
            }
            
            // Re-generate calendars to show selected dates
            generateCalendars();
        }

        // Format dates for display in the requested format (all slots combined)
        function formatDatesForDisplay() {
            // Group dates by year and month from all time slots
            const datesByYearMonth = {};
            const pendingByYearMonth = {};
            
            // Process all time slots
            if (state.timeSlots && state.timeSlots.length > 0) {
                state.timeSlots.forEach(slot => {
                    // Process selected dates
                    if (slot.selectedDates) {
                        slot.selectedDates.forEach(dateString => {
                            const [year, month, day] = dateString.split('-').map(Number);
                            const key = `${year}-${month}`;
                            
                            if (!datesByYearMonth[key]) {
                                datesByYearMonth[key] = [];
                            }
                            datesByYearMonth[key].push(day);
                        });
                    }
                    
                    // Process pending lessons
                    if (slot.pendingLessons) {
                        Object.entries(slot.pendingLessons).forEach(([monthKey, count]) => {
                            if (count > 0) {
                                if (!pendingByYearMonth[monthKey]) {
                                    pendingByYearMonth[monthKey] = 0;
                                }
                                pendingByYearMonth[monthKey] += count;
                            }
                        });
                    }
                });
            }
            
            // Format the dates as required
            const formattedDates = [];
            
            // Ensure chronological order by sorting keys
            Object.keys(datesByYearMonth).sort().forEach(key => {
                const [year, month] = key.split('-').map(Number);
                const days = [...new Set(datesByYearMonth[key])].sort((a, b) => a - b); // Remove duplicates and sort
                
                // Format with the requested format
                const monthName = month + 1; // Convert to 1-based index
                
                // Single day format: - 2025年4月 29
                // Multiple days format: - 2025年5月 6/13/20/27
                const daysStr = days.length === 1 ? days[0] : days.join('/');
                formattedDates.push(`- ${year}年${monthName}月 ${daysStr}`);
            });
            
            // Add pending lessons for each month
            Object.entries(pendingByYearMonth).forEach(([monthKey, count]) => {
                if (count > 0) {
                    const [year, month] = monthKey.split('-').map(Number);
                    formattedDates.push(`- ${year}年${month}月 待約${count}堂`);
                }
            });
            
            return formattedDates.join('\n');
        }

        // Format dates for a specific slot
        function formatSlotDatesForDisplay(slot) {
            // Group dates by year and month for this slot only
            const datesByYearMonth = {};
            const pendingByYearMonth = {};
            
            // Process selected dates for this slot
            if (slot.selectedDates) {
                slot.selectedDates.forEach(dateString => {
                    const [year, month, day] = dateString.split('-').map(Number);
                    const key = `${year}-${month}`;
                    
                    if (!datesByYearMonth[key]) {
                        datesByYearMonth[key] = [];
                    }
                    datesByYearMonth[key].push(day);
                });
            }
            
            // Process pending lessons for this slot
            if (slot.pendingLessons) {
                Object.entries(slot.pendingLessons).forEach(([monthKey, count]) => {
                    if (count > 0) {
                        if (!pendingByYearMonth[monthKey]) {
                            pendingByYearMonth[monthKey] = 0;
                        }
                        pendingByYearMonth[monthKey] += count;
                    }
                });
            }
            
            // Format the dates as required
            const formattedDates = [];
            
            // Ensure chronological order by sorting keys properly (year-month format)
            const sortedKeys = Object.keys(datesByYearMonth).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                
                // First compare years, then months
                if (yearA !== yearB) {
                    return yearA - yearB;
                }
                return monthA - monthB;
            });
            
            sortedKeys.forEach(key => {
                const [year, month] = key.split('-').map(Number);
                const days = [...new Set(datesByYearMonth[key])].sort((a, b) => a - b); // Remove duplicates and sort
                
                // Format with the requested format
                const monthName = month + 1; // Convert to 1-based index
                
                // Single day format: - 2025年4月 29
                // Multiple days format: - 2025年5月 6/13/20/27
                const daysStr = days.length === 1 ? days[0] : days.join('/');
                formattedDates.push(`- ${year}年${monthName}月 ${daysStr}`);
            });
            
            // Add pending lessons for each month (also sorted)
            const sortedPendingKeys = Object.keys(pendingByYearMonth).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                
                if (yearA !== yearB) {
                    return yearA - yearB;
                }
                return monthA - monthB;
            });
            
            sortedPendingKeys.forEach(monthKey => {
                const count = pendingByYearMonth[monthKey];
                if (count > 0) {
                    const [year, month] = monthKey.split('-').map(Number);
                    formattedDates.push(`- ${year}年${month}月 待約${count}堂`);
                }
            });
            
            return formattedDates.join('\n');
        }

        // Message Generation Functions
        function generateMessage() {
            const isNewStudent = document.querySelector('input[name="registrationType"]:checked').value === '新生報名';
            
            // For new students, check if any time slot has dates selected
            if (isNewStudent) {
                let hasAnyDates = false;
                if (state.timeSlots && state.timeSlots.length > 0) {
                    hasAnyDates = state.timeSlots.some(slot => {
                        const dates = slot.selectedDates || [];
                        const pending = Object.values(slot.pendingLessons || {}).reduce((sum, count) => sum + count, 0);
                        return dates.length > 0 || pending > 0;
                    });
                }
                
                if (!hasAnyDates) {
                    showAlert('請選擇上課日期');
                    return;
                }
            }
            
            // Get students with ages
            const studentNames = [];
            const studentEntries = document.querySelectorAll('.student-entry');
            studentEntries.forEach(entry => {
                const name = entry.querySelector('.student-name').value.trim();
                const age = entry.querySelector('.student-age').value.trim();
                if (name) {
                    if (age) {
                        studentNames.push(`${name}(${age}歲)`);
                    } else {
                        studentNames.push(name);
                    }
                }
            });
            
            // Get referral names
            const referralNames = [];
            document.querySelectorAll('.referral-name').forEach(input => {
                const name = input.value.trim();
                if (name) {
                    referralNames.push(name);
                }
            });
            
            // Validate referral names
            const referralCount = parseInt(referralDiscount.value);
            if (referralCount > 0 && referralNames.filter(name => name.trim() !== '').length !== referralCount) {
                showAlert('請填寫所有介紹朋友的姓名');
                return;
            }
            
            // Get trial lesson info if new student
            const trialInstructor = isNewStudent ? document.getElementById('trialInstructor').value.trim() : '';
            
            // Get formatted trial date
            let trialDateStr = '';
            if (isNewStudent) {
                const year = trialYear.value;
                const month = trialMonth.value;
                const day = trialDay.value;
                trialDateStr = `${year}年${month}月${day}日`;
            }
            
            if (isNewStudent && !trialInstructor) {
                showAlert('新生報名需要填寫試堂導師');
                return;
            }
            
            // Get form values
            const registrationType = document.querySelector('input[name="registrationType"]:checked').value;
            const location = state.selectedLocation;
            const courseTypeValue = state.selectedCourseType;
            const classFormatValue = state.selectedClassFormat;
            const instructorType = state.selectedInstructorType;
            const instructorName = document.getElementById('instructorName').value.trim();
            const pricePerLesson = parseFloat(document.getElementById('pricePerLesson').value);
            const groupDiscount = parseInt(document.getElementById('groupDiscount').value);
            const studentSourceValue = document.getElementById('studentSource').value;
            const referrerName = document.getElementById('referrerName').value.trim();
            
            // Get class time info for new students
            let selectedWeekdays = [];
            let classTime = '';
            let lessonsPerDay = 1;
            
            if (isNewStudent) {
                // Collect weekdays and times from all time slots
                state.timeSlots.forEach((slot, index) => {
                    const slotElement = document.querySelector(`.time-slot:nth-child(${index + 1})`);
                    if (slotElement) {
                        const timeInput = slotElement.querySelector('.class-time');
                        
                        // Check for weekday selection using new method (stored in slot data) or fallback to old method
                        let hasWeekday = false;
                        let weekdayValue = '';
                        
                        if (slot.selectedWeekdayChinese) {
                            hasWeekday = true;
                            weekdayValue = slot.selectedWeekdayChinese;
                        } else {
                            // Fallback to old radio button method
                            const weekdayInput = slotElement.querySelector('input[name^="weekday_"]:checked');
                            if (weekdayInput) {
                                hasWeekday = true;
                                weekdayValue = weekdayInput.value;
                            }
                        }
                        
                        if (hasWeekday && timeInput && timeInput.value.trim()) {
                            selectedWeekdays.push(weekdayValue);
                            if (!classTime) {
                                classTime = timeInput.value.trim();
                            }
                        }
                    }
                });
                
                if (selectedWeekdays.length === 0) {
                    showAlert('請選擇上課星期');
                    return;
                }
                
                if (!classTime) {
                    showAlert('請填寫上課時間');
                    return;
                }
            }
            
            // Show loading indicator
            instructionsSection.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            
            // Calculate total lessons and pricing
            const totalLessons = isNewStudent ? calculateTotalLessons() : 0;
            const numberOfStudents = Math.max(studentNames.length, 1);
            
            let finalPrice = 0;
            let periodDiscounts = [];
            
            if (isNewStudent) {
                // Check if this course type uses period-based discounts
                const usesPeriodDiscount = ['指定導師課程（全年）', '全年親子嬰兒班', '全年私人班'].includes(courseTypeValue);
                
                if (usesPeriodDiscount) {
                    // Calculate pricing by period (every 2 months)
                    const originalPeriodLessons = calculateLessonsByPeriod();
                    
                    // Try to optimize lesson distribution for better pricing
                    const optimization = optimizeLessonDistribution(originalPeriodLessons, pricePerLesson, numberOfStudents);
                    const periodLessons = optimization.periods;
                    
                    let totalCost = 0;
                    
                    periodLessons.forEach(period => {
                        if (period.lessons > 0) {
                            let periodCost = period.lessons * pricePerLesson * numberOfStudents;
                            let discount = 1.0; // No discount by default
                            let discountText = '';
                            
                            // Apply single semester discount based on lesson count
                            if (period.lessons >= 15) {
                                discount = 0.85;
                                discountText = '85折';
                            } else if (period.lessons >= 12) {
                                discount = 0.9;
                                discountText = '9折';
                            } else if (period.lessons >= 8) {
                                discount = 0.95;
                                discountText = '95折';
                            }
                            // Note: >=7 lessons count as complete semester for multi-semester discount, but no single discount
                            
                            periodCost = periodCost * discount;
                            totalCost += periodCost;
                            
                            // Track all periods with >0 lessons for display
                            if (period.lessons > 0) {
                                if (discountText && period.lessons >= 8) {
                                    // >=8堂有單學期折扣
                                    periodDiscounts.push({
                                        period: period.name,
                                        lessons: period.lessons,
                                        discount: discountText,
                                        originalCost: period.lessons * pricePerLesson * numberOfStudents,
                                        discountedCost: periodCost
                                    });
                                } else {
                                    // 7堂或<7堂都無單學期折扣
                                    periodDiscounts.push({
                                        period: period.name,
                                        lessons: period.lessons,
                                        discount: '無折扣',
                                        originalCost: period.lessons * pricePerLesson * numberOfStudents,
                                        discountedCost: periodCost,
                                        noDiscount: true
                                    });
                                }
                            }
                        }
                    });
                    
                    // Apply consecutive semester discount - only to complete semesters (>=7 lessons)
                    const consecutiveDiscounts = calculateConsecutiveSemesterDiscounts(periodLessons);
                    if (consecutiveDiscounts.length > 0) {
                        const consecutiveDiscount = consecutiveDiscounts[0];
                        
                        // Calculate total cost of complete semesters and incomplete semesters separately
                        let completeSemestersCost = 0;
                        let incompleteSemestersCost = 0;
                        
                        periodLessons.forEach(period => {
                            if (period.lessons > 0) {
                                let periodCost = period.lessons * pricePerLesson * numberOfStudents;
                                let discount = 1.0;
                                
                                // Apply single semester discount
                                if (period.lessons >= 15) {
                                    discount = 0.85;
                                } else if (period.lessons >= 12) {
                                    discount = 0.9;
                                } else if (period.lessons >= 8) {
                                    discount = 0.95;
                                }
                                
                                periodCost = periodCost * discount;
                                
                                if (period.lessons >= 7) {
                                    // Complete semester - subject to consecutive discount
                                    completeSemestersCost += periodCost;
                                } else {
                                    // Incomplete semester - no consecutive discount
                                    incompleteSemestersCost += periodCost;
                                }
                            }
                        });
                        
                        // Apply consecutive discount only to complete semesters
                        completeSemestersCost = completeSemestersCost * consecutiveDiscount.multiplier;
                        totalCost = completeSemestersCost + incompleteSemestersCost;
                        
                        // Add to period discounts for display
                        periodDiscounts.push({
                            period: `連續${consecutiveDiscount.count}期優惠`,
                            lessons: `(${consecutiveDiscount.periods.join('、')})`,
                            discount: `額外${consecutiveDiscount.discount}`,
                            isConsecutive: true
                        });
                    }
                    
                    // Apply group discount on total
                    if (groupDiscount >= 4) {
                        totalCost = totalCost * 0.85;
                    } else if (groupDiscount >= 3) {
                        totalCost = totalCost * 0.9;
                    } else if (groupDiscount >= 2) {
                        totalCost = totalCost * 0.95;
                    }
                    
                    // Apply referral discount
                    const referralDiscountAmount = referralCount * 200;
                    finalPrice = Math.round(totalCost - referralDiscountAmount);
                } else {
                    // Use old calculation for other course types
                    let baseCost = totalLessons * pricePerLesson * numberOfStudents;
                    
                    // Apply group discount
                    if (groupDiscount >= 4) {
                        baseCost = baseCost * 0.85;
                    } else if (groupDiscount >= 3) {
                        baseCost = baseCost * 0.9;
                    } else if (groupDiscount >= 2) {
                        baseCost = baseCost * 0.95;
                    }
                    
                    // Apply referral discount
                    const referralDiscountAmount = referralCount * 200;
                    finalPrice = Math.round(baseCost - referralDiscountAmount);
                }
            }
            
            // Generate the message
            setTimeout(() => {
                const formattedDate = new Date().toLocaleDateString('zh-HK', {
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                
                let message = '';
                message += `學員報讀課程資料：\n泳心游泳會課程單據 （待付款）\n\n`;
                message += `🏊謝謝你報讀本會 (全年)私人及小組游泳課程 🏊\n`;
                
                // For new students, add trial lesson info first
                if (isNewStudent) {
                    message += `(一)試堂課程資料:\n`;
                    message += `1.試堂導師：${trialInstructor}\n`;
                    message += `2.試堂日期：${trialDateStr}\n\n`;
                    message += `(二)報讀課程資料:\n`;
                } else {
                    message += `(一)報讀課程資料:\n`;
                }
                
                // Check if any time slot has valid data first
                let hasTimeSlotData = false;
                state.timeSlots.forEach((slot, index) => {
                    const slotElement = document.querySelector(`.time-slot:nth-child(${index + 1})`);
                    if (!slotElement) return;
                    
                    const timeInput = slotElement.querySelector('.class-time');
                    
                    // Check if slot has weekday selected and time filled
                    const hasWeekday = slot.selectedWeekdayChinese || slotElement.querySelector('input[name^="weekday_"]:checked');
                    
                    if (hasWeekday && timeInput && timeInput.value.trim()) {
                        hasTimeSlotData = true;
                    }
                });
                
                // Get period info for title
                let periodTitle = '';
                if (hasTimeSlotData) {
                    // Extract months from selected dates to determine period
                    const months = new Set();
                    state.timeSlots.forEach(slot => {
                        if (slot.selectedDates) {
                            slot.selectedDates.forEach(dateString => {
                                const [year, month, day] = dateString.split('-').map(Number);
                                months.add(month + 1); // Convert to 1-based
                            });
                        }
                    });
                    
                    if (months.size > 0) {
                        const sortedMonths = Array.from(months).sort((a, b) => a - b);
                        const firstMonth = sortedMonths[0];
                        const lastMonth = sortedMonths[sortedMonths.length - 1];
                        periodTitle = `${firstMonth}-${lastMonth}月學期課程資料:`;
                    }
                }
                
                if (periodTitle) {
                    // Remove the last colon from section title and add period info
                    message = message.replace(/課程資料:\n$/, `${periodTitle}\n`);
                }
                
                // Extract student names and ages separately
                const studentsWithoutAge = [];
                let firstStudentAge = '';
                
                studentNames.forEach(fullName => {
                    if (fullName.includes('(') && fullName.includes('歲)')) {
                        const ageMatch = fullName.match(/\((\d+)歲\)/);
                        const nameOnly = fullName.replace(/\(\d+歲\)/, '').trim();
                        studentsWithoutAge.push(nameOnly);
                        if (!firstStudentAge && ageMatch) {
                            firstStudentAge = ageMatch[1];
                        }
                    } else {
                        studentsWithoutAge.push(fullName);
                    }
                });
                
                message += `1.學員姓名: ${studentsWithoutAge.length > 0 ? studentsWithoutAge.join('、') : '(未填寫姓名)'}\n`;
                
                // Add age if available
                if (firstStudentAge) {
                    message += `2.學員年齡：${firstStudentAge}歲\n`;
                }
                
                let itemNumber = firstStudentAge ? 3 : 2;
                
                message += `${itemNumber}.上課地點：${location}🏊\n`;
                itemNumber++;
                
                // Simplify course name by removing ratio information
                let simplifiedCourseName = classFormatValue;
                if (classFormatValue.includes('指定導師')) {
                    // Remove ratio part for 指定導師 courses
                    simplifiedCourseName = classFormatValue.replace(/1:\d+(-\d+)?/, '').trim();
                }
                message += `${itemNumber}.報讀課程：${simplifiedCourseName} （全年）\n`;
                itemNumber++;
                
                message += `${itemNumber}.導師級別：${instructorType}`;
                if (instructorName) {
                    message += ` (${instructorName})`;
                }
                message += `\n`;
                itemNumber++;
                
                // Extract teacher-student ratio from class format (match complete patterns)
                let ratio = '';
                const ratioMatch = classFormatValue.match(/1:\d+(?:-\d+)?/);
                if (ratioMatch) {
                    ratio = ratioMatch[0];
                }
                
                if (ratio) {
                    message += `${itemNumber}.師生比例：${ratio}\n`;
                    itemNumber++;
                }
                
                // Add student source if applicable and not "無"
                if (isNewStudent && studentSourceValue !== "無") {
                    message += `${itemNumber}.學生來源：${studentSourceValue}`;
                    if (studentSourceValue === '朋友介紹' && referrerName) {
                        message += `（${referrerName}）`;
                    }
                    message += '\n';
                    itemNumber++;
                }
                state.timeSlots.forEach((slot, index) => {
                    const slotElement = document.querySelector(`.time-slot:nth-child(${index + 1})`);
                    if (!slotElement) return;
                    
                    const timeInput = slotElement.querySelector('.class-time');
                    
                    // Check if slot has weekday selected and time filled
                    const hasWeekday = slot.selectedWeekdayChinese || slotElement.querySelector('input[name^="weekday_"]:checked');
                    
                    if (hasWeekday && timeInput && timeInput.value.trim()) {
                        hasTimeSlotData = true;
                    }
                });
                
                if (hasTimeSlotData) {
                    message += `${itemNumber}.上課時間及日期：\n`;
                    
                    // Display each time slot separately with "時段一", "時段二" format
                    let slotCounter = 0;
                    state.timeSlots.forEach((slot, index) => {
                        const slotElement = document.querySelector(`.time-slot:nth-child(${index + 1})`);
                        if (!slotElement) return;
                        
                        const timeInput = slotElement.querySelector('.class-time');
                        const lessonsPerDaySelect = slotElement.querySelector('.lessons-per-day');
                        
                        // Get weekday from slot data or fallback to old method
                        let weekday = '';
                        if (slot.selectedWeekdayChinese) {
                            weekday = slot.selectedWeekdayChinese;
                        } else {
                            // Fallback to old radio button method
                            const weekdayInput = slotElement.querySelector('input[name^="weekday_"]:checked');
                            weekday = weekdayInput ? weekdayInput.value : '';
                        }
                        
                        if (weekday && timeInput && timeInput.value.trim()) {
                            slotCounter++;
                            const time = timeInput.value.trim();
                            const lessonsPerDay = parseFloat(lessonsPerDaySelect.value || 1);
                            
                            // Convert numbers to Chinese for slot numbering
                            const chineseNumbers = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
                            const slotNumberChinese = chineseNumbers[slotCounter - 1] || slotCounter;
                            
                            message += `時段${slotNumberChinese}\n`;
                            message += `逢${weekday} ${time} (${lessonsPerDay === 1 ? '1堂' : lessonsPerDay + '堂'})\n`;
                            
                            // Format dates for this specific slot
                            const slotFormattedDates = formatSlotDatesForDisplay(slot);
                            if (slotFormattedDates) {
                                message += `${slotFormattedDates}\n`;
                            }
                            
                            message += `\n`;
                        }
                    });
                    itemNumber++;
                }
                
                // Add pricing information
                if (hasTimeSlotData) {
                    message += `\n${itemNumber}.繳交學費費用：\n`;
                    message += `- 每堂：$${pricePerLesson}\n`;
                    
                    // Get the first slot's lessons per day as default
                    let defaultLessonsPerDay = 1;
                    if (state.timeSlots.length > 0) {
                        const firstSlotElement = document.querySelector('.time-slot:first-child');
                        if (firstSlotElement) {
                            const firstLessonsPerDaySelect = firstSlotElement.querySelector('.lessons-per-day');
                            if (firstLessonsPerDaySelect) {
                                defaultLessonsPerDay = parseFloat(firstLessonsPerDaySelect.value || 1);
                            }
                        }
                    }
                    
                    message += `- 每日堂數：${defaultLessonsPerDay}堂\n`;
                    
                    // Add remaining lessons and as-of date if provided
                    const remainingLessons = document.getElementById('remainingLessons').value.trim();
                    const asOfDateText = document.getElementById('asOfDateText').textContent;
                    
                    if (remainingLessons && remainingLessons !== '0' && asOfDateText !== '未設定') {
                        message += `- 餘下堂數：${remainingLessons}堂（截至${asOfDateText}）\n`;
                    } else if (remainingLessons && remainingLessons !== '0') {
                        message += `- 餘下堂數：${remainingLessons}堂\n`;
                    } else if (asOfDateText !== '未設定') {
                        message += `- 截至日期：${asOfDateText}\n`;
                    }
                    
                    if (isNewStudent) {
                        message += `- 總堂數：${totalLessons.toFixed(1).replace(/\.0$/, '')}堂\n`;
                        if (studentNames.length > 0) {
                            message += `- 學員人數：${numberOfStudents}人\n`;
                        }
                        
                        // Add clear calculation breakdown for period-based pricing
                        if (periodDiscounts.length > 0) {
                            // Check if optimization was applied
                            const originalPeriodLessons = calculateLessonsByPeriod();
                            const optimization = optimizeLessonDistribution(originalPeriodLessons, pricePerLesson, numberOfStudents);
                            
                            if (optimization.wasOptimized) {
                                message += `\n💡 系統已自動為您優化學期分配，節省 $${optimization.originalPrice - optimization.optimizedPrice}\n`;
                            }
                            
                            message += `\n計算過程：\n`;
                            
                            const discountPeriods = periodDiscounts.filter(d => !d.isConsecutive && !d.noDiscount);
                            const noDiscountPeriods = periodDiscounts.filter(d => d.noDiscount);
                            const consecutiveDiscounts = periodDiscounts.filter(d => d.isConsecutive);
                            
                            // Show individual period calculations
                            const allPeriods = [...noDiscountPeriods, ...discountPeriods];
                            allPeriods.forEach(period => {
                                if (period.noDiscount) {
                                    message += `${period.period}：${period.lessons}堂 × $${pricePerLesson} = $${period.originalCost}\n`;
                                } else {
                                    message += `${period.period}：${period.lessons}堂 × $${pricePerLesson} × ${period.discount} = $${Math.round(period.discountedCost)}\n`;
                                }
                            });
                            
                            // Show consecutive discount if applicable
                            if (consecutiveDiscounts.length > 0) {
                                const totalBeforeConsecutive = allPeriods.reduce((sum, p) => sum + Math.round(p.discountedCost), 0);
                                consecutiveDiscounts.forEach(discount => {
                                    message += `${discount.period} ${discount.lessons}：($${totalBeforeConsecutive}) × ${discount.discount} = $${finalPrice + (referralCount * 200)}\n`;
                                });
                            }
                        }
                        
                        if (groupDiscount > 1) {
                            const discountText = groupDiscount === 2 ? '95折' : groupDiscount === 3 ? '9折' : '85折';
                            message += `- 新生${groupDiscount}人同行首次報名優惠：${discountText}\n`;
                        }
                        
                        if (referralCount > 0) {
                            const namesText = referralNames.join('、');
                            message += `- 介紹朋友優惠：-$${referralCount * 200}（介紹${namesText}，共${referralCount}位）\n`;
                        }
                        
                        message += `- 總收費：$${finalPrice}\n`;
                    } else {
                        // 續報學員的收費計算
                        const continuingTotalLessons = calculateTotalLessons();
                        message += `- 總堂數：${continuingTotalLessons.toFixed(1).replace(/\.0$/, '')}堂\n`;
                        if (studentNames.length > 0) {
                            message += `- 學員人數：${numberOfStudents}人\n`;
                        }
                        
                        // 續報學員也享受學期折扣
                        let continuingFinalPrice = 0;
                        let continuingPeriodDiscounts = [];
                        
                        // 檢查課程類型是否使用學期折扣
                        const usesPeriodDiscount = ['指定導師課程（全年）', '全年親子嬰兒班', '全年私人班'].includes(courseTypeValue);
                        
                        if (usesPeriodDiscount && continuingTotalLessons > 0) {
                            // 計算學期折扣（每2個月為1期）
                            const continuingPeriodLessons = calculateLessonsByPeriod();
                            let totalCost = 0;
                            
                            continuingPeriodLessons.forEach(period => {
                                if (period.lessons > 0) {
                                    let periodCost = period.lessons * pricePerLesson * numberOfStudents;
                                    let discount = 1.0; // 無折扣預設
                                    let discountText = '';
                                    
                                    // 應用學期折扣標準：>=8堂享受95折，7堂無單學期折扣但算完整學期
                                    if (period.lessons >= 15) {
                                        discount = 0.85;
                                        discountText = '85折';
                                    } else if (period.lessons >= 12) {
                                        discount = 0.9;
                                        discountText = '9折';
                                    } else if (period.lessons >= 8) {
                                        discount = 0.95;
                                        discountText = '95折';
                                    }
                                    // Note: 7堂算完整學期但無單學期折扣
                                    
                                    periodCost = periodCost * discount;
                                    totalCost += periodCost;
                                    
                                    // 追蹤所有學期用於計算顯示
                                    if (discountText && period.lessons >= 8) {
                                        continuingPeriodDiscounts.push({
                                            period: period.name,
                                            lessons: period.lessons,
                                            discount: discountText,
                                            originalCost: period.lessons * pricePerLesson * numberOfStudents,
                                            discountedCost: periodCost
                                        });
                                    } else if (period.lessons >= 7) {
                                        // 7堂：無單學期折扣但算完整學期
                                        continuingPeriodDiscounts.push({
                                            period: period.name,
                                            lessons: period.lessons,
                                            discount: '無折扣',
                                            originalCost: period.lessons * pricePerLesson * numberOfStudents,
                                            discountedCost: periodCost,
                                            noDiscount: true
                                        });
                                    } else if (period.lessons > 0) {
                                        // <7堂：不算完整學期，無任何折扣
                                        continuingPeriodDiscounts.push({
                                            period: period.name,
                                            lessons: period.lessons,
                                            discount: '無折扣',
                                            originalCost: period.lessons * pricePerLesson * numberOfStudents,
                                            discountedCost: periodCost,
                                            noDiscount: true
                                        });
                                    }
                                }
                            });
                            
                            // 應用連續學期折扣 - 只對完整學期（≥7堂）
                            const continuingConsecutiveDiscounts = calculateConsecutiveSemesterDiscounts(continuingPeriodLessons);
                            if (continuingConsecutiveDiscounts.length > 0) {
                                const consecutiveDiscount = continuingConsecutiveDiscounts[0];
                                
                                // 計算完整學期和不完整學期的費用分別
                                let completeSemestersCost = 0;
                                let incompleteSemestersCost = 0;
                                
                                continuingPeriodLessons.forEach(period => {
                                    if (period.lessons > 0) {
                                        let periodCost = period.lessons * pricePerLesson * numberOfStudents;
                                        let discount = 1.0;
                                        
                                        // 應用單學期折扣
                                        if (period.lessons >= 15) {
                                            discount = 0.85;
                                        } else if (period.lessons >= 12) {
                                            discount = 0.9;
                                        } else if (period.lessons >= 8) {
                                            discount = 0.95;
                                        }
                                        
                                        periodCost = periodCost * discount;
                                        
                                        if (period.lessons >= 7) {
                                            // 完整學期 - 享受連續學期折扣
                                            completeSemestersCost += periodCost;
                                        } else {
                                            // 不完整學期 - 無連續學期折扣
                                            incompleteSemestersCost += periodCost;
                                        }
                                    }
                                });
                                
                                // 只對完整學期應用連續學期折扣
                                completeSemestersCost = completeSemestersCost * consecutiveDiscount.multiplier;
                                totalCost = completeSemestersCost + incompleteSemestersCost;
                                
                                // 添加到學期折扣顯示
                                continuingPeriodDiscounts.push({
                                    period: `連續${consecutiveDiscount.count}期優惠`,
                                    lessons: `(${consecutiveDiscount.periods.join('、')})`,
                                    discount: `額外${consecutiveDiscount.discount}`,
                                    isConsecutive: true
                                });
                            }
                            
                            // 應用介紹朋友折扣
                            const continuingReferralDiscountAmount = referralCount * 200;
                            continuingFinalPrice = Math.round(totalCost - continuingReferralDiscountAmount);
                        } else {
                            // 不使用學期折扣的課程類型，使用舊計算方式
                            let continuingBaseCost = continuingTotalLessons * pricePerLesson * numberOfStudents;
                            const continuingReferralDiscountAmount = referralCount * 200;
                            continuingFinalPrice = Math.round(continuingBaseCost - continuingReferralDiscountAmount);
                        }
                        
                        // 顯示學期折扣信息（如果有）- 清晰的計算過程
                        if (continuingPeriodDiscounts.length > 0) {
                            message += `\n計算過程：\n`;
                            
                            const discountPeriods = continuingPeriodDiscounts.filter(d => !d.isConsecutive && !d.noDiscount);
                            const noDiscountPeriods = continuingPeriodDiscounts.filter(d => d.noDiscount);
                            const consecutiveDiscounts = continuingPeriodDiscounts.filter(d => d.isConsecutive);
                            
                            // 顯示各學期計算
                            const allPeriods = [...noDiscountPeriods, ...discountPeriods];
                            allPeriods.forEach(period => {
                                if (period.noDiscount) {
                                    message += `${period.period}：${period.lessons}堂 × $${pricePerLesson} = $${period.originalCost}\n`;
                                } else {
                                    message += `${period.period}：${period.lessons}堂 × $${pricePerLesson} × ${period.discount} = $${Math.round(period.discountedCost)}\n`;
                                }
                            });
                            
                            // 顯示連續學期折扣
                            if (consecutiveDiscounts.length > 0) {
                                const totalBeforeConsecutive = allPeriods.reduce((sum, p) => sum + Math.round(p.discountedCost), 0);
                                consecutiveDiscounts.forEach(discount => {
                                    message += `${discount.period} ${discount.lessons}：($${totalBeforeConsecutive}) × ${discount.discount} = $${continuingFinalPrice + (referralCount * 200)}\n`;
                                });
                            }
                        }
                        
                        // 續報學員可享受介紹朋友優惠
                        if (referralCount > 0) {
                            const namesText = referralNames.join('、');
                            message += `- 介紹朋友優惠：-$${referralCount * 200}（介紹${namesText}，共${referralCount}位）\n`;
                        }
                        
                        message += `- 總收費：$${continuingFinalPrice}\n`;
                    }
                }
                
                // Update UI
                document.getElementById('generatedMessage').value = message;
                
                // Update summary
                document.getElementById('summaryCourseType').textContent = courseTypeValue;
                document.getElementById('summaryInstructor').textContent = instructorName ? `${instructorType} (${instructorName})` : instructorType;
                document.getElementById('summaryPrice').textContent = `$${pricePerLesson}`;
                
                // Update lessons and total for both types
                if (isNewStudent) {
                    document.getElementById('summaryLessons').textContent = `${totalLessons.toFixed(1).replace(/\.0$/, '')}堂`;
                    document.getElementById('summaryTotal').textContent = `$${finalPrice}`;
                } else {
                    const continuingTotalLessons = calculateTotalLessons();
                    document.getElementById('summaryLessons').textContent = `${continuingTotalLessons.toFixed(1).replace(/\.0$/, '')}堂`;
                    
                    // 計算續報總費用
                    let continuingBaseCost = continuingTotalLessons * pricePerLesson * numberOfStudents;
                    const continuingReferralDiscountAmount = referralCount * 200;
                    const continuingFinalPrice = Math.round(continuingBaseCost - continuingReferralDiscountAmount);
                    document.getElementById('summaryTotal').textContent = `$${continuingFinalPrice}`;
                }
                
                document.getElementById('studentCount').textContent = `${numberOfStudents}人`;
                
                // Group discount (only for new students)
                if (isNewStudent && groupDiscount > 1) {
                    document.getElementById('summaryGroupDiscountRow').classList.remove('hidden');
                    const discountText = groupDiscount === 2 ? '95折' : groupDiscount === 3 ? '9折' : '85折';
                    document.getElementById('summaryGroupDiscount').textContent = discountText;
                } else {
                    document.getElementById('summaryGroupDiscountRow').classList.add('hidden');
                }
                
                // Referral discount (for both types)
                if (referralCount > 0) {
                    document.getElementById('summaryReferralDiscountRow').classList.remove('hidden');
                    document.getElementById('summaryReferralDiscount').textContent = `-$${referralCount * 200}`;
                } else {
                    document.getElementById('summaryReferralDiscountRow').classList.add('hidden');
                }
                
                // Show results
                loadingIndicator.classList.add('hidden');
                messageOutput.classList.remove('hidden');
                summaryOutput.classList.remove('hidden');
                
            }, 1000); // Simulate processing delay
        }

        function copyMessageToClipboard() {
            const message = document.getElementById('generatedMessage').value;
            
            // Use Clipboard API
            navigator.clipboard.writeText(message).then(() => {
                // Change button text temporarily
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    已複製
                `;
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showAlert('複製失敗，請手動複製訊息');
            });
        }

        function editAgain() {
            messageOutput.classList.add('hidden');
            summaryOutput.classList.add('hidden');
            instructionsSection.classList.remove('hidden');
        }

        // Add New Time Slot Function
        function addNewTimeSlot() {
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            const newSlotId = ++state.timeSlotCounter;
            
            // Get current date for new slot
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Create new time slot data with current date
            const newSlot = {
                id: newSlotId,
                selectedDates: [],
                pendingLessons: {},
                currentYear: currentYear,
                currentMonth: currentMonth
            };
            state.timeSlots.push(newSlot);
            
            // Create new slot HTML
            const newSlotElement = document.createElement('div');
            newSlotElement.className = 'time-slot bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4';
            newSlotElement.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-medium text-gray-800 dark:text-gray-200">時段 ${newSlotId}</h4>
                    <button type="button" class="remove-time-slot-btn bg-red-500 hover:bg-red-600 text-white rounded-md px-3 py-1 text-sm transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">上課時間</label>
                        <input type="text" class="class-time w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base" placeholder="例：09:10-09:50">
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">每日堂數</label>
                        <select class="lessons-per-day w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 text-base">
                            <option value="1">1堂</option>
                            <option value="1.5">1.5堂</option>
                            <option value="2">2堂</option>
                            <option value="2.5">2.5堂</option>
                            <option value="3">3堂</option>
                        </select>
                    </div>
                </div>

                <!-- 日曆部分 -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <label class="block text-sm font-medium">選擇上課日期</label>
                        <div class="flex gap-2">
                            <button type="button" class="clear-slot-dates px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-300 rounded">清除此時段</button>
                        </div>
                    </div>
                    
                    <!-- 單月日曆顯示 -->
                    <div class="slot-calendar bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 mb-4">
                        <!-- 月份導航 -->
                        <div class="flex items-center justify-between mb-4">
                            <button type="button" class="prev-month-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div class="text-center">
                                <h3 class="current-month-year text-lg font-semibold text-gray-900 dark:text-gray-100"></h3>
                            </div>
                            <button type="button" class="next-month-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- 星期標題 - 可點擊選擇 -->
                        <div class="grid grid-cols-7 gap-1 mb-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-600 shadow-sm">
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="0" data-chinese="星期日">日</div>
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="1" data-chinese="星期一">一</div>
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="2" data-chinese="星期二">二</div>
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="3" data-chinese="星期三">三</div>
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="4" data-chinese="星期四">四</div>
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="5" data-chinese="星期五">五</div>
                            <div class="weekday-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30" data-weekday="6" data-chinese="星期六">六</div>
                        </div>
                        
                        <!-- 日期網格 -->
                        <div class="calendar-grid grid grid-cols-7 gap-1 mb-4">
                            <!-- 日期將在這裡動態生成 -->
                        </div>
                        
                        <!-- 待約堂數控制 -->
                        <div class="flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-600">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">本月待約堂數:</span>
                            <div class="flex items-center gap-2">
                                <button type="button" class="decrease-pending-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded text-sm">-</button>
                                <input type="number" class="current-month-pending w-16 text-center rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-1 text-sm" value="0" min="0">
                                <button type="button" class="increase-pending-btn px-3 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded text-sm">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium mb-2">此時段已選日期：</h4>
                                <div class="slot-selected-dates text-sm text-gray-600 dark:text-gray-400">
                                    暫未選擇日期
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600 dark:text-gray-400">時段堂數</div>
                                <div class="text-2xl font-bold text-primary dark:text-primary-light slot-total-lessons">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to container
            timeSlotsContainer.appendChild(newSlotElement);
            
            // Setup the new slot
            setupTimeSlot(newSlotId);
            
            // Setup remove button
            const removeBtn = newSlotElement.querySelector('.remove-time-slot-btn');
            removeBtn.addEventListener('click', () => removeTimeSlot(newSlotId));
            
            // Update remove buttons state
            updateRemoveTimeSlotButtons();
            
            // Update all slots display
            updateAllSlotsDisplay();
        }

        function removeTimeSlot(slotId) {
            // Find the slot index in state
            const slotIndex = state.timeSlots.findIndex(s => s.id === slotId);
            if (slotIndex === -1) return;
            
            // Remove from state
            state.timeSlots.splice(slotIndex, 1);
            
            // Remove from DOM using the correct index
            const slotElements = document.querySelectorAll('.time-slot');
            const slotElement = slotElements[slotIndex];
            if (slotElement) {
                slotElement.remove();
            }
            
            // Update slot numbers
            updateSlotNumbers();
            
            // Update remove buttons state
            updateRemoveTimeSlotButtons();
            
            // Update all slots display
            updateAllSlotsDisplay();
        }

        function updateSlotNumbers() {
            const slotElements = document.querySelectorAll('.time-slot');
            slotElements.forEach((element, index) => {
                const header = element.querySelector('h4');
                if (header) {
                    header.textContent = `時段 ${index + 1}`;
                }
            });
        }

        function updateRemoveTimeSlotButtons() {
            const slots = document.querySelectorAll('.time-slot');
            const removeButtons = document.querySelectorAll('.remove-time-slot-btn');
            
            removeButtons.forEach(btn => {
                if (slots.length <= 1) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            });
        }

        // Calculate lessons by period (every 2 months) - using semester planning inputs
        function calculateLessonsByPeriod() {
            const periods = [
                { name: 'A學期 (1-2月)', months: [1, 2], lessons: 0 },
                { name: 'B學期 (3-4月)', months: [3, 4], lessons: 0 },
                { name: 'C學期 (5-6月)', months: [5, 6], lessons: 0 },
                { name: 'D學期 (7-8月)', months: [7, 8], lessons: 0 },
                { name: 'E學期 (9-10月)', months: [9, 10], lessons: 0 },
                { name: 'F學期 (11-12月)', months: [11, 12], lessons: 0 }
            ];
            
            // Read from semester planning inputs
            const periodInputs = document.querySelectorAll('.period-lessons-input');
            periodInputs.forEach((input, index) => {
                if (index < periods.length) {
                    periods[index].lessons = parseInt(input.value) || 0;
                }
            });
            
            return periods;
        }
        
        // Calculate total lessons from semester planning
        function calculateTotalLessonsFromPlanning() {
            const periodInputs = document.querySelectorAll('.period-lessons-input');
            let total = 0;
            periodInputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            return total;
        }

        // Optimize lesson distribution for better pricing
        function optimizeLessonDistribution(originalPeriods, pricePerLesson, numberOfStudents) {
            // Create a copy to work with
            let periods = originalPeriods.map(p => ({ ...p }));
            
            // Only optimize periods with lessons > 0
            const activePeriods = periods.filter(p => p.lessons > 0);
            
            if (activePeriods.length < 2) {
                return { periods: originalPeriods, wasOptimized: false, originalPrice: 0, optimizedPrice: 0 };
            }
            
            // Calculate original price
            const originalPrice = calculatePeriodPrice(originalPeriods, pricePerLesson, numberOfStudents);
            
            console.log('Original periods:', originalPeriods.filter(p => p.lessons > 0));
            console.log('Original price:', originalPrice);
            
            // Try to optimize: move lessons from periods with more lessons to periods with 7 lessons
            let optimizedPeriods = periods.map(p => ({ ...p }));
            let hasOptimization = false;
            
            // Find periods that could benefit from optimization (7堂無折扣，但可以變成8堂95折)
            const needsOptimization = activePeriods.filter(p => p.lessons === 7);
            // Find periods that can donate lessons (>8堂，捐出後仍有>=8堂)
            const canDonate = activePeriods.filter(p => p.lessons >= 9);
            
            console.log('Needs optimization (7 lessons):', needsOptimization);
            console.log('Can donate (>=9 lessons):', canDonate);
            
            // Try to move 1 lesson from donor periods to 7-lesson periods
            for (const needsPeriod of needsOptimization) {
                for (const donorPeriod of canDonate) {
                    // 嘗試轉移1堂課
                    const testPeriods = optimizedPeriods.map(p => ({ ...p }));
                    const needsIndex = testPeriods.findIndex(p => p.name === needsPeriod.name);
                    const donorIndex = testPeriods.findIndex(p => p.name === donorPeriod.name);
                    
                    if (needsIndex !== -1 && donorIndex !== -1) {
                        testPeriods[needsIndex].lessons += 1; // 7 -> 8堂
                        testPeriods[donorIndex].lessons -= 1; // 9 -> 8堂
                        
                        console.log('Testing optimization:', testPeriods.filter(p => p.lessons > 0));
                        
                        // 計算新價格
                        const testPrice = calculatePeriodPrice(testPeriods, pricePerLesson, numberOfStudents);
                        console.log('Test price:', testPrice);
                        
                        if (testPrice < originalPrice) {
                            optimizedPeriods = testPeriods;
                            hasOptimization = true;
                            console.log('Optimization found! Savings:', originalPrice - testPrice);
                            break;
                        }
                    }
                }
                if (hasOptimization) break;
            }
            
            // If no simple optimization worked, try more balanced redistributions
            if (!hasOptimization && activePeriods.length === 2) {
                const totalLessons = activePeriods.reduce((sum, p) => sum + p.lessons, 0);
                
                // For 2 periods, try to make them as equal as possible while both >=8
                if (totalLessons >= 16) {
                    const half = Math.floor(totalLessons / 2);
                    const remainder = totalLessons % 2;
                    
                    const testPeriods = periods.map(p => ({ ...p }));
                    let assignedLessons = 0;
                    
                    activePeriods.forEach((period, index) => {
                        const periodIndex = testPeriods.findIndex(p => p.name === period.name);
                        if (index === 0) {
                            testPeriods[periodIndex].lessons = half + remainder;
                            assignedLessons = half + remainder;
                        } else {
                            testPeriods[periodIndex].lessons = totalLessons - assignedLessons;
                        }
                    });
                    
                    console.log('Testing balanced distribution:', testPeriods.filter(p => p.lessons > 0));
                    
                    const testPrice = calculatePeriodPrice(testPeriods, pricePerLesson, numberOfStudents);
                    console.log('Balanced test price:', testPrice);
                    
                    if (testPrice < originalPrice) {
                        optimizedPeriods = testPeriods;
                        hasOptimization = true;
                        console.log('Balanced optimization found! Savings:', originalPrice - testPrice);
                    }
                }
            }
            
            const finalPrice = hasOptimization ? calculatePeriodPrice(optimizedPeriods, pricePerLesson, numberOfStudents) : originalPrice;
            
            console.log('Final optimization result:', {
                wasOptimized: hasOptimization,
                originalPrice,
                finalPrice,
                savings: originalPrice - finalPrice
            });
            
            return {
                periods: hasOptimization ? optimizedPeriods : originalPeriods,
                wasOptimized: hasOptimization,
                originalPrice: originalPrice,
                optimizedPrice: finalPrice
            };
        }
        
        // Calculate total price for a period distribution
        function calculatePeriodPrice(periods, pricePerLesson, numberOfStudents) {
            let totalCost = 0;
            
            // Calculate single semester discounts
            periods.forEach(period => {
                if (period.lessons > 0) {
                    let periodCost = period.lessons * pricePerLesson * numberOfStudents;
                    let discount = 1.0;
                    
                    if (period.lessons >= 15) {
                        discount = 0.85;
                    } else if (period.lessons >= 12) {
                        discount = 0.9;
                    } else if (period.lessons >= 8) {
                        discount = 0.95;
                    }
                    // 7堂無折扣，<7堂也無折扣
                    
                    periodCost = periodCost * discount;
                    totalCost += periodCost;
                }
            });
            
            // Apply consecutive semester discount
            const consecutiveDiscounts = calculateConsecutiveSemesterDiscounts(periods);
            if (consecutiveDiscounts.length > 0) {
                const consecutiveDiscount = consecutiveDiscounts[0];
                
                // Calculate complete vs incomplete semesters
                let completeSemestersCost = 0;
                let incompleteSemestersCost = 0;
                
                periods.forEach(period => {
                    if (period.lessons > 0) {
                        let periodCost = period.lessons * pricePerLesson * numberOfStudents;
                        let discount = 1.0;
                        
                        if (period.lessons >= 15) {
                            discount = 0.85;
                        } else if (period.lessons >= 12) {
                            discount = 0.9;
                        } else if (period.lessons >= 8) {
                            discount = 0.95;
                        }
                        
                        periodCost = periodCost * discount;
                        
                        if (period.lessons >= 7) {
                            completeSemestersCost += periodCost;
                        } else {
                            incompleteSemestersCost += periodCost;
                        }
                    }
                });
                
                completeSemestersCost = completeSemestersCost * consecutiveDiscount.multiplier;
                totalCost = completeSemestersCost + incompleteSemestersCost;
            }
            
            return Math.round(totalCost);
        }

        // Calculate consecutive semester discounts
        function calculateConsecutiveSemesterDiscounts(periods) {
            const consecutiveDiscounts = [];
            
            // Filter periods with lessons >= 7
            const eligiblePeriods = periods.filter(period => period.lessons >= 7);
            
            if (eligiblePeriods.length < 2) {
                return consecutiveDiscounts;
            }
            
            // Check for consecutive semesters with proper cross-year handling
            const periodOrder = ['A學期 (1-2月)', 'B學期 (3-4月)', 'C學期 (5-6月)', 'D學期 (7-8月)', 'E學期 (9-10月)', 'F學期 (11-12月)'];
            
            // Create a map for quick lookup
            const periodMap = {};
            periods.forEach(period => {
                periodMap[period.name] = period;
            });
            
            // Find all possible consecutive sequences (not just the longest)
            let allConsecutiveSequences = [];
            
            // Check each possible consecutive sequence
            for (let startIdx = 0; startIdx < periodOrder.length; startIdx++) {
                for (let length = 2; length <= periodOrder.length; length++) {
                    const currentSequence = [];
                    let hasGap = false;
                    
                    // Build sequence starting from this period with specific length
                    for (let i = 0; i < length; i++) {
                        const periodIdx = (startIdx + i) % periodOrder.length;
                        const periodName = periodOrder[periodIdx];
                        const period = periodMap[periodName];
                        
                        if (period && period.lessons >= 7) {
                            currentSequence.push(period);
                        } else {
                            hasGap = true;
                            break; // Stop if we hit a gap
                        }
                    }
                    
                    // Only add if we have a complete sequence without gaps
                    if (!hasGap && currentSequence.length === length && currentSequence.length >= 2) {
                        allConsecutiveSequences.push([...currentSequence]);
                    }
                }
            }
            
            // Remove duplicates and find the longest sequence
            let longestSequence = [];
            const uniqueSequences = [];
            
            allConsecutiveSequences.forEach(seq => {
                const seqNames = seq.map(p => p.name).sort().join(',');
                
                // Check if this sequence is not already added
                const isDuplicate = uniqueSequences.some(existing => 
                    existing.map(p => p.name).sort().join(',') === seqNames
                );
                
                if (!isDuplicate) {
                    uniqueSequences.push(seq);
                    if (seq.length > longestSequence.length) {
                        longestSequence = seq;
                    }
                }
            });
            
            // Apply consecutive discounts based on the longest sequence
            if (longestSequence.length >= 2) {
                let discount = 1.0;
                let discountText = '';
                
                if (longestSequence.length >= 6) {
                    discount = 0.85;
                    discountText = '85折';
                } else if (longestSequence.length >= 3) {
                    discount = 0.9;
                    discountText = '9折';
                } else if (longestSequence.length >= 2) {
                    discount = 0.95;
                    discountText = '95折';
                }
                
                if (discountText) {
                    consecutiveDiscounts.push({
                        periods: longestSequence.map(p => p.name),
                        count: longestSequence.length,
                        discount: discountText,
                        multiplier: discount
                    });
                }
            }
            
            return consecutiveDiscounts;
        }

        // Helper Functions
        function formatDateString(year, month, day) {
            return `${year}-${month}-${day}`;
        }

        // Custom alert function
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90" onclick="this.closest('.fixed').remove()">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Setup course selectors
        function setupCourseSelectors() {
            const courseTypeSelectors = document.querySelectorAll('.course-type-selector');
            const classFormatContainer = document.getElementById('classFormatContainer');
            
            // Define class format options for each course type
            const classFormatOptions = {
                '全年親子嬰兒班': [
                    { short: '1:1', full: '私人班1:1' },
                    { short: '1:2', full: '私人班1:2' },
                    { short: '小組', full: '嬰幼兒小組班1:3-5' },
                    { short: '恆', full: '恆常泳班1:4-7' }
                ],
                '全年私人班': [
                    { short: '1:1', full: '私人班1:1' },
                    { short: '1:2', full: '私人班1:2' },
                    { short: '幼1:1', full: '幼兒私人班1:1' },
                    { short: '幼1:2', full: '幼兒私人班1:2' }
                ],
                '指定導師課程（全年）': [
                    { short: '小組', full: '指定導師小組班1:2-4' },
                    { short: '中', full: '指定導師中班1:4-6' },
                    { short: '高', full: '指定導師高班1:5-8' },
                    { short: '隊', full: '指定導師泳隊1:6-12' }
                ],
                '全年團體泳班': [
                    { short: '初', full: '全年團體泳班 初班 1:3-5' },
                    { short: '中', full: '全年團體泳班 中班 1:4-6' },
                    { short: '高', full: '全年團體泳班 高班 1:6-12' }
                ]
            };
            
            // Setup course type selectors
            courseTypeSelectors.forEach(selector => {
                selector.addEventListener('click', () => {
                    // Clear all selections
                    courseTypeSelectors.forEach(s => s.classList.remove('selected'));
                    
                    // Add selected class to clicked selector
                    selector.classList.add('selected');
                    
                    // Update state
                    state.selectedCourseType = selector.getAttribute('data-course-type');
                    
                    // Update class format options
                    updateClassFormatSelectors(state.selectedCourseType, classFormatOptions);
                    
                    // Update instructor options and pricing
                    updateClassFormatOptions();
                    updatePricingBasedOnSelection();
                });
            });
            
            // Initialize with default course type
            updateClassFormatSelectors(state.selectedCourseType, classFormatOptions);
        }
        
        function updateClassFormatSelectors(courseType, classFormatOptions) {
            const classFormatContainer = document.getElementById('classFormatContainer');
            
            // Clear existing options
            classFormatContainer.innerHTML = '';
            
            // Get options for selected course type
            const options = classFormatOptions[courseType] || [];
            
            // Determine grid columns based on number of options
            let gridCols = 'grid-cols-4';
            if (options.length === 3) {
                gridCols = 'grid-cols-3';
            } else if (options.length === 2) {
                gridCols = 'grid-cols-2';
            }
            
            // Update container class
            classFormatContainer.className = `grid ${gridCols} gap-1 p-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm`;
            
            // Add class format options
            options.forEach((option, index) => {
                const selector = document.createElement('div');
                selector.className = `class-format-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30`;
                selector.setAttribute('data-class-format', option.full);
                selector.setAttribute('data-short', option.short);
                selector.textContent = option.short;
                
                // Select first option by default
                if (index === 0) {
                    selector.classList.add('selected');
                    state.selectedClassFormat = option.full;
                }
                
                // Add click event
                selector.addEventListener('click', () => {
                    // Clear all selections
                    document.querySelectorAll('.class-format-selector').forEach(s => s.classList.remove('selected'));
                    
                    // Add selected class to clicked selector
                    selector.classList.add('selected');
                    
                    // Update state
                    state.selectedClassFormat = selector.getAttribute('data-class-format');
                    
                    // Update instructor options and pricing
                    updateInstructorOptionsForFormat();
                    updatePricingBasedOnSelection();
                });
                
                classFormatContainer.appendChild(selector);
            });
        }

        // Setup instructor type selector
        function setupInstructorTypeSelector() {
            updateInstructorTypeSelectors();
        }
        
        function updateInstructorTypeSelectors() {
            const instructorTypeContainer = document.getElementById('instructorTypeContainer');
            const selectedType = state.selectedCourseType;
            const selectedFormat = state.selectedClassFormat;
            
            // Define instructor options for each course type and format combination
            const instructorOptions = {
                '全年親子嬰兒班': {
                    '私人班1:1': ['資深導師', '高級導師'],
                    '私人班1:2': ['資深導師', '高級導師'],
                    '嬰幼兒小組班1:3-5': ['資深導師', '高級導師'],
                    '恆常泳班1:4-7': ['固定泳班導師']
                },
                '全年私人班': {
                    '私人班1:1': ['資深導師', '主管導師', '女導師', '高級導師', '初級導師'],
                    '私人班1:2': ['資深導師', '主管導師', '女導師', '高級導師', '初級導師'],
                    '幼兒私人班1:1': ['資深導師', '主管導師', '女導師'],
                    '幼兒私人班1:2': ['資深導師', '主管導師', '女導師']
                },
                '指定導師課程（全年）': {
                    '指定導師小組班1:2-4': ['資深導師', '主管導師', '女導師', '高級導師', '初級導師'],
                    '指定導師中班1:4-6': ['資深導師', '主管導師', '女導師', '高級導師', '初級導師'],
                    '指定導師高班1:5-8': ['資深導師', '主管導師', '女導師', '高級導師', '初級導師'],
                    '指定導師泳隊1:6-12': ['資深導師', '主管導師', '女導師', '高級導師', '初級導師']
                },
                '全年團體泳班': {
                    '全年團體泳班 初班 1:3-5': ['團體泳班導師'],
                    '全年團體泳班 中班 1:4-6': ['團體泳班導師'],
                    '全年團體泳班 高班 1:6-12': ['團體泳班導師']
                }
            };
            
            // Clear existing options
            instructorTypeContainer.innerHTML = '';
            
            // Get options for selected course type and format
            let options = [];
            if (instructorOptions[selectedType] && instructorOptions[selectedType][selectedFormat]) {
                options = instructorOptions[selectedType][selectedFormat];
            } else {
                // Fallback to default options
                options = ['資深導師', '主管導師', '女導師', '高級導師', '初級導師', '團體泳班導師'];
            }
            
            // Determine grid columns based on number of options
            let gridCols = 'grid-cols-6';
            if (options.length <= 5) {
                gridCols = 'grid-cols-5';
            } else if (options.length <= 4) {
                gridCols = 'grid-cols-4';
            } else if (options.length <= 3) {
                gridCols = 'grid-cols-3';
            } else if (options.length <= 2) {
                gridCols = 'grid-cols-2';
            }
            
            // Update container class
            instructorTypeContainer.className = `grid ${gridCols} gap-1 p-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm`;
            
            // Add instructor type options
            options.forEach((option, index) => {
                const selector = document.createElement('div');
                selector.className = `instructor-type-selector text-center text-sm font-medium py-2 cursor-pointer rounded transition-all duration-200 text-gray-700 dark:text-gray-200 hover:bg-primary/10 hover:text-primary border border-transparent hover:border-primary/30`;
                selector.setAttribute('data-instructor-type', option);
                selector.setAttribute('data-short', option.charAt(0)); // First character
                selector.textContent = option.charAt(0);
                
                // Select based on current state or default to '主管導師' if available, otherwise first option
                const shouldSelect = (state.selectedInstructorType === option) || 
                                   (index === 0 && !options.includes(state.selectedInstructorType)) ||
                                   (option === '主管導師' && options.includes('主管導師') && !options.includes(state.selectedInstructorType));
                
                if (shouldSelect) {
                    selector.classList.add('selected');
                    state.selectedInstructorType = option;
                }
                
                // Add click event
                selector.addEventListener('click', () => {
                    // Clear all selections
                    document.querySelectorAll('.instructor-type-selector').forEach(s => s.classList.remove('selected'));
                    
                    // Add selected class to clicked selector
                    selector.classList.add('selected');
                    
                    // Update state
                    state.selectedInstructorType = selector.getAttribute('data-instructor-type');
                    
                    // Update pricing
                    updatePricingBasedOnSelection();
                });
                
                instructorTypeContainer.appendChild(selector);
            });
        }

        // Semester Planning Functions
        function setupSemesterPlanning() {
            // Get all period lesson inputs
            const periodInputs = document.querySelectorAll('.period-lessons-input');
            
            // Add event listeners to all period inputs
            periodInputs.forEach(input => {
                input.addEventListener('input', updateSemesterPlanning);
            });
            
            // Listen to price and student count changes
            const priceInput = document.getElementById('pricePerLesson');
            if (priceInput) {
                priceInput.addEventListener('input', updateSemesterPlanning);
                priceInput.addEventListener('change', updateSemesterPlanning);
            }
            
            // Listen to student changes
            document.addEventListener('change', (e) => {
                if (e.target.closest('.student-entry')) {
                    updateSemesterPlanning();
                }
            });
            
            // Listen to course type and format changes
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('course-type-selector') || 
                    e.target.classList.contains('class-format-selector') ||
                    e.target.classList.contains('instructor-type-selector')) {
                    // Delay to allow state updates
                    setTimeout(updateSemesterPlanning, 100);
                }
            });
            
            // Initial update
            updateSemesterPlanning();
        }
        
        function updateSemesterPlanning() {
            // Get current values
            const pricePerLesson = parseFloat(document.getElementById('pricePerLesson').value) || 225;
            const studentEntries = document.querySelectorAll('.student-entry');
            const numberOfStudents = Math.max(studentEntries.length, 1);
            
            // Update display values
            document.getElementById('displayPricePerLesson').textContent = `$${pricePerLesson}`;
            document.getElementById('displayStudentCount').textContent = `${numberOfStudents}人`;
            
            // Update basic cost info
            const baseCostInfo = document.getElementById('baseCostInfo');
            baseCostInfo.innerHTML = `
                7堂: $${(7 * pricePerLesson * numberOfStudents).toLocaleString()} (無折扣)<br>
                8堂: $${(8 * pricePerLesson * numberOfStudents).toLocaleString()} → $${Math.round(8 * pricePerLesson * numberOfStudents * 0.95).toLocaleString()} (95折)<br>
                12堂: $${(12 * pricePerLesson * numberOfStudents).toLocaleString()} → $${Math.round(12 * pricePerLesson * numberOfStudents * 0.9).toLocaleString()} (9折)<br>
                15堂: $${(15 * pricePerLesson * numberOfStudents).toLocaleString()} → $${Math.round(15 * pricePerLesson * numberOfStudents * 0.85).toLocaleString()} (85折)
            `;
            
            // Calculate each period's cost and discount
            const periodInputs = document.querySelectorAll('.period-lessons-input');
            let totalLessons = 0;
            let totalCost = 0;
            const activePeriods = [];
            
            periodInputs.forEach(input => {
                const lessons = parseInt(input.value) || 0;
                totalLessons += lessons;
                
                if (lessons > 0) {
                    let periodCost = lessons * pricePerLesson * numberOfStudents;
                    let discount = 1.0;
                    let discountText = '';
                    
                    // Apply single period discounts
                    if (lessons >= 15) {
                        discount = 0.85;
                        discountText = '→ $' + Math.round(periodCost * discount).toLocaleString() + ' (85折)';
                    } else if (lessons >= 12) {
                        discount = 0.9;
                        discountText = '→ $' + Math.round(periodCost * discount).toLocaleString() + ' (9折)';
                    } else if (lessons >= 8) {
                        discount = 0.95;
                        discountText = '→ $' + Math.round(periodCost * discount).toLocaleString() + ' (95折)';
                    } else if (lessons >= 7) {
                        discountText = '(無單期折扣)';
                    } else {
                        discountText = '(無折扣)';
                    }
                    
                    periodCost = periodCost * discount;
                    totalCost += periodCost;
                    
                    // Update period display
                    const periodPlanning = input.closest('.period-planning');
                    const costSpan = periodPlanning.querySelector('.period-cost');
                    const discountSpan = periodPlanning.querySelector('.period-discount-info');
                    
                    costSpan.textContent = '$' + (lessons * pricePerLesson * numberOfStudents).toLocaleString();
                    discountSpan.textContent = discountText;
                    
                    if (lessons >= 7) {
                        activePeriods.push({
                            name: input.getAttribute('data-period'),
                            lessons: lessons
                        });
                    }
                } else {
                    // Clear display for periods with 0 lessons
                    const periodPlanning = input.closest('.period-planning');
                    const costSpan = periodPlanning.querySelector('.period-cost');
                    const discountSpan = periodPlanning.querySelector('.period-discount-info');
                    
                    costSpan.textContent = '$0';
                    discountSpan.textContent = '';
                }
            });
            
            // Calculate consecutive period discounts
            let consecutiveBonus = '';
            if (activePeriods.length >= 6) {
                totalCost = totalCost * 0.85;
                consecutiveBonus = `連續${activePeriods.length}期優惠: 額外85折`;
            } else if (activePeriods.length >= 3) {
                totalCost = totalCost * 0.9;
                consecutiveBonus = `連續${activePeriods.length}期優惠: 額外9折`;
            } else if (activePeriods.length >= 2) {
                totalCost = totalCost * 0.95;
                consecutiveBonus = `連續${activePeriods.length}期優惠: 額外95折`;
            } else if (activePeriods.length === 1) {
                consecutiveBonus = '單期報名 (無連續優惠)';
            } else {
                consecutiveBonus = '尚未選擇學期';
            }
            
            // Update total display
            document.getElementById('plannedTotalLessons').textContent = `${totalLessons}堂`;
            document.getElementById('consecutiveBonusInfo').textContent = consecutiveBonus;
            document.getElementById('plannedTotalCost').textContent = `$${Math.round(totalCost).toLocaleString()}`;
        }

        // Setup as-of date selector
        function setupAsOfDateSelector() {
            // Set default to no date
            const asOfDateText = document.getElementById('asOfDateText');
            asOfDateText.textContent = '未設定';
            
            // Populate day options
            updateAsOfDayOptions();
            
            // Setup as-of date events
            setupAsOfDateEvents();
        }
        
        function setupAsOfDateEvents() {
            // As-of date selector elements
            const asOfDateDisplay = document.getElementById('asOfDateDisplay');
            const asOfDateSelector = document.getElementById('asOfDateSelector');
            const editAsOfDateBtn = document.getElementById('editAsOfDateBtn');
            const confirmAsOfDateBtn = document.getElementById('confirmAsOfDateBtn');
            const cancelAsOfDateBtn = document.getElementById('cancelAsOfDateBtn');
            const clearAsOfDateBtn = document.getElementById('clearAsOfDateBtn');
            const asOfCalendarMonthYear = document.getElementById('asOfCalendarMonthYear');
            const asOfCalendarGrid = document.getElementById('asOfCalendarGrid');
            const asOfPrevMonthBtn = document.getElementById('asOfPrevMonthBtn');
            const asOfNextMonthBtn = document.getElementById('asOfNextMonthBtn');
            const asOfYear = document.getElementById('asOfYear');
            const asOfMonth = document.getElementById('asOfMonth');
            const asOfDay = document.getElementById('asOfDay');
            
            // State for as-of calendar
            state.asOfCalendar = {
                currentYear: parseInt(asOfYear.value),
                currentMonth: parseInt(asOfMonth.value) - 1,
                selectedDate: null
            };
            
            // Edit button click
            editAsOfDateBtn.addEventListener('click', () => {
                // Update state with current values if there's a selected date
                const asOfDateText = document.getElementById('asOfDateText');
                if (asOfDateText.textContent !== '未設定') {
                    state.asOfCalendar.currentYear = parseInt(asOfYear.value);
                    state.asOfCalendar.currentMonth = parseInt(asOfMonth.value) - 1;
                    state.asOfCalendar.selectedDate = {
                        year: parseInt(asOfYear.value),
                        month: parseInt(asOfMonth.value) - 1,
                        day: parseInt(asOfDay.value)
                    };
                } else {
                    // No date selected, use current date as default
                    const today = new Date();
                    state.asOfCalendar.currentYear = today.getFullYear();
                    state.asOfCalendar.currentMonth = today.getMonth();
                    state.asOfCalendar.selectedDate = {
                        year: today.getFullYear(),
                        month: today.getMonth(),
                        day: today.getDate()
                    };
                    
                    // Update selectors
                    asOfYear.value = today.getFullYear();
                    asOfMonth.value = today.getMonth() + 1;
                    updateAsOfDayOptions();
                    asOfDay.value = today.getDate();
                }
                
                asOfDateDisplay.classList.add('hidden');
                asOfDateSelector.classList.remove('hidden');
                renderAsOfCalendar();
            });
            
            // Confirm button click
            confirmAsOfDateBtn.addEventListener('click', () => {
                if (state.asOfCalendar.selectedDate) {
                    // Update selectors with calendar selection
                    asOfYear.value = state.asOfCalendar.selectedDate.year;
                    asOfMonth.value = state.asOfCalendar.selectedDate.month + 1;
                    updateAsOfDayOptions();
                    asOfDay.value = state.asOfCalendar.selectedDate.day;
                    
                    // Update display text
                    updateAsOfDateDisplay();
                }
                
                // Hide selector, show display
                asOfDateSelector.classList.add('hidden');
                asOfDateDisplay.classList.remove('hidden');
            });
            
            // Cancel button click
            cancelAsOfDateBtn.addEventListener('click', () => {
                asOfDateSelector.classList.add('hidden');
                asOfDateDisplay.classList.remove('hidden');
            });
            
            // Clear button click
            clearAsOfDateBtn.addEventListener('click', () => {
                state.asOfCalendar.selectedDate = null;
                const asOfDateText = document.getElementById('asOfDateText');
                asOfDateText.textContent = '未設定';
                editAsOfDateBtn.textContent = '設定';
                
                asOfDateSelector.classList.add('hidden');
                asOfDateDisplay.classList.remove('hidden');
            });
            
            // Calendar navigation
            asOfPrevMonthBtn.addEventListener('click', () => {
                state.asOfCalendar.currentMonth--;
                if (state.asOfCalendar.currentMonth < 0) {
                    state.asOfCalendar.currentMonth = 11;
                    state.asOfCalendar.currentYear--;
                }
                renderAsOfCalendar();
            });
            
            asOfNextMonthBtn.addEventListener('click', () => {
                state.asOfCalendar.currentMonth++;
                if (state.asOfCalendar.currentMonth > 11) {
                    state.asOfCalendar.currentMonth = 0;
                    state.asOfCalendar.currentYear++;
                }
                renderAsOfCalendar();
            });
            
            // Listen to selector changes
            asOfYear.addEventListener('change', () => {
                updateAsOfDayOptions();
                updateAsOfDateDisplay();
            });
            asOfMonth.addEventListener('change', () => {
                updateAsOfDayOptions();
                updateAsOfDateDisplay();
            });
            asOfDay.addEventListener('change', updateAsOfDateDisplay);
        }
        
        function renderAsOfCalendar() {
            const asOfCalendarMonthYear = document.getElementById('asOfCalendarMonthYear');
            const asOfCalendarGrid = document.getElementById('asOfCalendarGrid');
            
            // Update month/year display
            asOfCalendarMonthYear.textContent = `${state.asOfCalendar.currentYear}年${state.monthNames[state.asOfCalendar.currentMonth]}`;
            
            // Clear calendar grid
            asOfCalendarGrid.innerHTML = '';
            
            // Get calendar info for current month
            const firstDayOfMonth = new Date(state.asOfCalendar.currentYear, state.asOfCalendar.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.asOfCalendar.currentYear, state.asOfCalendar.currentMonth + 1, 0).getDate();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'text-center p-2';
                asOfCalendarGrid.appendChild(emptyDay);
            }
            
            // Create actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'text-center text-sm p-2 cursor-pointer border rounded transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-600';
                dayElement.textContent = day;
                
                // Check if this date is the selected date
                if (state.asOfCalendar.selectedDate &&
                    state.asOfCalendar.selectedDate.year === state.asOfCalendar.currentYear &&
                    state.asOfCalendar.selectedDate.month === state.asOfCalendar.currentMonth &&
                    state.asOfCalendar.selectedDate.day === day) {
                    dayElement.classList.add('bg-primary', 'text-white');
                    dayElement.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-600');
                }
                
                // Add click event to select date
                dayElement.addEventListener('click', () => {
                    // Remove selection from all days
                    asOfCalendarGrid.querySelectorAll('div').forEach(d => {
                        d.classList.remove('bg-primary', 'text-white');
                        if (d.textContent && d.classList.contains('cursor-pointer')) {
                            d.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-600');
                        }
                    });
                    
                    // Add selection to clicked day
                    dayElement.classList.add('bg-primary', 'text-white');
                    dayElement.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-600');
                    
                    // Update selected date
                    state.asOfCalendar.selectedDate = {
                        year: state.asOfCalendar.currentYear,
                        month: state.asOfCalendar.currentMonth,
                        day: day
                    };
                });
                
                asOfCalendarGrid.appendChild(dayElement);
            }
        }
        
        function updateAsOfDateDisplay() {
            const asOfYear = document.getElementById('asOfYear');
            const asOfMonth = document.getElementById('asOfMonth');
            const asOfDay = document.getElementById('asOfDay');
            const asOfDateText = document.getElementById('asOfDateText');
            const editAsOfDateBtn = document.getElementById('editAsOfDateBtn');
            
            if (state.asOfCalendar && state.asOfCalendar.selectedDate) {
                const year = asOfYear.value;
                const month = asOfMonth.value;
                const day = asOfDay.value;
                
                asOfDateText.textContent = `${year}年${month}月${day}日`;
                editAsOfDateBtn.textContent = '修改';
            }
        }
        
        // Update as-of day options based on selected year and month
        function updateAsOfDayOptions() {
            const asOfYear = document.getElementById('asOfYear');
            const asOfMonth = document.getElementById('asOfMonth');
            const asOfDay = document.getElementById('asOfDay');
            
            if (!asOfYear || !asOfMonth || !asOfDay) return;
            
            const year = parseInt(asOfYear.value);
            const month = parseInt(asOfMonth.value) - 1; // JavaScript months are 0-indexed
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Save current day selection if possible
            const currentDay = parseInt(asOfDay.value) || 1;
            
            // Clear existing options
            asOfDay.innerHTML = '';
            
            // Add new day options
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}日`;
                asOfDay.appendChild(option);
            }
            
            // Restore previous day selection if valid, otherwise select day 1
            if (currentDay <= daysInMonth) {
                asOfDay.value = currentDay;
            } else {
                asOfDay.value = 1;
            }
        }

        // Initialize the app when document is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
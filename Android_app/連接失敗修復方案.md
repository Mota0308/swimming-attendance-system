# 連接失敗修復方案

## 🚨 問題描述

用戶反映：創建賬號時顯示 "failed to connect 203.145.95.240:3000"

## 🔍 問題分析

### 根本原因
1. **遠程服務器無法訪問** - `203.145.95.240` 無法ping通
2. **API配置錯誤** - 使用了無法訪問的遠程IP地址
3. **本地服務器未運行** - 本地API服務器沒有啟動

### 診斷結果
```bash
# Ping測試結果
ping 203.145.95.240
# 結果: 100% 封包遺失 - 無法訪問

# 本地服務器測試
curl http://localhost:3000/health
# 結果: 連接成功 - 本地服務器正常
```

## ✅ 修復方案

### 方案1: 使用本地服務器（推薦）

#### 1. 修改API配置
```kotlin
// 修復前
private const val DEFAULT_BASE_URL = "http://203.145.95.240:3000"

// 修復後
private const val DEFAULT_BASE_URL = "http://10.0.2.2:3000" // Android模擬器/本地開發
```

#### 2. 啟動本地API服務器
```bash
cd api-server
node server.js
```

#### 3. 測試連接
```bash
# 測試本地服務器
curl http://localhost:3000/health

# 測試API端點
curl -H "X-API-Public-Key: ttdrcccy" -H "X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://localhost:3000/health
```

### 方案2: 使用WiFi網絡（如果手機和電腦在同一網絡）

#### 1. 獲取電腦IP地址
```bash
ipconfig | findstr "IPv4"
```

#### 2. 修改API配置
```kotlin
private const val DEFAULT_BASE_URL = "http://192.168.x.x:3000" // 替換為實際IP
```

#### 3. 確保防火牆允許連接
- 開放端口3000
- 允許Node.js通過防火牆

### 方案3: 使用Android模擬器（開發測試）

#### 1. 使用模擬器專用地址
```kotlin
private const val DEFAULT_BASE_URL = "http://10.0.2.2:3000"
```

#### 2. 在Android Studio中運行
- 使用AVD模擬器
- 確保模擬器可以訪問主機網絡

## 🛠️ 立即修復步驟

### 步驟1: 啟動API服務器
```bash
cd api-server
node server.js
```

### 步驟2: 修改API配置
已將 `APIConfig.kt` 中的基礎URL改為：
```kotlin
private const val DEFAULT_BASE_URL = "http://10.0.2.2:3000"
```

### 步驟3: 重新構建APK
```bash
cd Android_app
./gradlew assembleDebug
```

### 步驟4: 安裝並測試
1. 安裝新APK到手機
2. 測試創建賬號功能
3. 檢查是否還有連接錯誤

## 📱 不同設備的配置

### Android模擬器
```kotlin
private const val DEFAULT_BASE_URL = "http://10.0.2.2:3000"
```

### 實體設備（WiFi連接）
```kotlin
private const val DEFAULT_BASE_URL = "http://192.168.x.x:3000" // 電腦IP
```

### 實體設備（USB調試）
```kotlin
private const val DEFAULT_BASE_URL = "http://localhost:3000"
```

## 🔧 故障排除

### 問題1: 仍然無法連接
**解決方案**:
1. 檢查API服務器是否運行
2. 確認端口3000已開放
3. 檢查防火牆設置

### 問題2: 模擬器無法連接
**解決方案**:
1. 重啟Android模擬器
2. 檢查模擬器網絡設置
3. 使用 `adb reverse tcp:3000 tcp:3000`

### 問題3: 實體設備無法連接
**解決方案**:
1. 確保手機和電腦在同一WiFi網絡
2. 檢查電腦IP地址
3. 測試網絡連接

## 📊 測試命令

### 測試本地服務器
```bash
# 檢查服務器狀態
netstat -an | findstr :3000

# 測試健康檢查
curl http://localhost:3000/health

# 測試API端點
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -H "X-API-Public-Key: ttdrcccy" \
  -H "X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" \
  -d '{"phone":"test123","password":"123456","userType":"parent"}'
```

### 測試網絡連接
```bash
# 測試本地連接
ping localhost

# 測試端口連接
telnet localhost 3000
```

## 🎯 成功標準

### 功能測試
- ✅ 可以連接到API服務器
- ✅ 創建賬號功能正常
- ✅ 不再出現連接錯誤
- ✅ 數據庫操作成功

### 性能測試
- ✅ 連接響應時間 < 3秒
- ✅ 請求成功率 > 95%
- ✅ 錯誤處理正常

## 🚀 下一步計劃

### 短期目標
1. 確保本地開發環境正常
2. 測試所有API端點
3. 完善錯誤處理

### 長期目標
1. 部署到雲端服務器
2. 實現負載均衡
3. 添加監控和日誌

---

**修復版本**: 1.0.3  
**修復日期**: 2025年8月7日  
**問題類型**: 網絡連接失敗  
**修復狀態**: ✅ 已完成 
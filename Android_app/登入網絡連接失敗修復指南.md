# 登入網絡連接失敗修復指南

## 🔍 問題描述

在Android應用登入時顯示"網絡連接失敗"錯誤。

## 🎯 可能的原因

### 1. API服務器未運行
- Node.js進程已停止
- 服務器崩潰或異常退出
- 端口被其他程序佔用

### 2. 端口配置不匹配
- API服務器運行在端口3001
- Android應用仍配置為端口3000
- 防火牆阻止端口訪問

### 3. 網絡連接問題
- 設備無法訪問服務器IP
- 網絡權限不足
- DNS解析問題

## 🔧 解決方案

### 步驟1: 檢查API服務器狀態

#### 1.1 運行診斷腳本
```bash
# 在api-server目錄下運行
.\diagnose-connection.ps1
```

#### 1.2 手動檢查
```bash
# 檢查Node.js進程
Get-Process node -ErrorAction SilentlyContinue

# 檢查端口使用
netstat -an | findstr :3001

# 測試API連接
curl -H "x-api-public-key: ttdrcccy" -H "x-api-private-key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://localhost:3001/health
```

### 步驟2: 重啟API服務器

#### 2.1 使用修復腳本
```bash
# 在api-server目錄下運行
.\fix-login-issue.bat
```

#### 2.2 手動重啟
```bash
# 停止所有Node.js進程
taskkill /f /im node.exe

# 等待3秒
timeout /t 3

# 啟動服務器
node server.js
```

### 步驟3: 驗證API服務器

#### 3.1 檢查啟動信息
服務器啟動時應該顯示：
```
🚀 API 服務器已啟動
📍 本地地址: http://localhost:3001
🌐 服務器地址: http://203.145.95.240:3001
🔑 API 密鑰已配置
```

#### 3.2 測試健康檢查
```bash
# 本地測試
curl -H "x-api-public-key: ttdrcccy" -H "x-api-private-key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://localhost:3001/health

# 公網測試
curl -H "x-api-public-key: ttdrcccy" -H "x-api-private-key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://203.145.95.240:3001/health
```

### 步驟4: 重新構建Android APK

#### 4.1 確認代碼更新
檢查以下文件是否已更新為端口3001：
- `app/src/main/java/com/swimming/attendance/network/APIConfig.kt`
- `app/src/main/java/com/swimming/attendance/ui/NetworkConfigActivity.kt`

#### 4.2 構建新APK
```bash
# 在Android_app目錄下運行
.\build_new_apk.bat
```

### 步驟5: 安裝和測試

#### 5.1 安裝新APK
1. 將 `app\build\outputs\apk\release\app-release.apk` 傳輸到Android設備
2. 在設備上啟用"未知來源"應用安裝
3. 安裝新APK

#### 5.2 測試登入
1. 啟動應用
2. 選擇家長版本
3. 輸入測試賬號：
   - 電話：test
   - 密碼：123456
4. 點擊登入

## 🧪 測試賬號

### 可用測試賬號
| 電話號碼 | 密碼 | 用戶類型 |
|---------|------|----------|
| test | 123456 | parent |
| 0912345678 | 123456 | parent |
| admin | admin123 | parent |
| demo | demo123 | parent |

## 📱 Android應用配置

### API配置
- **基礎URL**: http://203.145.95.240:3001
- **公開密鑰**: ttdrcccy
- **私有密鑰**: 2b207365-cbf0-4e42-a3bf-f932c84557c4

### 網絡權限
確保AndroidManifest.xml包含：
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

## 🔍 故障排除

### 問題1: API服務器無法啟動
**症狀**: 端口被佔用錯誤
**解決方案**:
```bash
# 查找佔用端口的進程
netstat -ano | findstr :3001
# 終止進程
taskkill /f /pid <進程ID>
```

### 問題2: 防火牆阻止連接
**症狀**: 連接超時
**解決方案**:
1. 檢查Windows防火牆設置
2. 允許Node.js通過防火牆
3. 開放端口3001

### 問題3: 網絡權限問題
**症狀**: 應用無法訪問網絡
**解決方案**:
1. 檢查應用權限設置
2. 確保網絡權限已授予
3. 重啟應用

### 問題4: DNS解析問題
**症狀**: 無法解析服務器IP
**解決方案**:
1. 使用IP地址而不是域名
2. 檢查網絡設置
3. 嘗試使用本地Wi-Fi網絡

## 📊 診斷工具

### 1. 網絡診斷
```bash
# 測試網絡連接
ping 203.145.95.240

# 測試端口連接
telnet 203.145.95.240 3001
```

### 2. API診斷
```bash
# 健康檢查
curl -H "x-api-public-key: ttdrcccy" -H "x-api-private-key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://203.145.95.240:3001/health

# 獲取學生資料
curl -H "x-api-public-key: ttdrcccy" -H "x-api-private-key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://203.145.95.240:3001/students
```

### 3. Android應用診斷
1. 長按登入按鈕進入測試界面
2. 查看連接狀態
3. 檢查API配置

## ✅ 驗證清單

- [ ] API服務器在端口3001正常運行
- [ ] 健康檢查端點響應正常
- [ ] Android應用代碼已更新為端口3001
- [ ] 新APK已構建並安裝
- [ ] 網絡權限已授予
- [ ] 測試賬號可以正常登入

## 🚨 緊急修復

如果問題持續存在，可以嘗試：

1. **重啟整個系統**
2. **使用本地Wi-Fi網絡** (192.168.1.24:3001)
3. **檢查服務器防火牆設置**
4. **聯繫網絡管理員**

---

**最後更新**: 2025年1月8日  
**版本**: 1.0  
**狀態**: 待測試 
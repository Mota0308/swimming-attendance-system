# 用戶賬戶創建異常診斷指南

## 🚨 問題描述

用戶反映：點擊創建賬號時顯示"用戶賬戶創建異常"錯誤。

## 🔍 可能的原因分析

### 1. 網絡連接問題
- **API服務器未運行**
- **網絡連接超時**
- **防火牆阻止連接**

### 2. API配置問題
- **基礎URL錯誤**
- **API密鑰無效**
- **請求格式錯誤**

### 3. 服務器端問題
- **MongoDB連接失敗**
- **數據庫權限問題**
- **服務器內部錯誤**

### 4. 客戶端問題
- **JSON格式錯誤**
- **請求頭缺失**
- **超時設置過短**

## 🛠️ 診斷步驟

### 步驟1: 檢查API服務器狀態

```bash
# 檢查服務器是否運行
netstat -an | findstr :3000

# 測試健康檢查端點
curl -H "X-API-Public-Key: ttdrcccy" -H "X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" http://203.145.95.240:3000/health
```

### 步驟2: 檢查網絡連接

```bash
# 測試網絡連接
ping 203.145.95.240

# 測試端口連接
telnet 203.145.95.240 3000
```

### 步驟3: 檢查API配置

```kotlin
// 檢查當前配置
val baseUrl = apiConfig.getBaseUrl()
val publicKey = apiConfig.getPublicApiKey()
val privateKey = apiConfig.getPrivateApiKey()

Log.d("Diagnostic", "Base URL: $baseUrl")
Log.d("Diagnostic", "Public Key: $publicKey")
Log.d("Diagnostic", "Private Key: $privateKey")
```

### 步驟4: 測試API端點

```bash
# 測試用戶註冊端點
curl -X POST http://203.145.95.240:3000/auth/register \
  -H "Content-Type: application/json" \
  -H "X-API-Public-Key: ttdrcccy" \
  -H "X-API-Private-Key: 2b207365-cbf0-4e42-a3bf-f932c84557c4" \
  -d '{
    "phone": "test123456",
    "password": "password123",
    "userType": "parent",
    "createdAt": 1640995200000
  }'
```

## 📋 診斷檢查清單

### 網絡檢查
- [ ] API服務器正在運行
- [ ] 端口3000已開放
- [ ] 網絡連接正常
- [ ] 防火牆未阻止連接

### 配置檢查
- [ ] 基礎URL正確: `http://203.145.95.240:3000`
- [ ] API密鑰正確
- [ ] 請求頭設置正確
- [ ] Content-Type設置正確

### 服務器檢查
- [ ] MongoDB連接正常
- [ ] 數據庫權限正確
- [ ] 服務器日誌無錯誤
- [ ] 內存使用正常

### 客戶端檢查
- [ ] JSON格式正確
- [ ] 請求方法正確 (POST)
- [ ] 超時設置合理
- [ ] 錯誤處理正常

## 🔧 常見解決方案

### 解決方案1: 重啟API服務器

```bash
# 停止現有服務器
taskkill /F /IM node.exe

# 重新啟動服務器
cd api-server
node server.js
```

### 解決方案2: 檢查MongoDB連接

```javascript
// 在server.js中添加連接測試
const testConnection = async () => {
    try {
        const client = new MongoClient(MONGO_URI);
        await client.connect();
        console.log('✅ MongoDB連接成功');
        await client.close();
    } catch (error) {
        console.error('❌ MongoDB連接失敗:', error);
    }
};
```

### 解決方案3: 增加錯誤日誌

```kotlin
// 在CloudAPIService中添加詳細日誌
Log.d(TAG, "🔗 嘗試連接到: ${apiConfig.getBaseUrl()}/auth/register")
Log.d(TAG, "📤 發送數據: $jsonData")
Log.d(TAG, "📊 響應碼: $responseCode")
Log.d(TAG, "📄 響應內容: $response")
```

### 解決方案4: 添加重試機制

```kotlin
private suspend fun createUserAccountWithRetry(userAccount: UserAccount, maxRetries: Int = 3): APIResponse {
    repeat(maxRetries) { attempt ->
        try {
            val result = createUserAccount(userAccount)
            if (result.success) return result
        } catch (e: Exception) {
            Log.w(TAG, "重試 ${attempt + 1}/$maxRetries 失敗: ${e.message}")
            if (attempt == maxRetries - 1) throw e
            delay(1000 * (attempt + 1)) // 指數退避
        }
    }
    return APIResponse(false, "重試次數已用完")
}
```

## 📊 錯誤代碼對照表

| 錯誤代碼 | 可能原因 | 解決方案 |
|---------|---------|---------|
| 404 | 端點不存在 | 檢查URL路徑 |
| 401 | API密鑰錯誤 | 驗證密鑰配置 |
| 500 | 服務器內部錯誤 | 檢查服務器日誌 |
| 超時 | 網絡連接問題 | 檢查網絡設置 |
| JSON解析錯誤 | 數據格式錯誤 | 檢查請求體格式 |

## 🚀 立即行動

### 1. 檢查服務器狀態
```bash
# 檢查Node.js進程
tasklist | findstr node

# 檢查端口使用
netstat -an | findstr :3000
```

### 2. 重啟服務器
```bash
cd api-server
node server.js
```

### 3. 測試連接
```bash
curl http://203.145.95.240:3000/health
```

### 4. 重新構建APK
```bash
cd Android_app
./gradlew assembleDebug
```

## 📞 進一步診斷

如果問題仍然存在，請提供以下信息：

1. **完整的錯誤日誌**
2. **API服務器控制台輸出**
3. **網絡連接測試結果**
4. **Android Studio Logcat輸出**

---

**診斷版本**: 1.0.0  
**創建日期**: 2025年8月7日  
**適用於**: 用戶賬戶創建異常問題 
 
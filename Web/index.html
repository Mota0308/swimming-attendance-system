<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com; connect-src 'self' https://swiming-production.up.railway.app; img-src 'self' data: https:; object-src 'none'; base-uri 'self'; form-action 'self';">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23667eea'/%3E%3Ctext x='32' y='38' text-anchor='middle' font-size='28' fill='white'%3E%F0%9F%8F%8B%EF%B8%8F%3C/text%3E%3C/svg%3E">
    <title>游泳系統 - 管理平台</title>
    
    <!-- 預載入關鍵資源 -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="styles.css?v=7" as="style">
    <link rel="preload" href="database-connector.js?v=26" as="script">
    <link rel="preload" href="script.js?v=39" as="script">
    
    <!-- DNS預解析 -->
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//swiming-production.up.railway.app">
    
    <!-- 關鍵CSS內聯，避免阻塞渲染 -->
    <style>
        /* 關鍵渲染路徑CSS */
        body { margin: 0; font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .loading-spinner { color: white; text-align: center; }
        .section { display: none; }
        .section.active { display: block; }
        .login-container { max-width: 400px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .login-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* 優化字體載入 */
        .font-loading { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .font-loaded { font-family: 'Inter', sans-serif; }
    </style>
    
    <!-- 非關鍵CSS異步載入 -->
    <link rel="stylesheet" href="styles.css?v=7">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 登入界面 -->
    <div id="loginSection" class="section active">
        <div class="login-container">
            <div class="login-header">
                <h1><i class="fas fa-swimming-pool"></i> 游泳系統</h1>
                <p>管理平台</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="phoneInput">
                        <i class="fas fa-phone"></i> 電話號碼
                    </label>
                    <input type="tel" id="phoneInput" name="phone" required placeholder="請輸入電話號碼">
                </div>
                
                <div class="form-group">
                    <label for="passwordInput">
                        <i class="fas fa-lock"></i> 密碼
                    </label>
                    <input type="password" id="passwordInput" name="password" required placeholder="請輸入密碼">
                </div>
                
                <div class="form-group">
                    <label for="roleSelect">
                        <i class="fas fa-user-tag"></i> 登入身份
                    </label>
                    <select id="roleSelect" name="role">
                        <option value="parent">學生</option>
                        <option value="coach" selected>教練</option>
                        <option value="supervisor">主管</option>
                        <option value="admin">管理員</option>
                    </select>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> 登入
                </button>
            </form>
            
            <div id="loginMessage" class="message"></div>
            
            <div class="login-footer">
                <p>© 2025 游泳系統</p>
            </div>
        </div>
    </div>

    <!-- 教練主界面 -->
    <div id="coachSection" class="section">
        <nav class="top-nav">
            <div class="nav-left">
                <h2><i class="fas fa-swimming-pool"></i> 游泳系統 - <span id="userRoleDisplay">管理平台</span></h2>
            </div>
            <div class="nav-right">
                <span id="userInfo" class="user-info">
                    <i class="fas fa-user"></i> <span id="userPhone"></span>
                </span>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </nav>

        <div class="main-content">
            <!-- 用戶信息區域 -->
            <div class="user-info-section">
                <div class="info-card">
                    <h3><i class="fas fa-user-circle"></i> 用戶信息</h3>
                    <p><strong>電話：</strong><span id="displayUserPhone"></span></p>
                    <p><strong>身份：</strong><span id="displayUserRole">教練</span></p>
                    <p><strong>登入時間：</strong><span id="loginTime"></span></p>
                </div>
                
                <!-- 數據庫連接狀態 -->
                <div class="info-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-database"></i> 數據庫連接狀態</h3>
                    <p><strong>連接狀態：</strong><span id="dbConnectionStatus">檢查中...</span></p>
                    <p><strong>最後同步：</strong><span id="lastSyncTime">-</span></p>
                    <p><strong>緩存數據：</strong><span id="cacheInfo">-</span></p>
                    <button id="refreshDbBtn" class="refresh-btn" onclick="refreshDatabaseConnection()" style="margin-top: 10px;">
                        <i class="fas fa-sync-alt"></i> 刷新連接
                    </button>
                </div>
            </div>

            <!-- 功能選項區域 -->
            <div class="features-section">
                <div class="feature-grid">
                    <div class="feature-card" onclick="showAttendanceManagement()">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>出席記錄管理</h3>
                        <p>管理學生出席記錄</p>
                    </div>
                    
                    <div class="feature-card" onclick="showLocationClub()">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>地點泳會</h3>
                        <p>管理地點和泳會信息</p>
                    </div>
                    
                    <div class="feature-card" onclick="showStaffWorkHours()">
                        <i class="fas fa-user-clock"></i>
                        <h3>教練工時</h3>
                        <p>查看所有 staff 的工時日曆</p>
                    </div>
                    
                    <div class="feature-card" onclick="showStaffRoster()">
                        <i class="fas fa-user-calendar"></i>
                        <h3>教練更表</h3>
                        <p>查看所有 staff 的更表</p>
                    </div>
                </div>
            </div>

            <!-- 出席記錄管理界面 -->
            <div id="attendanceSection" class="feature-interface hidden">
                <div class="interface-header">
                    <h3><i class="fas fa-clipboard-check"></i> 出席記錄管理</h3>
                    <button class="back-btn" onclick="hideAllFeatures()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
                
                <div class="attendance-controls">
                    <div class="control-group">
                        <label>選擇月份：</label>
                        <select id="attendanceMonth">
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>選擇地點：</label>
                        <select id="attendanceLocation">
                            <option value="">請選擇地點</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>選擇泳會：</label>
                        <select id="attendanceClub">
                            <option value="">請選擇泳會</option>
                        </select>
                    </div>
                    
                    <button class="refresh-btn" onclick="loadAttendanceData()">
                        <i class="fas fa-sync-alt"></i> 刷新數據
                    </button>
                </div>
                
                <div id="attendanceTable" class="attendance-table">
                    <div class="table-header">
                        <div class="table-cell">學生姓名</div>
                        <div class="table-cell">出席狀態</div>
                        <div class="table-cell">日期</div>
                        <div class="table-cell">操作</div>
                    </div>
                    <div id="attendanceData" class="table-body">
                        <!-- 數據將在這裡動態加載 -->
                    </div>
                </div>

                <!-- 新增：課程編排 UI 容器 -->
                <div id="schedulerContainer" class="mt-6"></div>

                <!-- 新增：出席排列板（獨立 UI） -->
                <div id="attendanceBoardContainer" class="mt-6"></div>
            </div>


            <!-- 地點泳會管理界面 -->
            <div id="locationClubSection" class="feature-interface hidden">
                <div class="interface-header">
                    <h3><i class="fas fa-map-marker-alt"></i> 地點泳會管理</h3>
                    <button class="back-btn" onclick="hideAllFeatures()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
                
                <div class="location-club-controls">
                    <div class="control-group">
                        <label>選擇地點：</label>
                        <select id="locationSelect">
                            <option value="">請選擇地點</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>選擇泳會：</label>
                        <select id="clubSelect">
                            <option value="">請選擇泳會</option>
                        </select>
                    </div>
                    
                    <button class="refresh-btn" onclick="loadLocationClubData()">
                        <i class="fas fa-sync-alt"></i> 刷新數據
                    </button>
                </div>
                
                <div class="location-club-info">
                    <div class="info-card">
                        <h4>當前選擇</h4>
                        <p><strong>地點：</strong><span id="currentLocation">未選擇</span></p>
                        <p><strong>泳會：</strong><span id="currentClub">未選擇</span></p>
                    </div>
                </div>
            </div>

            <!-- 教練工時（主管查看全部 / 教練僅顯示自己） -->
            <div id="staffWorkHoursSection" class="feature-interface hidden">
                <div class="interface-header">
                    <h3><i class="fas fa-user-clock"></i> 教練工時 <span id="workHoursCount" style="margin-left:12px;color:#6b7280;font-weight:500;font-size:14px;"></span></h3>
                    <button class="back-btn" onclick="hideAllFeatures()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
                <div class="location-club-controls" id="coachWorkFilters">
                    <div class="control-group">
                        <label>月份：</label>
                        <select id="coachWorkMonth">
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>地點：</label>
                        <select id="coachWorkLocation">
                            <option value="">全部地點</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>泳會：</label>
                        <select id="coachWorkClub">
                            <option value="">全部泳會</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>教練：</label>
                        <select id="coachWorkCoach">
                            <option value="">全部教練</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="refreshCurrentWorkHours()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>

                <!-- 教練工時汇总表格 -->
                <div class="work-hours-summary-section">
                    <h4><i class="fas fa-table"></i> 教練工時汇总</h4>
                    <div class="summary-table-container">
                        <table id="workHoursSummaryTable" class="work-hours-summary-table">
                            <thead>
                                <tr>
                                    <th>月份</th>
                                    <th>教練名稱</th>
                                    <th>總工時</th>
                                </tr>
                            </thead>
                            <tbody id="workHoursSummaryBody">
                                <tr>
                                    <td colspan="3" class="loading-message">
                                        <i class="fas fa-spinner fa-spin"></i> 載入中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="staffWorkHoursCalendars" class="work-hours-calendar"></div>
            </div>

            <!-- 教練更表 -->
            <div id="staffRosterSection" class="feature-interface hidden">
                <div class="interface-header">
                    <h3 id="rosterSectionTitle"><i class="fas fa-user-calendar"></i> 教練更表</h3>
                    <button class="back-btn" onclick="hideAllFeatures()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
                
                <!-- 新增：每日上課地點統計 -->
                <div class="roster-statistics-section">
                    <h4><i class="fas fa-chart-bar"></i> 每日上課地點統計</h4>
                    <div class="statistics-controls">
                        <div class="control-group">
                            <label>統計月份：</label>
                            <select id="statsMonth">
                                <option value="1">1月</option>
                                <option value="2">2月</option>
                                <option value="3">3月</option>
                                <option value="4">4月</option>
                                <option value="5">5月</option>
                                <option value="6">6月</option>
                                <option value="7">7月</option>
                                <option value="8" selected>8月</option>
                                <option value="9">9月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                        </div>
                        <button class="refresh-btn" onclick="generateDailyLocationStats()">
                            <i class="fas fa-calculator"></i> 生成統計
                        </button>
                        <button class="export-btn" onclick="exportLocationStats()">
                            <i class="fas fa-download"></i> 導出統計
                        </button>
                    </div>
                    <div id="dailyLocationStats" class="daily-stats-container">
                        <!-- 統計結果將在這裡顯示 -->
                    </div>
                </div>
                
                <div class="location-club-controls">
                    <div class="control-group">
                        <label>選擇教練：</label>
                        <select id="staffCoachSelect">
                            <option value="">全部教練</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="onChangeStaffCoach()">
                        <i class="fas fa-sync-alt"></i> 載入更表
                    </button>
                    <button class="export-btn" onclick="saveSelectedCoachRoster()">
                        <i class="fas fa-save"></i> 保存更表
                    </button>
                </div>
                <div id="staffRosterCalendars" class="roster-calendar"></div>
            </div>
        </div>
    </div>

    <!-- 加載指示器 -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>載入中...</p>
        </div>
    </div>

    <!-- 關鍵腳本優先載入 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="security.js?v=4" defer></script>
    <script src="database-connector.js?v=26" defer></script>
    
    <!-- 主要腳本使用defer，避免阻塞渲染 -->
    <script src="script.js?v=39" defer></script>
    
    <!-- 非關鍵腳本異步載入 -->
    <script src="scheduler-light.js?v=4" async></script>
    <script src="attendance-board-light.js?v=3" async></script>
    <script src="test-hasReschedule.js" defer></script>
    <script src="debug-hasReschedule-flow.js" defer></script>
    <script src="debug-roster-data.js" defer></script>
    <script src="debug-work-hours.js" defer></script>
    
    <!-- 緩存清除和字體載入優化 -->
    <script>
      // 強制清除緩存並重新加載關鍵腳本
      function forceClearCache() {
        if ('caches' in window) {
          caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
          });
        }
        
        // 清除 localStorage 中的緩存標記
        if (localStorage.getItem('cache_version') !== '28') {
          localStorage.clear();
          localStorage.setItem('cache_version', '28');
          
          // 如果不是首次加載，強制刷新
          if (sessionStorage.getItem('page_loaded')) {
            window.location.reload(true);
            return;
          }
          sessionStorage.setItem('page_loaded', 'true');
        }
      }
      
      // 立即執行緩存清除
      forceClearCache();
      
      // 字體載入優化
      if ('fonts' in document) {
        document.fonts.ready.then(() => {
          document.body.classList.add('font-loaded');
          document.body.classList.remove('font-loading');
        });
      } else {
        // 降級方案
        setTimeout(() => {
          document.body.classList.add('font-loaded');
          document.body.classList.remove('font-loading');
        }, 1000);
      }
      
      // Service Worker 註冊（提升載入速度）
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // 使用相對路徑，避免絕對路徑問題
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('✅ Service Worker 註冊成功:', registration.scope);
            })
            .catch(error => {
              console.warn('⚠️ Service Worker 註冊失敗:', error);
              // 不顯示錯誤給用戶，因為這不是關鍵功能
            });
        });
      }
    </script>
    
    <script>
      // 優化初始化邏輯
      function initAttendanceUIs(){
        if (window.initSchedulerLight) {
          window.initSchedulerLight('schedulerContainer');
        }
        if (window.initAttendanceBoardLight) {
          window.initAttendanceBoardLight('attendanceBoardContainer');
        }
      }
      
      // 使用更高效的初始化策略
      function initializeWhenReady() {
        if (window.databaseConnector && typeof window.databaseConnector.fetchStudentsRaw === 'function') {
          initAttendanceUIs();
        } else {
          // 如果還沒準備好，等待一小段時間再試
          setTimeout(initializeWhenReady, 100);
        }
      }
      
      // 首選：等待資料連接器就緒
      document.addEventListener('databaseConnectorReady', initAttendanceUIs);
      
      // 後備：DOM Ready 時若已就緒則立即初始化
      document.addEventListener('DOMContentLoaded', initializeWhenReady);
    </script>
  </body>
</html> 
# 🔄 課程編排系統 - 遞進篩選邏輯說明

## 📋 概述

本系統已從原來的**並列篩選**（AND邏輯）改為**遞進篩選**（層層縮小範圍），當您選擇日期、星期和地點時，篩選範圍會逐步縮小，提供更精確的結果。

## 🔍 篩選邏輯對比

### ❌ 原來的並列篩選（已棄用）
```javascript
// 舊邏輯：並列執行，同時滿足所有條件
let filtered = allStudentsCache.filter(s => {
  const okLoc = location ? eqLocation(s.location, location) : true;
  const okDay = wantDay ? (s.day === wantDay) : true;
  return okLoc && okDay;  // 必須同時滿足地點和星期
});
```

### ✅ 新的遞進篩選（現用）
```javascript
// 新邏輯：遞進執行，層層縮小範圍
let filtered = allStudentsCache;

// 步驟1：按地點篩選（第一層縮小）
if (location) {
  filtered = filtered.filter(s => eqLocation(s.location, location));
}

// 步驟2：按星期篩選（第二層縮小）
if (wantDay) {
  filtered = filtered.filter(s => s.day === wantDay);
}
```

## 📊 遞進篩選流程圖

```
原始數據 (100名學生)
        ↓
    📍 地點篩選
    荔枝角公園
        ↓
    縮小範圍 (30名學生)
        ↓
    📅 星期篩選
    星期一
        ↓
    進一步縮小 (10名學生)
        ↓
    🎯 最終結果
```

## 🔧 具體實現步驟

### 步驟1：數據預處理
```javascript
filtered = filtered.map(s => {
  // 標準化時間格式和星期信息
  if (s.time && /星期[一二三四五六日]/.test(s.time)) {
    const t = extractDayAndTime(s.time);
    if (t.day) s.day = t.day; 
    if (t.time) s.time = t.time;
  } else {
    s.time = to24hRange(s.time);
  }
  return s;
});
```

### 步驟2：地點篩選（第一層縮小）
```javascript
if (location) {
  const beforeLocation = filtered.length;
  filtered = filtered.filter(s => eqLocation(s.location, location));
  console.log(`📍 地點篩選：${beforeLocation} → ${filtered.length} (縮小範圍)`);
}
```

### 步驟3：星期篩選（第二層縮小）
```javascript
if (wantDay) {
  const beforeDay = filtered.length;
  filtered = filtered.filter(s => s.day === wantDay);
  console.log(`📅 星期篩選：${beforeDay} → ${filtered.length} (進一步縮小範圍)`);
}
```

### 步驟4：智能回退機制
```javascript
if (!filtered.length) {
  if (location && wantDay) {
    // 如果同時選擇了地點和星期但沒有結果，先回退到只按地點篩選
    filtered = allStudentsCache.filter(s => eqLocation(s.location, location));
    toast(`⚠️ 在${location}的${wantDay}沒有學生，已顯示該地點所有時段的學生`);
  } else if (location) {
    // 如果只選擇了地點但沒有結果，顯示該地點所有學生
    filtered = allStudentsCache.filter(s => eqLocation(s.location, location));
    toast(`⚠️ 在${location}沒有找到學生資料`);
  } else if (wantDay) {
    // 如果只選擇了星期但沒有結果，顯示該星期所有學生
    filtered = allStudentsCache.filter(s => s.day === wantDay);
    toast(`⚠️ 在${wantDay}沒有找到學生資料`);
  }
}
```

### 步驟5：數據去重
```javascript
const uniq = new Map();
filtered.forEach(s => {
  const key = `${(s.phone||'').trim()}|${s.name}`;
  if (!uniq.has(key)) uniq.set(key, s);
});
filtered = Array.from(uniq.values());
```

## 🎯 實際應用示例

### 示例1：只選擇地點
- **選擇**：地點 = 荔枝角公園
- **篩選過程**：
  1. 原始數據：100名學生
  2. 地點篩選：100 → 30名學生（縮小範圍）
  3. 最終結果：30名學生

### 示例2：只選擇星期
- **選擇**：星期 = 星期一
- **篩選過程**：
  1. 原始數據：100名學生
  2. 星期篩選：100 → 40名學生（縮小範圍）
  3. 最終結果：40名學生

### 示例3：選擇地點 + 星期
- **選擇**：地點 = 荔枝角公園，星期 = 星期一
- **篩選過程**：
  1. 原始數據：100名學生
  2. 地點篩選：100 → 30名學生（縮小範圍）
  3. 星期篩選：30 → 10名學生（進一步縮小範圍）
  4. 最終結果：10名學生

### 示例4：智能回退
- **選擇**：地點 = 荔枝角公園，星期 = 星期三
- **假設**：荔枝角公園星期三沒有學生
- **篩選過程**：
  1. 原始數據：100名學生
  2. 地點篩選：100 → 30名學生（縮小範圍）
  3. 星期篩選：30 → 0名學生（沒有結果）
  4. 智能回退：顯示荔枝角公園所有時段的學生（30名）
  5. 提示：`⚠️ 在荔枝角公園的星期三沒有學生，已顯示該地點所有時段的學生`

## 🔍 控制台日誌

系統會在控制台輸出詳細的篩選過程：

```
📍 地點篩選：100 → 30 (縮小範圍)
📅 星期篩選：30 → 10 (進一步縮小範圍)
✅ 最終篩選結果：10名學生
```

## 💡 優勢

1. **範圍逐步縮小**：符合用戶的直觀理解
2. **性能更好**：避免重複遍歷數據
3. **邏輯清晰**：每個篩選步驟都有明確的作用
4. **智能回退**：避免顯示空白結果
5. **詳細日誌**：便於調試和監控

## 🚀 使用方法

1. **選擇日期**：系統會自動推導星期
2. **選擇地點**：第一層篩選，縮小範圍
3. **選擇星期**：第二層篩選，進一步縮小範圍
4. **查看結果**：系統會顯示符合條件的學生

## 🔧 技術實現

- **語言**：JavaScript ES6+
- **篩選方法**：Array.filter()
- **數據結構**：Map 用於去重
- **日誌系統**：console.log 和 toast 提示
- **錯誤處理**：try-catch 和智能回退

## 📝 更新日誌

- **v2.0**：從並列篩選改為遞進篩選
- **v2.1**：添加智能回退機制
- **v2.2**：添加詳細的控制台日誌
- **v2.3**：優化用戶體驗和錯誤處理

---

*這個遞進篩選系統確保了篩選條件的層層縮小，提供了更精確和用戶友好的數據過濾體驗。* 